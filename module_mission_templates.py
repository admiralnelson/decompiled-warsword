# -*- coding: UTF-8 -*-
####################################################################################################################
# Generated by Warband Module Decompiler
# All rights of the module belong to their respective owners
####################################################################################################################

from header_common import *
from header_operations import *
from header_mission_templates import *
from header_animations import *
from header_sounds import *
from header_music import *
from header_items import *
from module_constants import *

####################################################################################################################
#   Each mission-template is a tuple that contains the following fields:
#  1) Mission-template id (string): used for referencing mission-templates in other files.
#     The prefix mt_ is automatically added before each mission-template id
#
#  2) Mission-template flags (int): See header_mission-templates.py for a list of available flags
#  3) Mission-type(int): Which mission types this mission template matches.
#     For mission-types to be used with the default party-meeting system,
#     this should be 'charge' or 'charge_with_ally' otherwise must be -1.
#     
#  4) Mission description text (string).
#  5) List of spawn records (list): Each spawn record is a tuple that contains the following fields:
#    5.1) entry-no: Troops spawned from this spawn record will use this entry
#    5.2) spawn flags.
#    5.3) alter flags. which equipment will be overriden
#    5.4) ai flags.
#    5.5) Number of troops to spawn.
#    5.6) list of equipment to add to troops spawned from here (maximum 8).
#  6) List of triggers (list).
#     See module_triggers.py for infomation about triggers.
#
#  Please note that mission templates is work in progress and can be changed in the future versions.
# 
####################################################################################################################

pilgrim_disguise = [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff, itm_throwing_daggers]
af_castle_lord = af_override_horse | af_override_weapons| af_require_civilian

"""
    add mana mission template. Sometimes it's not triggering in release ver.
"""
log = display_message
magic_trigger = (
    10, 0, 0, 
    [            
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$spelleffect", 1),
    ],
    [
      (reset_mission_timer_b),
      (log, "@DEBUG: add mana mission template called! (line 2)"),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$hasnotcastthisturn", 0),
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":len", reg1),
      (val_add, ":len", 1),
      (gt, ":len", 1),
      (log, "@DEBUG: checks success! (line 8)"),
      (log, "@var_dump(':len') => {reg1} (line 9)"),
      (assign, "$windsofmagic", 0),
      (store_random_in_range, ":random", 1, 9),
      (val_add, "$windsofmagic", ":random"),
      (assign, ":randomCheck", ":random"),
      (assign, reg2, ":random"),
      (display_message, "@Winds of Magic: {reg2}.", 0xFF5733),
      (get_player_agent_no, ":playerAgentHandle"),
      (agent_get_team, ":playerTeam", ":playerAgentHandle"),
      (assign, ":bonusModifier", ":random"),
      (try_begin),
        (troop_slot_eq, "trp_player", 225, 1),
        (troop_slot_eq, "trp_player", 257, 1),
        (agent_get_slot, ":isTeamPlayer", ":playerAgentHandle", 112),
        (agent_is_alive, ":playerAgentHandle"),
        (assign, "$spell_cast", 0),
        (try_begin),
          (eq, ":isTeamPlayer", 1),
          (assign, "$spell_cast", 1),
          (agent_set_slot, ":playerAgentHandle", 112, 0),
        (try_end),
        (troop_get_slot, ":var7", "trp_player", 229),
        (troop_get_slot, ":var8", "trp_player", 230),
        (troop_get_slot, ":var9", "trp_player", 226),
        (store_add, ":var10", ":var7", 1),
        (lt, ":var8", ":var7"),
        (val_add, ":var8", "$windsofmagic"),
        (store_skill_level, ":var11", 20, "trp_player"),
        (try_begin),
          (ge, ":var11", 8),
          (val_add, ":var8", 7),
        (else_try),
          (ge, ":var11", 5),
          (val_add, ":var8", 5),
        (else_try),
          (val_add, ":var8", 3),
        (try_end),
        (val_add, ":var8", ":var11"),
        (call_script, "script_ce_get_troop_armour_encumbrance", "trp_player"),
        (assign, ":var12", reg1),
        (try_begin),
          (lt, ":var12", 10),
          (val_add, ":var8", 6),
        (else_try),
          (lt, ":var12", 15),
          (val_add, ":var8", 4),
        (else_try),
          (lt, ":var12", 19),
          (val_add, ":var8", 2),
        (else_try),
          (gt, ":var12", 54),
          (val_sub, ":var8", 14),
        (else_try),
          (gt, ":var12", 49),
          (val_sub, ":var8", 12),
        (else_try),
          (gt, ":var12", 44),
          (val_sub, ":var8", 10),
        (else_try),
          (gt, ":var12", 39),
          (val_sub, ":var8", 8),
        (else_try),
          (gt, ":var12", 34),
          (val_sub, ":var8", 6),
        (else_try),
          (gt, ":var12", 29),
          (val_sub, ":var8", 4),
        (else_try),
          (gt, ":var12", 24),
          (val_sub, ":var8", 2),
        (try_end),
        (agent_get_wielded_item, ":var13", ":playerAgentHandle", 1),
        (try_begin),
          (ge, ":var13", 1),
          (val_sub, ":random", 5),
        (try_end),
        (try_begin),
          (ge, "$tempest", 1),
          (try_for_agents, ":var14"),
            (agent_slot_eq, ":var14", 167, 1),
            (agent_get_team, ":var15", ":var14"),
            (neg|teams_are_enemies, ":var15", ":playerTeam"),
            (store_random_in_range, ":var16", 15, 26),
            (assign, reg4, ":var16"),
            (val_add, ":random", ":var16"),
            (display_message, "@Mana tempest adds {reg4} mana.", 0x0BBCFC),
          (try_end),
        (try_end),
        (try_begin),
          (ge, "$boon", 1),
          (try_for_agents, ":var14"),
            (agent_slot_eq, ":var14", 166, 1),
            (agent_get_team, ":var15", ":var14"),
            (neg|teams_are_enemies, ":var15", ":playerTeam"),
            (store_random_in_range, ":var16", 15, 26),
            (assign, reg4, ":var16"),
            (val_add, ":random", ":var16"),
            (display_message, "@Boon of Tzeentch adds {reg4} mana.", 0xFFFFFFAA),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$darknessbonus", 1),
          (agent_slot_eq, ":playerAgentHandle", 104, 1),
          (val_add, ":bonusModifier", 2),
          (agent_set_slot, ":playerAgentHandle", 104, 0),
          (assign, "$darknessbonus", 0),
        (try_end),
        (try_begin),
          (eq, "$leechbonus", 1),
          (agent_get_slot, ":var17", ":playerAgentHandle", 144),
          (val_add, ":bonusModifier", ":var17"),
          (agent_set_slot, ":playerAgentHandle", 144, 0),
        (try_end),
        (try_begin),
          (eq, "$goblinshaman_in_battle", 1),
          (agent_get_slot, ":var18", ":playerAgentHandle", 124),
          (ge, ":var18", 1),
          (val_add, ":bonusModifier", ":var18"),
          (agent_set_slot, ":playerAgentHandle", 124, 0),
        (try_end),
        (try_begin),
          (eq, "$goblinshaman_in_battle", 1),
          (agent_get_slot, ":var19", ":playerAgentHandle", 125),
          (eq, ":var19", 1),
          (val_sub, ":bonusModifier", 1),
          (agent_set_slot, ":playerAgentHandle", 125, 0),
        (try_end),
        (try_begin),
          (eq, "$drain_magic", 1),
          (agent_get_slot, ":var20", "$drainlifecaster", 68),
          (teams_are_enemies, ":var20", ":playerTeam"),
          (val_sub, ":bonusModifier", 10),
          (display_message, "@Drain magic reduces your mana accumulation by 10 mana.", 0x0BBCFC),
          (assign, "$drain_magic", 0),
        (try_end),
        (try_begin),
          (eq, "$mork_save_uz", 1),
          (agent_get_slot, ":var20", "$morksaveuzcaster", 68),
          (teams_are_enemies, ":var20", ":playerTeam"),
          (val_sub, ":bonusModifier", 10),
          (display_message, "@Mork save uz reduces your mana accumulation by 10 mana.", 0x009900),
          (assign, "$mork_save_uz", 0),
        (try_end),
        (try_begin),
          (eq, "$mork_save_uz_2", 1),
          (agent_get_slot, ":var20", "$morksaveuz2caster", 68),
          (teams_are_enemies, ":var20", ":playerTeam"),
          (val_sub, ":bonusModifier", 10),
          (display_message, "@Mork save uz reduces your mana accumulation by 10 mana.", 0x00FF00),
          (assign, "$mork_save_uz", 0),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":playerAgentHandle", 112, 1),
          (assign, ":bonusModifier", 1),
          (agent_set_slot, ":playerAgentHandle", 112, 0),
        (try_end),
        (val_clamp, ":var8", 1, ":var10"),
        (troop_set_slot, "trp_player", 230, ":var8"),
        (call_script, "script_cf_equip_spell_ammo"),
      (try_end),
      (try_begin),
        (eq, ":var9", 7),
        (assign, "$brightattribute", 0),
      (try_end),
      (try_begin),
        (eq, "$orcshaman_in_battle", 1),
        (try_for_agents, ":var21"),
          (agent_is_alive, ":var21"),
          (agent_is_human, ":var21"),
          (agent_is_active, ":var21"),
          (agent_get_troop_id, ":var22", ":var21"),
          (troop_get_type, ":var23", ":var22"),
          (eq, ":var23", 12),
          (troop_slot_eq, ":var22", 225, 1),
          (agent_get_slot, ":var24", ":var21", 145),
          (agent_set_slot, ":var21", 146, ":var24"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$orcshaman_in_battle", 1),
        (try_for_agents, ":var21"),
          (agent_is_alive, ":var21"),
          (agent_is_human, ":var21"),
          (agent_is_active, ":var21"),
          (agent_get_troop_id, ":var22", ":var21"),
          (troop_get_type, ":var23", ":var22"),
          (eq, ":var23", 12),
          (agent_set_slot, ":var21", 145, 0),
        (try_end),
      (try_end),
      (gt, ":len", 1),
      (call_script, "script_list_clear", "trp_list_13"),
      (store_sub, ":var25", ":len", 1),
      (assign, "$hasnotcastthisturn", ":var25"),
      (try_for_agents, ":var14"),
        (neq, ":var14", ":playerAgentHandle"),
        (agent_is_alive, ":var14"),
        (agent_is_human, ":var14"),
        (agent_is_active, ":var14"),
        (neg|agent_is_wounded, ":var14"),
        (agent_get_troop_id, ":agentHandle", ":var14"),
        (troop_get_slot, ":var27", ":agentHandle", 225),
        (eq, ":var27", 1),
        (try_begin),
          (agent_slot_eq, ":var14", 147, 0),
          (call_script, "script_cf_equip_casters", ":var14", ":agentHandle"),
          (agent_set_slot, ":var14", 147, 1),
        (try_end),
        (agent_get_position, pos1, ":var14"),
        (agent_get_team, ":playerTeam", ":var14"),
        (try_for_agents, ":var28"),
          (agent_is_alive, ":var28"),
          (agent_is_human, ":var28"),
          (agent_is_active, ":var28"),
          (agent_get_team, ":var29", ":var28"),
          (teams_are_enemies, ":var29", ":playerTeam"),
          (agent_get_position, pos2, ":var28"),
          (get_distance_between_positions, ":var30", pos1, pos2),
          (lt, ":var30", 16000),
          (call_script, "script_list_add", "trp_list_13", ":var28"),
        (try_end),
        (agent_set_slot, ":var14", 152, 0),
        (call_script, "script_list_count", "trp_list_13"),
        (assign, ":var31", reg1),
        (val_add, ":var31", 1),
        (gt, ":var31", 1),
        (store_random_in_range, ":var32", 1, 11),
        (eq, ":var32", 10),
        (agent_set_slot, ":var14", 152, 1),
        (val_sub, "$hasnotcastthisturn", 1),
        (troop_get_slot, ":aiDecision", ":agentHandle", 226),
        (store_skill_level, ":var34", 18, ":agentHandle"),
        (store_random_in_range, ":bonusModifier", 1, 11),
        (val_add, ":bonusModifier", ":var34"),
        (try_begin),
          (ge, ":randomCheck", 7),
          (val_add, ":bonusModifier", 2),
        (try_end),
        (try_begin),
          (ge, "$tempest", 1),
          (try_for_agents, ":var14"),
            (agent_slot_eq, ":var14", 167, 1),
            (agent_get_team, ":var15", ":var14"),
            (neg|teams_are_enemies, ":var15", ":playerTeam"),
            (val_add, ":bonusModifier", 4),
          (try_end),
        (try_end),
        (try_begin),
          (ge, "$boon", 1),
          (try_for_agents, ":var14"),
            (agent_slot_eq, ":var14", 166, 1),
            (agent_get_team, ":var15", ":var14"),
            (neg|teams_are_enemies, ":var15", ":playerTeam"),
            (val_add, ":bonusModifier", 4),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$darknessbonus", 1),
          (agent_slot_eq, ":var14", 104, 1),
          (val_add, ":bonusModifier", 2),
          (agent_set_slot, ":var14", 104, 0),
        (try_end),
        (try_begin),
          (eq, "$leechbonus", 1),
          (agent_get_slot, ":var17", ":var14", 144),
          (val_add, ":bonusModifier", ":var17"),
          (agent_set_slot, ":var14", 144, 0),
        (try_end),
        (try_begin),
          (eq, ":aiDecision", 12),
          (eq, ":randomCheck", 8),
          (val_add, ":bonusModifier", 2),
        (try_end),
        (try_begin),
          (eq, "$goblinshaman_in_battle", 1),
          (agent_get_slot, ":var18", ":var14", 124),
          (ge, ":var18", 1),
          (val_add, ":bonusModifier", ":var18"),
          (agent_set_slot, ":var14", 124, 0),
        (try_end),
        (try_begin),
          (eq, "$goblinshaman_in_battle", 1),
          (agent_get_slot, ":var19", ":var14", 125),
          (eq, ":var19", 1),
          (val_sub, ":bonusModifier", 1),
          (agent_set_slot, ":var14", 125, 0),
        (try_end),
        (try_begin),
          (eq, "$drain_magic", 1),
          (agent_get_slot, ":var20", "$drainlifecaster", 68),
          (teams_are_enemies, ":var20", ":playerTeam"),
          (val_sub, ":bonusModifier", 4),
          (assign, "$drain_magic", 0),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var14", 112, 1),
          (assign, ":bonusModifier", 1),
          (agent_set_slot, ":var14", 112, 0),
        (try_end),
        (ge, ":bonusModifier", 11),
        (try_begin),
          (eq, ":aiDecision", 1),
          (call_script, "script_light_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 2),
          (call_script, "script_gold_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 3),
          (call_script, "script_jade_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 4),
          (call_script, "script_celestial_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 5),
          (call_script, "script_grey_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 6),
          (call_script, "script_amethyst_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 7),
          (call_script, "script_bright_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 8),
          (call_script, "script_amber_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 9),
          (call_script, "script_qhaysh_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 10),
          (call_script, "script_dhar_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 11),
          (call_script, "script_undeath_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 12),
          (call_script, "script_tzeentch_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 13),
          (call_script, "script_slaanesh_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 14),
          (call_script, "script_nurgle_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 15),
          (call_script, "script_orc_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 16),
          (call_script, "script_goblin_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 17),
          (call_script, "script_ruin_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 18),
          (call_script, "script_plague_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 19),
          (call_script, "script_nehekhara_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 20),
          (call_script, "script_ice_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 21),
          (call_script, "script_desert_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 22),
          (call_script, "script_wild_magic_decision", ":var14"),
        (else_try),
          (eq, ":aiDecision", 23),
          (call_script, "script_ulric_priest_decision", ":var14"),
        (else_try),
        (try_end),
            (call_script, "script_list_clear", "trp_list_13"),
      (try_end),
    ])

mission_templates = [
  ("town_default", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_scene_source, af_override_horse, 0, 1, []),
    (9, mtef_scene_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_scene_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (eq, "$talk_context", 14),
        (call_script, "script_music_set_situation_with_culture", 512),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_initialize_tavern_variables"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (1, 0, 0, 
    [
      (gt, "$g_belligerent_drunk_leaving", 0),
      (entry_point_get_position, pos0, 0),
      (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
      (get_distance_between_positions, ":var0", pos0, pos1),
      (le, ":var0", 150),
    ],
    [
      (agent_fade_out, "$g_belligerent_drunk_leaving"),
      (assign, "$g_belligerent_drunk_leaving", 0),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_main_attacker_agent", 0),
        (set_trigger_result, 1),
      (try_end),
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
    ],
    []),

    (2, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (neg|troop_slot_eq, "trp_hired_assassin", 12, "$g_encountered_party"),
      (troop_slot_eq, "trp_belligerent_drunk", 12, "$g_encountered_party"),
      (eq, "$drunks_dont_pick_fights", 0),
    ],
    [
      (try_begin),
        (eq, "$g_start_belligerent_drunk_fight", 0),
        (assign, "$g_start_belligerent_drunk_fight", 1),
        (try_for_agents, ":var0"),
          (agent_get_troop_id, ":var1", ":var0"),
          (eq, ":var1", "trp_belligerent_drunk"),
          (assign, "$g_belligerent_drunk", ":var0"),
        (try_end),
      (else_try),
        (eq, "$g_start_belligerent_drunk_fight", 1),
        (agent_is_active, "$g_belligerent_drunk"),
        (agent_is_alive, "$g_belligerent_drunk"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos0, ":var2"),
        (agent_get_position, pos1, "$g_belligerent_drunk"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (position_get_z, ":var4", pos0),
        (position_get_z, ":var5", pos1),
        (store_sub, ":var6", ":var5", ":var4"),
        (try_begin),
          (le, ":var6", 0),
          (val_mul, ":var6", -1),
        (try_end),
        (store_mul, ":var7", ":var6", 3),
        (val_add, ":var3", ":var7"),
        (store_random_in_range, ":var8", 0, 200),
        (store_add, ":var9", 400, ":var8"),
        (le, ":var3", ":var9"),
        (call_script, "script_activate_tavern_attackers"),
        (start_mission_conversation, "trp_belligerent_drunk"),
        (assign, "$g_start_belligerent_drunk_fight", 2),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (troop_slot_eq, "trp_hired_assassin", 12, "$g_encountered_party"),
    ],
    [
      (try_begin),
        (eq, "$g_start_hired_assassin_fight", 0),
        (assign, "$g_start_hired_assassin_fight", 1),
        (try_for_agents, ":var0"),
          (agent_get_troop_id, ":var1", ":var0"),
          (eq, ":var1", "trp_hired_assassin"),
          (assign, "$g_hired_assassin", ":var0"),
        (try_end),
      (else_try),
        (eq, "$g_start_hired_assassin_fight", 1),
        (agent_is_active, "$g_hired_assassin"),
        (agent_is_alive, "$g_hired_assassin"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos0, ":var2"),
        (agent_get_position, pos1, "$g_hired_assassin"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (position_get_z, ":var4", pos0),
        (position_get_z, ":var5", pos1),
        (store_sub, ":var6", ":var5", ":var4"),
        (try_begin),
          (le, ":var6", 0),
          (val_mul, ":var6", -1),
        (try_end),
        (store_mul, ":var7", ":var6", 3),
        (val_add, ":var3", ":var7"),
        (store_random_in_range, ":var8", 0, 200),
        (store_add, ":var9", 400, ":var8"),
        (le, ":var3", ":var9"),
        (call_script, "script_activate_tavern_attackers"),
        (assign, "$g_start_hired_assassin_fight", 2),
      (try_end),
    ]),

    (3, 0, ti_once, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (gt, "$g_main_attacker_agent", 0),
      (neg|this_or_next|agent_is_alive, "$g_main_attacker_agent"),
      (agent_is_wounded, "$g_main_attacker_agent"),
    ],
    [
      (mission_enable_talk),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_position, pos4, ":var0"),
        (agent_set_scripted_destination, ":var0", pos4),
      (try_end),
      (party_get_slot, ":var1", "$g_encountered_party", 20),
      (start_mission_conversation, ":var1"),
    ]),

    (3, 0, ti_once, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (gt, "$g_main_attacker_agent", 0),
      (main_hero_fallen),
    ],
    [
      (jump_to_menu, "mnu_lost_tavern_duel"),
      (finish_mission, 0),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (gt, "$g_main_attacker_agent", 0),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (is_between, ":var1", "itm_darts", "itm_torch"),
      (neq, ":var1", "itm_javelin_melee"),
      (neq, ":var1", "itm_throwing_spear_melee"),
      (neq, ":var1", "itm_jarid_melee"),
      (neq, ":var1", "itm_light_throwing_axes_melee"),
      (neq, ":var1", "itm_throwing_axes_melee"),
      (neq, ":var1", "itm_heavy_throwing_axes_melee"),
    ],
    [
      (party_get_slot, ":var0", "$g_encountered_party", 20),
      (start_mission_conversation, ":var0"),
    ]),

    (1, 0, 0, 
    [
      (gt, "$g_main_attacker_agent", 0),
    ],
    [
      (agent_get_wielded_item, ":var0", "$g_main_attacker_agent", 0),
      (val_max, "$g_attacker_drawn_weapon", ":var0"),
      (call_script, "script_neutral_behavior_in_fight"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", "skl_leadership", "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var3", 11),
        (assign, ":var4", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var3", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var4", "mt_castle_visit"),
        (else_try),
          (assign, ":var4", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var3", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (agent_slot_ge, "$fplayer_agent_no", 36, 1),
        (mission_tpl_entry_set_override_flags, ":var4", ":var3", 0),
      (try_end),
      (store_current_scene, ":var5"),
      (modify_visitors_at_site, ":var5"),
      (assign, ":var6", 0),
      (party_get_num_companion_stacks, ":var7", "p_main_party"),
      (try_for_range, ":var8", 0, ":var7"),
        (party_stack_get_troop_id, ":var9", "p_main_party", ":var8"),
        (neq, ":var9", "trp_player"),
        (troop_is_hero, ":var9"),
        (neg|troop_is_wounded, ":var9"),
        (val_add, ":var6", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var9", 161, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var3", ":var9", 1),
        (eq, ":var6", ":var2"),
        (assign, ":var7", 0),
      (try_end),
      (gt, ":var6", 0),
      (set_show_messages, 0),
      (team_give_order, "$fplayer_team_no", 8, 1),
      (team_set_order_listener, "$fplayer_team_no", 8),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (ge, ":var2", 0),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (neg|troop_is_wounded, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("conversation_encounter", 0, -1,
  "Conversation encounter",
  [
    (0, mtef_visitor_source, af_override_horse, 0, 1, []),
    (1, mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("town_center", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_eq, ":var1", 161, 1),
        (agent_set_team, ":var0", 0),
        (agent_ai_set_aggressiveness, ":var0", 5),
        (troop_set_slot, ":var1", 161, 0),
        (try_begin),
          (troop_slot_eq, ":var1", 149, 3),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_main_attacker_agent", 0),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (store_current_scene, ":var0"),
        (scene_set_slot, ":var0", 0, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (mission_enable_talk),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    [
      (try_begin),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_sneak_into_town_caught_dispersed_guards"),
      (try_end),
      (mission_enable_talk),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
      (try_begin),
        (eq, "$town_nighttime", 0),
        (play_sound, "snd_town_ambiance", 2),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (1, 0, 0, 
    [
      (this_or_next|eq, "$talk_context", 18),
      (eq, "$talk_context", 19),
    ],
    [
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talk_context", 19),
    ],
    [
      (get_player_agent_no, ":var0"),
      (assign, reg6, ":var0"),
      (call_script, "script_activate_town_guard"),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos4, ":var0"),
      (try_for_range, ":var1", "trp_npc1", "trp_heroes_end"),
        (troop_slot_ge, ":var1", 149, 2),
        (str_store_troop_name, s4, ":var1"),
        (display_message, "str_s4_joins_prison_break"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (add_visitors_to_current_scene, 24, ":var1", 1, 0, 0),
        (troop_set_slot, ":var1", 161, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 18),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_captivity_start_castle_defeat"),
        (assign, ":var0", "trp_heroes_end"),
        (try_for_range, ":var1", "trp_npc1", ":var0"),
          (troop_set_slot, ":var1", 149, 0),
        (try_end),
        (mission_enable_talk),
        (finish_mission, 0),
      (else_try),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$talk_context", 19),
      (neg|main_hero_fallen, 0),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (all_enemies_defeated),
    ],
    [
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_ge, ":var1", 149, 2),
        (try_begin),
          (agent_is_alive, ":var0"),
          (troop_set_slot, ":var1", 149, 4),
        (else_try),
          (troop_set_slot, ":var1", 149, 5),
        (try_end),
      (try_end),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission, 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (this_or_next|eq, ":var2", "trp_swadian_prison_guard"),
        (this_or_next|eq, ":var2", "trp_vaegir_prison_guard"),
        (this_or_next|eq, ":var2", "trp_khergit_prison_guard"),
        (this_or_next|eq, ":var2", "trp_rhodok_prison_guard"),
        (eq, ":var2", "trp_sarranid_prison_guard"),
        (eq, ":var3", "trp_player"),
        (display_message, "@You got keys of dungeon."),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", "skl_leadership", "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var3", 11),
        (assign, ":var4", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var3", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var4", "mt_castle_visit"),
        (else_try),
          (assign, ":var4", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var3", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (agent_slot_ge, "$fplayer_agent_no", 36, 1),
        (mission_tpl_entry_set_override_flags, ":var4", ":var3", 0),
      (try_end),
      (store_current_scene, ":var5"),
      (modify_visitors_at_site, ":var5"),
      (assign, ":var6", 0),
      (party_get_num_companion_stacks, ":var7", "p_main_party"),
      (try_for_range, ":var8", 0, ":var7"),
        (party_stack_get_troop_id, ":var9", "p_main_party", ":var8"),
        (neq, ":var9", "trp_player"),
        (troop_is_hero, ":var9"),
        (neg|troop_is_wounded, ":var9"),
        (val_add, ":var6", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var9", 161, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var3", ":var9", 1),
        (eq, ":var6", ":var2"),
        (assign, ":var7", 0),
      (try_end),
      (gt, ":var6", 0),
      (set_show_messages, 0),
      (team_give_order, "$fplayer_team_no", 8, 1),
      (team_set_order_listener, "$fplayer_team_no", 8),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (ge, ":var2", 0),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (neg|troop_is_wounded, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("village_center", 0, -1,
  "village center",
  [
    (0, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_visitor_source, af_override_horse, 0, 1, []),
    (47, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_music_set_situation_with_culture", 65536),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
        (neg|check_quest_failed, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
          (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
        (else_try),
          (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
        (try_end),
      (try_end),
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (try_begin),
          (call_script, "script_list_count", "trp_list_08"),
          (gt, reg1, 0),
          (val_add, reg1, 1),
          (assign, reg3, reg1),
          (get_player_agent_no, ":var0"),
          (try_for_range, ":var1", 1, reg3),
            (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
            (eq, reg1, ":var0"),
            (store_agent_hit_points, ":var2", ":var0", 1),
            (val_mul, ":var2", 100),
            (agent_get_slot, ":var3", ":var0", 58),
            (store_div, ":var4", ":var2", ":var3"),
            (gt, ":var2", 25),
            (troop_set_health, "trp_player", ":var4"),
          (try_end),
        (try_end),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_hunt_down_fugitive"),
      (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
      (neg|check_quest_failed, "qst_hunt_down_fugitive"),
      (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", "skl_leadership", "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var3", 11),
        (assign, ":var4", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var3", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var4", "mt_castle_visit"),
        (else_try),
          (assign, ":var4", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var3", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (agent_slot_ge, "$fplayer_agent_no", 36, 1),
        (mission_tpl_entry_set_override_flags, ":var4", ":var3", 0),
      (try_end),
      (store_current_scene, ":var5"),
      (modify_visitors_at_site, ":var5"),
      (assign, ":var6", 0),
      (party_get_num_companion_stacks, ":var7", "p_main_party"),
      (try_for_range, ":var8", 0, ":var7"),
        (party_stack_get_troop_id, ":var9", "p_main_party", ":var8"),
        (neq, ":var9", "trp_player"),
        (troop_is_hero, ":var9"),
        (neg|troop_is_wounded, ":var9"),
        (val_add, ":var6", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var9", 161, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var3", ":var9", 1),
        (eq, ":var6", ":var2"),
        (assign, ":var7", 0),
      (try_end),
      (gt, ":var6", 0),
      (set_show_messages, 0),
      (team_give_order, "$fplayer_team_no", 8, 1),
      (team_set_order_listener, "$fplayer_team_no", 8),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (ge, ":var2", 0),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (neg|troop_is_wounded, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("bandits_at_night", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, aif_start_alarmed, 1, [itm_practice_staff,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_scene_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (agent_set_team, ":var0", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    magic_trigger,

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, 3, 
    [
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (item_slot_eq, "$currentbanner", 132, 1),
      (try_begin),
        (eq, "$spell_cast", 1),
        (store_random_in_range, ":var0", 1, 6),
        (try_begin),
          (eq, ":var0", 5),
          (call_script, "script_cf_cancel_magic_effect"),
          (display_message, "@The rune of spellbreaking cancels all magical effects.", 0xFFCC00),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
    ]),

    (1, 4, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_town_bandits_failed"),
      (else_try),
        (jump_to_menu, "mnu_town_bandits_succeeded"),
      (try_end),
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", "skl_leadership", "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var3", 11),
        (assign, ":var4", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var3", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var4", "mt_castle_visit"),
        (else_try),
          (assign, ":var4", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var3", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (agent_slot_ge, "$fplayer_agent_no", 36, 1),
        (mission_tpl_entry_set_override_flags, ":var4", ":var3", 0),
      (try_end),
      (store_current_scene, ":var5"),
      (modify_visitors_at_site, ":var5"),
      (assign, ":var6", 0),
      (party_get_num_companion_stacks, ":var7", "p_main_party"),
      (try_for_range, ":var8", 0, ":var7"),
        (party_stack_get_troop_id, ":var9", "p_main_party", ":var8"),
        (neq, ":var9", "trp_player"),
        (troop_is_hero, ":var9"),
        (neg|troop_is_wounded, ":var9"),
        (val_add, ":var6", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var9", 161, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var3", ":var9", 1),
        (eq, ":var6", ":var2"),
        (assign, ":var7", 0),
      (try_end),
      (gt, ":var6", 0),
      (set_show_messages, 0),
      (team_give_order, "$fplayer_team_no", 8, 1),
      (team_set_order_listener, "$fplayer_team_no", 8),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (ge, ":var2", 0),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (neg|troop_is_wounded, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("village_training", mtf_arena_fight, -1,
  "village training",
  [
    (2, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (4, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_train_peasants_against_bandits_training_succeeded", 0),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_train_peasants_against_bandits_training_succeeded", 1),
      (try_end),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("visit_town_castle", 0, -1,
  "You enter the halls of the lord.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (neq, "$talk_context", 18),
      (set_trigger_result, 1),
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (eq, "$talk_context", 18),
    ],
    [
      (try_begin),
        (call_script, "script_list_count", "trp_list_08"),
        (gt, reg1, 0),
        (val_add, reg1, 1),
        (assign, reg3, reg1),
        (get_player_agent_no, ":var0"),
        (try_for_range, ":var1", 1, reg3),
          (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
          (eq, reg1, ":var0"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (val_mul, ":var2", 100),
          (agent_get_slot, ":var3", ":var0", 58),
          (store_div, ":var4", ":var2", ":var3"),
          (gt, ":var2", 25),
          (troop_set_health, "trp_player", ":var4"),
        (try_end),
      (try_end),
      (display_message, "str_leaving_area_during_prison_break"),
      (set_jump_mission, "mt_sneak_caught_fight"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$talk_context", 1),
        (try_begin),
          (store_faction_of_party, ":var0", "$current_town"),
          (faction_slot_eq, ":var0", 4, 6),
          (faction_slot_eq, ":var0", 5, "$current_town"),
          (call_script, "script_music_set_situation_with_culture", 16777216),
        (try_end),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("back_alley_kill_local_merchant", mtf_battle_mode, -1,
  "You enter the back alley",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 1),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (assign, ":var1", 0),
      (assign, ":var3", -1),
      (assign, ":var4", -1),
      (try_for_agents, ":var5"),
        (agent_get_troop_id, ":var6", ":var5"),
        (try_begin),
          (eq, ":var6", "trp_local_merchant"),
          (store_agent_hit_points, ":var1", ":var5"),
          (assign, ":var3", ":var5"),
        (else_try),
          (eq, ":var6", "trp_player"),
          (store_agent_hit_points, ":var2", ":var5"),
          (assign, ":var4", ":var5"),
        (try_end),
      (try_end),
      (ge, ":var4", 0),
      (ge, ":var3", 0),
      (agent_is_alive, ":var4"),
      (agent_is_alive, ":var3"),
      (is_between, ":var1", 1, 30),
      (gt, ":var2", 50),
      (start_mission_conversation, "trp_local_merchant"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_local_merchant"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (call_script, "script_fail_quest", "qst_kill_local_merchant"),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -4),
        (call_script, "script_succeed_quest", "qst_kill_local_merchant"),
      (try_end),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("back_alley_revolt", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_weapons|af_override_horse|af_override_head, aif_start_alarmed, 4, [itm_quarter_staff]),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_collect_taxes_failed"),
      (finish_mission),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_collect_taxes_failed"),
      (else_try),
        (jump_to_menu, "mnu_collect_taxes_rebels_killed"),
      (try_end),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("lead_charge", mtf_battle_mode|mtf_synch_inventory, charge,
  "You lead your men to battle.",
  [
    (1, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 12, []),
    (0, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 0, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 12, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 0, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (eq, "$resurrect_in_play", 0),
        (call_script, "script_agent_reassign_team", ":var0"),
      (try_end),
      (assign, ":var1", 5000),
      (agent_get_troop_id, ":var2", ":var0"),
      (store_character_level, ":var3", ":var2"),
      (val_mul, ":var3", 35),
      (val_add, ":var1", ":var3"),
      (try_begin),
        (troop_get_slot, ":var4", ":var2", 175),
        (eq, ":var4", 2),
        (val_add, ":var1", 100000),
      (try_end),
      (store_random_in_range, ":var5", 0, 3000),
      (val_add, ":var1", ":var5"),
      (try_begin),
        (eq, "$resurrect_in_play", 0),
        (agent_get_party_id, ":var6", ":var0"),
        (party_get_morale, ":var7", ":var6"),
        (store_sub, ":var8", ":var7", 70),
      (else_try),
        (assign, ":var8", 30),
      (try_end),
      (val_mul, ":var8", 30),
      (val_add, ":var1", ":var8"),
      (agent_set_slot, ":var0", 16, ":var1"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
      (call_script, "script_apply_death_effect_on_courage_scores", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_beam_emitter_pain_full"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
      (assign, "$g_defender_reinforcement_limit", 2),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":var0", reg0),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_party_id, ":var3", ":var2"),
        (try_begin),
          (neq, ":var3", "p_main_party"),
          (neg|agent_is_ally, ":var2"),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var4", ":var0", ":var1"),
      (try_begin),
        (lt, ":var4", 15),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (val_add, "$g_defender_reinforcement_limit", 1),
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),
      (lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
      (store_mission_timer_a, ":var5"),
      (ge, ":var5", 10),
      (store_normalized_team_count, ":var6", 0),
      (lt, ":var6", 6),
    ],
    [
      (add_reinforcements_to_entry, 0, 7),
      (assign, "$defender_reinforcement_limit_increased", 0),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 3, 7),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, ti_once, 
    [
      (neg|party_slot_eq, "p_main_party", 83, 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
    ],
    [
      (call_script, "script_select_battle_tactic"),
      (call_script, "script_battle_tactic_init"),
    ]),

    (3, 0, 0, 
    [
      (call_script, "script_apply_effect_of_other_people_on_courage_scores"),
    ],
    []),

    (3, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (store_mission_timer_a, ":var1"),
        (ge, ":var1", 3),
        (call_script, "script_decide_run_away_or_not", ":var0", ":var1"),
      (try_end),
    ],
    []),

    (5, 0, 0, 
    [
      (neg|party_slot_eq, "p_main_party", 83, 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 3),
      (call_script, "script_battle_tactic_apply"),
    ],
    []),

    (0, 0, 3, 
    [
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (item_slot_eq, "$currentbanner", 132, 1),
      (try_begin),
        (eq, "$spell_cast", 1),
        (store_random_in_range, ":var0", 1, 6),
        (try_begin),
          (eq, ":var0", 5),
          (call_script, "script_cf_cancel_magic_effect"),
          (display_message, "@The rune of spellbreaking cancels all magical effects.", 0xFFCC00),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_slot_eq, "trp_player", 225, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_player_missile_light", "itm_phas_protection_ammo"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (item_get_type, ":var7", ":var3"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (item_get_type, ":var8", ":var4"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (item_get_type, ":var9", ":var5"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (item_get_type, ":var10", ":var6"),
        (try_end),
        (try_begin),
          (ge, ":var3", 1),
          (this_or_next|eq, ":var7", 17),
          (this_or_next|eq, ":var7", 16),
          (eq, ":var7", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var3", 0),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (this_or_next|eq, ":var8", 17),
          (this_or_next|eq, ":var8", 16),
          (eq, ":var8", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var4", 1),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (this_or_next|eq, ":var9", 17),
          (this_or_next|eq, ":var9", 16),
          (eq, ":var9", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var5", 2),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (this_or_next|eq, ":var10", 17),
          (this_or_next|eq, ":var10", 16),
          (eq, ":var10", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var6", 3),
        (try_end),
      (else_try),
        (item_get_type, ":var11", ":var1"),
        (this_or_next|eq, ":var11", 17),
        (this_or_next|eq, ":var11", 16),
        (eq, ":var11", 18),
        (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (is_between, ":var3", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var3"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (is_between, ":var4", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (is_between, ":var5", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (is_between, ":var6", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    magic_trigger,

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (set_fixed_point_multiplier, 1),
      (get_scene_boundaries, pos2, pos3),
      (position_get_x, "$g_bound_right", pos2),
      (position_get_y, "$g_bound_top", pos2),
      (position_get_x, "$g_bound_left", pos3),
      (position_get_y, "$g_bound_bottom", pos3),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_weapon_use_classify_agent", ":var0"),
    ]),

    (2, 0, 0, 
    [
      (this_or_next|party_slot_eq, "p_main_party", 78, 1),
      (this_or_next|party_slot_eq, "p_main_party", 79, 1),
      (party_slot_eq, "p_main_party", 80, 1),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_non_player, ":var0"),
        (assign, ":var1", -1),
        (assign, ":var2", -1),
        (assign, ":var3", 0),
        (assign, ":var4", 0),
        (try_begin),
          (agent_get_team, ":var5", ":var0"),
          (eq, ":var5", "$fplayer_team_no"),
          (agent_get_division, ":var6", ":var0"),
          (team_get_weapon_usage_order, ":var3", ":var5", ":var6"),
          (team_get_hold_fire_order, ":var4", ":var5", ":var6"),
          (store_add, ":var7", 300, ":var6"),
          (team_get_slot, ":var1", ":var5", ":var7"),
          (store_add, ":var7", 309, ":var6"),
          (team_get_slot, ":var2", ":var5", ":var7"),
        (try_end),
        (neq, ":var3", 1),
        (eq, ":var1", -1),
        (try_begin),
          (party_slot_eq, "p_main_party", 78, 1),
          (agent_get_slot, ":var8", ":var0", 33),
          (gt, ":var8", 0),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (agent_get_horse, ":var10", ":var0"),
          (try_begin),
            (le, ":var10", 0),
            (agent_set_slot, ":var0", 33, 0),
            (eq, ":var9", ":var8"),
            (try_begin),
              (eq, ":var2", 1),
              (assign, ":var11", 0),
            (else_try),
              (assign, ":var11", 1),
            (try_end),
            (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
          (else_try),
            (agent_get_position, pos1, ":var0"),
            (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var5", 1),
            (assign, ":var12", reg0),
            (try_begin),
              (lt, ":var12", 500),
              (agent_get_combat_state, ":var13", ":var0"),
              (gt, ":var13", 3),
              (eq, ":var9", ":var8"),
              (try_begin),
                (eq, ":var2", 1),
                (assign, ":var11", 0),
              (else_try),
                (assign, ":var11", 1),
              (try_end),
              (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
            (else_try),
              (neq, ":var9", ":var8"),
              (agent_set_wielded_item, ":var0", ":var8"),
            (try_end),
          (try_end),
        (else_try),
          (party_slot_eq, "p_main_party", 79, 1),
          (agent_get_slot, ":var14", ":var0", 34),
          (gt, ":var14", 0),
          (neq, ":var4", 1),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (agent_get_ammo, ":var15", ":var0"),
          (try_begin),
            (le, ":var15", 0),
            (agent_set_slot, ":var0", 34, 0),
            (eq, ":var9", ":var14"),
            (try_begin),
              (eq, ":var2", 1),
              (assign, ":var11", 0),
            (else_try),
              (assign, ":var11", 1),
            (try_end),
            (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
          (else_try),
            (gt, ":var15", 0),
            (agent_get_horse, ":var10", ":var0"),
            (le, ":var10", 0),
          (else_try),
            (gt, ":var15", 0),
            (neq, ":var9", ":var14"),
            (agent_set_wielded_item, ":var0", ":var14"),
          (try_end),
        (else_try),
          (party_slot_eq, "p_main_party", 80, 1),
          (agent_get_slot, ":var16", ":var0", 35),
          (gt, ":var16", 0),
          (store_add, ":var7", 185, ":var6"),
          (team_slot_eq, ":var5", ":var7", 0),
          (neq, ":var2", 1),
          (agent_get_position, pos1, ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var5", 1),
          (assign, ":var12", reg0),
          (assign, ":var17", reg1),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (try_begin),
            (this_or_next|lt, ":var17", 300),
            (lt, ":var12", 700),
            (agent_get_combat_state, ":var13", ":var0"),
            (gt, ":var13", 3),
            (eq, ":var9", ":var16"),
            (call_script, "script_weapon_use_backup_weapon", ":var0", 1),
          (else_try),
            (neq, ":var9", ":var16"),
            (agent_set_wielded_item, ":var0", ":var16"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 81, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (assign, ":var4", ":var2"),
      (try_begin),
        (agent_is_human, ":var0"),
        (try_begin),
          (neg|agent_is_human, ":var1"),
          (eq, ":var3", -1),
          (agent_get_item_id, ":var5", ":var1"),
          (ge, ":var5", 0),
          (gt, ":var4", 5),
          (item_get_slot, ":var6", ":var5", 65),
          (try_begin),
            (lt, ":var6", 18),
            (val_div, ":var6", 3),
            (val_max, ":var2", ":var6"),
          (else_try),
            (is_between, ":var6", 18, 25),
            (val_div, ":var6", 2),
            (val_max, ":var2", ":var6"),
          (else_try),
            (val_max, ":var2", ":var6"),
          (try_end),
          (try_begin),
            (agent_get_speed, pos0, ":var1"),
            (position_get_y, ":var7", pos0),
            (position_get_x, ":var8", pos0),
            (val_max, ":var7", ":var8"),
            (convert_from_fixed_point, ":var7"),
            (gt, ":var7", 6),
            (val_mul, ":var2", 2),
          (try_end),
        (try_end),
      (else_try),
        (neg|agent_is_human, ":var0"),
        (gt, ":var3", 0),
        (item_slot_ge, ":var3", 62, 150),
        (agent_get_horse, ":var5", ":var1"),
        (eq, ":var5", -1),
        (try_begin),
          (agent_get_action_dir, ":var9", ":var1"),
          (eq, ":var9", 0),
          (val_mul, ":var2", 2),
          (val_max, ":var2", 50),
        (else_try),
          (val_mul, ":var2", 3),
          (val_div, ":var2", 2),
          (val_max, ":var2", 30),
        (try_end),
        (val_max, ":var2", ":var4"),
        (agent_get_speed, pos0, ":var0"),
        (position_get_y, ":var7", pos0),
        (position_get_x, ":var8", pos0),
        (val_max, ":var7", ":var8"),
        (convert_from_fixed_point, ":var7"),
        (val_sub, ":var7", 3),
        (val_clamp, ":var7", -2, 4),
        (store_mul, ":var10", ":var7", 10),
        (val_add, ":var2", ":var10"),
        (agent_get_item_id, ":var5", ":var0"),
        (item_get_slot, ":var11", ":var5", 64),
        (val_div, ":var11", 4),
        (val_sub, ":var2", ":var11"),
        (store_random_in_range, ":var12", 0, 100),
        (try_begin),
          (store_div, ":var13", ":var4", 5),
          (val_sub, ":var12", ":var13"),
          (val_sub, ":var12", ":var7"),
          (try_begin),
            (gt, ":var4", 5),
            (eq, ":var9", 0),
            (val_sub, ":var12", 10),
          (try_end),
          (lt, ":var12", 10),
          (agent_set_animation, ":var0", "anim_horse_rear"),
        (try_end),
      (try_end),
      (gt, ":var2", ":var4"),
      (val_sub, ":var2", ":var4"),
      (store_agent_hit_points, ":var14", ":var0", 1),
      (val_sub, ":var14", ":var2"),
      (agent_set_hit_points, ":var0", ":var14", 1),
      (assign, reg2, -1),
      (agent_get_horse, ":var15", "$fplayer_agent_no"),
      (try_begin),
        (try_begin),
          (eq, ":var0", ":var15"),
          (assign, reg2, 0),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (assign, reg2, 1),
        (try_end),
        (neq, reg2, -1),
        (assign, reg1, ":var2"),
        (display_message, "@{reg2?You:Your mount} received {reg1} extra damage!", 0xFF4040),
      (else_try),
        (try_begin),
          (eq, ":var1", ":var15"),
          (assign, reg2, 0),
        (else_try),
          (eq, ":var1", "$fplayer_agent_no"),
          (assign, reg2, 1),
        (try_end),
        (neq, reg2, -1),
        (assign, reg1, ":var2"),
        (display_message, "@{reg2?You strike:Your horse charges} for {reg1} bonus damage!"),
      (try_end),
    ]),

    (ti_on_agent_dismount, 0, 0, 
    [
      (party_get_slot, reg3, "p_main_party", 76),
      (is_between, reg3, 0, 9),
    ],
    [
      (store_trigger_param_2, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (store_trigger_param_1, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_is_non_player, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (eq, ":var2", "$fplayer_team_no"),
        (agent_set_division, ":var1", reg3),
        (agent_set_slot, ":var1", 29, reg3),
      (else_try),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 29, 0),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [
      (party_get_slot, reg3, "p_main_party", 77),
      (is_between, reg3, 0, 9),
    ],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (agent_get_team, ":var5", ":var2"),
      (assign, ":var6", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (this_or_next|eq, ":var5", "$defender_team"),
        (eq, ":var5", "$defender_team_2"),
        (assign, ":var6", 0),
      (try_end),
      (eq, ":var6", 1),
      (try_begin),
        (eq, ":var5", "$fplayer_team_no"),
        (agent_set_division, ":var2", reg3),
        (agent_set_slot, ":var2", 29, reg3),
      (else_try),
        (agent_set_division, ":var2", 0),
        (agent_set_slot, ":var2", 29, 0),
      (try_end),
    ]),

    (2, 0, ti_once, 
    [
      (store_mission_timer_a, reg0),
      (gt, reg0, 2),
    ],
    [
      (set_show_messages, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 0, 9),
          (store_add, ":var2", 176, ":var1"),
          (this_or_next|team_slot_eq, ":var0", ":var2", 2),
          (team_slot_eq, ":var0", ":var2", 5),
          (team_give_order, ":var0", ":var1", 3),
        (try_end),
      (try_end),
      (set_show_messages, 1),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 82, 1),
      (store_mission_timer_a, reg0),
      (gt, reg0, 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 9),
        (store_add, ":var1", 336, ":var0"),
        (neg|team_slot_eq, "$fplayer_team_no", ":var1", 0),
        (call_script, "script_formation_current_position", 2, "$fplayer_team_no", ":var0"),
        (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, "$fplayer_team_no", 2),
        (this_or_next|lt, reg0, 325),
        (position_is_behind_position, pos1, pos2),
        (team_set_order_listener, "$fplayer_team_no", ":var0"),
        (call_script, "script_order_sp_brace_begin_end", 0, "$fplayer_team_no"),
        (team_set_order_listener, "$fplayer_team_no", -1),
      (try_end),
      (try_for_range, ":var2", 0, 4),
        (neq, ":var2", "$fplayer_team_no"),
        (team_slot_ge, ":var2", 5, 1),
        (assign, ":var3", -1),
        (team_get_slot, ":var4", ":var2", 1),
        (this_or_next|eq, ":var4", "fac_deserters"),
        (is_between, ":var4", "fac_player_supporters_faction", "fac_kingdoms_end"),
        (try_begin),
          (this_or_next|eq, ":var4", "fac_player_supporters_faction"),
          (eq, ":var4", "fac_kingdom_5"),
          (try_begin),
            (team_slot_eq, ":var2", 336, 0),
            (store_add, ":var1", 14, 0),
            (team_slot_ge, ":var2", 14, 10),
            (store_add, ":var1", 68, 0),
            (team_slot_ge, ":var2", ":var1", 80),
            (store_add, ":var1", 185, 0),
            (team_get_movement_order, ":var3", ":var2", 0),
            (neg|this_or_next|team_slot_eq, ":var2", ":var1", 0),
            (neq, ":var3", 2),
            (assign, ":var5", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_slot_ge, ":var6", 5, 1),
              (team_get_slot, reg0, ":var6", 9),
              (val_add, ":var5", reg0),
            (try_end),
            (ge, ":var5", 5),
            (assign, ":var7", 99999),
            (call_script, "script_formation_current_position", 2, ":var2", 0),
            (call_script, "script_team_get_position_of_enemies", 1, ":var2", 2),
            (get_distance_between_positions, ":var7", pos1, pos2),
            (is_between, ":var7", 1500, 5000),
            (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, ":var2", 2),
            (gt, reg0, 600),
            (neg|position_is_behind_position, pos1, pos2),
            (team_set_order_listener, ":var2", 0),
            (call_script, "script_order_sp_brace_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (neg|team_slot_eq, ":var2", 336, 0),
            (assign, ":var8", 0),
            (try_begin),
              (assign, ":var5", 0),
              (try_for_range, ":var6", 0, 4),
                (teams_are_enemies, ":var6", ":var2"),
                (team_slot_ge, ":var6", 5, 1),
                (team_get_slot, reg0, ":var6", 9),
                (val_add, ":var5", reg0),
              (try_end),
              (team_get_movement_order, ":var3", ":var2", 0),
              (this_or_next|eq, ":var3", 2),
              (lt, ":var5", 5),
              (assign, ":var8", 1),
            (else_try),
              (store_add, ":var1", 14, 0),
              (neg|team_slot_ge, ":var2", 14, 10),
              (assign, ":var8", 1),
            (else_try),
              (store_add, ":var1", 68, 0),
              (neg|team_slot_ge, ":var2", ":var1", 80),
              (assign, ":var8", 1),
            (else_try),
              (assign, ":var7", 0),
              (call_script, "script_formation_current_position", 2, ":var2", 0),
              (call_script, "script_team_get_position_of_enemies", 1, ":var2", 2),
              (get_distance_between_positions, ":var7", pos1, pos2),
              (gt, ":var7", 6500),
              (assign, ":var8", 1),
            (else_try),
              (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, ":var2", 2),
              (this_or_next|lt, reg0, 350),
              (position_is_behind_position, pos1, pos2),
              (assign, ":var8", 1),
            (try_end),
            (eq, ":var8", 1),
            (team_set_order_listener, ":var2", 0),
            (call_script, "script_order_sp_brace_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (try_end),
        (try_begin),
          (neq, ":var4", "fac_kingdom_1"),
          (neq, ":var4", "fac_kingdom_5"),
          (try_begin),
            (store_add, ":var1", 318, 1),
            (neg|team_slot_eq, ":var2", ":var1", 1),
            (team_get_slot, ":var9", ":var2", 8),
            (team_get_slot, ":var10", ":var2", 5),
            (store_mul, reg0, ":var9", 100),
            (val_div, reg0, ":var10"),
            (is_between, reg0, 25, 76),
            (assign, ":var11", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_get_slot, reg0, ":var6", 5),
              (val_add, ":var11", reg0),
            (try_end),
            (lt, ":var9", ":var11"),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_skirmish_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (store_add, ":var1", 318, 1),
            (team_slot_eq, ":var2", ":var1", 1),
            (team_get_slot, ":var9", ":var2", 8),
            (assign, ":var11", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_get_slot, reg0, ":var6", 5),
              (val_add, ":var11", reg0),
            (try_end),
            (gt, ":var9", ":var11"),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_skirmish_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var4", "fac_kingdom_1"),
          (eq, ":var4", "fac_kingdom_5"),
          (assign, ":var7", 99999),
          (try_begin),
            (store_add, ":var1", 327, 1),
            (neg|team_slot_ge, ":var2", ":var1", 1),
            (team_get_slot, reg1, ":var2", 8),
            (team_get_slot, ":var10", ":var2", 5),
            (val_mul, reg1, 100),
            (val_div, reg1, ":var10"),
            (gt, reg1, 25),
            (team_get_movement_order, ":var3", ":var2", 1),
            (neq, ":var3", 2),
            (call_script, "script_battlegroup_get_position", 2, ":var2", 1),
            (call_script, "script_get_nearest_enemy_battlegroup_location", 28, ":var2", 2),
            (is_between, reg0, 1000, 7000),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_volley_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (store_add, ":var1", 327, 1),
            (team_slot_ge, ":var2", ":var1", 1),
            (assign, ":var8", 0),
            (try_begin),
              (team_get_movement_order, ":var3", ":var2", 1),
              (eq, ":var3", 2),
              (assign, ":var8", 1),
            (else_try),
              (call_script, "script_battlegroup_get_position", 2, ":var2", 1),
              (call_script, "script_get_nearest_enemy_battlegroup_location", 28, ":var2", 2),
              (neg|is_between, reg0, 1000, 8000),
              (assign, ":var8", 1),
            (try_end),
            (eq, ":var8", 1),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_volley_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 318),
    ],
    [
      (call_script, "script_order_skirmish_skirmish"),
    ]),

    (1, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 327),
    ],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (try_for_range, ":var0", 0, 4),
          (try_for_range, ":var1", 327, 336),
            (team_set_slot, ":var0", ":var1", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var2", 0, 9),
          (store_add, ":var1", 327, ":var2"),
          (team_slot_ge, ":var0", ":var1", 1),
          (team_get_slot, ":var3", ":var0", ":var1"),
          (val_add, ":var3", 1),
          (team_set_slot, ":var0", ":var1", ":var3"),
        (try_end),
      (try_end),
      (try_for_agents, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_is_non_player, ":var4"),
        (agent_slot_ge, ":var4", 37, 1),
        (agent_get_ammo, ":var5", ":var4", 1),
        (gt, ":var5", 0),
        (agent_get_team, ":var0", ":var4"),
        (agent_get_division, ":var2", ":var4"),
        (store_add, ":var1", 327, ":var2"),
        (team_get_slot, ":var3", ":var0", ":var1"),
        (agent_get_slot, ":var6", ":var4", 37),
        (try_begin),
          (eq, ":var6", 8),
          (assign, ":var7", 2),
        (else_try),
          (eq, ":var6", 9),
          (assign, ":var7", 5),
        (try_end),
        (agent_get_combat_state, ":var8", ":var4"),
        (this_or_next|eq, ":var8", 1),
        (eq, ":var8", 3),
        (store_mod, reg0, ":var3", ":var7"),
        (try_begin),
          (eq, reg0, 0),
          (agent_set_attack_action, ":var4", 0, 0),
        (else_try),
          (agent_set_attack_action, ":var4", 0, 1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, "$key_special_1"),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 36),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (0.1, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 336),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_slot_eq, ":var0", 15, 0),
        (agent_slot_ge, ":var0", 35, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (agent_slot_eq, ":var0", 35, ":var1"),
        (agent_get_team, ":var2", ":var0"),
        (agent_get_division, ":var3", ":var0"),
        (team_get_movement_order, ":var4", ":var2", ":var3"),
        (assign, ":var5", 0),
        (try_begin),
          (neq, ":var0", "$fplayer_agent_no"),
          (store_add, ":var6", 336, ":var3"),
          (team_slot_eq, ":var2", ":var6", 1),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 11),
          (assign, ":var5", 1),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (agent_slot_eq, "$fplayer_agent_no", 39, 1),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (agent_get_speed, pos0, ":var0"),
        (position_get_y, ":var7", pos0),
        (position_get_x, ":var8", pos0),
        (val_max, ":var7", ":var8"),
        (eq, ":var7", 0),
        (try_begin),
          (agent_get_animation, ":var9", ":var0"),
          (try_begin),
            (item_slot_eq, ":var1", 67, 1),
            (assign, ":var10", "anim_spearwall_bracing_low"),
          (else_try),
            (assign, ":var10", "anim_spearwall_bracing"),
          (try_end),
          (neq, ":var9", ":var10"),
          (agent_set_animation, ":var0", ":var10"),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
          (agent_get_look_position, pos1, ":var0"),
          (position_get_x, ":var11", pos1),
          (position_get_y, ":var12", pos1),
          (agent_set_slot, ":var0", 1, ":var11"),
          (agent_set_slot, ":var0", 2, ":var12"),
          (agent_set_slot, ":var0", 38, 0),
        (try_end),
        (agent_get_slot, ":var13", ":var0", 38),
        (try_begin),
          (lt, ":var13", 20),
          (val_add, ":var13", 1),
          (agent_set_slot, ":var0", 38, ":var13"),
        (try_end),
        (agent_set_is_alarmed, ":var0", 0),
        (agent_get_slot, ":var11", ":var0", 1),
        (agent_get_slot, ":var12", ":var0", 2),
        (init_position, pos2),
        (position_set_x, pos2, ":var11"),
        (position_set_y, pos2, ":var12"),
        (agent_set_look_target_position, ":var0", pos2),
        (ge, ":var13", 20),
        (item_get_slot, ":var14", ":var1", 62),
        (assign, ":var15", ":var14"),
        (assign, ":var16", -1),
        (assign, ":var17", -1),
        (agent_get_position, pos1, ":var0"),
        (try_for_agents, ":var18"),
          (agent_is_alive, ":var18"),
          (neg|agent_is_human, ":var18"),
          (agent_get_rider, ":var19", ":var18"),
          (ge, ":var19", 0),
          (agent_get_team, ":var20", ":var19"),
          (teams_are_enemies, ":var2", ":var20"),
          (agent_get_position, pos2, ":var18"),
          (get_distance_between_positions, ":var21", pos1, pos2),
          (lt, ":var21", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (get_angle_between_positions, ":var22", pos1, pos2),
          (val_abs, ":var22"),
          (convert_from_fixed_point, ":var22"),
          (is_between, ":var22", 165, 181),
          (agent_get_speed, pos0, ":var18"),
          (position_get_y, ":var7", pos0),
          (position_get_x, ":var8", pos0),
          (val_max, ":var7", ":var8"),
          (ge, ":var7", 300),
          (assign, ":var15", ":var21"),
          (assign, ":var16", ":var18"),
          (assign, ":var17", ":var19"),
        (try_end),
        (gt, ":var16", -1),
        (agent_set_animation, ":var0", "anim_spearwall_bracing_recoil"),
        (agent_set_slot, ":var0", 38, 0),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var23", ":var16", 0),
        (store_agent_hit_points, ":var24", ":var16", 1),
        (val_div, ":var7", 6),
        (val_sub, ":var7", 10),
        (try_begin),
          (item_slot_eq, ":var1", 67, 1),
          (val_add, ":var7", 5),
          (gt, ":var14", 200),
          (val_add, ":var7", 5),
        (try_end),
        (val_sub, ":var23", ":var7"),
        (val_max, ":var23", 0),
        (agent_set_hit_points, ":var16", ":var23", 0),
        (agent_deliver_damage_to_agent, ":var16", ":var16"),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (try_begin),
          (gt, ":var23", 0),
          (store_random_in_range, ":var25", 0, 100),
          (try_begin),
            (item_slot_eq, ":var1", 67, 1),
            (val_sub, ":var25", 10),
            (gt, ":var14", 200),
            (val_sub, ":var25", 10),
          (try_end),
          (lt, ":var25", 50),
          (agent_set_animation, ":var16", "anim_horse_rear"),
        (else_try),
          (le, ":var23", 0),
          (store_random_in_range, ":var25", 40, 75),
          (store_agent_hit_points, ":var26", ":var17", 0),
          (val_min, ":var25", ":var26"),
          (agent_set_hit_points, ":var17", ":var25", 0),
        (try_end),
        (try_begin),
          (agent_get_horse, ":var27", "$fplayer_agent_no"),
          (eq, ":var16", ":var27"),
          (val_sub, ":var24", ":var23"),
          (assign, reg1, ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced spear!", 0xFF4040),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (val_sub, ":var24", ":var23"),
          (assign, reg1, ":var24"),
          (str_store_item_name, s1, ":var1"),
          (display_message, "@Braced {s1} dealt {reg1} damage!"),
          (agent_set_slot, "$fplayer_agent_no", 39, 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, "$key_special_0"),
      (agent_is_alive, "$fplayer_agent_no"),
      (neg|agent_slot_eq, "$fplayer_agent_no", 39, 1),
    ],
    [
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_get_wielded_item, ":var0", "$fplayer_agent_no", 0),
      (assign, ":var1", 0),
      (try_begin),
        (agent_slot_ge, "$fplayer_agent_no", 35, 1),
        (agent_slot_eq, "$fplayer_agent_no", 35, ":var0"),
        (assign, ":var1", 1),
      (else_try),
        (ge, ":var0", 0),
        (item_get_type, ":var2", ":var0"),
        (eq, ":var2", 4),
        (agent_set_slot, "$fplayer_agent_no", 35, ":var0"),
        (assign, ":var1", 1),
      (try_end),
      (eq, ":var1", 1),
      (str_store_item_name, s1, ":var0"),
      (display_message, "@Bracing {s1} for charge.", 0x6495ED),
      (agent_set_slot, "$fplayer_agent_no", 39, 1),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
      (agent_is_alive, "$fplayer_agent_no"),
      (neg|agent_slot_eq, "$fplayer_agent_no", 39, 0),
    ],
    [
      (display_message, "@Releasing from brace.", 0x6495ED),
      (agent_set_animation, "$fplayer_agent_no", "anim_spearwall_bracing_recoil"),
      (agent_set_slot, "$fplayer_agent_no", 39, 0),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (assign, "$rethink_on_formation", 0),
      (assign, "$autorotate_at_player", 1),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 0, 9),
          (store_add, ":var2", 176, ":var1"),
          (team_set_slot, ":var0", ":var2", -1),
          (store_add, ":var2", 239, ":var1"),
          (team_set_slot, ":var0", ":var2", 10),
          (store_add, ":var2", 284, ":var1"),
          (team_set_slot, ":var0", ":var2", -1),
          (store_add, ":var2", 212, ":var1"),
          (team_set_slot, ":var0", ":var2", 1),
        (try_end),
      (try_end),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (call_script, "script_store_battlegroup_data"),
      (store_sub, ":var0", "fac_kingdoms_end", "fac_player_supporters_faction"),
      (store_mul, ":var1", 4, ":var0"),
      (try_for_range, ":var2", 0, ":var1"),
        (team_set_slot, 7, ":var2", 0),
      (try_end),
      (try_for_agents, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_team, ":var4", ":var3"),
        (agent_get_troop_id, ":var5", ":var3"),
        (store_faction_of_troop, ":var6", ":var5"),
        (is_between, ":var6", "fac_player_supporters_faction", "fac_kingdoms_end"),
        (store_mul, ":var2", ":var4", ":var0"),
        (val_sub, ":var6", "fac_player_supporters_faction"),
        (val_add, ":var2", ":var6"),
        (team_get_slot, ":var7", 7, ":var2"),
        (val_add, ":var7", 1),
        (team_set_slot, 7, ":var2", ":var7"),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (team_slot_ge, ":var8", 5, 1),
        (team_get_leader, ":var9", ":var8"),
        (try_begin),
          (ge, ":var9", 0),
          (agent_get_troop_id, ":var10", ":var9"),
          (store_faction_of_troop, ":var11", ":var10"),
        (else_try),
          (assign, ":var11", 0),
          (assign, ":var12", 0),
          (store_mul, ":var13", ":var8", ":var0"),
          (store_add, ":var1", ":var13", ":var0"),
          (try_for_range, ":var2", ":var13", ":var1"),
            (team_get_slot, ":var7", 7, ":var2"),
            (gt, ":var7", ":var12"),
            (assign, ":var12", ":var7"),
            (store_sub, ":var11", ":var13", ":var2"),
            (val_add, ":var11", "fac_player_supporters_faction"),
          (try_end),
        (try_end),
        (team_set_slot, ":var8", 1, ":var11"),
      (try_end),
    ]),

    (0.1, 0, 0, 
    [
      (neq, "$when_f1_first_detected", 0),
      (store_mission_timer_c_msec, reg0),
      (val_sub, reg0, "$when_f1_first_detected"),
      (ge, reg0, 250),
      (party_slot_eq, "p_main_party", 108, 23),
    ],
    [
      (assign, "$when_f1_first_detected", 0),
      (try_begin),
        (game_key_is_down, gk_order_1),
        (party_set_slot, p_camp_bandits, 108, 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, p_camp_bandits, 108, 1),
        (call_script, "script_player_order_formations", 0),
        (party_set_slot, "p_main_party", 108, 0),
        (party_set_slot, p_camp_bandits, 108, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (neg|main_hero_fallen),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (store_mission_timer_c_msec, "$last_player_trigger"),
      (try_begin),
        (try_for_range, ":var0", 0, 4),
          (try_for_range, ":var1", 0, 9),
            (store_add, ":var2", 176, ":var1"),
            (this_or_next|team_slot_eq, ":var0", ":var2", 4),
            (team_slot_eq, ":var0", ":var2", 5),
            (team_set_slot, ":var0", ":var2", -1),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_store_battlegroup_data"),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (assign, ":var3", reg0),
      (try_begin),
        (eq, ":var3", 0),
        (try_for_range, ":var1", 0, 9),
          (call_script, "script_formation_end", "$fplayer_team_no", ":var1"),
        (try_end),
      (try_end),
      (gt, ":var3", 0),
      (call_script, "script_division_reset_places"),
      (try_begin),
        (party_slot_eq, p_camp_bandits, 108, 2),
        (neg|game_key_is_down, gk_order_1),
        (assign, ":var4", 0),
        (try_for_range, ":var1", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var1"),
          (store_add, ":var2", 284, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", -1),
          (store_add, ":var2", 14, ":var1"),
          (team_slot_ge, "$fplayer_team_no", ":var2", 1),
          (store_add, ":var2", 212, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", 1),
          (team_get_order_position, pos1, "$fplayer_team_no", ":var1"),
          (val_add, ":var4", 1),
        (try_end),
        (gt, ":var4", 0),
        (copy_position, 16, 1),
        (assign, ":var5", 1000000),
        (try_for_range, ":var0", 0, 4),
          (teams_are_enemies, ":var0", "$fplayer_team_no"),
          (team_slot_ge, ":var0", 5, 1),
          (try_for_range, ":var1", 0, 9),
            (store_add, ":var2", 14, ":var1"),
            (team_slot_ge, ":var0", ":var2", 1),
            (call_script, "script_battlegroup_get_position", 28, ":var0", ":var1"),
            (get_distance_between_positions, reg0, pos16, pos28),
            (gt, ":var5", reg0),
            (assign, ":var5", reg0),
            (assign, ":var6", ":var0"),
            (assign, ":var7", ":var1"),
          (try_end),
        (try_end),
        (call_script, "script_battlegroup_get_action_radius", ":var6", ":var7"),
        (assign, ":var8", reg0),
        (try_begin),
          (le, ":var5", ":var8"),
          (call_script, "script_battlegroup_get_position", 16, ":var6", ":var7"),
          (gt, ":var4", 1),
          (store_add, ":var2", 176, ":var7"),
          (team_get_slot, reg0, ":var6", ":var2"),
          (call_script, "script_str_store_division_type_name", 1, reg0),
          (display_message, "@...and attack enemy {s1} division!"),
        (try_end),
        (call_script, "script_point_y_toward_position", 16, 24),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var1", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var1"),
          (store_add, ":var2", 14, ":var1"),
          (team_get_slot, ":var9", "$fplayer_team_no", ":var2"),
          (gt, ":var9", 0),
          (try_begin),
            (le, ":var5", ":var8"),
            (store_add, ":var2", 284, ":var1"),
            (team_set_slot, "$fplayer_team_no", ":var2", ":var6"),
            (store_add, ":var2", 293, ":var1"),
            (team_set_slot, "$fplayer_team_no", ":var2", ":var7"),
          (try_end),
          (store_add, ":var2", 185, ":var1"),
          (team_get_slot, ":var10", "$fplayer_team_no", ":var2"),
          (try_begin),
            (gt, ":var4", 1),
            (agent_set_position, "$fplayer_agent_no", pos16),
            (call_script, "script_player_attempt_formation", ":var1", ":var10", 1),
          (else_try),
            (try_begin),
              (le, ":var5", ":var8"),
              (call_script, "script_battlegroup_get_attack_destination", 16, "$fplayer_team_no", ":var1", ":var6", ":var7"),
              (store_add, ":var2", 176, ":var7"),
              (team_get_slot, reg0, ":var6", ":var2"),
              (call_script, "script_str_store_division_type_name", 1, reg0),
              (display_message, "@...and attack enemy {s1} division!"),
            (try_end),
            (neq, ":var10", 0),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var1", 16),
            (store_add, ":var2", 194, ":var1"),
            (team_get_slot, ":var11", "$fplayer_team_no", ":var2"),
            (try_begin),
              (store_add, ":var2", 176, ":var1"),
              (team_get_slot, ":var12", "$fplayer_team_no", ":var2"),
              (neq, ":var12", 2),
              (neq, ":var12", 5),
              (call_script, "script_get_centering_amount", ":var10", ":var9", ":var11"),
              (try_begin),
                (eq, ":var12", 1),
                (val_mul, reg0, -1),
                (assign, ":var13", "script_form_archers"),
              (else_try),
                (assign, ":var13", "script_form_infantry"),
              (try_end),
              (position_move_x, 16, reg0),
            (else_try),
              (assign, ":var13", "script_form_cavalry"),
            (try_end),
            (copy_position, 1, 16),
            (call_script, ":var13", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11", ":var10"),
          (try_end),
          (store_add, ":var2", 203, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", 0),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, p_camp_bandits, 108, 0),
      (try_end),
      (try_begin),
        (gt, "$rethink_on_formation", 0),
        (try_for_agents, ":var14"),
          (agent_force_rethink, ":var14"),
        (try_end),
        (assign, "$rethink_on_formation", 0),
      (try_end),
      (assign, "$autorotate_at_player", 0),
      (try_for_range, ":var1", 0, 9),
        (store_add, ":var2", 14, ":var1"),
        (team_get_slot, ":var9", "$fplayer_team_no", ":var2"),
        (gt, ":var9", 0),
        (store_add, ":var2", 284, ":var1"),
        (team_get_slot, ":var15", "$fplayer_team_no", ":var2"),
        (store_add, ":var2", 293, ":var1"),
        (team_get_slot, ":var16", "$fplayer_team_no", ":var2"),
        (try_begin),
          (ge, ":var15", 0),
          (store_add, ":var2", 14, ":var16"),
          (team_get_slot, reg0, ":var15", ":var2"),
          (le, reg0, 0),
          (store_add, ":var2", 284, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", -1),
          (store_add, ":var2", 176, ":var16"),
          (team_get_slot, reg0, ":var15", ":var2"),
          (call_script, "script_str_store_division_type_name", 1, reg0),
          (str_store_class_name, 2, ":var1"),
          (display_message, "@{s2}: returning after destroying enemy {s1} division."),
          (store_add, ":var2", 203, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", 1),
        (try_end),
        (store_add, ":var2", 212, ":var1"),
        (team_get_slot, ":var17", "$fplayer_team_no", ":var2"),
        (store_mod, ":var18", ":var17", 4),
        (val_add, ":var17", 1),
        (team_set_slot, "$fplayer_team_no", ":var2", ":var17"),
        (try_begin),
          (store_add, ":var2", 203, ":var1"),
          (team_slot_eq, "$fplayer_team_no", ":var2", 1),
          (try_begin),
            (eq, 0, 1),
            (call_script, "script_battlegroup_place_around_leader", "$fplayer_team_no", ":var1"),
          (else_try),
            (call_script, "script_battlegroup_place_at_leader", "$fplayer_team_no", ":var1"),
          (try_end),
          (team_set_slot, "$fplayer_team_no", ":var2", 1),
        (else_try),
          (eq, ":var18", 0),
          (team_get_movement_order, reg0, "$fplayer_team_no", ":var1"),
          (neq, reg0, 11),
          (store_add, ":var2", 185, ":var1"),
          (team_get_slot, ":var10", "$fplayer_team_no", ":var2"),
          (try_begin),
            (neq, ":var10", 0),
            (store_add, ":var2", 194, ":var1"),
            (team_get_slot, ":var11", "$fplayer_team_no", ":var2"),
            (store_add, ":var2", 176, ":var1"),
            (team_get_slot, ":var12", "$fplayer_team_no", ":var2"),
            (try_begin),
              (ge, ":var15", 0),
              (try_begin),
                (this_or_next|eq, ":var12", 1),
                (this_or_next|eq, ":var12", 5),
                (eq, ":var12", 4),
                (store_add, ":var2", 104, ":var1"),
                (team_slot_eq, "$fplayer_team_no", ":var2", 1),
                (call_script, "script_formation_current_position", 1, "$fplayer_team_no", ":var1"),
              (else_try),
                (call_script, "script_battlegroup_get_attack_destination", 1, "$fplayer_team_no", ":var1", ":var15", ":var16"),
              (try_end),
            (else_try),
              (call_script, "script_get_formation_destination", 1, "$fplayer_team_no", ":var1"),
              (try_begin),
                (neq, ":var12", 2),
                (neq, ":var12", 5),
                (position_move_y, pos1, -2000),
              (try_end),
              (call_script, "script_point_y_toward_position", 1, 24),
              (try_begin),
                (neq, ":var12", 2),
                (neq, ":var12", 5),
                (position_move_y, pos1, 2000),
              (try_end),
            (try_end),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var1", 1),
            (try_begin),
              (neq, ":var12", 2),
              (neq, ":var12", 5),
              (call_script, "script_get_centering_amount", ":var10", ":var9", ":var11"),
              (try_begin),
                (eq, ":var12", 1),
                (val_mul, reg0, -1),
              (try_end),
              (position_move_x, 1, reg0),
            (try_end),
            (try_begin),
              (eq, ":var12", 1),
              (call_script, "script_form_archers", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11", ":var10"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (eq, ":var12", 5),
              (try_begin),
                (ge, ":var15", 0),
                (call_script, "script_formation_current_position", 29, "$fplayer_team_no", ":var1"),
                (call_script, "script_battlegroup_get_position", 24, ":var15", ":var16"),
                (get_distance_between_positions, ":var5", pos29, pos24),
                (call_script, "script_battlegroup_get_action_radius", "$fplayer_team_no", ":var1"),
                (assign, ":var19", reg0),
                (call_script, "script_battlegroup_get_action_radius", ":var15", ":var16"),
                (val_add, ":var19", reg0),
                (le, ":var5", ":var19"),
                (call_script, "script_formation_end", "$fplayer_team_no", ":var1"),
                (str_store_class_name, 1, ":var1"),
                (display_message, "@{s1}: cavalry formation disassembled."),
                (set_show_messages, 0),
                (team_give_order, "$fplayer_team_no", ":var1", 2),
                (set_show_messages, 1),
              (else_try),
                (call_script, "script_form_cavalry", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11"),
              (try_end),
            (else_try),
              (call_script, "script_form_infantry", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11", ":var10"),
            (try_end),
            (val_add, "$rethink_on_formation", 1),
          (else_try),
            (ge, ":var15", 0),
            (store_add, ":var2", 293, ":var1"),
            (team_get_slot, ":var16", "$fplayer_team_no", ":var2"),
            (try_begin),
              (this_or_next|eq, ":var12", 1),
              (this_or_next|eq, ":var12", 5),
              (eq, ":var12", 4),
              (store_add, ":var2", 104, ":var1"),
              (team_slot_eq, "$fplayer_team_no", ":var2", 1),
              (call_script, "script_battlegroup_get_position", 1, "$fplayer_team_no", ":var1"),
            (else_try),
              (call_script, "script_battlegroup_get_attack_destination", 1, "$fplayer_team_no", ":var1", ":var15", ":var16"),
            (try_end),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var1", 1),
            (team_get_movement_order, ":var20", "$fplayer_team_no", ":var1"),
            (try_begin),
              (ge, ":var15", 0),
              (call_script, "script_battlegroup_get_position", 29, "$fplayer_team_no", ":var1"),
              (call_script, "script_battlegroup_get_position", 24, ":var15", ":var16"),
              (get_distance_between_positions, ":var5", pos29, pos24),
              (call_script, "script_battlegroup_get_action_radius", "$fplayer_team_no", ":var1"),
              (assign, ":var19", reg0),
              (call_script, "script_battlegroup_get_action_radius", ":var15", ":var16"),
              (val_add, ":var19", reg0),
              (le, ":var5", ":var19"),
              (try_begin),
                (neq, ":var20", 2),
                (set_show_messages, 0),
                (team_give_order, "$fplayer_team_no", ":var1", 2),
                (set_show_messages, 1),
              (try_end),
            (else_try),
              (neq, ":var20", 0),
              (set_show_messages, 0),
              (team_give_order, "$fplayer_team_no", ":var1", 0),
              (set_show_messages, 1),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, "$autorotate_at_player", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_fix_division", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 83, 1),
    ],
    [
      (assign, "$ranged_clock", 1),
      (assign, "$battle_phase", 1),
      (init_position, pos51),
      (init_position, pos53),
      (init_position, pos54),
      (init_position, pos55),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 83, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 15, 0),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var1", 0, 4),
        (call_script, "script_battlegroup_get_position", 0, ":var1", 9),
        (position_get_x, reg0, pos0),
        (team_set_slot, ":var1", 2, reg0),
        (position_get_y, reg0, pos0),
        (team_set_slot, ":var1", 3, reg0),
        (neq, ":var1", "$fplayer_team_no"),
        (store_add, ":var2", 185, 1),
        (team_set_slot, ":var1", ":var2", 0),
      (try_end),
      (call_script, "script_field_tactics", 1),
    ]),

    (0.1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 83, 1),
    ],
    [
      (store_mission_timer_c_msec, reg0),
      (val_sub, reg0, "$last_player_trigger"),
      (ge, reg0, 250),
      (val_add, "$last_player_trigger", 500),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),
      (try_begin),
        (lt, "$battle_phase", 3),
        (call_script, "script_cf_count_casualties"),
        (assign, "$battle_phase", 3),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
      (else_try),
        (eq, "$battle_phase", 1),
        (call_script, "script_field_tactics", 0),
      (else_try),
        (call_script, "script_field_tactics", 1),
        (ge, "$battle_phase", 3),
        (store_mul, reg1, 5, 4),
        (store_mod, reg0, "$ranged_clock", reg1),
        (eq, reg0, 0),
        (try_begin),
          (neg|team_slot_eq, 0, 4, "$defender_reinforcement_stage"),
          (team_set_slot, 0, 4, "$defender_reinforcement_stage"),
          (try_for_range, ":var0", 0, 9),
            (store_add, ":var1", 176, ":var0"),
            (team_set_slot, 0, ":var1", -1),
            (team_set_slot, 2, ":var1", -1),
          (try_end),
        (try_end),
        (try_begin),
          (neg|team_slot_eq, 1, 4, "$attacker_reinforcement_stage"),
          (team_set_slot, 1, 4, "$attacker_reinforcement_stage"),
          (try_for_range, ":var0", 0, 9),
            (store_add, ":var1", 176, ":var0"),
            (team_set_slot, 1, ":var1", -1),
            (team_set_slot, 3, ":var1", -1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 1),
        (assign, ":var2", 0),
        (try_for_range, ":var3", 0, 4),
          (neq, ":var3", "$fplayer_team_no"),
          (team_slot_ge, ":var3", 5, 1),
          (call_script, "script_battlegroup_get_position", 1, ":var3", 1),
          (team_get_order_position, pos0, ":var3", 1),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":var2", 1),
        (try_end),
        (eq, ":var2", 0),
        (assign, "$battle_phase", 2),
      (try_end),
      (val_add, "$ranged_clock", 1),
    ]),

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
      (party_slot_eq, "p_main_party", 83, 1),
      (party_slot_eq, "p_main_party", 86, 2),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (call_script, "script_agent_fix_division", ":var0"),
      (try_end),
      (set_show_messages, 0),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
      (team_give_order, "$fplayer_team_no", 9, 10),
      (team_give_order, "$fplayer_team_no", 9, 13),
      (set_show_messages, 1),
    ]),

  ]),

  ("village_attack_bandits", mtf_battle_mode|mtf_synch_inventory, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_use_exact_number, 0, aif_start_alarmed, 7, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    magic_trigger,

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (0, 0, 3, 
    [
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (item_slot_eq, "$currentbanner", 132, 1),
      (try_begin),
        (eq, "$spell_cast", 1),
        (store_random_in_range, ":var0", 1, 6),
        (try_begin),
          (eq, ":var0", 5),
          (call_script, "script_cf_cancel_magic_effect"),
          (display_message, "@The rune of spellbreaking cancels all magical effects.", 0xFFCC00),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_slot_eq, "trp_player", 225, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_player_missile_light", "itm_phas_protection_ammo"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (item_get_type, ":var7", ":var3"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (item_get_type, ":var8", ":var4"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (item_get_type, ":var9", ":var5"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (item_get_type, ":var10", ":var6"),
        (try_end),
        (try_begin),
          (ge, ":var3", 1),
          (this_or_next|eq, ":var7", 17),
          (this_or_next|eq, ":var7", 16),
          (eq, ":var7", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var3", 0),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (this_or_next|eq, ":var8", 17),
          (this_or_next|eq, ":var8", 16),
          (eq, ":var8", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var4", 1),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (this_or_next|eq, ":var9", 17),
          (this_or_next|eq, ":var9", 16),
          (eq, ":var9", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var5", 2),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (this_or_next|eq, ":var10", 17),
          (this_or_next|eq, ":var10", 16),
          (eq, ":var10", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var6", 3),
        (try_end),
      (else_try),
        (item_get_type, ":var11", ":var1"),
        (this_or_next|eq, ":var11", 17),
        (this_or_next|eq, ":var11", 16),
        (eq, ":var11", 18),
        (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (is_between, ":var3", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (is_between, ":var4", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (is_between, ":var5", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (is_between, ":var6", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (assign, "$g_battle_result", -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (add_reinforcements_to_entry, 1, 6),
      (else_try),
        (add_reinforcements_to_entry, 1, 29),
      (try_end),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (try_begin),
        (party_slot_eq, "p_main_party", 85, 1),
        (assign, ":var0", 0),
        (try_for_agents, ":var1"),
          (agent_is_ally, ":var1"),
          (agent_is_alive, ":var1"),
          (val_add, ":var0", 1),
        (try_end),
        (gt, ":var0", 0),
        (try_begin),
          (neq, "$cam_free", 1),
          (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
          (call_script, "script_cust_cam_init_death_cam", 2),
          (party_slot_eq, "p_main_party", 86, 1),
          (set_show_messages, 0),
          (team_give_order, "$fplayer_team_no", 9, 2),
          (team_set_order_listener, "$fplayer_team_no", 9),
          (call_script, "script_player_order_formations", 2),
          (set_show_messages, 1),
        (try_end),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (set_fixed_point_multiplier, 1),
      (get_scene_boundaries, pos2, pos3),
      (position_get_x, "$g_bound_right", pos2),
      (position_get_y, "$g_bound_top", pos2),
      (position_get_x, "$g_bound_left", pos3),
      (position_get_y, "$g_bound_bottom", pos3),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_weapon_use_classify_agent", ":var0"),
    ]),

    (2, 0, 0, 
    [
      (this_or_next|party_slot_eq, "p_main_party", 78, 1),
      (this_or_next|party_slot_eq, "p_main_party", 79, 1),
      (party_slot_eq, "p_main_party", 80, 1),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_non_player, ":var0"),
        (assign, ":var1", -1),
        (assign, ":var2", -1),
        (assign, ":var3", 0),
        (assign, ":var4", 0),
        (try_begin),
          (agent_get_team, ":var5", ":var0"),
          (eq, ":var5", "$fplayer_team_no"),
          (agent_get_division, ":var6", ":var0"),
          (team_get_weapon_usage_order, ":var3", ":var5", ":var6"),
          (team_get_hold_fire_order, ":var4", ":var5", ":var6"),
          (store_add, ":var7", 300, ":var6"),
          (team_get_slot, ":var1", ":var5", ":var7"),
          (store_add, ":var7", 309, ":var6"),
          (team_get_slot, ":var2", ":var5", ":var7"),
        (try_end),
        (neq, ":var3", 1),
        (eq, ":var1", -1),
        (try_begin),
          (party_slot_eq, "p_main_party", 78, 1),
          (agent_get_slot, ":var8", ":var0", 33),
          (gt, ":var8", 0),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (agent_get_horse, ":var10", ":var0"),
          (try_begin),
            (le, ":var10", 0),
            (agent_set_slot, ":var0", 33, 0),
            (eq, ":var9", ":var8"),
            (try_begin),
              (eq, ":var2", 1),
              (assign, ":var11", 0),
            (else_try),
              (assign, ":var11", 1),
            (try_end),
            (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
          (else_try),
            (agent_get_position, pos1, ":var0"),
            (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var5", 1),
            (assign, ":var12", reg0),
            (try_begin),
              (lt, ":var12", 500),
              (agent_get_combat_state, ":var13", ":var0"),
              (gt, ":var13", 3),
              (eq, ":var9", ":var8"),
              (try_begin),
                (eq, ":var2", 1),
                (assign, ":var11", 0),
              (else_try),
                (assign, ":var11", 1),
              (try_end),
              (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
            (else_try),
              (neq, ":var9", ":var8"),
              (agent_set_wielded_item, ":var0", ":var8"),
            (try_end),
          (try_end),
        (else_try),
          (party_slot_eq, "p_main_party", 79, 1),
          (agent_get_slot, ":var14", ":var0", 34),
          (gt, ":var14", 0),
          (neq, ":var4", 1),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (agent_get_ammo, ":var15", ":var0"),
          (try_begin),
            (le, ":var15", 0),
            (agent_set_slot, ":var0", 34, 0),
            (eq, ":var9", ":var14"),
            (try_begin),
              (eq, ":var2", 1),
              (assign, ":var11", 0),
            (else_try),
              (assign, ":var11", 1),
            (try_end),
            (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
          (else_try),
            (gt, ":var15", 0),
            (agent_get_horse, ":var10", ":var0"),
            (le, ":var10", 0),
          (else_try),
            (gt, ":var15", 0),
            (neq, ":var9", ":var14"),
            (agent_set_wielded_item, ":var0", ":var14"),
          (try_end),
        (else_try),
          (party_slot_eq, "p_main_party", 80, 1),
          (agent_get_slot, ":var16", ":var0", 35),
          (gt, ":var16", 0),
          (store_add, ":var7", 185, ":var6"),
          (team_slot_eq, ":var5", ":var7", 0),
          (neq, ":var2", 1),
          (agent_get_position, pos1, ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var5", 1),
          (assign, ":var12", reg0),
          (assign, ":var17", reg1),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (try_begin),
            (this_or_next|lt, ":var17", 300),
            (lt, ":var12", 700),
            (agent_get_combat_state, ":var13", ":var0"),
            (gt, ":var13", 3),
            (eq, ":var9", ":var16"),
            (call_script, "script_weapon_use_backup_weapon", ":var0", 1),
          (else_try),
            (neq, ":var9", ":var16"),
            (agent_set_wielded_item, ":var0", ":var16"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 81, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (assign, ":var4", ":var2"),
      (try_begin),
        (agent_is_human, ":var0"),
        (try_begin),
          (neg|agent_is_human, ":var1"),
          (eq, ":var3", -1),
          (agent_get_item_id, ":var5", ":var1"),
          (ge, ":var5", 0),
          (gt, ":var4", 5),
          (item_get_slot, ":var6", ":var5", 65),
          (try_begin),
            (lt, ":var6", 18),
            (val_div, ":var6", 3),
            (val_max, ":var2", ":var6"),
          (else_try),
            (is_between, ":var6", 18, 25),
            (val_div, ":var6", 2),
            (val_max, ":var2", ":var6"),
          (else_try),
            (val_max, ":var2", ":var6"),
          (try_end),
          (try_begin),
            (agent_get_speed, pos0, ":var1"),
            (position_get_y, ":var7", pos0),
            (position_get_x, ":var8", pos0),
            (val_max, ":var7", ":var8"),
            (convert_from_fixed_point, ":var7"),
            (gt, ":var7", 6),
            (val_mul, ":var2", 2),
          (try_end),
        (try_end),
      (else_try),
        (neg|agent_is_human, ":var0"),
        (gt, ":var3", 0),
        (item_slot_ge, ":var3", 62, 150),
        (agent_get_horse, ":var5", ":var1"),
        (eq, ":var5", -1),
        (try_begin),
          (agent_get_action_dir, ":var9", ":var1"),
          (eq, ":var9", 0),
          (val_mul, ":var2", 2),
          (val_max, ":var2", 50),
        (else_try),
          (val_mul, ":var2", 3),
          (val_div, ":var2", 2),
          (val_max, ":var2", 30),
        (try_end),
        (val_max, ":var2", ":var4"),
        (agent_get_speed, pos0, ":var0"),
        (position_get_y, ":var7", pos0),
        (position_get_x, ":var8", pos0),
        (val_max, ":var7", ":var8"),
        (convert_from_fixed_point, ":var7"),
        (val_sub, ":var7", 3),
        (val_clamp, ":var7", -2, 4),
        (store_mul, ":var10", ":var7", 10),
        (val_add, ":var2", ":var10"),
        (agent_get_item_id, ":var5", ":var0"),
        (item_get_slot, ":var11", ":var5", 64),
        (val_div, ":var11", 4),
        (val_sub, ":var2", ":var11"),
        (store_random_in_range, ":var12", 0, 100),
        (try_begin),
          (store_div, ":var13", ":var4", 5),
          (val_sub, ":var12", ":var13"),
          (val_sub, ":var12", ":var7"),
          (try_begin),
            (gt, ":var4", 5),
            (eq, ":var9", 0),
            (val_sub, ":var12", 10),
          (try_end),
          (lt, ":var12", 10),
          (agent_set_animation, ":var0", "anim_horse_rear"),
        (try_end),
      (try_end),
      (gt, ":var2", ":var4"),
      (val_sub, ":var2", ":var4"),
      (store_agent_hit_points, ":var14", ":var0", 1),
      (val_sub, ":var14", ":var2"),
      (agent_set_hit_points, ":var0", ":var14", 1),
      (assign, reg2, -1),
      (agent_get_horse, ":var15", "$fplayer_agent_no"),
      (try_begin),
        (try_begin),
          (eq, ":var0", ":var15"),
          (assign, reg2, 0),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (assign, reg2, 1),
        (try_end),
        (neq, reg2, -1),
        (assign, reg1, ":var2"),
        (display_message, "@{reg2?You:Your mount} received {reg1} extra damage!", 0xFF4040),
      (else_try),
        (try_begin),
          (eq, ":var1", ":var15"),
          (assign, reg2, 0),
        (else_try),
          (eq, ":var1", "$fplayer_agent_no"),
          (assign, reg2, 1),
        (try_end),
        (neq, reg2, -1),
        (assign, reg1, ":var2"),
        (display_message, "@{reg2?You strike:Your horse charges} for {reg1} bonus damage!"),
      (try_end),
    ]),

    (ti_on_agent_dismount, 0, 0, 
    [
      (party_get_slot, reg3, "p_main_party", 76),
      (is_between, reg3, 0, 9),
    ],
    [
      (store_trigger_param_2, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (store_trigger_param_1, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_is_non_player, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (eq, ":var2", "$fplayer_team_no"),
        (agent_set_division, ":var1", reg3),
        (agent_set_slot, ":var1", 29, reg3),
      (else_try),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 29, 0),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [
      (party_get_slot, reg3, "p_main_party", 77),
      (is_between, reg3, 0, 9),
    ],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (agent_get_team, ":var5", ":var2"),
      (assign, ":var6", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (this_or_next|eq, ":var5", "$defender_team"),
        (eq, ":var5", "$defender_team_2"),
        (assign, ":var6", 0),
      (try_end),
      (eq, ":var6", 1),
      (try_begin),
        (eq, ":var5", "$fplayer_team_no"),
        (agent_set_division, ":var2", reg3),
        (agent_set_slot, ":var2", 29, reg3),
      (else_try),
        (agent_set_division, ":var2", 0),
        (agent_set_slot, ":var2", 29, 0),
      (try_end),
    ]),

    (2, 0, ti_once, 
    [
      (store_mission_timer_a, reg0),
      (gt, reg0, 2),
    ],
    [
      (set_show_messages, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 0, 9),
          (store_add, ":var2", 176, ":var1"),
          (this_or_next|team_slot_eq, ":var0", ":var2", 2),
          (team_slot_eq, ":var0", ":var2", 5),
          (team_give_order, ":var0", ":var1", 3),
        (try_end),
      (try_end),
      (set_show_messages, 1),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 82, 1),
      (store_mission_timer_a, reg0),
      (gt, reg0, 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 9),
        (store_add, ":var1", 336, ":var0"),
        (neg|team_slot_eq, "$fplayer_team_no", ":var1", 0),
        (call_script, "script_formation_current_position", 2, "$fplayer_team_no", ":var0"),
        (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, "$fplayer_team_no", 2),
        (this_or_next|lt, reg0, 325),
        (position_is_behind_position, pos1, pos2),
        (team_set_order_listener, "$fplayer_team_no", ":var0"),
        (call_script, "script_order_sp_brace_begin_end", 0, "$fplayer_team_no"),
        (team_set_order_listener, "$fplayer_team_no", -1),
      (try_end),
      (try_for_range, ":var2", 0, 4),
        (neq, ":var2", "$fplayer_team_no"),
        (team_slot_ge, ":var2", 5, 1),
        (assign, ":var3", -1),
        (team_get_slot, ":var4", ":var2", 1),
        (this_or_next|eq, ":var4", "fac_deserters"),
        (is_between, ":var4", "fac_player_supporters_faction", "fac_kingdoms_end"),
        (try_begin),
          (this_or_next|eq, ":var4", "fac_player_supporters_faction"),
          (eq, ":var4", "fac_kingdom_5"),
          (try_begin),
            (team_slot_eq, ":var2", 336, 0),
            (store_add, ":var1", 14, 0),
            (team_slot_ge, ":var2", 14, 10),
            (store_add, ":var1", 68, 0),
            (team_slot_ge, ":var2", ":var1", 80),
            (store_add, ":var1", 185, 0),
            (team_get_movement_order, ":var3", ":var2", 0),
            (neg|this_or_next|team_slot_eq, ":var2", ":var1", 0),
            (neq, ":var3", 2),
            (assign, ":var5", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_slot_ge, ":var6", 5, 1),
              (team_get_slot, reg0, ":var6", 9),
              (val_add, ":var5", reg0),
            (try_end),
            (ge, ":var5", 5),
            (assign, ":var7", 99999),
            (call_script, "script_formation_current_position", 2, ":var2", 0),
            (call_script, "script_team_get_position_of_enemies", 1, ":var2", 2),
            (get_distance_between_positions, ":var7", pos1, pos2),
            (is_between, ":var7", 1500, 5000),
            (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, ":var2", 2),
            (gt, reg0, 600),
            (neg|position_is_behind_position, pos1, pos2),
            (team_set_order_listener, ":var2", 0),
            (call_script, "script_order_sp_brace_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (neg|team_slot_eq, ":var2", 336, 0),
            (assign, ":var8", 0),
            (try_begin),
              (assign, ":var5", 0),
              (try_for_range, ":var6", 0, 4),
                (teams_are_enemies, ":var6", ":var2"),
                (team_slot_ge, ":var6", 5, 1),
                (team_get_slot, reg0, ":var6", 9),
                (val_add, ":var5", reg0),
              (try_end),
              (team_get_movement_order, ":var3", ":var2", 0),
              (this_or_next|eq, ":var3", 2),
              (lt, ":var5", 5),
              (assign, ":var8", 1),
            (else_try),
              (store_add, ":var1", 14, 0),
              (neg|team_slot_ge, ":var2", 14, 10),
              (assign, ":var8", 1),
            (else_try),
              (store_add, ":var1", 68, 0),
              (neg|team_slot_ge, ":var2", ":var1", 80),
              (assign, ":var8", 1),
            (else_try),
              (assign, ":var7", 0),
              (call_script, "script_formation_current_position", 2, ":var2", 0),
              (call_script, "script_team_get_position_of_enemies", 1, ":var2", 2),
              (get_distance_between_positions, ":var7", pos1, pos2),
              (gt, ":var7", 6500),
              (assign, ":var8", 1),
            (else_try),
              (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, ":var2", 2),
              (this_or_next|lt, reg0, 350),
              (position_is_behind_position, pos1, pos2),
              (assign, ":var8", 1),
            (try_end),
            (eq, ":var8", 1),
            (team_set_order_listener, ":var2", 0),
            (call_script, "script_order_sp_brace_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (try_end),
        (try_begin),
          (neq, ":var4", "fac_kingdom_1"),
          (neq, ":var4", "fac_kingdom_5"),
          (try_begin),
            (store_add, ":var1", 318, 1),
            (neg|team_slot_eq, ":var2", ":var1", 1),
            (team_get_slot, ":var9", ":var2", 8),
            (team_get_slot, ":var10", ":var2", 5),
            (store_mul, reg0, ":var9", 100),
            (val_div, reg0, ":var10"),
            (is_between, reg0, 25, 76),
            (assign, ":var11", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_get_slot, reg0, ":var6", 5),
              (val_add, ":var11", reg0),
            (try_end),
            (lt, ":var9", ":var11"),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_skirmish_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (store_add, ":var1", 318, 1),
            (team_slot_eq, ":var2", ":var1", 1),
            (team_get_slot, ":var9", ":var2", 8),
            (assign, ":var11", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_get_slot, reg0, ":var6", 5),
              (val_add, ":var11", reg0),
            (try_end),
            (gt, ":var9", ":var11"),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_skirmish_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var4", "fac_kingdom_1"),
          (eq, ":var4", "fac_kingdom_5"),
          (assign, ":var7", 99999),
          (try_begin),
            (store_add, ":var1", 327, 1),
            (neg|team_slot_ge, ":var2", ":var1", 1),
            (team_get_slot, reg1, ":var2", 8),
            (team_get_slot, ":var10", ":var2", 5),
            (val_mul, reg1, 100),
            (val_div, reg1, ":var10"),
            (gt, reg1, 25),
            (team_get_movement_order, ":var3", ":var2", 1),
            (neq, ":var3", 2),
            (call_script, "script_battlegroup_get_position", 2, ":var2", 1),
            (call_script, "script_get_nearest_enemy_battlegroup_location", 28, ":var2", 2),
            (is_between, reg0, 1000, 7000),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_volley_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (store_add, ":var1", 327, 1),
            (team_slot_ge, ":var2", ":var1", 1),
            (assign, ":var8", 0),
            (try_begin),
              (team_get_movement_order, ":var3", ":var2", 1),
              (eq, ":var3", 2),
              (assign, ":var8", 1),
            (else_try),
              (call_script, "script_battlegroup_get_position", 2, ":var2", 1),
              (call_script, "script_get_nearest_enemy_battlegroup_location", 28, ":var2", 2),
              (neg|is_between, reg0, 1000, 8000),
              (assign, ":var8", 1),
            (try_end),
            (eq, ":var8", 1),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_volley_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 318),
    ],
    [
      (call_script, "script_order_skirmish_skirmish"),
    ]),

    (1, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 327),
    ],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (try_for_range, ":var0", 0, 4),
          (try_for_range, ":var1", 327, 336),
            (team_set_slot, ":var0", ":var1", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var2", 0, 9),
          (store_add, ":var1", 327, ":var2"),
          (team_slot_ge, ":var0", ":var1", 1),
          (team_get_slot, ":var3", ":var0", ":var1"),
          (val_add, ":var3", 1),
          (team_set_slot, ":var0", ":var1", ":var3"),
        (try_end),
      (try_end),
      (try_for_agents, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_is_non_player, ":var4"),
        (agent_slot_ge, ":var4", 37, 1),
        (agent_get_ammo, ":var5", ":var4", 1),
        (gt, ":var5", 0),
        (agent_get_team, ":var0", ":var4"),
        (agent_get_division, ":var2", ":var4"),
        (store_add, ":var1", 327, ":var2"),
        (team_get_slot, ":var3", ":var0", ":var1"),
        (agent_get_slot, ":var6", ":var4", 37),
        (try_begin),
          (eq, ":var6", 8),
          (assign, ":var7", 2),
        (else_try),
          (eq, ":var6", 9),
          (assign, ":var7", 5),
        (try_end),
        (agent_get_combat_state, ":var8", ":var4"),
        (this_or_next|eq, ":var8", 1),
        (eq, ":var8", 3),
        (store_mod, reg0, ":var3", ":var7"),
        (try_begin),
          (eq, reg0, 0),
          (agent_set_attack_action, ":var4", 0, 0),
        (else_try),
          (agent_set_attack_action, ":var4", 0, 1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, "$key_special_1"),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 36),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (0.1, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 336),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_slot_eq, ":var0", 15, 0),
        (agent_slot_ge, ":var0", 35, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (agent_slot_eq, ":var0", 35, ":var1"),
        (agent_get_team, ":var2", ":var0"),
        (agent_get_division, ":var3", ":var0"),
        (team_get_movement_order, ":var4", ":var2", ":var3"),
        (assign, ":var5", 0),
        (try_begin),
          (neq, ":var0", "$fplayer_agent_no"),
          (store_add, ":var6", 336, ":var3"),
          (team_slot_eq, ":var2", ":var6", 1),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 11),
          (assign, ":var5", 1),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (agent_slot_eq, "$fplayer_agent_no", 39, 1),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (agent_get_speed, pos0, ":var0"),
        (position_get_y, ":var7", pos0),
        (position_get_x, ":var8", pos0),
        (val_max, ":var7", ":var8"),
        (eq, ":var7", 0),
        (try_begin),
          (agent_get_animation, ":var9", ":var0"),
          (try_begin),
            (item_slot_eq, ":var1", 67, 1),
            (assign, ":var10", "anim_spearwall_bracing_low"),
          (else_try),
            (assign, ":var10", "anim_spearwall_bracing"),
          (try_end),
          (neq, ":var9", ":var10"),
          (agent_set_animation, ":var0", ":var10"),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
          (agent_get_look_position, pos1, ":var0"),
          (position_get_x, ":var11", pos1),
          (position_get_y, ":var12", pos1),
          (agent_set_slot, ":var0", 1, ":var11"),
          (agent_set_slot, ":var0", 2, ":var12"),
          (agent_set_slot, ":var0", 38, 0),
        (try_end),
        (agent_get_slot, ":var13", ":var0", 38),
        (try_begin),
          (lt, ":var13", 20),
          (val_add, ":var13", 1),
          (agent_set_slot, ":var0", 38, ":var13"),
        (try_end),
        (agent_set_is_alarmed, ":var0", 0),
        (agent_get_slot, ":var11", ":var0", 1),
        (agent_get_slot, ":var12", ":var0", 2),
        (init_position, pos2),
        (position_set_x, pos2, ":var11"),
        (position_set_y, pos2, ":var12"),
        (agent_set_look_target_position, ":var0", pos2),
        (ge, ":var13", 20),
        (item_get_slot, ":var14", ":var1", 62),
        (assign, ":var15", ":var14"),
        (assign, ":var16", -1),
        (assign, ":var17", -1),
        (agent_get_position, pos1, ":var0"),
        (try_for_agents, ":var18"),
          (agent_is_alive, ":var18"),
          (neg|agent_is_human, ":var18"),
          (agent_get_rider, ":var19", ":var18"),
          (ge, ":var19", 0),
          (agent_get_team, ":var20", ":var19"),
          (teams_are_enemies, ":var2", ":var20"),
          (agent_get_position, pos2, ":var18"),
          (get_distance_between_positions, ":var21", pos1, pos2),
          (lt, ":var21", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (get_angle_between_positions, ":var22", pos1, pos2),
          (val_abs, ":var22"),
          (convert_from_fixed_point, ":var22"),
          (is_between, ":var22", 165, 181),
          (agent_get_speed, pos0, ":var18"),
          (position_get_y, ":var7", pos0),
          (position_get_x, ":var8", pos0),
          (val_max, ":var7", ":var8"),
          (ge, ":var7", 300),
          (assign, ":var15", ":var21"),
          (assign, ":var16", ":var18"),
          (assign, ":var17", ":var19"),
        (try_end),
        (gt, ":var16", -1),
        (agent_set_animation, ":var0", "anim_spearwall_bracing_recoil"),
        (agent_set_slot, ":var0", 38, 0),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var23", ":var16", 0),
        (store_agent_hit_points, ":var24", ":var16", 1),
        (val_div, ":var7", 6),
        (val_sub, ":var7", 10),
        (try_begin),
          (item_slot_eq, ":var1", 67, 1),
          (val_add, ":var7", 5),
          (gt, ":var14", 200),
          (val_add, ":var7", 5),
        (try_end),
        (val_sub, ":var23", ":var7"),
        (val_max, ":var23", 0),
        (agent_set_hit_points, ":var16", ":var23", 0),
        (agent_deliver_damage_to_agent, ":var16", ":var16"),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (try_begin),
          (gt, ":var23", 0),
          (store_random_in_range, ":var25", 0, 100),
          (try_begin),
            (item_slot_eq, ":var1", 67, 1),
            (val_sub, ":var25", 10),
            (gt, ":var14", 200),
            (val_sub, ":var25", 10),
          (try_end),
          (lt, ":var25", 50),
          (agent_set_animation, ":var16", "anim_horse_rear"),
        (else_try),
          (le, ":var23", 0),
          (store_random_in_range, ":var25", 40, 75),
          (store_agent_hit_points, ":var26", ":var17", 0),
          (val_min, ":var25", ":var26"),
          (agent_set_hit_points, ":var17", ":var25", 0),
        (try_end),
        (try_begin),
          (agent_get_horse, ":var27", "$fplayer_agent_no"),
          (eq, ":var16", ":var27"),
          (val_sub, ":var24", ":var23"),
          (assign, reg1, ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced spear!", 0xFF4040),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (val_sub, ":var24", ":var23"),
          (assign, reg1, ":var24"),
          (str_store_item_name, s1, ":var1"),
          (display_message, "@Braced {s1} dealt {reg1} damage!"),
          (agent_set_slot, "$fplayer_agent_no", 39, 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, "$key_special_0"),
      (agent_is_alive, "$fplayer_agent_no"),
      (neg|agent_slot_eq, "$fplayer_agent_no", 39, 1),
    ],
    [
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_get_wielded_item, ":var0", "$fplayer_agent_no", 0),
      (assign, ":var1", 0),
      (try_begin),
        (agent_slot_ge, "$fplayer_agent_no", 35, 1),
        (agent_slot_eq, "$fplayer_agent_no", 35, ":var0"),
        (assign, ":var1", 1),
      (else_try),
        (ge, ":var0", 0),
        (item_get_type, ":var2", ":var0"),
        (eq, ":var2", 4),
        (agent_set_slot, "$fplayer_agent_no", 35, ":var0"),
        (assign, ":var1", 1),
      (try_end),
      (eq, ":var1", 1),
      (str_store_item_name, s1, ":var0"),
      (display_message, "@Bracing {s1} for charge.", 0x6495ED),
      (agent_set_slot, "$fplayer_agent_no", 39, 1),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
      (agent_is_alive, "$fplayer_agent_no"),
      (neg|agent_slot_eq, "$fplayer_agent_no", 39, 0),
    ],
    [
      (display_message, "@Releasing from brace.", 0x6495ED),
      (agent_set_animation, "$fplayer_agent_no", "anim_spearwall_bracing_recoil"),
      (agent_set_slot, "$fplayer_agent_no", 39, 0),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("menu_event_attack", mtf_battle_mode|mtf_synch_inventory, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_use_exact_number, 0, aif_start_alarmed, 7, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    magic_trigger,

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (0, 0, 3, 
    [
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (item_slot_eq, "$currentbanner", 132, 1),
      (try_begin),
        (eq, "$spell_cast", 1),
        (store_random_in_range, ":var0", 1, 6),
        (try_begin),
          (eq, ":var0", 5),
          (call_script, "script_cf_cancel_magic_effect"),
          (display_message, "@The rune of spellbreaking cancels all magical effects.", 0xFFCC00),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_slot_eq, "trp_player", 225, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_player_missile_light", "itm_phas_protection_ammo"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (item_get_type, ":var7", ":var3"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (item_get_type, ":var8", ":var4"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (item_get_type, ":var9", ":var5"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (item_get_type, ":var10", ":var6"),
        (try_end),
        (try_begin),
          (ge, ":var3", 1),
          (this_or_next|eq, ":var7", 17),
          (this_or_next|eq, ":var7", 16),
          (eq, ":var7", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var3", 0),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (this_or_next|eq, ":var8", 17),
          (this_or_next|eq, ":var8", 16),
          (eq, ":var8", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var4", 1),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (this_or_next|eq, ":var9", 17),
          (this_or_next|eq, ":var9", 16),
          (eq, ":var9", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var5", 2),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (this_or_next|eq, ":var10", 17),
          (this_or_next|eq, ":var10", 16),
          (eq, ":var10", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var6", 3),
        (try_end),
      (else_try),
        (item_get_type, ":var11", ":var1"),
        (this_or_next|eq, ":var11", 17),
        (this_or_next|eq, ":var11", 16),
        (eq, ":var11", 18),
        (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (is_between, ":var3", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (is_between, ":var4", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (is_between, ":var5", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (is_between, ":var6", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (add_reinforcements_to_entry, 1, 6),
      (else_try),
        (add_reinforcements_to_entry, 1, 29),
      (try_end),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, 3, 
    [
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (item_slot_eq, "$currentbanner", 132, 1),
      (try_begin),
        (eq, "$spell_cast", 1),
        (store_random_in_range, ":var0", 1, 6),
        (try_begin),
          (eq, ":var0", 5),
          (call_script, "script_cf_cancel_magic_effect"),
          (display_message, "@The rune of spellbreaking cancels all magical effects.", 0xFFCC00),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (neq, "$g_mt_mode", 3),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("village_raid", mtf_battle_mode|mtf_synch_inventory, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 12, []),
    (3, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 0, []),
    (1, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 12, []),
    (1, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 0, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    magic_trigger,

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (0, 0, 3, 
    [
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (item_slot_eq, "$currentbanner", 132, 1),
      (try_begin),
        (eq, "$spell_cast", 1),
        (store_random_in_range, ":var0", 1, 6),
        (try_begin),
          (eq, ":var0", 5),
          (call_script, "script_cf_cancel_magic_effect"),
          (display_message, "@The rune of spellbreaking cancels all magical effects.", 0xFFCC00),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_slot_eq, "trp_player", 225, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_player_missile_light", "itm_phas_protection_ammo"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (item_get_type, ":var7", ":var3"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (item_get_type, ":var8", ":var4"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (item_get_type, ":var9", ":var5"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (item_get_type, ":var10", ":var6"),
        (try_end),
        (try_begin),
          (ge, ":var3", 1),
          (this_or_next|eq, ":var7", 17),
          (this_or_next|eq, ":var7", 16),
          (eq, ":var7", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var3", 0),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (this_or_next|eq, ":var8", 17),
          (this_or_next|eq, ":var8", 16),
          (eq, ":var8", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var4", 1),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (this_or_next|eq, ":var9", 17),
          (this_or_next|eq, ":var9", 16),
          (eq, ":var9", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var5", 2),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (this_or_next|eq, ":var10", 17),
          (this_or_next|eq, ":var10", 16),
          (eq, ":var10", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var6", 3),
        (try_end),
      (else_try),
        (item_get_type, ":var11", ":var1"),
        (this_or_next|eq, ":var11", 17),
        (this_or_next|eq, ":var11", 16),
        (eq, ":var11", 18),
        (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (is_between, ":var3", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (is_between, ":var4", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (is_between, ":var5", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (is_between, ":var6", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$defender_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 0, 6),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 3, 6),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 20, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$g_village_raid_evil", 0),
        (call_script, "script_play_victorious_sound"),
      (else_try),
        (play_track, "track_victorious_evil", 1),
      (try_end),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (try_begin),
        (party_slot_eq, "p_main_party", 85, 1),
        (assign, ":var0", 0),
        (try_for_agents, ":var1"),
          (agent_is_ally, ":var1"),
          (agent_is_alive, ":var1"),
          (val_add, ":var0", 1),
        (try_end),
        (gt, ":var0", 0),
        (try_begin),
          (neq, "$cam_free", 1),
          (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
          (call_script, "script_cust_cam_init_death_cam", 2),
          (party_slot_eq, "p_main_party", 86, 1),
          (set_show_messages, 0),
          (team_give_order, "$fplayer_team_no", 9, 2),
          (team_set_order_listener, "$fplayer_team_no", 9),
          (call_script, "script_player_order_formations", 2),
          (set_show_messages, 1),
        (try_end),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (set_fixed_point_multiplier, 1),
      (get_scene_boundaries, pos2, pos3),
      (position_get_x, "$g_bound_right", pos2),
      (position_get_y, "$g_bound_top", pos2),
      (position_get_x, "$g_bound_left", pos3),
      (position_get_y, "$g_bound_bottom", pos3),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_weapon_use_classify_agent", ":var0"),
    ]),

    (2, 0, 0, 
    [
      (this_or_next|party_slot_eq, "p_main_party", 78, 1),
      (this_or_next|party_slot_eq, "p_main_party", 79, 1),
      (party_slot_eq, "p_main_party", 80, 1),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_non_player, ":var0"),
        (assign, ":var1", -1),
        (assign, ":var2", -1),
        (assign, ":var3", 0),
        (assign, ":var4", 0),
        (try_begin),
          (agent_get_team, ":var5", ":var0"),
          (eq, ":var5", "$fplayer_team_no"),
          (agent_get_division, ":var6", ":var0"),
          (team_get_weapon_usage_order, ":var3", ":var5", ":var6"),
          (team_get_hold_fire_order, ":var4", ":var5", ":var6"),
          (store_add, ":var7", 300, ":var6"),
          (team_get_slot, ":var1", ":var5", ":var7"),
          (store_add, ":var7", 309, ":var6"),
          (team_get_slot, ":var2", ":var5", ":var7"),
        (try_end),
        (neq, ":var3", 1),
        (eq, ":var1", -1),
        (try_begin),
          (party_slot_eq, "p_main_party", 78, 1),
          (agent_get_slot, ":var8", ":var0", 33),
          (gt, ":var8", 0),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (agent_get_horse, ":var10", ":var0"),
          (try_begin),
            (le, ":var10", 0),
            (agent_set_slot, ":var0", 33, 0),
            (eq, ":var9", ":var8"),
            (try_begin),
              (eq, ":var2", 1),
              (assign, ":var11", 0),
            (else_try),
              (assign, ":var11", 1),
            (try_end),
            (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
          (else_try),
            (agent_get_position, pos1, ":var0"),
            (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var5", 1),
            (assign, ":var12", reg0),
            (try_begin),
              (lt, ":var12", 500),
              (agent_get_combat_state, ":var13", ":var0"),
              (gt, ":var13", 3),
              (eq, ":var9", ":var8"),
              (try_begin),
                (eq, ":var2", 1),
                (assign, ":var11", 0),
              (else_try),
                (assign, ":var11", 1),
              (try_end),
              (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
            (else_try),
              (neq, ":var9", ":var8"),
              (agent_set_wielded_item, ":var0", ":var8"),
            (try_end),
          (try_end),
        (else_try),
          (party_slot_eq, "p_main_party", 79, 1),
          (agent_get_slot, ":var14", ":var0", 34),
          (gt, ":var14", 0),
          (neq, ":var4", 1),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (agent_get_ammo, ":var15", ":var0"),
          (try_begin),
            (le, ":var15", 0),
            (agent_set_slot, ":var0", 34, 0),
            (eq, ":var9", ":var14"),
            (try_begin),
              (eq, ":var2", 1),
              (assign, ":var11", 0),
            (else_try),
              (assign, ":var11", 1),
            (try_end),
            (call_script, "script_weapon_use_backup_weapon", ":var0", ":var11"),
          (else_try),
            (gt, ":var15", 0),
            (agent_get_horse, ":var10", ":var0"),
            (le, ":var10", 0),
          (else_try),
            (gt, ":var15", 0),
            (neq, ":var9", ":var14"),
            (agent_set_wielded_item, ":var0", ":var14"),
          (try_end),
        (else_try),
          (party_slot_eq, "p_main_party", 80, 1),
          (agent_get_slot, ":var16", ":var0", 35),
          (gt, ":var16", 0),
          (store_add, ":var7", 185, ":var6"),
          (team_slot_eq, ":var5", ":var7", 0),
          (neq, ":var2", 1),
          (agent_get_position, pos1, ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var5", 1),
          (assign, ":var12", reg0),
          (assign, ":var17", reg1),
          (agent_get_wielded_item, ":var9", ":var0", 0),
          (try_begin),
            (this_or_next|lt, ":var17", 300),
            (lt, ":var12", 700),
            (agent_get_combat_state, ":var13", ":var0"),
            (gt, ":var13", 3),
            (eq, ":var9", ":var16"),
            (call_script, "script_weapon_use_backup_weapon", ":var0", 1),
          (else_try),
            (neq, ":var9", ":var16"),
            (agent_set_wielded_item, ":var0", ":var16"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 81, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (assign, ":var4", ":var2"),
      (try_begin),
        (agent_is_human, ":var0"),
        (try_begin),
          (neg|agent_is_human, ":var1"),
          (eq, ":var3", -1),
          (agent_get_item_id, ":var5", ":var1"),
          (ge, ":var5", 0),
          (gt, ":var4", 5),
          (item_get_slot, ":var6", ":var5", 65),
          (try_begin),
            (lt, ":var6", 18),
            (val_div, ":var6", 3),
            (val_max, ":var2", ":var6"),
          (else_try),
            (is_between, ":var6", 18, 25),
            (val_div, ":var6", 2),
            (val_max, ":var2", ":var6"),
          (else_try),
            (val_max, ":var2", ":var6"),
          (try_end),
          (try_begin),
            (agent_get_speed, pos0, ":var1"),
            (position_get_y, ":var7", pos0),
            (position_get_x, ":var8", pos0),
            (val_max, ":var7", ":var8"),
            (convert_from_fixed_point, ":var7"),
            (gt, ":var7", 6),
            (val_mul, ":var2", 2),
          (try_end),
        (try_end),
      (else_try),
        (neg|agent_is_human, ":var0"),
        (gt, ":var3", 0),
        (item_slot_ge, ":var3", 62, 150),
        (agent_get_horse, ":var5", ":var1"),
        (eq, ":var5", -1),
        (try_begin),
          (agent_get_action_dir, ":var9", ":var1"),
          (eq, ":var9", 0),
          (val_mul, ":var2", 2),
          (val_max, ":var2", 50),
        (else_try),
          (val_mul, ":var2", 3),
          (val_div, ":var2", 2),
          (val_max, ":var2", 30),
        (try_end),
        (val_max, ":var2", ":var4"),
        (agent_get_speed, pos0, ":var0"),
        (position_get_y, ":var7", pos0),
        (position_get_x, ":var8", pos0),
        (val_max, ":var7", ":var8"),
        (convert_from_fixed_point, ":var7"),
        (val_sub, ":var7", 3),
        (val_clamp, ":var7", -2, 4),
        (store_mul, ":var10", ":var7", 10),
        (val_add, ":var2", ":var10"),
        (agent_get_item_id, ":var5", ":var0"),
        (item_get_slot, ":var11", ":var5", 64),
        (val_div, ":var11", 4),
        (val_sub, ":var2", ":var11"),
        (store_random_in_range, ":var12", 0, 100),
        (try_begin),
          (store_div, ":var13", ":var4", 5),
          (val_sub, ":var12", ":var13"),
          (val_sub, ":var12", ":var7"),
          (try_begin),
            (gt, ":var4", 5),
            (eq, ":var9", 0),
            (val_sub, ":var12", 10),
          (try_end),
          (lt, ":var12", 10),
          (agent_set_animation, ":var0", "anim_horse_rear"),
        (try_end),
      (try_end),
      (gt, ":var2", ":var4"),
      (val_sub, ":var2", ":var4"),
      (store_agent_hit_points, ":var14", ":var0", 1),
      (val_sub, ":var14", ":var2"),
      (agent_set_hit_points, ":var0", ":var14", 1),
      (assign, reg2, -1),
      (agent_get_horse, ":var15", "$fplayer_agent_no"),
      (try_begin),
        (try_begin),
          (eq, ":var0", ":var15"),
          (assign, reg2, 0),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (assign, reg2, 1),
        (try_end),
        (neq, reg2, -1),
        (assign, reg1, ":var2"),
        (display_message, "@{reg2?You:Your mount} received {reg1} extra damage!", 0xFF4040),
      (else_try),
        (try_begin),
          (eq, ":var1", ":var15"),
          (assign, reg2, 0),
        (else_try),
          (eq, ":var1", "$fplayer_agent_no"),
          (assign, reg2, 1),
        (try_end),
        (neq, reg2, -1),
        (assign, reg1, ":var2"),
        (display_message, "@{reg2?You strike:Your horse charges} for {reg1} bonus damage!"),
      (try_end),
    ]),

    (ti_on_agent_dismount, 0, 0, 
    [
      (party_get_slot, reg3, "p_main_party", 76),
      (is_between, reg3, 0, 9),
    ],
    [
      (store_trigger_param_2, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (store_trigger_param_1, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_is_non_player, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (eq, ":var2", "$fplayer_team_no"),
        (agent_set_division, ":var1", reg3),
        (agent_set_slot, ":var1", 29, reg3),
      (else_try),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 29, 0),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [
      (party_get_slot, reg3, "p_main_party", 77),
      (is_between, reg3, 0, 9),
    ],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (agent_get_team, ":var5", ":var2"),
      (assign, ":var6", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (this_or_next|eq, ":var5", "$defender_team"),
        (eq, ":var5", "$defender_team_2"),
        (assign, ":var6", 0),
      (try_end),
      (eq, ":var6", 1),
      (try_begin),
        (eq, ":var5", "$fplayer_team_no"),
        (agent_set_division, ":var2", reg3),
        (agent_set_slot, ":var2", 29, reg3),
      (else_try),
        (agent_set_division, ":var2", 0),
        (agent_set_slot, ":var2", 29, 0),
      (try_end),
    ]),

    (2, 0, ti_once, 
    [
      (store_mission_timer_a, reg0),
      (gt, reg0, 2),
    ],
    [
      (set_show_messages, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 0, 9),
          (store_add, ":var2", 176, ":var1"),
          (this_or_next|team_slot_eq, ":var0", ":var2", 2),
          (team_slot_eq, ":var0", ":var2", 5),
          (team_give_order, ":var0", ":var1", 3),
        (try_end),
      (try_end),
      (set_show_messages, 1),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 82, 1),
      (store_mission_timer_a, reg0),
      (gt, reg0, 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 9),
        (store_add, ":var1", 336, ":var0"),
        (neg|team_slot_eq, "$fplayer_team_no", ":var1", 0),
        (call_script, "script_formation_current_position", 2, "$fplayer_team_no", ":var0"),
        (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, "$fplayer_team_no", 2),
        (this_or_next|lt, reg0, 325),
        (position_is_behind_position, pos1, pos2),
        (team_set_order_listener, "$fplayer_team_no", ":var0"),
        (call_script, "script_order_sp_brace_begin_end", 0, "$fplayer_team_no"),
        (team_set_order_listener, "$fplayer_team_no", -1),
      (try_end),
      (try_for_range, ":var2", 0, 4),
        (neq, ":var2", "$fplayer_team_no"),
        (team_slot_ge, ":var2", 5, 1),
        (assign, ":var3", -1),
        (team_get_slot, ":var4", ":var2", 1),
        (this_or_next|eq, ":var4", "fac_deserters"),
        (is_between, ":var4", "fac_player_supporters_faction", "fac_kingdoms_end"),
        (try_begin),
          (this_or_next|eq, ":var4", "fac_player_supporters_faction"),
          (eq, ":var4", "fac_kingdom_5"),
          (try_begin),
            (team_slot_eq, ":var2", 336, 0),
            (store_add, ":var1", 14, 0),
            (team_slot_ge, ":var2", 14, 10),
            (store_add, ":var1", 68, 0),
            (team_slot_ge, ":var2", ":var1", 80),
            (store_add, ":var1", 185, 0),
            (team_get_movement_order, ":var3", ":var2", 0),
            (neg|this_or_next|team_slot_eq, ":var2", ":var1", 0),
            (neq, ":var3", 2),
            (assign, ":var5", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_slot_ge, ":var6", 5, 1),
              (team_get_slot, reg0, ":var6", 9),
              (val_add, ":var5", reg0),
            (try_end),
            (ge, ":var5", 5),
            (assign, ":var7", 99999),
            (call_script, "script_formation_current_position", 2, ":var2", 0),
            (call_script, "script_team_get_position_of_enemies", 1, ":var2", 2),
            (get_distance_between_positions, ":var7", pos1, pos2),
            (is_between, ":var7", 1500, 5000),
            (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, ":var2", 2),
            (gt, reg0, 600),
            (neg|position_is_behind_position, pos1, pos2),
            (team_set_order_listener, ":var2", 0),
            (call_script, "script_order_sp_brace_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (neg|team_slot_eq, ":var2", 336, 0),
            (assign, ":var8", 0),
            (try_begin),
              (assign, ":var5", 0),
              (try_for_range, ":var6", 0, 4),
                (teams_are_enemies, ":var6", ":var2"),
                (team_slot_ge, ":var6", 5, 1),
                (team_get_slot, reg0, ":var6", 9),
                (val_add, ":var5", reg0),
              (try_end),
              (team_get_movement_order, ":var3", ":var2", 0),
              (this_or_next|eq, ":var3", 2),
              (lt, ":var5", 5),
              (assign, ":var8", 1),
            (else_try),
              (store_add, ":var1", 14, 0),
              (neg|team_slot_ge, ":var2", 14, 10),
              (assign, ":var8", 1),
            (else_try),
              (store_add, ":var1", 68, 0),
              (neg|team_slot_ge, ":var2", ":var1", 80),
              (assign, ":var8", 1),
            (else_try),
              (assign, ":var7", 0),
              (call_script, "script_formation_current_position", 2, ":var2", 0),
              (call_script, "script_team_get_position_of_enemies", 1, ":var2", 2),
              (get_distance_between_positions, ":var7", pos1, pos2),
              (gt, ":var7", 6500),
              (assign, ":var8", 1),
            (else_try),
              (call_script, "script_get_nearest_enemy_battlegroup_current_position", 1, ":var2", 2),
              (this_or_next|lt, reg0, 350),
              (position_is_behind_position, pos1, pos2),
              (assign, ":var8", 1),
            (try_end),
            (eq, ":var8", 1),
            (team_set_order_listener, ":var2", 0),
            (call_script, "script_order_sp_brace_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (try_end),
        (try_begin),
          (neq, ":var4", "fac_kingdom_1"),
          (neq, ":var4", "fac_kingdom_5"),
          (try_begin),
            (store_add, ":var1", 318, 1),
            (neg|team_slot_eq, ":var2", ":var1", 1),
            (team_get_slot, ":var9", ":var2", 8),
            (team_get_slot, ":var10", ":var2", 5),
            (store_mul, reg0, ":var9", 100),
            (val_div, reg0, ":var10"),
            (is_between, reg0, 25, 76),
            (assign, ":var11", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_get_slot, reg0, ":var6", 5),
              (val_add, ":var11", reg0),
            (try_end),
            (lt, ":var9", ":var11"),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_skirmish_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (store_add, ":var1", 318, 1),
            (team_slot_eq, ":var2", ":var1", 1),
            (team_get_slot, ":var9", ":var2", 8),
            (assign, ":var11", 0),
            (try_for_range, ":var6", 0, 4),
              (teams_are_enemies, ":var6", ":var2"),
              (team_get_slot, reg0, ":var6", 5),
              (val_add, ":var11", reg0),
            (try_end),
            (gt, ":var9", ":var11"),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_skirmish_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var4", "fac_kingdom_1"),
          (eq, ":var4", "fac_kingdom_5"),
          (assign, ":var7", 99999),
          (try_begin),
            (store_add, ":var1", 327, 1),
            (neg|team_slot_ge, ":var2", ":var1", 1),
            (team_get_slot, reg1, ":var2", 8),
            (team_get_slot, ":var10", ":var2", 5),
            (val_mul, reg1, 100),
            (val_div, reg1, ":var10"),
            (gt, reg1, 25),
            (team_get_movement_order, ":var3", ":var2", 1),
            (neq, ":var3", 2),
            (call_script, "script_battlegroup_get_position", 2, ":var2", 1),
            (call_script, "script_get_nearest_enemy_battlegroup_location", 28, ":var2", 2),
            (is_between, reg0, 1000, 7000),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_volley_begin_end", 1, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (else_try),
            (store_add, ":var1", 327, 1),
            (team_slot_ge, ":var2", ":var1", 1),
            (assign, ":var8", 0),
            (try_begin),
              (team_get_movement_order, ":var3", ":var2", 1),
              (eq, ":var3", 2),
              (assign, ":var8", 1),
            (else_try),
              (call_script, "script_battlegroup_get_position", 2, ":var2", 1),
              (call_script, "script_get_nearest_enemy_battlegroup_location", 28, ":var2", 2),
              (neg|is_between, reg0, 1000, 8000),
              (assign, ":var8", 1),
            (try_end),
            (eq, ":var8", 1),
            (team_set_order_listener, ":var2", 1),
            (call_script, "script_order_volley_begin_end", 0, ":var2"),
            (team_set_order_listener, ":var2", -1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 318),
    ],
    [
      (call_script, "script_order_skirmish_skirmish"),
    ]),

    (1, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 327),
    ],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (try_for_range, ":var0", 0, 4),
          (try_for_range, ":var1", 327, 336),
            (team_set_slot, ":var0", ":var1", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var2", 0, 9),
          (store_add, ":var1", 327, ":var2"),
          (team_slot_ge, ":var0", ":var1", 1),
          (team_get_slot, ":var3", ":var0", ":var1"),
          (val_add, ":var3", 1),
          (team_set_slot, ":var0", ":var1", ":var3"),
        (try_end),
      (try_end),
      (try_for_agents, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_is_non_player, ":var4"),
        (agent_slot_ge, ":var4", 37, 1),
        (agent_get_ammo, ":var5", ":var4", 1),
        (gt, ":var5", 0),
        (agent_get_team, ":var0", ":var4"),
        (agent_get_division, ":var2", ":var4"),
        (store_add, ":var1", 327, ":var2"),
        (team_get_slot, ":var3", ":var0", ":var1"),
        (agent_get_slot, ":var6", ":var4", 37),
        (try_begin),
          (eq, ":var6", 8),
          (assign, ":var7", 2),
        (else_try),
          (eq, ":var6", 9),
          (assign, ":var7", 5),
        (try_end),
        (agent_get_combat_state, ":var8", ":var4"),
        (this_or_next|eq, ":var8", 1),
        (eq, ":var8", 3),
        (store_mod, reg0, ":var3", ":var7"),
        (try_begin),
          (eq, reg0, 0),
          (agent_set_attack_action, ":var4", 0, 0),
        (else_try),
          (agent_set_attack_action, ":var4", 0, 1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, "$key_special_1"),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 36),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (0.1, 0, 0, 
    [
      (call_script, "script_cf_order_active_check", 336),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_slot_eq, ":var0", 15, 0),
        (agent_slot_ge, ":var0", 35, 1),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (agent_slot_eq, ":var0", 35, ":var1"),
        (agent_get_team, ":var2", ":var0"),
        (agent_get_division, ":var3", ":var0"),
        (team_get_movement_order, ":var4", ":var2", ":var3"),
        (assign, ":var5", 0),
        (try_begin),
          (neq, ":var0", "$fplayer_agent_no"),
          (store_add, ":var6", 336, ":var3"),
          (team_slot_eq, ":var2", ":var6", 1),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 11),
          (assign, ":var5", 1),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (agent_slot_eq, "$fplayer_agent_no", 39, 1),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (agent_get_speed, pos0, ":var0"),
        (position_get_y, ":var7", pos0),
        (position_get_x, ":var8", pos0),
        (val_max, ":var7", ":var8"),
        (eq, ":var7", 0),
        (try_begin),
          (agent_get_animation, ":var9", ":var0"),
          (try_begin),
            (item_slot_eq, ":var1", 67, 1),
            (assign, ":var10", "anim_spearwall_bracing_low"),
          (else_try),
            (assign, ":var10", "anim_spearwall_bracing"),
          (try_end),
          (neq, ":var9", ":var10"),
          (agent_set_animation, ":var0", ":var10"),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
          (agent_get_look_position, pos1, ":var0"),
          (position_get_x, ":var11", pos1),
          (position_get_y, ":var12", pos1),
          (agent_set_slot, ":var0", 1, ":var11"),
          (agent_set_slot, ":var0", 2, ":var12"),
          (agent_set_slot, ":var0", 38, 0),
        (try_end),
        (agent_get_slot, ":var13", ":var0", 38),
        (try_begin),
          (lt, ":var13", 20),
          (val_add, ":var13", 1),
          (agent_set_slot, ":var0", 38, ":var13"),
        (try_end),
        (agent_set_is_alarmed, ":var0", 0),
        (agent_get_slot, ":var11", ":var0", 1),
        (agent_get_slot, ":var12", ":var0", 2),
        (init_position, pos2),
        (position_set_x, pos2, ":var11"),
        (position_set_y, pos2, ":var12"),
        (agent_set_look_target_position, ":var0", pos2),
        (ge, ":var13", 20),
        (item_get_slot, ":var14", ":var1", 62),
        (assign, ":var15", ":var14"),
        (assign, ":var16", -1),
        (assign, ":var17", -1),
        (agent_get_position, pos1, ":var0"),
        (try_for_agents, ":var18"),
          (agent_is_alive, ":var18"),
          (neg|agent_is_human, ":var18"),
          (agent_get_rider, ":var19", ":var18"),
          (ge, ":var19", 0),
          (agent_get_team, ":var20", ":var19"),
          (teams_are_enemies, ":var2", ":var20"),
          (agent_get_position, pos2, ":var18"),
          (get_distance_between_positions, ":var21", pos1, pos2),
          (lt, ":var21", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (get_angle_between_positions, ":var22", pos1, pos2),
          (val_abs, ":var22"),
          (convert_from_fixed_point, ":var22"),
          (is_between, ":var22", 165, 181),
          (agent_get_speed, pos0, ":var18"),
          (position_get_y, ":var7", pos0),
          (position_get_x, ":var8", pos0),
          (val_max, ":var7", ":var8"),
          (ge, ":var7", 300),
          (assign, ":var15", ":var21"),
          (assign, ":var16", ":var18"),
          (assign, ":var17", ":var19"),
        (try_end),
        (gt, ":var16", -1),
        (agent_set_animation, ":var0", "anim_spearwall_bracing_recoil"),
        (agent_set_slot, ":var0", 38, 0),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var23", ":var16", 0),
        (store_agent_hit_points, ":var24", ":var16", 1),
        (val_div, ":var7", 6),
        (val_sub, ":var7", 10),
        (try_begin),
          (item_slot_eq, ":var1", 67, 1),
          (val_add, ":var7", 5),
          (gt, ":var14", 200),
          (val_add, ":var7", 5),
        (try_end),
        (val_sub, ":var23", ":var7"),
        (val_max, ":var23", 0),
        (agent_set_hit_points, ":var16", ":var23", 0),
        (agent_deliver_damage_to_agent, ":var16", ":var16"),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (try_begin),
          (gt, ":var23", 0),
          (store_random_in_range, ":var25", 0, 100),
          (try_begin),
            (item_slot_eq, ":var1", 67, 1),
            (val_sub, ":var25", 10),
            (gt, ":var14", 200),
            (val_sub, ":var25", 10),
          (try_end),
          (lt, ":var25", 50),
          (agent_set_animation, ":var16", "anim_horse_rear"),
        (else_try),
          (le, ":var23", 0),
          (store_random_in_range, ":var25", 40, 75),
          (store_agent_hit_points, ":var26", ":var17", 0),
          (val_min, ":var25", ":var26"),
          (agent_set_hit_points, ":var17", ":var25", 0),
        (try_end),
        (try_begin),
          (agent_get_horse, ":var27", "$fplayer_agent_no"),
          (eq, ":var16", ":var27"),
          (val_sub, ":var24", ":var23"),
          (assign, reg1, ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced spear!", 0xFF4040),
        (else_try),
          (eq, ":var0", "$fplayer_agent_no"),
          (val_sub, ":var24", ":var23"),
          (assign, reg1, ":var24"),
          (str_store_item_name, s1, ":var1"),
          (display_message, "@Braced {s1} dealt {reg1} damage!"),
          (agent_set_slot, "$fplayer_agent_no", 39, 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, "$key_special_0"),
      (agent_is_alive, "$fplayer_agent_no"),
      (neg|agent_slot_eq, "$fplayer_agent_no", 39, 1),
    ],
    [
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_get_wielded_item, ":var0", "$fplayer_agent_no", 0),
      (assign, ":var1", 0),
      (try_begin),
        (agent_slot_ge, "$fplayer_agent_no", 35, 1),
        (agent_slot_eq, "$fplayer_agent_no", 35, ":var0"),
        (assign, ":var1", 1),
      (else_try),
        (ge, ":var0", 0),
        (item_get_type, ":var2", ":var0"),
        (eq, ":var2", 4),
        (agent_set_slot, "$fplayer_agent_no", 35, ":var0"),
        (assign, ":var1", 1),
      (try_end),
      (eq, ":var1", 1),
      (str_store_item_name, s1, ":var0"),
      (display_message, "@Bracing {s1} for charge.", 0x6495ED),
      (agent_set_slot, "$fplayer_agent_no", 39, 1),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
      (agent_is_alive, "$fplayer_agent_no"),
      (neg|agent_slot_eq, "$fplayer_agent_no", 39, 0),
    ],
    [
      (display_message, "@Releasing from brace.", 0x6495ED),
      (agent_set_animation, "$fplayer_agent_no", "anim_spearwall_bracing_recoil"),
      (agent_set_slot, "$fplayer_agent_no", 39, 0),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("besiege_inner_battle_castle", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("besiege_inner_battle_town_center", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (2, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (1, 0, 0, 
    [
      (ge, "$emitters", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_attached_scene_prop, ":var1", ":var0"),
        (ge, ":var1", 1),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
        (scene_prop_get_slot, ":var3", ":var1", 53),
        (store_mission_timer_a, ":var4"),
        (store_sub, ":var5", ":var4", ":var3"),
        (ge, ":var5", 10),
        (prop_instance_receive_damage, ":var1", ":var0", 100),
        (val_sub, "$emitters", 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
      (eq, "$magic_in_sieges", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("castle_attack_walls_defenders_sally", mtf_battle_mode|mtf_synch_inventory, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 12, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

   magic_trigger,

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 20, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (assign, "$g_siege_sallied_out_once", 1),
      (assign, "$g_siege_method", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("castle_attack_walls_belfry", mtf_battle_mode|mtf_synch_inventory, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 7, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$mana_boost_activated", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (set_show_messages, 1),
    ],
    []),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    magic_trigger,

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", 9, 8),
      (team_give_order, "$attacker_team", 9, 8),
      (team_give_order, "$attacker_team", 9, 8),
      (set_show_messages, 1),
    ],
    []),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 5, 
    [],
    [
      (lt, "$defender_reinforcement_stage", 7),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 8),
      (add_reinforcements_to_entry, 4, 7),
      (val_add, "$defender_reinforcement_stage", 1),
      (try_begin),
        (gt, ":var0", 300),
        (get_player_agent_no, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (neq, ":var3", "$defender_team"),
        (neq, ":var3", "$defender_team_2"),
        (ge, "$defender_reinforcement_stage", 2),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 0, 2),
        (team_give_order, "$defender_team_2", 0, 2),
        (team_give_order, "$defender_team", 2, 2),
        (team_give_order, "$defender_team_2", 2, 2),
        (set_show_messages, 1),
        (ge, "$defender_reinforcement_stage", 4),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 9, 2),
        (team_give_order, "$defender_team_2", 9, 2),
        (set_show_messages, 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$defender_reinforcement_stage", 0),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 5),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 1, 8),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    []),

    (0, 2, ti_once, 
    [
      (call_script, "script_cf_siege_rotate_belfry_platform"),
    ],
    [
      (assign, "$belfry_positioned", 3),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("castle_attack_walls_ladder", mtf_battle_mode|mtf_synch_inventory, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 7, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$mana_boost_activated", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (set_show_messages, 1),
    ],
    []),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 5, 
    [],
    [
      (lt, "$defender_reinforcement_stage", 7),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 8),
      (add_reinforcements_to_entry, 4, 7),
      (val_add, "$defender_reinforcement_stage", 1),
      (try_begin),
        (gt, ":var0", 300),
        (get_player_agent_no, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (neq, ":var3", "$defender_team"),
        (neq, ":var3", "$defender_team_2"),
        (ge, "$defender_reinforcement_stage", 2),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 0, 2),
        (team_give_order, "$defender_team_2", 0, 2),
        (team_give_order, "$defender_team", 2, 2),
        (team_give_order, "$defender_team_2", 2, 2),
        (set_show_messages, 1),
        (ge, "$defender_reinforcement_stage", 4),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 9, 2),
        (team_give_order, "$defender_team_2", 9, 2),
        (set_show_messages, 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$defender_reinforcement_stage", 0),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 5),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 1, 8),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    magic_trigger,

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("castle_visit", 0, -1,
  "Castle visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_practice_staff,itm_throwing_daggers]),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (ge, "$emitters", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_attached_scene_prop, ":var1", ":var0"),
        (ge, ":var1", 1),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
        (scene_prop_get_slot, ":var3", ":var1", 53),
        (store_mission_timer_a, ":var4"),
        (store_sub, ":var5", ":var4", ":var3"),
        (ge, ":var5", 10),
        (prop_instance_receive_damage, ":var1", ":var0", 100),
        (val_sub, "$emitters", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (get_player_agent_no, ":var1"),
      (try_begin),
        (neq, ":var1", ":var0"),
        (agent_set_team, ":var0", 7),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (agent_get_troop_id, ":var2", ":var0"),
        (troop_get_slot, ":var3", ":var2", 161),
        (eq, ":var3", 1),
        (agent_set_team, ":var0", 0),
        (agent_ai_set_aggressiveness, ":var0", 5),
        (troop_set_slot, ":var2", 161, 0),
        (try_begin),
          (troop_slot_eq, ":var2", 149, 3),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (this_or_next|eq, ":var2", "trp_swadian_prison_guard"),
        (this_or_next|eq, ":var2", "trp_vaegir_prison_guard"),
        (this_or_next|eq, ":var2", "trp_khergit_prison_guard"),
        (this_or_next|eq, ":var2", "trp_rhodok_prison_guard"),
        (eq, ":var2", "trp_sarranid_prison_guard"),
        (eq, ":var3", "trp_player"),
        (display_message, "@You got keys of dungeon."),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (this_or_next|eq, "$talk_context", 18),
      (eq, "$talk_context", 19),
    ],
    [
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talk_context", 19),
    ],
    [
      (get_player_agent_no, ":var0"),
      (assign, reg6, ":var0"),
      (call_script, "script_activate_town_guard"),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos4, ":var0"),
      (try_for_range, ":var1", "trp_npc1", "trp_heroes_end"),
        (troop_slot_ge, ":var1", 149, 1),
        (str_store_troop_name, s4, ":var1"),
        (display_message, "str_s4_joins_prison_break"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (assign, ":var3", 24),
        (add_visitors_to_current_scene, ":var3", ":var1", 1, 0, 0),
        (troop_set_slot, ":var1", 161, 1),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (set_trigger_result, 1),
        (mission_enable_talk),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (3, 0, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 18),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_captivity_start_castle_defeat"),
        (assign, ":var0", "trp_heroes_end"),
        (try_for_range, ":var1", "trp_npc1", ":var0"),
          (troop_set_slot, ":var1", 149, 0),
        (try_end),
        (mission_enable_talk),
        (finish_mission, 0),
      (else_try),
        (mission_enable_talk),
        (finish_mission, 0),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$talk_context", 19),
      (neg|main_hero_fallen, 0),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (all_enemies_defeated),
    ],
    [
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_ge, ":var1", 149, 2),
        (try_begin),
          (agent_is_alive, ":var0"),
          (troop_set_slot, ":var1", 149, 4),
        (else_try),
          (troop_set_slot, ":var1", 149, 5),
        (try_end),
      (try_end),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", "skl_leadership", "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var3", 11),
        (assign, ":var4", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var3", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var4", "mt_castle_visit"),
        (else_try),
          (assign, ":var4", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var3", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (agent_slot_ge, "$fplayer_agent_no", 36, 1),
        (mission_tpl_entry_set_override_flags, ":var4", ":var3", 0),
      (try_end),
      (store_current_scene, ":var5"),
      (modify_visitors_at_site, ":var5"),
      (assign, ":var6", 0),
      (party_get_num_companion_stacks, ":var7", "p_main_party"),
      (try_for_range, ":var8", 0, ":var7"),
        (party_stack_get_troop_id, ":var9", "p_main_party", ":var8"),
        (neq, ":var9", "trp_player"),
        (troop_is_hero, ":var9"),
        (neg|troop_is_wounded, ":var9"),
        (val_add, ":var6", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var9", 161, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var3", ":var9", 1),
        (eq, ":var6", ":var2"),
        (assign, ":var7", 0),
      (try_end),
      (gt, ":var6", 0),
      (set_show_messages, 0),
      (team_give_order, "$fplayer_team_no", 8, 1),
      (team_set_order_listener, "$fplayer_team_no", 8),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (ge, ":var2", 0),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 84, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (neg|troop_is_wounded, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("training_ground_trainer_talk", 0, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (0, 1, 2, 
    [
      (lt, "$trainer_help_message", 2),
    ],
    [
      (try_begin),
        (eq, "$trainer_help_message", 0),
      (else_try),
      (try_end),
      (val_add, "$trainer_help_message", 1),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("training_ground_trainer_training", mtf_arena_fight, -1,
  "You will fight a match in the arena.",
  [
    (16, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_shield,itm_practice_sword,itm_practice_boots]),
    (17, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (18, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (19, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_boots]),
    (20, mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 1),
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
      (assign, "$training_fight_won", 1),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("training_ground_training", mtf_arena_fight, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_staff]),
    (1, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_staff]),
    (2, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_staff]),
    (3, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_staff]),
    (4, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_staff]),
    (8, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_last_destroyed_gourds", 0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_training_ground_training_success_ratio", 0),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_fixed_point_multiplier, 100),
        (entry_point_get_position, pos1, 0),
        (init_position, pos2),
        (position_set_y, pos2, "$g_training_ground_ranged_distance"),
        (position_transform_position_to_parent, pos3, pos1, pos2),
        (copy_position, 1, 3),
        (assign, ":var0", 10),
        (assign, ":var1", 0),
        (try_for_range, ":var2", 0, ":var0"),
          (store_sub, ":var3", ":var2", ":var1"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var3"),
          (copy_position, 2, 1),
          (init_position, pos0),
          (store_random_in_range, ":var5", 0, 360),
          (position_rotate_z, pos2, ":var5"),
          (store_random_in_range, ":var5", 50, 600),
          (position_move_x, 2, ":var5"),
          (store_random_in_range, ":var5", 0, 360),
          (position_transform_position_to_local, pos3, pos1, pos2),
          (position_rotate_z, pos0, ":var5"),
          (position_transform_position_to_parent, pos4, pos0, pos3),
          (position_transform_position_to_parent, pos2, pos1, pos4),
          (position_set_z_to_ground_level, pos2),
          (position_move_z, pos2, 150),
          (assign, ":var6", 1),
          (try_for_range, ":var7", 0, 10),
            (eq, ":var6", 1),
            (neq, ":var3", ":var7"),
            (scene_prop_get_instance, ":var8", "spr_gourd", ":var7"),
            (prop_instance_get_position, pos3, ":var8"),
            (get_distance_between_positions, ":var9", pos2, pos3),
            (lt, ":var9", 100),
            (assign, ":var6", 0),
          (try_end),
          (try_begin),
            (eq, ":var6", 0),
            (val_add, ":var0", 1),
            (val_add, ":var1", 1),
          (else_try),
            (prop_instance_set_position, ":var4", pos2),
            (prop_instance_animate_to_position, ":var4", pos2, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var3"),
            (position_move_z, pos2, -150),
            (prop_instance_set_position, ":var8", pos2),
            (prop_instance_animate_to_position, ":var8", pos2, 1),
          (try_end),
        (try_end),
      (else_try),
        (eq, "$g_mt_mode", 3),
        (assign, ":var10", 0),
        (try_for_range, ":var2", 0, 100),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var2"),
          (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var2"),
          (ge, ":var4", 0),
          (ge, ":var8", 0),
          (val_add, ":var10", 1),
          (prop_instance_get_position, pos0, ":var8"),
          (position_move_z, pos0, 150),
          (prop_instance_set_position, ":var4", pos0),
          (prop_instance_animate_to_position, ":var4", pos0, 1),
        (try_end),
        (store_sub, ":var0", ":var10", "$g_training_ground_training_num_gourds_to_destroy"),
        (try_for_range, ":var2", 0, ":var0"),
          (store_random_in_range, ":var11", 0, ":var10"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var11"),
          (prop_instance_get_position, pos0, ":var4"),
          (position_get_z, ":var12", pos0),
          (try_begin),
            (lt, ":var12", -50000),
          (else_try),
            (position_set_z, pos0, -100000),
            (prop_instance_set_position, ":var4", pos0),
            (prop_instance_animate_to_position, ":var4", pos0, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var11"),
            (prop_instance_set_position, ":var8", pos0),
            (prop_instance_animate_to_position, ":var8", pos0, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_training_ground_training_success_ratio", 100),
      (else_try),
        (assign, ":var0", 0),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var2", ":var1"),
          (eq, ":var2", 1),
          (val_add, ":var0", 1),
        (try_end),
        (store_sub, ":var3", "$g_training_ground_training_num_enemies", ":var0"),
        (store_mul, "$g_training_ground_training_success_ratio", ":var3", 100),
        (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_enemies"),
      (try_end),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_ammo, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|main_hero_fallen),
      (this_or_next|eq, ":var1", 0),
      (gt, ":var2", 116),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 10),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (get_player_agent_no, ":var0"),
      (agent_get_horse, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|lt, ":var1", 0),
      (this_or_next|main_hero_fallen),
      (this_or_next|ge, "$scene_num_total_gourds_destroyed", "$g_training_ground_training_num_gourds_to_destroy"),
      (gt, ":var2", 120),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 100),
      (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_gourds_to_destroy"),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (0, 0, 0, 
    [
      (gt, "$g_last_destroyed_gourds", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (entry_point_get_position, pos1, 0),
        (position_move_y, pos1, 100, 0),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos2, ":var0"),
        (try_begin),
          (position_is_behind_position, pos2, pos1),
          (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
        (else_try),
          (display_message, "@You must stay behind the line on the ground! Point is not counted."),
        (try_end),
      (else_try),
        (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
      (try_end),
      (assign, "$g_last_destroyed_gourds", 0),
    ],
    []),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("sneak_caught_fight", mtf_battle_mode, -1,
  "You must fight your way out!",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff,itm_throwing_daggers]),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (64, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$sneaked_into_town", 128),
        (assign, ":var0", 8),
      (else_try),
        (assign, ":var0", 5),
      (try_end),
      (try_begin),
        (party_get_slot, ":var1", "$current_town", 250),
        (store_current_hours, ":var2"),
        (store_add, ":var3", ":var1", 4),
        (is_between, ":var2", ":var3", ":var1"),
        (try_begin),
          (eq, "$sneaked_into_town", 128),
          (assign, ":var0", 5),
        (else_try),
          (assign, ":var0", 2),
        (try_end),
      (else_try),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (try_begin),
          (eq, "$sneaked_into_town", 128),
          (assign, ":var0", 7),
        (else_try),
          (assign, ":var0", 4),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (entry_point_get_position, pos0, 7),
      (else_try),
        (party_slot_eq, "$current_town", 0, 3),
        (entry_point_get_position, pos0, 0),
      (else_try),
        (entry_point_get_position, pos0, 1),
      (try_end),
      (assign, ":var4", -1),
      (assign, ":var5", -1),
      (try_for_range, ":var6", 0, ":var0"),
        (assign, ":var7", 100000),
        (try_for_range, ":var8", 2, 64),
          (neq, ":var5", ":var8"),
          (entry_point_get_position, pos1, ":var8"),
          (get_distance_between_positions, ":var9", pos0, pos1),
          (lt, ":var9", ":var7"),
          (gt, ":var9", ":var4"),
          (assign, ":var7", ":var9"),
          (assign, ":var10", ":var8"),
        (try_end),
        (store_faction_of_party, ":var11", "$current_town"),
        (try_begin),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", 2),
          (try_begin),
            (eq, "$sneaked_into_town", 128),
            (faction_get_slot, ":var12", ":var11", 44),
          (else_try),
            (faction_get_slot, ":var12", ":var11", 42),
          (try_end),
        (else_try),
          (try_begin),
            (eq, "$sneaked_into_town", 128),
            (faction_get_slot, ":var12", ":var11", 44),
          (else_try),
            (faction_get_slot, ":var12", ":var11", 42),
          (try_end),
        (try_end),
        (assign, ":var5", ":var10"),
        (assign, ":var4", ":var7"),
        (add_visitors_to_current_scene, ":var10", ":var12", 1, 0),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_wish_to_surrender"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (play_sound, "snd_sneak_town_halt"),
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (0, 3, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (eq, ":var2", 1),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (try_begin),
          (le, ":var3", 800),
          (agent_clear_scripted_mode, ":var1"),
        (else_try),
          (agent_set_scripted_destination, ":var1", pos0, 0),
        (try_end),
      (try_end),
    ]),

    (5, 1, ti_once, 
    [
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_dispersed_guards"),
      (finish_mission, 1),
    ]),

    (ti_on_leave_area, 0, ti_once, 
    [],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("ai_training", 0, -1,
  "You start training.",
  [
    (0, 0, 0, aif_start_alarmed, 30, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("camera_test", 0, -1,
  "camera Test.",
  [
  ],
  [
    (1, 0, 0, 
    [
      (mission_cam_set_mode, 1),
      (entry_point_get_position, pos3, 3),
      (mission_cam_set_position, pos3),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("arena_melee_fight", mtf_arena_fight, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (1, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_red]),
    (2, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (3, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (4, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_red]),
    (5, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_red]),
    (6, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_red]),
    (7, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (8, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_blue]),
    (9, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (10, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_blue]),
    (11, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (12, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_blue]),
    (13, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (14, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_blue]),
    (15, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_blue]),
    (16, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (17, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (18, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (19, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (20, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (21, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_green]),
    (22, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_green]),
    (23, mtef_team_2|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (25, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (26, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (27, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (28, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (29, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_yellow]),
    (30, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow]),
    (31, mtef_team_3|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (32, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (33, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (34, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (35, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (36, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (37, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (38, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (39, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_yellow]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (50, mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (51, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (52, mtef_scene_source, af_override_horse, 0, 1, []),
    (53, mtef_scene_source, af_override_horse, 0, 1, []),
    (54, mtef_scene_source, af_override_horse, 0, 1, []),
    (55, mtef_scene_source, af_override_horse, 0, 1, []),
    (56, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_padded_cloth,itm_segmented_helmet]),
    (57, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_padded_cloth,itm_segmented_helmet]),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_arena_training_num_agents_spawned", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_trigger_result, 1),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (try_begin),
        (eq, "$g_mt_mode", 3),
        (call_script, "script_end_tournament_fight", 0),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_kill_count, "$g_arena_training_kills", ":var1", 1),
      (try_end),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 2),
      (call_script, "script_music_set_situation_with_culture", 65536),
      (store_current_scene, reg1),
      (scene_set_slot, reg1, 0, 1),
      (mission_enable_talk),
      (get_player_agent_no, ":var0"),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_get_troop_id, ":var3", ":var2"),
        (is_between, ":var3", "trp_novice_fighter", "trp_tournament_master"),
        (eq, ":var1", 0),
        (agent_set_team, ":var2", 1),
        (assign, ":var1", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 3),
      (play_sound, "snd_arena_ambiance", 2),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (call_script, "script_end_tournament_fight", 1),
        (call_script, "script_play_victorious_sound"),
        (finish_mission),
      (else_try),
        (call_script, "script_end_tournament_fight", 0),
        (finish_mission),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (start_presentation, "prsnt_arena_training"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (assign, "$g_arena_training_max_opponents", 40),
      (assign, "$g_arena_training_num_agents_spawned", 0),
      (assign, "$g_arena_training_kills", 0),
      (assign, "$g_arena_training_won", 0),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
      (assign, ":var1", 0),
      (try_begin),
        (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
        (num_active_teams_le, 1),
        (assign, ":var1", 1),
      (try_end),
      (this_or_next|eq, ":var1", 1),
      (main_hero_fallen),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_kill_count, "$g_arena_training_kills", ":var0", 1),
      (assign, "$g_arena_training_won", 0),
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_arena_training_won", 1),
      (try_end),
      (assign, "$g_mt_mode", 2),
      (set_jump_mission, "mt_arena_melee_fight"),
      (party_get_slot, ":var1", "$current_town", 16),
      (modify_visitors_at_site, ":var1"),
      (reset_visitors),
      (set_visitor, 35, "trp_veteran_fighter"),
      (set_visitor, 36, "trp_hired_blade"),
      (set_jump_entry, 50),
      (jump_to_scene, ":var1"),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (is_between, ":var2", 0, 7),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 7),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var3"),
      (this_or_next|ge, ":var3", "$g_arena_training_next_spawn_time"),
      (this_or_next|lt, "$g_arena_training_num_agents_spawned", 6),
      (num_active_teams_le, 1),
      (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
    ],
    [
      (assign, ":var0", "$g_arena_training_num_agents_spawned"),
      (store_div, ":var0", "$g_arena_training_num_agents_spawned", 6),
      (assign, ":var1", "$g_arena_training_num_agents_spawned"),
      (val_mod, ":var1", 6),
      (val_add, ":var0", ":var1"),
      (val_min, ":var0", 9),
      (val_add, ":var0", "trp_arena_training_fighter_1"),
      (assign, ":var2", 10000),
      (get_player_agent_no, ":var3"),
      (agent_get_position, pos5, ":var3"),
      (try_for_range, ":var4", 0, ":var2"),
        (store_random_in_range, ":var5", 32, 40),
        (neq, ":var5", "$g_player_entry_point"),
        (entry_point_get_position, pos1, ":var5"),
        (get_distance_between_positions, ":var6", pos5, pos1),
        (gt, ":var6", 1200),
        (assign, ":var2", 0),
      (try_end),
      (add_visitors_to_current_scene, ":var5", ":var0", 1),
      (store_add, ":var7", "$g_arena_training_num_agents_spawned", 1),
      (store_mission_timer_a, ":var8"),
      (store_add, "$g_arena_training_next_spawn_time", ":var8", 14),
      (store_div, ":var9", ":var7", 3),
      (val_sub, "$g_arena_training_next_spawn_time", ":var9"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
    ],
    [
      (assign, ":var0", 6),
      (val_max, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_slot_eq, ":var2", 7, 0),
        (agent_get_team, ":var3", ":var2"),
        (is_between, ":var3", 0, 7),
        (try_begin),
          (eq, ":var2", ":var1"),
          (agent_set_team, ":var2", 6),
        (else_try),
          (store_random_in_range, ":var4", 0, ":var0"),
          (try_for_range, ":var5", 0, 6),
            (troop_set_slot, "trp_temp_array_a", ":var5", 0),
          (try_end),
          (try_for_agents, ":var6"),
            (agent_is_human, ":var6"),
            (agent_is_alive, ":var6"),
            (neq, ":var2", ":var1"),
            (agent_slot_eq, ":var6", 7, 1),
            (agent_get_team, ":var7", ":var6"),
            (troop_get_slot, ":var8", "trp_temp_array_a", ":var7"),
            (val_add, ":var8", 1),
            (troop_set_slot, "trp_temp_array_a", ":var7", ":var8"),
          (try_end),
          (assign, ":var9", 0),
          (troop_get_slot, ":var10", "trp_temp_array_a", 0),
          (try_for_range, ":var5", 1, 6),
            (troop_slot_ge, "trp_temp_array_a", ":var5", ":var10"),
            (troop_get_slot, ":var10", "trp_temp_array_a", ":var5"),
            (assign, ":var9", ":var5"),
          (try_end),
          (store_random_in_range, ":var11", 5, 100),
          (try_begin),
            (lt, ":var11", "$g_arena_training_num_agents_spawned"),
            (assign, ":var4", ":var9"),
          (try_end),
          (agent_set_team, ":var2", ":var4"),
        (try_end),
        (agent_set_slot, ":var2", 7, 1),
        (try_begin),
          (neq, ":var2", ":var1"),
          (val_add, "$g_arena_training_num_agents_spawned", 1),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("arena_challenge_fight", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a melee fight in the arena.",
  [
    (56, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_for_lady"),
      (else_try),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_for_lady"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
      (else_try),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
      (else_try),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_denounce_lord"),
      (else_try),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_denounce_lord"),
      (else_try),
        (quest_get_slot, ":var0", "qst_denounce_lord", 2),
        (str_store_troop_name, s4, ":var0"),
      (try_end),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("duel_with_lord", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_sword_medieval_a,itm_arena_tunic_blue]),
    (16, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_sword_medieval_a,itm_arena_tunic_blue]),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_for_lady"),
      (else_try),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_for_lady"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
      (else_try),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
      (else_try),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_denounce_lord"),
      (else_try),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_denounce_lord"),
      (else_try),
        (quest_get_slot, ":var0", "qst_denounce_lord", 2),
        (str_store_troop_name, s4, ":var0"),
      (try_end),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("wedding", 0, -1,
  "Wedding",
  [
    (0, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (1, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (2, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (3, mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, []),
    (4, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (5, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (6, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (7, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (show_object_details_overlay, 1),
      (finish_mission, 0),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (show_object_details_overlay, 1),
      (finish_mission, 0),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_wedding_state", 0),
      (play_track, "track_wedding", 2),
      (show_object_details_overlay, 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
        (eq, ":var1", "$g_wedding_bishop_troop"),
      (else_try),
        (eq, ":var1", "$g_wedding_bride_troop"),
        (agent_set_no_dynamics, ":var0", 1),
        (init_position, pos1),
        (position_set_z, pos1, -1000),
        (agent_set_position, ":var0", pos1),
      (else_try),
        (eq, ":var1", "$g_wedding_brides_dad_troop"),
        (agent_set_no_dynamics, ":var0", 1),
        (init_position, pos1),
        (position_set_z, pos1, -1000),
        (agent_set_position, ":var0", pos1),
      (else_try),
        (eq, ":var1", "$g_wedding_groom_troop"),
        (agent_set_no_dynamics, ":var0", 1),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (agent_set_position, ":var0", pos1),
        (agent_set_animation, ":var0", "anim_wedding_groom_wait"),
      (else_try),
        (try_begin),
          (eq, ":var2", 0),
          (store_random_in_range, ":var3", 0, 3),
          (try_begin),
            (eq, ":var3", 0),
            (agent_set_slot, ":var0", 18, "anim_wedding_guest_notr"),
            (agent_set_animation, ":var0", "anim_wedding_guest_notr"),
          (else_try),
            (agent_set_slot, ":var0", 18, "anim_wedding_guest"),
            (agent_set_animation, ":var0", "anim_wedding_guest"),
          (try_end),
        (else_try),
          (agent_set_slot, ":var0", 18, "anim_wedding_guest_woman"),
          (agent_set_animation, ":var0", "anim_wedding_guest_woman"),
        (try_end),
        (store_random_in_range, ":var4", 0, 100),
        (agent_set_animation_progress, ":var0", ":var4"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (try_begin),
          (eq, ":var2", "$g_wedding_groom_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_bride_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_brides_dad_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_bishop_troop"),
        (else_try),
          (agent_get_slot, ":var3", ":var1", 18),
          (agent_set_animation, ":var1", ":var3"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$g_wedding_state", 0),
        (mission_cam_set_mode, 1, 0, 0),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_rotate_x, pos1, 5),
        (position_set_x, pos1, -500),
        (position_set_y, pos1, 1000),
        (position_set_z, pos1, 600),
        (mission_cam_set_position, pos1),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_rotate_x, pos1, -15),
        (position_set_x, pos1, -500),
        (position_set_y, pos1, 1000),
        (position_set_z, pos1, 600),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 1),
        (ge, ":var0", 4),
        (init_position, pos1),
        (position_rotate_z, pos1, 90),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -580),
        (position_set_y, pos1, 700),
        (position_set_z, pos1, 200),
        (mission_cam_set_position, pos1),
        (init_position, pos1),
        (position_rotate_z, pos1, 150),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -580),
        (position_set_y, pos1, 100),
        (position_set_z, pos1, 200),
        (mission_cam_animate_to_position, pos1, 6000, 1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 2),
        (ge, ":var0", 9),
        (mission_cam_animate_to_screen_color, 4278190080, 1000),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 3),
        (ge, ":var0", 10),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_stairs"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_stairs"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -90),
        (position_set_x, pos1, 300),
        (position_set_y, pos1, 950),
        (position_set_z, pos1, 420),
        (mission_cam_set_position, pos1),
        (position_set_x, pos1, 175),
        (position_set_y, pos1, 950),
        (position_set_z, pos1, 320),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (mission_cam_animate_to_screen_color, 0, 500),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 4),
        (ge, ":var0", 14),
        (init_position, pos1),
        (position_rotate_z, pos1, -60),
        (position_rotate_x, pos1, 10),
        (position_set_x, pos1, -400),
        (position_set_y, pos1, 200),
        (position_set_z, pos1, 115),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 5),
        (ge, ":var0", 20),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_walk"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_walk"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -140),
        (position_rotate_x, pos1, -15),
        (position_set_x, pos1, -625),
        (position_set_y, pos1, -530),
        (position_set_z, pos1, 180),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 6),
        (ge, ":var0", 22),
        (init_position, pos1),
        (position_rotate_z, pos1, 45),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -260),
        (position_set_y, pos1, 120),
        (position_set_z, pos1, 275),
        (mission_cam_set_position, pos1),
        (position_rotate_z, pos1, 10),
        (mission_cam_animate_to_position, pos1, 2000, 0),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 7),
        (ge, ":var0", 24),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_last"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_last"),
          (else_try),
            (eq, ":var4", "$g_wedding_groom_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_groom_last"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -45),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -900),
        (position_set_y, pos1, -850),
        (position_set_z, pos1, 230),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 8),
        (ge, ":var0", 31),
        (init_position, pos1),
        (position_set_x, pos1, -550),
        (position_set_y, pos1, -625),
        (position_set_z, pos1, 1500),
        (particle_system_burst, "psys_wedding_rose", pos1, 750),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 9),
        (ge, ":var0", 33),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_set_x, pos1, -536),
        (position_set_y, pos1, -415),
        (position_set_z, pos1, 135),
        (mission_cam_set_position, pos1),
        (position_rotate_z, pos1, -8),
        (position_set_z, pos1, 350),
        (position_rotate_x, pos1, 35),
        (mission_cam_animate_to_position_and_aperture, pos1, 10, 9000, 1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 10),
        (ge, ":var0", 41),
        (mission_cam_set_screen_color, 16777215),
        (mission_cam_animate_to_screen_color, 4294967295, 3000),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 11),
        (ge, ":var0", 48),
        (show_object_details_overlay, 1),
        (finish_mission, 0),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("tutorial_training_ground", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (33, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (34, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (35, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (42, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (62, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (63, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (64, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$g_tutorial_training_ground_state", 20),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_tutorial_show_mouse_movement"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (agent_set_no_death_knock_down_only, ":var0", 1),
      (agent_set_invulnerable_shield, ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_slot, ":var0", 8, -1),
      (get_player_agent_no, ":var1"),
      (try_begin),
        (eq, ":var0", ":var1"),
        (agent_set_team, ":var0", 7),
      (try_end),
      (try_for_range, ":var2", 0, 64),
        (entry_point_get_position, pos2, ":var2"),
        (get_sq_distance_between_positions, ":var3", pos1, pos2),
        (lt, ":var3", 100),
        (agent_set_slot, ":var0", 8, ":var2"),
      (try_end),
      (agent_get_troop_id, ":var4", ":var0"),
      (try_begin),
        (eq, ":var4", "trp_tutorial_archer_1"),
        (agent_get_position, pos1, ":var0"),
        (agent_set_scripted_destination, ":var0", pos1),
        (scene_prop_get_num_instances, ":var5", "spr_archery_target_with_hit_a"),
        (assign, ":var6", 10000000),
        (assign, ":var7", -1),
        (try_for_range, ":var8", 0, ":var5"),
          (scene_prop_get_instance, ":var9", "spr_archery_target_with_hit_a", ":var8"),
          (prop_instance_get_position, pos2, ":var9"),
          (get_sq_distance_between_positions, ":var10", pos1, pos2),
          (lt, ":var10", ":var6"),
          (assign, ":var6", ":var10"),
          (assign, ":var7", ":var9"),
        (try_end),
        (agent_set_slot, ":var0", 9, ":var7"),
      (else_try),
        (this_or_next|eq, ":var4", "trp_tutorial_rider_1"),
        (eq, ":var4", "trp_tutorial_rider_2"),
        (agent_set_slot, ":var0", 11, 48),
        (agent_set_slot, ":var0", 9, -1),
        (entry_point_get_position, pos1, 48),
        (agent_set_scripted_destination, ":var0", pos1),
      (try_end),
    ]),

    (ti_on_agent_knocked_down, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (ge, "$g_tutorial_training_ground_melee_trainer_attack", 0),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_parry", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 2),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_parry"),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 3),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (try_end),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_chamber", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 7),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_chamber"),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 8),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (try_end),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_combat", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 4),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 5),
          (play_sound, "snd_tutorial_2"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
        (try_end),
      (else_try),
        (agent_is_human, ":var0"),
        (assign, "$g_tutorial_training_ground_melee_last_winner", ":var1"),
        (assign, "$g_tutorial_training_ground_melee_last_loser", ":var0"),
        (assign, "$g_tutorial_training_ground_melee_state", 0),
        (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 7),
        (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 7),
        (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_1"),
        (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_2"),
      (try_end),
      (agent_set_hit_points, ":var0", 100, 0),
      (agent_set_hit_points, ":var1", 100, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 13),
      (team_set_relation, 0, 1, 0),
      (team_set_relation, 0, 2, 0),
      (team_set_relation, 0, 3, 0),
      (team_set_relation, 0, 7, 0),
      (team_set_relation, 7, 1, 1),
      (team_set_relation, 7, 2, 1),
      (team_set_relation, 7, 3, 1),
      (team_set_relation, 1, 2, -1),
      (team_set_relation, 1, 3, 1),
      (team_set_relation, 2, 3, 1),
      (assign, "$g_position_to_use_for_replacing_scene_items", 8),
      (call_script, "script_replace_scene_items_with_spawn_items_before_ms"),
      (assign, "$g_tutorial_training_ground_state", 0),
      (assign, "$g_tutorial_training_ground_conversation_state", 0),
      (assign, "$g_tutorial_training_ground_melee_paused", 0),
      (assign, "$g_tutorial_training_ground_melee_state", 0),
      (assign, "$g_tutorial_training_ground_melee_next_action_time", 0),
      (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
      (assign, "$g_tutorial_training_ground_melee_last_loser", -1),
      (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
      (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_next_action_time", 0),
      (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (assign, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
      (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (assign, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
      (assign, "$g_tutorial_training_ground_next_score_time", 0),
      (assign, "$g_tutorial_mouse_dir", -1),
      (assign, "$g_tutorial_mouse_click", -1),
      (assign, "$g_pointer_arrow_height_adder", -1000),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 600),
      (tutorial_message_set_center_justify, 0),
      (mission_enable_talk),
      (call_script, "script_replace_scene_items_with_spawn_items_after_ms"),
      (entry_point_get_position, pos1, 59),
      (set_spawn_position, pos1),
      (spawn_horse, "itm_practice_horse", 0),
      (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_bow", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_bow_2", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_arrows", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0), 
      (scene_spawned_item_get_instance, ":var0", "itm_practice_arrows_2", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_crossbow", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_bolts", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_javelin", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_arena_lance", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
    ]),

    (0, 1, ti_once, 
    [],
    [
      (tutorial_message_set_background, 1),
      (tutorial_message, "str_tutorial_training_ground_intro_message"),
    ]),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "trp_tutorial_archer_1"),
        (try_begin),
          (agent_get_wielded_item, ":var3", ":var1", 0),
          (neq, ":var3", "itm_practice_bow"),
          (agent_set_wielded_item, ":var1", "itm_practice_bow"),
        (else_try),
          (agent_get_slot, ":var4", ":var1", 9),
          (prop_instance_get_position, pos1, ":var4"),
          (position_move_z, pos1, 10),
          (agent_set_look_target_position, ":var1", pos1),
          (try_begin),
            (neg|agent_slot_ge, ":var1", 19, ":var0"),
            (agent_set_attack_action, ":var1", 0),
            (store_random_in_range, ":var5", 3, 13),
            (val_add, ":var5", ":var0"),
            (agent_set_slot, ":var1", 19, ":var5"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "trp_tutorial_rider_1"),
        (eq, ":var1", "trp_tutorial_rider_2"),
        (agent_get_slot, ":var2", ":var0", 11),
        (entry_point_get_position, pos1, ":var2"),
        (agent_get_position, pos2, ":var0"),
        (get_sq_distance_between_positions, ":var3", pos1, pos2),
        (try_begin),
          (lt, ":var3", 6400),
          (val_add, ":var2", 1),
          (try_begin),
            (gt, ":var2", 57),
            (assign, ":var2", 48),
          (try_end),
          (agent_set_slot, ":var0", 11, ":var2"),
          (entry_point_get_position, pos1, ":var2"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
        (try_begin),
          (eq, ":var1", "trp_tutorial_rider_2"),
          (try_begin),
            (agent_get_wielded_item, ":var4", ":var0", 0),
            (neq, ":var4", "itm_practice_bow"),
            (agent_set_wielded_item, ":var0", "itm_practice_bow"),
          (else_try),
            (scene_prop_get_num_instances, ":var5", "spr_archery_target_with_hit_a"),
            (assign, ":var6", 10000000),
            (assign, ":var7", -1),
            (try_for_range, ":var8", 0, ":var5"),
              (scene_prop_get_instance, ":var9", "spr_archery_target_with_hit_a", ":var8"),
              (neg|agent_slot_eq, ":var0", 9, ":var9"),
              (prop_instance_get_position, pos1, ":var9"),
              (position_is_behind_position, pos2, pos1),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", ":var6"),
              (assign, ":var6", ":var3"),
              (assign, ":var7", ":var9"),
            (try_end),
            (try_begin),
              (lt, ":var6", 40000),
              (prop_instance_get_position, pos1, ":var7"),
              (position_move_z, pos1, 10),
              (init_position, pos3),
              (position_set_x, pos3, -160),
              (position_transform_position_to_parent, pos4, pos1, pos3),
              (copy_position, 1, 4),
              (agent_set_look_target_position, ":var0", pos1),
              (lt, ":var6", 22500),
              (agent_set_slot, ":var0", 9, ":var7"),
              (agent_set_attack_action, ":var0", 0),
            (else_try),
              (agent_get_slot, ":var10", ":var0", 9),
              (ge, ":var10", 0),
              (prop_instance_get_position, pos1, ":var10"),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", 40000),
              (position_move_z, pos1, 10),
              (init_position, pos3),
              (position_set_x, pos3, -160),
              (position_transform_position_to_parent, pos4, pos1, pos3),
              (copy_position, 1, 4),
              (agent_set_look_target_position, ":var0", pos1),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var1", "trp_tutorial_rider_1"),
          (try_begin),
            (agent_get_wielded_item, ":var4", ":var0", 0),
            (neq, ":var4", "itm_practice_sword"),
            (agent_set_wielded_item, ":var0", "itm_practice_sword"),
          (else_try),
            (scene_prop_get_num_instances, ":var5", "spr_dummy_a_undestructable"),
            (assign, ":var6", 10000000),
            (assign, ":var7", -1),
            (try_for_range, ":var8", 0, ":var5"),
              (scene_prop_get_instance, ":var9", "spr_dummy_a_undestructable", ":var8"),
              (neg|agent_slot_eq, ":var0", 9, ":var9"),
              (prop_instance_get_position, pos1, ":var9"),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", ":var6"),
              (assign, ":var6", ":var3"),
              (assign, ":var7", ":var9"),
            (try_end),
            (try_begin),
              (lt, ":var6", 10000),
              (prop_instance_get_position, pos1, ":var7"),
              (position_transform_position_to_local, pos3, pos2, pos1),
              (position_get_x, ":var11", pos3),
              (position_get_y, ":var12", pos3),
              (is_between, ":var11", -200, 200),
              (gt, ":var12", -100),
              (init_position, pos3),
              (try_begin),
                (lt, ":var11", 0),
                (position_move_x, 3, -100),
                (position_move_z, pos3, 100),
              (else_try),
                (position_move_x, 3, 100),
                (position_move_z, pos3, 150),
              (try_end),
              (position_transform_position_to_parent, pos4, pos2, pos3),
              (agent_set_look_target_position, ":var0", pos4),
              (try_begin),
                (lt, ":var11", 0),
                (agent_set_attack_action, ":var0", 2, 1),
              (else_try),
                (agent_set_attack_action, ":var0", 1, 1),
              (try_end),
              (this_or_next|lt, ":var6", 900),
              (lt, ":var12", 100),
              (agent_set_attack_action, ":var0", 0, 0),
              (agent_set_slot, ":var0", 9, ":var7"),
            (else_try),
              (agent_get_slot, ":var10", ":var0", 9),
              (ge, ":var10", 0),
              (prop_instance_get_position, pos1, ":var10"),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", 10000),
              (position_transform_position_to_local, pos3, pos2, pos1),
              (position_get_x, ":var11", pos3),
              (position_get_y, ":var12", pos3),
              (is_between, ":var11", -200, 200),
              (gt, ":var12", -100),
              (init_position, pos3),
              (try_begin),
                (lt, ":var11", 0),
                (position_move_x, 3, -100),
                (position_move_z, pos3, 100),
              (else_try),
                (position_move_x, 3, 100),
                (position_move_z, pos3, 150),
              (try_end),
              (position_transform_position_to_parent, pos4, pos2, pos3),
              (agent_set_look_target_position, ":var0", pos4),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "trp_tutorial_archer_1"),
        (try_begin),
          (agent_get_wielded_item, ":var3", ":var1", 0),
          (neq, ":var3", "itm_practice_bow"),
          (agent_set_wielded_item, ":var1", "itm_practice_bow"),
        (else_try),
          (agent_get_slot, ":var4", ":var1", 9),
          (prop_instance_get_position, pos1, ":var4"),
          (agent_set_look_target_position, ":var1", pos1),
          (try_begin),
            (neg|agent_slot_ge, ":var1", 19, ":var0"),
            (agent_set_attack_action, ":var1", 0),
            (store_random_in_range, ":var5", 3, 13),
            (val_add, ":var5", ":var0"),
            (agent_set_slot, ":var1", 19, ":var5"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_iterate_pointer_arrow"),
    ],
    []),

    (5, 0, 0, 
    [
      (try_begin),
        (store_mission_timer_a, ":var0"),
        (ge, ":var0", 30),
        (eq, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
        (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 0),
        (tutorial_message, -1),
      (try_end),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (neq, ":var2", ":var1"),
        (agent_refill_ammo, ":var2"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (assign, ":var2", 0),
      (try_begin),
        (eq, ":var1", "itm_practice_bow"),
        (agent_has_item_equipped, ":var0", "itm_practice_arrows"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_bow_2"),
        (agent_has_item_equipped, ":var0", "itm_practice_arrows_2"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_crossbow"),
        (agent_has_item_equipped, ":var0", "itm_practice_bolts"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_javelin"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (le, ":var3", 1),
        (assign, ":var2", 1),
      (try_end),
      (eq, ":var2", 1),
      (agent_refill_ammo, ":var0"),
      (dialog_box, "str_tutorial_training_ground_ammo_refill", "@Tutorial"),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (mission_disable_talk),
      (try_begin),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (assign, "$g_tutorial_training_ground_current_score", 0),
        (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 2),
        (try_begin),
          (try_begin),
            (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
            (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
            (prop_instance_get_position, pos0, ":var1"),
            (position_move_z, pos0, 1000, 1),
            (prop_instance_set_position, ":var1", pos0),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 200),
            (try_begin),
              (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (prop_instance_get_position, pos0, ":var1"),
              (position_move_z, pos0, 1000, 1),
              (prop_instance_set_position, ":var1", pos0),
            (try_end),
          (try_end),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 3),
        (try_begin),
          (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 4),
        (try_begin),
          (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 5),
        (try_begin),
          (agent_get_horse, ":var3", ":var0"),
          (lt, ":var3", 0),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_2"),
          (try_begin),
            (assign, ":var4", -1),
            (try_for_agents, ":var5"),
              (agent_get_item_id, ":var6", ":var5"),
              (eq, ":var6", "itm_practice_horse"),
              (assign, ":var4", ":var5"),
            (try_end),
            (agent_get_position, pos0, ":var4"),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_get_position, pos1, ":var2"),
            (set_fixed_point_multiplier, 100),
            (position_get_x, ":var7", pos0),
            (position_get_x, ":var8", pos1),
            (position_get_y, ":var9", pos0),
            (position_get_y, ":var10", pos1),
            (this_or_next|neq, ":var7", ":var8"),
            (neq, ":var9", ":var10"),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 200),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 6),
        (try_begin),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_3"),
        (else_try),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
          (assign, ":var11", "spr_dummy_a_undestructable"),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_4"),
        (else_try),
          (assign, ":var11", "spr_archery_target_with_hit_a"),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_5"),
        (try_end),
        (try_begin),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
          (store_add, ":var12", "$g_tutorial_training_ground_current_score", 48),
          (entry_point_get_position, pos0, ":var12"),
          (init_position, pos2),
          (position_move_y, pos2, -800),
          (position_transform_position_to_parent, pos3, pos0, pos2),
          (copy_position, 0, 3),
          (agent_get_position, pos2, ":var0"),
          (try_begin),
            (get_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 500),
            (val_add, "$g_tutorial_training_ground_current_score", 1),
            (ge, "$g_tutorial_training_ground_current_score", 10),
            (assign, "$g_pointer_arrow_height_adder", -1000),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0x000000, 10),
            (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
            (play_sound, "snd_tutorial_2"),
          (try_end),
          (try_begin),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_get_position, pos1, ":var2"),
            (set_fixed_point_multiplier, 1),
            (position_get_x, ":var7", pos0),
            (position_get_x, ":var8", pos1),
            (position_get_y, ":var9", pos0),
            (position_get_y, ":var10", pos1),
            (this_or_next|neq, ":var7", ":var8"),
            (neq, ":var9", ":var10"),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 150),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (scene_prop_get_num_instances, ":var14", ":var11"),
          (try_begin),
            (lt, "$g_tutorial_training_ground_current_score", 6),
            (assign, ":var15", -1),
            (store_add, ":var16", "$g_tutorial_training_ground_current_score", 1),
            (try_for_range, ":var17", 0, ":var14"),
              (scene_prop_get_instance, ":var18", ":var11", ":var17"),
              (prop_instance_get_variation_id_2, ":var19", ":var18"),
              (eq, ":var16", ":var19"),
              (assign, ":var15", ":var18"),
              (assign, ":var14", 0),
            (try_end),
            (try_begin),
              (prop_instance_get_position, pos0, ":var15"),
              (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
              (prop_instance_get_position, pos1, ":var2"),
              (set_fixed_point_multiplier, 1),
              (position_get_x, ":var7", pos0),
              (position_get_x, ":var8", pos1),
              (position_get_y, ":var9", pos0),
              (position_get_y, ":var10", pos1),
              (this_or_next|neq, ":var7", ":var8"),
              (neq, ":var9", ":var10"),
              (prop_instance_set_position, ":var2", pos0),
              (assign, "$g_pointer_arrow_height_adder", 200),
              (play_sound, "snd_tutorial_1"),
            (try_end),
          (else_try),
            (assign, "$g_pointer_arrow_height_adder", -1000),
            (try_begin),
              (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (agent_unequip_item, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (try_end),
            (agent_unequip_item, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0x000000, 10),
            (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
            (play_sound, "snd_tutorial_2"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (mission_disable_talk),
      (try_begin),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_begin),
          (assign, "$g_last_destroyed_gourds", 0),
          (assign, "$g_tutorial_training_ground_current_score", 0),
          (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_archer_trainer_item_1", 0),
          (prop_instance_get_position, pos0, ":var1"),
          (position_move_z, pos0, 1000, 1),
          (prop_instance_set_position, ":var1", pos0),
          (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
          (prop_instance_set_position, ":var2", pos0),
          (assign, "$g_pointer_arrow_height_adder", 100),
          (try_begin),
            (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (prop_instance_get_position, pos0, ":var1"),
            (position_move_z, pos0, 1000, 1),
            (prop_instance_set_position, ":var1", pos0),
          (try_end),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 2),
        (try_begin),
          (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_1"),
          (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
          (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_archer_trainer_item_1"),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 3),
        (try_begin),
          (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_2"),
            (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_archer_trainer_item_2"),
            (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 4),
        (try_begin),
          (try_for_range, ":var3", 0, 3),
            (scene_prop_get_instance, ":var4", "spr_gourd", ":var3"),
            (prop_instance_refill_hit_points, ":var4"),
            (entry_point_get_position, pos0, 45),
            (init_position, pos1),
            (store_sub, ":var5", ":var3", 1),
            (val_mul, ":var5", 5),
            (position_rotate_z, pos1, ":var5"),
            (try_begin),
              (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
              (position_move_y, pos1, 1300),
            (else_try),
              (position_move_y, pos1, 800),
              (val_mul, ":var5", 2),
            (try_end),
            (position_transform_position_to_parent, pos2, pos0, pos1),
            (position_set_z_to_ground_level, pos2),
            (scene_prop_get_instance, ":var6", "spr_gourd_spike", ":var3"),
            (prop_instance_set_position, ":var6", pos2),
            (position_move_z, pos2, 150, 1),
            (prop_instance_set_position, ":var4", pos2),
          (try_end),
          (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
          (scene_prop_get_instance, ":var6", "spr_gourd_spike", 1),
          (prop_instance_get_position, pos1, ":var6"),
          (prop_instance_set_position, ":var2", pos1),
          (assign, "$g_pointer_arrow_height_adder", 200),
          (tutorial_message, "str_tutorial_training_ground_archer_text_2"),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 5),
        (try_begin),
          (try_begin),
            (neq, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
            (assign, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
            (try_begin),
              (lt, "$g_last_destroyed_gourds", 3),
              (play_sound, "snd_tutorial_1"),
            (else_try),
              (play_sound, "snd_tutorial_2"),
            (try_end),
          (try_end),
          (try_begin),
            (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
            (eq, "$g_last_destroyed_gourds", 0),
            (entry_point_get_position, pos0, 45),
            (agent_get_position, pos1, ":var0"),
            (neg|position_is_behind_position, pos1, pos0),
            (tutorial_message, "str_tutorial_training_ground_archer_text_3"),
          (else_try),
            (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
            (eq, "$g_last_destroyed_gourds", 1),
            (tutorial_message, "str_tutorial_training_ground_archer_text_4"),
          (try_end),
          (ge, "$g_last_destroyed_gourds", 3),
          (assign, "$g_pointer_arrow_height_adder", -1000),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 6),
        (try_begin),
          (try_begin),
            (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (agent_unequip_item, ":var0", "$g_tutorial_training_ground_archer_trainer_item_2"),
          (try_end),
          (agent_unequip_item, ":var0", "$g_tutorial_training_ground_archer_trainer_item_1"),
          (tutorial_message, "str_tutorial_training_ground_archer_text_5", 0x000000, 10),
          (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
          (val_add, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 1),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_attack"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (store_random_in_range, "$g_tutorial_training_ground_melee_state", 1, 5),
          (assign, "$g_tutorial_update_mouse_presentation", 1),
          (assign, "$g_tutorial_training_ground_next_score_time", 0),
        (try_end),
      (else_try),
        (gt, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination_no_attack, ":var3", pos1),
          (agent_get_attack_action, ":var5", ":var0"),
          (try_begin),
            (eq, ":var5", 2),
            (agent_get_action_dir, ":var6", ":var0"),
            (try_begin),
              (eq, ":var6", 0),
              (agent_set_defend_action, ":var3", 0, 1),
            (else_try),
              (eq, ":var6", 3),
              (agent_set_defend_action, ":var3", 3, 1),
            (else_try),
              (eq, ":var6", 1),
              (agent_set_defend_action, ":var3", 2, 1),
            (else_try),
              (eq, ":var6", 2),
              (agent_set_defend_action, ":var3", 1, 1),
            (try_end),
          (try_end),
          (try_begin),
            (ge, "$g_tutorial_training_ground_current_score", 5),
            (tutorial_message, -1),
            (assign, "$g_tutorial_training_ground_melee_state", 0),
            (agent_set_team, ":var0", 0),
            (agent_set_team, ":var3", 7),
            (agent_set_hit_points, ":var0", 100, 0),
            (agent_set_hit_points, ":var3", 100, 0),
            (assign, "$g_tutorial_training_ground_conversation_state", 9),
            (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_attack"),
            (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_get_attack_action, ":var5", ":var0"),
        (eq, ":var5", 2),
        (agent_get_action_dir, ":var6", ":var0"),
        (store_add, ":var7", ":var6", 1),
        (agent_get_wielded_item, ":var8", ":var0", 0),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var8"),
        (store_mission_timer_a, ":var9"),
        (gt, ":var9", "$g_tutorial_training_ground_next_score_time"),
        (try_begin),
          (eq, ":var7", "$g_tutorial_training_ground_melee_state"),
          (val_add, "$g_tutorial_training_ground_current_score", 1),
          (try_begin),
            (ge, "$g_tutorial_training_ground_current_score", 5),
            (assign, "$g_tutorial_training_ground_melee_state", 5),
            (play_sound, "snd_tutorial_2"),
          (else_try),
            (play_sound, "snd_tutorial_1"),
            (assign, ":var10", 100),
            (try_for_range, ":var11", 0, ":var10"),
              (store_random_in_range, ":var12", 1, 5),
              (neq, ":var12", "$g_tutorial_training_ground_melee_state"),
              (assign, "$g_tutorial_training_ground_melee_state", ":var12"),
              (assign, ":var10", 0),
            (try_end),
          (try_end),
          (assign, "$g_tutorial_update_mouse_presentation", 1),
        (else_try),
          (val_add, "$g_tutorial_training_ground_current_score_2", 1),
          (play_sound, "snd_tutorial_fail"),
        (try_end),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var9", 1),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (assign, reg1, "$g_tutorial_training_ground_current_score_2"),
      (str_clear, s0),
      (assign, "$g_tutorial_mouse_dir", -1),
      (assign, "$g_tutorial_mouse_click", -1),
      (try_begin),
        (neq, "$g_tutorial_training_ground_melee_state", 5),
        (store_mission_timer_a, ":var9"),
        (this_or_next|eq, "$g_tutorial_update_mouse_presentation", 0),
        (gt, ":var9", "$g_tutorial_training_ground_next_score_time"),
        (try_begin),
          (eq, "$g_tutorial_training_ground_melee_state", 1),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_down"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 4),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_up"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 2),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_right"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 3),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_left"),
        (try_end),
        (store_sub, "$g_tutorial_mouse_dir", "$g_tutorial_training_ground_melee_state", 1),
        (assign, "$g_tutorial_mouse_click", 0),
        (try_begin),
          (eq, "$g_tutorial_update_mouse_presentation", 1),
          (assign, "$g_tutorial_update_mouse_presentation", 0),
          (start_presentation, "prsnt_tutorial_show_mouse_movement"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_get_wielded_item, ":var8", ":var0", 0),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var8"),
        (tutorial_message, "str_tutorial_training_ground_attack_training"),
      (else_try),
        (tutorial_message, "str_tutorial_training_ground_warning_melee"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_parry"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination_no_attack, ":var3", pos1),
          (agent_get_position, pos2, ":var3"),
          (get_sq_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 400),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_begin),
              (ge, "$g_tutorial_training_ground_current_score", 5),
              (assign, "$g_tutorial_mouse_dir", -1),
              (assign, "$g_tutorial_mouse_click", -1),
              (tutorial_message, -1),
              (assign, "$g_tutorial_training_ground_melee_state", 0),
              (agent_set_team, ":var0", 0),
              (agent_set_team, ":var3", 7),
              (agent_set_hit_points, ":var0", 100, 0),
              (agent_set_hit_points, ":var3", 100, 0),
              (assign, "$g_tutorial_training_ground_conversation_state", 1),
              (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
              (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
            (else_try),
              (store_random_in_range, ":var7", 0, 4),
              (agent_set_attack_action, ":var3", ":var7", 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (assign, "$g_tutorial_mouse_dir", ":var7"),
              (try_begin),
                (is_between, ":var7", 1, 3),
                (store_sub, "$g_tutorial_mouse_dir", 3, ":var7"),
              (try_end),
              (assign, "$g_tutorial_mouse_click", 1),
              (start_presentation, "prsnt_tutorial_show_mouse_movement"),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_get_defend_action, ":var8", ":var0"),
            (gt, ":var8", 0),
            (agent_get_action_dir, ":var9", ":var0"),
            (agent_get_action_dir, ":var10", ":var3"),
            (assign, ":var11", 0),
            (try_begin),
              (eq, ":var10", 0),
              (eq, ":var9", 0),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 3),
              (eq, ":var9", 3),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 1),
              (eq, ":var9", 2),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 2),
              (eq, ":var9", 1),
              (assign, ":var11", 1),
            (try_end),
            (eq, ":var11", 1),
            (assign, "$g_tutorial_mouse_dir", -1),
            (assign, "$g_tutorial_mouse_click", -1),
            (agent_set_attack_action, ":var3", 0, 0),
            (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
            (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_in_parried_animation, ":var3"),
        (agent_get_wielded_item, ":var12", ":var0", 1),
        (eq, ":var12", -1),
        (agent_get_wielded_item, ":var13", ":var0", 0),
        (neq, ":var13", "itm_practice_dagger"),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var13"),
        (store_mission_timer_a, ":var5"),
        (gt, ":var5", "$g_tutorial_training_ground_next_score_time"),
        (val_add, "$g_tutorial_training_ground_current_score", 1),
        (try_begin),
          (lt, "$g_tutorial_training_ground_current_score", 5),
          (play_sound, "snd_tutorial_1"),
        (else_try),
          (play_sound, "snd_tutorial_2"),
        (try_end),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var5", 1),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (try_begin),
        (agent_get_wielded_item, ":var12", ":var0", 1),
        (eq, ":var12", -1),
        (agent_get_wielded_item, ":var13", ":var0", 0),
        (neq, ":var13", "itm_practice_dagger"),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var13"),
        (tutorial_message, "str_tutorial_training_ground_parry_training"),
      (else_try),
        (neq, ":var12", -1),
        (tutorial_message, "str_tutorial_training_ground_warning_shield"),
      (else_try),
        (tutorial_message, "str_tutorial_training_ground_warning_melee_with_parry"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_chamber"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination_no_attack, ":var3", pos1),
          (agent_get_position, pos2, ":var3"),
          (get_sq_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 400),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_begin),
              (ge, "$g_tutorial_training_ground_current_score", 5),
              (tutorial_message, -1),
              (assign, "$g_tutorial_training_ground_melee_state", 0),
              (agent_set_team, ":var0", 0),
              (agent_set_team, ":var3", 7),
              (agent_set_hit_points, ":var0", 100, 0),
              (agent_set_hit_points, ":var3", 100, 0),
              (assign, "$g_tutorial_training_ground_conversation_state", 6),
              (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
              (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
            (else_try),
              (store_random_in_range, "$g_tutorial_training_ground_melee_trainer_attack_dir", 0, 4),
              (agent_set_attack_action, ":var3", "$g_tutorial_training_ground_melee_trainer_attack_dir", 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (agent_set_attack_action, ":var3", -1, 0),
              (agent_set_defend_action, ":var3", 0, 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (agent_set_attack_action, ":var3", "$g_tutorial_training_ground_melee_trainer_attack_dir", 0),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 3),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_in_parried_animation, ":var3"),
        (agent_get_attack_action, ":var7", ":var0"),
        (store_mission_timer_a, ":var5"),
        (gt, ":var5", "$g_tutorial_training_ground_next_score_time"),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var5", 1),
        (eq, ":var7", 1),
        (val_add, "$g_tutorial_training_ground_current_score", 1),
        (try_begin),
          (lt, "$g_tutorial_training_ground_current_score", 5),
          (play_sound, "snd_tutorial_1"),
        (else_try),
          (play_sound, "snd_tutorial_2"),
        (try_end),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (tutorial_message, "str_tutorial_training_ground_chamber_training"),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_combat"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_clear_scripted_mode, ":var3"),
          (agent_force_rethink, ":var3"),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (eq, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (eq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (mission_enable_talk),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var1", 10000000),
      (try_for_agents, ":var2"),
        (agent_get_troop_id, ":var3", ":var2"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
        (eq, ":var3", "trp_tutorial_fighter_4"),
        (agent_get_position, pos2, ":var2"),
        (get_sq_distance_between_positions, ":var4", pos1, pos2),
        (lt, ":var4", ":var1"),
        (assign, ":var1", ":var4"),
      (try_end),
      (try_begin),
        (le, ":var1", 1600),
        (assign, "$g_tutorial_training_ground_melee_paused", 1),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
          (eq, ":var3", "trp_tutorial_fighter_4"),
          (agent_set_team, ":var2", 7),
          (agent_get_position, pos2, ":var2"),
          (agent_set_scripted_destination, ":var2", pos2),
          (try_begin),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
            (agent_set_wielded_item, ":var2", -1),
          (try_end),
          (agent_force_rethink, ":var2"),
          (agent_set_look_target_agent, ":var2", ":var0"),
        (try_end),
      (else_try),
        (gt, "$g_tutorial_training_ground_melee_paused", 0),
        (assign, "$g_tutorial_training_ground_melee_paused", 0),
        (assign, "$g_tutorial_training_ground_melee_state", 0),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_paused", 0),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
          (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
          (try_for_range, ":var5", 0, 2),
            (try_begin),
              (ge, "$g_tutorial_training_ground_melee_last_winner", 0),
              (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_last_winner"),
              (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
            (try_end),
            (this_or_next|eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
            (eq, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
            (assign, ":var6", 0),
            (try_for_agents, ":var2"),
              (agent_get_troop_id, ":var3", ":var2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
              (eq, ":var3", "trp_tutorial_fighter_4"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_last_loser"),
              (val_add, ":var6", 1),
            (try_end),
            (store_random_in_range, ":var7", 0, ":var6"),
            (try_for_agents, ":var2"),
              (agent_get_troop_id, ":var3", ":var2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
              (eq, ":var3", "trp_tutorial_fighter_4"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_last_loser"),
              (val_sub, ":var7", 1),
              (lt, ":var7", 0),
              (try_begin),
                (eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
                (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", ":var2"),
              (else_try),
                (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", ":var2"),
              (try_end),
            (try_end),
          (try_end),
          (try_for_agents, ":var2"),
            (agent_get_troop_id, ":var3", ":var2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
            (eq, ":var3", "trp_tutorial_fighter_4"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
            (agent_set_wielded_item, ":var2", -1),
          (try_end),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 3),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var8"),
          (gt, ":var8", "$g_tutorial_training_ground_melee_next_action_time"),
          (try_for_agents, ":var2"),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, ":var3", ":var2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
            (eq, ":var3", "trp_tutorial_fighter_4"),
            (try_begin),
              (eq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (entry_point_get_position, pos1, 30),
              (agent_set_scripted_destination, ":var2", pos1),
            (else_try),
              (eq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (entry_point_get_position, pos1, 31),
              (agent_set_scripted_destination, ":var2", pos1),
            (else_try),
              (agent_get_slot, ":var9", ":var2", 8),
              (entry_point_get_position, pos1, ":var9"),
              (agent_set_scripted_destination, ":var2", pos1),
            (try_end),
          (try_end),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 2),
        (try_begin),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (entry_point_get_position, pos2, 30),
          (get_sq_distance_between_positions, ":var10", pos1, pos2),
          (lt, ":var10", 400),
          (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (entry_point_get_position, pos2, 31),
          (get_sq_distance_between_positions, ":var11", pos1, pos2),
          (lt, ":var11", 400),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 3),
        (try_begin),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (store_mission_timer_a, ":var8"),
          (gt, ":var8", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 1),
          (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 2),
          (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
        (try_end),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_1", 0, -1,
  "You enter the training ground.",
  [
    (0, mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_shield,itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows,itm_leather_jerkin,itm_leather_boots]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_1_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_1_state", 0),
      (assign, "$tutorial_1_msg_1_displayed", 0),
      (assign, "$tutorial_1_msg_2_displayed", 0),
      (assign, "$tutorial_1_msg_3_displayed", 0),
      (assign, "$tutorial_1_msg_4_displayed", 0),
      (assign, "$tutorial_1_msg_5_displayed", 0),
      (assign, "$tutorial_1_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_1_state", 0),
        (try_begin),
          (eq, "$tutorial_1_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_1_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_1"),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (entry_point_get_position, pos1, 1),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (tutorial_message, "str_tutorial_1_msg_1"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 2),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 1),
        (try_begin),
          (eq, "$tutorial_1_msg_2_displayed", 0),
          (assign, "$tutorial_1_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 3),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 2),
        (try_begin),
          (eq, "$tutorial_1_msg_3_displayed", 0),
          (assign, "$tutorial_1_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_3"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 4),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
      (else_try),
        (eq, "$tutorial_1_state", 3),
        (try_begin),
          (eq, "$tutorial_1_msg_4_displayed", 0),
          (assign, "$tutorial_1_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_4"),
          (store_mission_timer_a, "$tutorial_time"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (gt, ":var0", 10),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 4),
        (try_begin),
          (eq, "$tutorial_1_msg_5_displayed", 0),
          (assign, "$tutorial_1_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_5"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var2"),
          (agent_get_ammo, ":var5", ":var2"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var2"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 5),
        (eq, "$tutorial_1_msg_6_displayed", 0),
        (assign, "$tutorial_1_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_1_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_1_finished", 1),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_shield,itm_leather_jerkin,itm_leather_boots]),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_2_state", 9),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_2_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_2_state", 0),
      (assign, "$tutorial_2_msg_1_displayed", 0),
      (assign, "$tutorial_2_msg_2_displayed", 0),
      (assign, "$tutorial_2_msg_3_displayed", 0),
      (assign, "$tutorial_2_msg_4_displayed", 0),
      (assign, "$tutorial_2_msg_5_displayed", 0),
      (assign, "$tutorial_2_msg_6_displayed", 0),
      (assign, "$tutorial_2_msg_7_displayed", 0),
      (assign, "$tutorial_2_msg_8_displayed", 0),
      (assign, "$tutorial_2_msg_9_displayed", 0),
      (assign, "$tutorial_2_melee_agent_state", 0),
    ],
    []),

    (10, 0, 0, 
    [
      (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
      (agent_refill_ammo, reg0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_2_state", 0),
        (try_begin),
          (eq, "$tutorial_2_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_2_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_1"),
          (team_give_order, 1, 9, 11),
          (team_give_order, 1, 0, 2),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (ge, ":var2", 0),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 1),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 2),
        (get_player_agent_no, ":var2"),
        (agent_set_kick_allowed, ":var2", 0),
        (try_begin),
          (eq, "$tutorial_2_melee_agent_state", 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (agent_clear_scripted_mode, ":var1"),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (store_mission_timer_a, "$tutorial_time"),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 2),
          (try_begin),
            (eq, "$tutorial_2_msg_2_displayed", 0),
            (assign, "$tutorial_2_msg_2_displayed", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (store_mission_timer_a, ":var0"),
          (val_sub, ":var0", "$tutorial_time"),
          (store_sub, reg3, 20, ":var0"),
          (tutorial_message, "str_tutorial_2_msg_2"),
          (gt, ":var0", 20),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 3),
          (try_begin),
            (eq, "$tutorial_2_msg_3_displayed", 0),
            (assign, "$tutorial_2_msg_3_displayed", 1),
            (tutorial_message, "str_tutorial_2_msg_3"),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 2),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 4),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 2),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 30),
          (agent_set_position, ":var1", pos1),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
          (prop_instance_get_position, pos1, ":var4"),
          (position_rotate_z, pos1, 90),
          (prop_instance_animate_to_position, ":var4", pos1, 150),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (val_add, "$tutorial_2_state", 1),
        (try_end),
      (else_try),
        (eq, "$tutorial_2_state", 3),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_set_kick_allowed, ":var2", 1),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (store_mission_timer_a, "$tutorial_time"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 4),
        (try_begin),
          (eq, "$tutorial_2_msg_4_displayed", 0),
          (assign, "$tutorial_2_msg_4_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_2_msg_4"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 5),
        (set_spawn_position, pos1),
        (spawn_item, "itm_tutorial_sword"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_set_position, ":var1", pos1),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 5),
        (try_begin),
          (eq, "$tutorial_2_msg_5_displayed", 0),
          (assign, "$tutorial_2_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 2),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 6),
        (try_begin),
          (eq, "$tutorial_2_msg_6_displayed", 0),
          (assign, "$tutorial_2_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_has_item_equipped, ":var2", "itm_tutorial_sword"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 7),
        (try_begin),
          (eq, "$tutorial_2_msg_7_displayed", 0),
          (assign, "$tutorial_2_msg_7_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_7"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (agent_clear_scripted_mode, ":var1"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 4),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 8),
        (try_begin),
          (eq, "$tutorial_2_msg_8_displayed", 0),
          (assign, "$tutorial_2_msg_8_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_8"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 9),
        (eq, "$tutorial_2_msg_9_displayed", 0),
        (assign, "$tutorial_2_msg_9_displayed", 1),
        (tutorial_message, "str_tutorial_2_msg_9"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_2_finished", 1),
      (else_try),
        (gt, "$tutorial_2_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_3", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_leather_jerkin,itm_leather_boots]),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 12),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
      (assign, "$tutorial_3_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_item, "itm_tutorial_staff_no_attack"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (ge, ":var2", 0),
        (agent_has_item_equipped, ":var2", "itm_tutorial_staff_no_attack"),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (get_player_agent_no, ":var2"),
        (agent_set_kick_allowed, ":var2", 0),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_3"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 6),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 3),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 7),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 8),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 9),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 10),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 11),
        (try_begin),
          (eq, "$tutorial_3_msg_5_displayed", 0),
          (assign, "$tutorial_3_msg_5_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_5"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 12),
        (try_begin),
          (eq, "$tutorial_3_msg_6_displayed", 0),
          (assign, "$tutorial_3_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 5),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 13),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 5),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_3_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_staff,itm_leather_jerkin,itm_leather_boots]),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_1"),
          (play_sound, "snd_tutorial_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (neg|agent_is_alive, reg0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (neg|agent_is_alive, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (eq, "$tutorial_3_msg_5_displayed", 0),
        (assign, "$tutorial_3_msg_5_displayed", 1),
        (tutorial_message, "str_tutorial_3_2_msg_5"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_3_finished", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_4", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows,itm_leather_jerkin,itm_leather_boots]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_4_state", 11),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 13),
    ]),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_4_state", 0),
      (assign, "$tutorial_4_msg_1_displayed", 0),
      (assign, "$tutorial_4_msg_2_displayed", 0),
      (assign, "$tutorial_4_msg_3_displayed", 0),
      (assign, "$tutorial_4_msg_4_displayed", 0),
      (assign, "$tutorial_4_msg_5_displayed", 0),
      (assign, "$tutorial_4_msg_6_displayed", 0),
      (assign, "$tutorial_4_msg_7_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_4_state", 0),
        (try_begin),
          (eq, "$tutorial_4_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_4_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_1"),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_horse, "itm_tutorial_saddle_horse"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (ge, ":var2", 0),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 2),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 1),
        (try_begin),
          (eq, "$tutorial_4_msg_2_displayed", 0),
          (assign, "$tutorial_4_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 3),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 2),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 3),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 4),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 3),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 4),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 5),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 4),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 5),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 1),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 6),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 7),
        (try_begin),
          (eq, "$tutorial_4_msg_3_displayed", 0),
          (assign, "$tutorial_4_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 8),
        (try_begin),
          (eq, "$tutorial_4_msg_4_displayed", 0),
          (assign, "$tutorial_4_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 2),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 8),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 9),
        (try_begin),
          (eq, "$tutorial_4_msg_5_displayed", 0),
          (assign, "$tutorial_4_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 8),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 10),
        (try_begin),
          (eq, "$tutorial_4_msg_6_displayed", 0),
          (assign, "$tutorial_4_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_6"),
          (play_sound, "snd_tutorial_1"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var1"),
          (agent_get_ammo, ":var5", ":var1"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var1"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_4_state", 1),
      (else_try),
        (eq, "$tutorial_4_state", 11),
        (eq, "$tutorial_4_msg_7_displayed", 0),
        (assign, "$tutorial_4_msg_7_displayed", 1),
        (tutorial_message, "str_tutorial_4_msg_7"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_4_finished", 1),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_5", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_tutorial_sword,itm_tutorial_shield,itm_tutorial_short_bow,itm_tutorial_arrows,itm_tutorial_saddle_horse,itm_leather_jerkin,itm_leather_boots]),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_5_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_5_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_5_state", 0),
      (assign, "$tutorial_5_msg_1_displayed", 0),
      (assign, "$tutorial_5_msg_2_displayed", 0),
      (assign, "$tutorial_5_msg_3_displayed", 0),
      (assign, "$tutorial_5_msg_4_displayed", 0),
      (assign, "$tutorial_5_msg_5_displayed", 0),
      (assign, "$tutorial_5_msg_6_displayed", 0),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, 0, 9, 11),
      (set_show_messages, 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_5_state", 0),
        (try_begin),
          (eq, "$tutorial_5_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_5_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_1"),
          (entry_point_get_position, pos1, 5),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 1),
        (try_begin),
          (eq, "$tutorial_5_msg_2_displayed", 0),
          (assign, "$tutorial_5_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 2),
        (try_begin),
          (eq, "$tutorial_5_msg_3_displayed", 0),
          (assign, "$tutorial_5_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (set_visitor, 5, "trp_vaegir_archer"),
        (set_visitor, 6, "trp_vaegir_archer"),
        (set_visitor, 7, "trp_vaegir_archer"),
        (entry_point_get_position, pos1, 11),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 12),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (set_show_messages, 0),
        (team_give_order, 0, 1, 11),
        (set_show_messages, 1),
      (else_try),
        (eq, "$tutorial_5_state", 3),
        (try_begin),
          (eq, "$tutorial_5_msg_4_displayed", 0),
          (assign, "$tutorial_5_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 1),
        (entry_point_get_position, pos2, 11),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 12),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (set_visitor, 8, "trp_bandit"),
        (set_visitor, 9, "trp_bandit"),
        (set_visitor, 10, "trp_bandit"),
        (set_visitor, 11, "trp_bandit"),
        (team_give_order, 1, 9, 2),
      (else_try),
        (eq, "$tutorial_5_state", 4),
        (try_begin),
          (eq, "$tutorial_5_msg_5_displayed", 0),
          (assign, "$tutorial_5_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (assign, ":var4", 0),
        (try_for_agents, ":var5"),
          (agent_is_human, ":var5"),
          (agent_is_alive, ":var5"),
          (agent_get_team, ":var6", ":var5"),
          (eq, ":var6", 1),
          (val_add, ":var4", 1),
        (try_end),
        (eq, ":var4", 0),
        (val_add, "$tutorial_5_state", 1),
      (else_try),
        (eq, "$tutorial_5_state", 5),
        (eq, "$tutorial_5_msg_6_displayed", 0),
        (assign, "$tutorial_5_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_5_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_5_finished", 1),
      (else_try),
        (gt, "$tutorial_5_state", 30),
        (tutorial_message, "str_tutorial_failed"),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (try_end),
    ],
    []),

  ]),

  ("quick_battle_battle", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 15),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (ge, "$emitters", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_attached_scene_prop, ":var1", ":var0"),
        (ge, ":var1", 1),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
        (scene_prop_get_slot, ":var3", ":var1", 53),
        (store_mission_timer_a, ":var4"),
        (store_sub, ":var5", ":var4", ":var3"),
        (ge, ":var5", 10),
        (prop_instance_receive_damage, ":var1", ":var0", 100),
        (val_sub, "$emitters", 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 10, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (assign, "$rethink_on_formation", 0),
      (assign, "$autorotate_at_player", 1),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 0, 9),
          (store_add, ":var2", 176, ":var1"),
          (team_set_slot, ":var0", ":var2", -1),
          (store_add, ":var2", 239, ":var1"),
          (team_set_slot, ":var0", ":var2", 10),
          (store_add, ":var2", 284, ":var1"),
          (team_set_slot, ":var0", ":var2", -1),
          (store_add, ":var2", 212, ":var1"),
          (team_set_slot, ":var0", ":var2", 1),
        (try_end),
      (try_end),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (call_script, "script_store_battlegroup_data"),
      (store_sub, ":var0", "fac_kingdoms_end", "fac_player_supporters_faction"),
      (store_mul, ":var1", 4, ":var0"),
      (try_for_range, ":var2", 0, ":var1"),
        (team_set_slot, 7, ":var2", 0),
      (try_end),
      (try_for_agents, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_team, ":var4", ":var3"),
        (agent_get_troop_id, ":var5", ":var3"),
        (store_faction_of_troop, ":var6", ":var5"),
        (is_between, ":var6", "fac_player_supporters_faction", "fac_kingdoms_end"),
        (store_mul, ":var2", ":var4", ":var0"),
        (val_sub, ":var6", "fac_player_supporters_faction"),
        (val_add, ":var2", ":var6"),
        (team_get_slot, ":var7", 7, ":var2"),
        (val_add, ":var7", 1),
        (team_set_slot, 7, ":var2", ":var7"),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (team_slot_ge, ":var8", 5, 1),
        (team_get_leader, ":var9", ":var8"),
        (try_begin),
          (ge, ":var9", 0),
          (agent_get_troop_id, ":var10", ":var9"),
          (store_faction_of_troop, ":var11", ":var10"),
        (else_try),
          (assign, ":var11", 0),
          (assign, ":var12", 0),
          (store_mul, ":var13", ":var8", ":var0"),
          (store_add, ":var1", ":var13", ":var0"),
          (try_for_range, ":var2", ":var13", ":var1"),
            (team_get_slot, ":var7", 7, ":var2"),
            (gt, ":var7", ":var12"),
            (assign, ":var12", ":var7"),
            (store_sub, ":var11", ":var13", ":var2"),
            (val_add, ":var11", "fac_player_supporters_faction"),
          (try_end),
        (try_end),
        (team_set_slot, ":var8", 1, ":var11"),
      (try_end),
    ]),

    (0.1, 0, 0, 
    [
      (neq, "$when_f1_first_detected", 0),
      (store_mission_timer_c_msec, reg0),
      (val_sub, reg0, "$when_f1_first_detected"),
      (ge, reg0, 250),
      (party_slot_eq, "p_main_party", 108, 23),
    ],
    [
      (assign, "$when_f1_first_detected", 0),
      (try_begin),
        (game_key_is_down, gk_order_1),
        (party_set_slot, p_camp_bandits, 108, 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, p_camp_bandits, 108, 1),
        (call_script, "script_player_order_formations", 0),
        (party_set_slot, "p_main_party", 108, 0),
        (party_set_slot, p_camp_bandits, 108, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (neg|main_hero_fallen),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (store_mission_timer_c_msec, "$last_player_trigger"),
      (try_begin),
        (try_for_range, ":var0", 0, 4),
          (try_for_range, ":var1", 0, 9),
            (store_add, ":var2", 176, ":var1"),
            (this_or_next|team_slot_eq, ":var0", ":var2", 4),
            (team_slot_eq, ":var0", ":var2", 5),
            (team_set_slot, ":var0", ":var2", -1),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_store_battlegroup_data"),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (assign, ":var3", reg0),
      (try_begin),
        (eq, ":var3", 0),
        (try_for_range, ":var1", 0, 9),
          (call_script, "script_formation_end", "$fplayer_team_no", ":var1"),
        (try_end),
      (try_end),
      (gt, ":var3", 0),
      (call_script, "script_division_reset_places"),
      (try_begin),
        (party_slot_eq, p_camp_bandits, 108, 2),
        (neg|game_key_is_down, gk_order_1),
        (assign, ":var4", 0),
        (try_for_range, ":var1", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var1"),
          (store_add, ":var2", 284, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", -1),
          (store_add, ":var2", 14, ":var1"),
          (team_slot_ge, "$fplayer_team_no", ":var2", 1),
          (store_add, ":var2", 212, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", 1),
          (team_get_order_position, pos1, "$fplayer_team_no", ":var1"),
          (val_add, ":var4", 1),
        (try_end),
        (gt, ":var4", 0),
        (copy_position, 16, 1),
        (assign, ":var5", 1000000),
        (try_for_range, ":var0", 0, 4),
          (teams_are_enemies, ":var0", "$fplayer_team_no"),
          (team_slot_ge, ":var0", 5, 1),
          (try_for_range, ":var1", 0, 9),
            (store_add, ":var2", 14, ":var1"),
            (team_slot_ge, ":var0", ":var2", 1),
            (call_script, "script_battlegroup_get_position", 28, ":var0", ":var1"),
            (get_distance_between_positions, reg0, pos16, pos28),
            (gt, ":var5", reg0),
            (assign, ":var5", reg0),
            (assign, ":var6", ":var0"),
            (assign, ":var7", ":var1"),
          (try_end),
        (try_end),
        (call_script, "script_battlegroup_get_action_radius", ":var6", ":var7"),
        (assign, ":var8", reg0),
        (try_begin),
          (le, ":var5", ":var8"),
          (call_script, "script_battlegroup_get_position", 16, ":var6", ":var7"),
          (gt, ":var4", 1),
          (store_add, ":var2", 176, ":var7"),
          (team_get_slot, reg0, ":var6", ":var2"),
          (call_script, "script_str_store_division_type_name", 1, reg0),
          (display_message, "@...and attack enemy {s1} division!"),
        (try_end),
        (call_script, "script_point_y_toward_position", 16, 24),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var1", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var1"),
          (store_add, ":var2", 14, ":var1"),
          (team_get_slot, ":var9", "$fplayer_team_no", ":var2"),
          (gt, ":var9", 0),
          (try_begin),
            (le, ":var5", ":var8"),
            (store_add, ":var2", 284, ":var1"),
            (team_set_slot, "$fplayer_team_no", ":var2", ":var6"),
            (store_add, ":var2", 293, ":var1"),
            (team_set_slot, "$fplayer_team_no", ":var2", ":var7"),
          (try_end),
          (store_add, ":var2", 185, ":var1"),
          (team_get_slot, ":var10", "$fplayer_team_no", ":var2"),
          (try_begin),
            (gt, ":var4", 1),
            (agent_set_position, "$fplayer_agent_no", pos16),
            (call_script, "script_player_attempt_formation", ":var1", ":var10", 1),
          (else_try),
            (try_begin),
              (le, ":var5", ":var8"),
              (call_script, "script_battlegroup_get_attack_destination", 16, "$fplayer_team_no", ":var1", ":var6", ":var7"),
              (store_add, ":var2", 176, ":var7"),
              (team_get_slot, reg0, ":var6", ":var2"),
              (call_script, "script_str_store_division_type_name", 1, reg0),
              (display_message, "@...and attack enemy {s1} division!"),
            (try_end),
            (neq, ":var10", 0),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var1", 16),
            (store_add, ":var2", 194, ":var1"),
            (team_get_slot, ":var11", "$fplayer_team_no", ":var2"),
            (try_begin),
              (store_add, ":var2", 176, ":var1"),
              (team_get_slot, ":var12", "$fplayer_team_no", ":var2"),
              (neq, ":var12", 2),
              (neq, ":var12", 5),
              (call_script, "script_get_centering_amount", ":var10", ":var9", ":var11"),
              (try_begin),
                (eq, ":var12", 1),
                (val_mul, reg0, -1),
                (assign, ":var13", "script_form_archers"),
              (else_try),
                (assign, ":var13", "script_form_infantry"),
              (try_end),
              (position_move_x, 16, reg0),
            (else_try),
              (assign, ":var13", "script_form_cavalry"),
            (try_end),
            (copy_position, 1, 16),
            (call_script, ":var13", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11", ":var10"),
          (try_end),
          (store_add, ":var2", 203, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", 0),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, p_camp_bandits, 108, 0),
      (try_end),
      (try_begin),
        (gt, "$rethink_on_formation", 0),
        (try_for_agents, ":var14"),
          (agent_force_rethink, ":var14"),
        (try_end),
        (assign, "$rethink_on_formation", 0),
      (try_end),
      (assign, "$autorotate_at_player", 0),
      (try_for_range, ":var1", 0, 9),
        (store_add, ":var2", 14, ":var1"),
        (team_get_slot, ":var9", "$fplayer_team_no", ":var2"),
        (gt, ":var9", 0),
        (store_add, ":var2", 284, ":var1"),
        (team_get_slot, ":var15", "$fplayer_team_no", ":var2"),
        (store_add, ":var2", 293, ":var1"),
        (team_get_slot, ":var16", "$fplayer_team_no", ":var2"),
        (try_begin),
          (ge, ":var15", 0),
          (store_add, ":var2", 14, ":var16"),
          (team_get_slot, reg0, ":var15", ":var2"),
          (le, reg0, 0),
          (store_add, ":var2", 284, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", -1),
          (store_add, ":var2", 176, ":var16"),
          (team_get_slot, reg0, ":var15", ":var2"),
          (call_script, "script_str_store_division_type_name", 1, reg0),
          (str_store_class_name, 2, ":var1"),
          (display_message, "@{s2}: returning after destroying enemy {s1} division."),
          (store_add, ":var2", 203, ":var1"),
          (team_set_slot, "$fplayer_team_no", ":var2", 1),
        (try_end),
        (store_add, ":var2", 212, ":var1"),
        (team_get_slot, ":var17", "$fplayer_team_no", ":var2"),
        (store_mod, ":var18", ":var17", 4),
        (val_add, ":var17", 1),
        (team_set_slot, "$fplayer_team_no", ":var2", ":var17"),
        (try_begin),
          (store_add, ":var2", 203, ":var1"),
          (team_slot_eq, "$fplayer_team_no", ":var2", 1),
          (try_begin),
            (eq, 0, 1),
            (call_script, "script_battlegroup_place_around_leader", "$fplayer_team_no", ":var1"),
          (else_try),
            (call_script, "script_battlegroup_place_at_leader", "$fplayer_team_no", ":var1"),
          (try_end),
          (team_set_slot, "$fplayer_team_no", ":var2", 1),
        (else_try),
          (eq, ":var18", 0),
          (team_get_movement_order, reg0, "$fplayer_team_no", ":var1"),
          (neq, reg0, 11),
          (store_add, ":var2", 185, ":var1"),
          (team_get_slot, ":var10", "$fplayer_team_no", ":var2"),
          (try_begin),
            (neq, ":var10", 0),
            (store_add, ":var2", 194, ":var1"),
            (team_get_slot, ":var11", "$fplayer_team_no", ":var2"),
            (store_add, ":var2", 176, ":var1"),
            (team_get_slot, ":var12", "$fplayer_team_no", ":var2"),
            (try_begin),
              (ge, ":var15", 0),
              (try_begin),
                (this_or_next|eq, ":var12", 1),
                (this_or_next|eq, ":var12", 5),
                (eq, ":var12", 4),
                (store_add, ":var2", 104, ":var1"),
                (team_slot_eq, "$fplayer_team_no", ":var2", 1),
                (call_script, "script_formation_current_position", 1, "$fplayer_team_no", ":var1"),
              (else_try),
                (call_script, "script_battlegroup_get_attack_destination", 1, "$fplayer_team_no", ":var1", ":var15", ":var16"),
              (try_end),
            (else_try),
              (call_script, "script_get_formation_destination", 1, "$fplayer_team_no", ":var1"),
              (try_begin),
                (neq, ":var12", 2),
                (neq, ":var12", 5),
                (position_move_y, pos1, -2000),
              (try_end),
              (call_script, "script_point_y_toward_position", 1, 24),
              (try_begin),
                (neq, ":var12", 2),
                (neq, ":var12", 5),
                (position_move_y, pos1, 2000),
              (try_end),
            (try_end),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var1", 1),
            (try_begin),
              (neq, ":var12", 2),
              (neq, ":var12", 5),
              (call_script, "script_get_centering_amount", ":var10", ":var9", ":var11"),
              (try_begin),
                (eq, ":var12", 1),
                (val_mul, reg0, -1),
              (try_end),
              (position_move_x, 1, reg0),
            (try_end),
            (try_begin),
              (eq, ":var12", 1),
              (call_script, "script_form_archers", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11", ":var10"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (eq, ":var12", 5),
              (try_begin),
                (ge, ":var15", 0),
                (call_script, "script_formation_current_position", 29, "$fplayer_team_no", ":var1"),
                (call_script, "script_battlegroup_get_position", 24, ":var15", ":var16"),
                (get_distance_between_positions, ":var5", pos29, pos24),
                (call_script, "script_battlegroup_get_action_radius", "$fplayer_team_no", ":var1"),
                (assign, ":var19", reg0),
                (call_script, "script_battlegroup_get_action_radius", ":var15", ":var16"),
                (val_add, ":var19", reg0),
                (le, ":var5", ":var19"),
                (call_script, "script_formation_end", "$fplayer_team_no", ":var1"),
                (str_store_class_name, 1, ":var1"),
                (display_message, "@{s1}: cavalry formation disassembled."),
                (set_show_messages, 0),
                (team_give_order, "$fplayer_team_no", ":var1", 2),
                (set_show_messages, 1),
              (else_try),
                (call_script, "script_form_cavalry", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11"),
              (try_end),
            (else_try),
              (call_script, "script_form_infantry", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var11", ":var10"),
            (try_end),
            (val_add, "$rethink_on_formation", 1),
          (else_try),
            (ge, ":var15", 0),
            (store_add, ":var2", 293, ":var1"),
            (team_get_slot, ":var16", "$fplayer_team_no", ":var2"),
            (try_begin),
              (this_or_next|eq, ":var12", 1),
              (this_or_next|eq, ":var12", 5),
              (eq, ":var12", 4),
              (store_add, ":var2", 104, ":var1"),
              (team_slot_eq, "$fplayer_team_no", ":var2", 1),
              (call_script, "script_battlegroup_get_position", 1, "$fplayer_team_no", ":var1"),
            (else_try),
              (call_script, "script_battlegroup_get_attack_destination", 1, "$fplayer_team_no", ":var1", ":var15", ":var16"),
            (try_end),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var1", 1),
            (team_get_movement_order, ":var20", "$fplayer_team_no", ":var1"),
            (try_begin),
              (ge, ":var15", 0),
              (call_script, "script_battlegroup_get_position", 29, "$fplayer_team_no", ":var1"),
              (call_script, "script_battlegroup_get_position", 24, ":var15", ":var16"),
              (get_distance_between_positions, ":var5", pos29, pos24),
              (call_script, "script_battlegroup_get_action_radius", "$fplayer_team_no", ":var1"),
              (assign, ":var19", reg0),
              (call_script, "script_battlegroup_get_action_radius", ":var15", ":var16"),
              (val_add, ":var19", reg0),
              (le, ":var5", ":var19"),
              (try_begin),
                (neq, ":var20", 2),
                (set_show_messages, 0),
                (team_give_order, "$fplayer_team_no", ":var1", 2),
                (set_show_messages, 1),
              (try_end),
            (else_try),
              (neq, ":var20", 0),
              (set_show_messages, 0),
              (team_give_order, "$fplayer_team_no", ":var1", 0),
              (set_show_messages, 1),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, "$autorotate_at_player", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_fix_division", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 83, 1),
    ],
    [
      (assign, "$ranged_clock", 1),
      (assign, "$battle_phase", 1),
      (init_position, pos51),
      (init_position, pos53),
      (init_position, pos54),
      (init_position, pos55),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 83, 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 15, 0),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var1", 0, 4),
        (call_script, "script_battlegroup_get_position", 0, ":var1", 9),
        (position_get_x, reg0, pos0),
        (team_set_slot, ":var1", 2, reg0),
        (position_get_y, reg0, pos0),
        (team_set_slot, ":var1", 3, reg0),
        (neq, ":var1", "$fplayer_team_no"),
        (store_add, ":var2", 185, 1),
        (team_set_slot, ":var1", ":var2", 0),
      (try_end),
      (call_script, "script_field_tactics", 1),
    ]),

    (0.1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 83, 1),
    ],
    [
      (store_mission_timer_c_msec, reg0),
      (val_sub, reg0, "$last_player_trigger"),
      (ge, reg0, 250),
      (val_add, "$last_player_trigger", 500),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),
      (try_begin),
        (lt, "$battle_phase", 3),
        (call_script, "script_cf_count_casualties"),
        (assign, "$battle_phase", 3),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
      (else_try),
        (eq, "$battle_phase", 1),
        (call_script, "script_field_tactics", 0),
      (else_try),
        (call_script, "script_field_tactics", 1),
        (ge, "$battle_phase", 3),
        (store_mul, reg1, 5, 4),
        (store_mod, reg0, "$ranged_clock", reg1),
        (eq, reg0, 0),
        (try_begin),
          (neg|team_slot_eq, 0, 4, "$defender_reinforcement_stage"),
          (team_set_slot, 0, 4, "$defender_reinforcement_stage"),
          (try_for_range, ":var0", 0, 9),
            (store_add, ":var1", 176, ":var0"),
            (team_set_slot, 0, ":var1", -1),
            (team_set_slot, 2, ":var1", -1),
          (try_end),
        (try_end),
        (try_begin),
          (neg|team_slot_eq, 1, 4, "$attacker_reinforcement_stage"),
          (team_set_slot, 1, 4, "$attacker_reinforcement_stage"),
          (try_for_range, ":var0", 0, 9),
            (store_add, ":var1", 176, ":var0"),
            (team_set_slot, 1, ":var1", -1),
            (team_set_slot, 3, ":var1", -1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 1),
        (assign, ":var2", 0),
        (try_for_range, ":var3", 0, 4),
          (neq, ":var3", "$fplayer_team_no"),
          (team_slot_ge, ":var3", 5, 1),
          (call_script, "script_battlegroup_get_position", 1, ":var3", 1),
          (team_get_order_position, pos0, ":var3", 1),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":var2", 1),
        (try_end),
        (eq, ":var2", 0),
        (assign, "$battle_phase", 2),
      (try_end),
      (val_add, "$ranged_clock", 1),
    ]),

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
      (party_slot_eq, "p_main_party", 83, 1),
      (party_slot_eq, "p_main_party", 86, 2),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (call_script, "script_agent_fix_division", ":var0"),
      (try_end),
      (set_show_messages, 0),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
      (team_give_order, "$fplayer_team_no", 9, 10),
      (team_give_order, "$fplayer_team_no", 9, 13),
      (set_show_messages, 1),
    ]),

  ]),

  ("quick_battle_siege", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$mana_boost_activated", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 15),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (ge, "$emitters", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_attached_scene_prop, ":var1", ":var0"),
        (ge, ":var1", 1),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
        (scene_prop_get_slot, ":var3", ":var1", 53),
        (store_mission_timer_a, ":var4"),
        (store_sub, ":var5", ":var4", ":var3"),
        (ge, ":var5", 10),
        (prop_instance_receive_damage, ":var1", ":var0", 100),
        (val_sub, "$emitters", 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 10, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    []),

    (0, 2, ti_once, 
    [
      (call_script, "script_cf_siege_rotate_belfry_platform"),
    ],
    [
      (assign, "$belfry_positioned", 3),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (set_show_messages, 1),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("multiplayer_dm", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 0),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (multiplayer_make_everyone_enemy),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_get_my_player, ":var0"),
        (is_between, ":var0", 0, 1000),
        (player_get_team_no, ":var1", ":var0"),
        (lt, ":var1", 2),
        (player_get_kill_count, ":var2", ":var0"),
        (player_get_death_count, ":var3", ":var0"),
        (store_mul, ":var4", ":var2", 1000),
        (val_sub, ":var4", ":var3"),
        (assign, ":var5", 1),
        (get_max_players, ":var6"),
        (assign, ":var7", ":var6"),
        (try_for_range, ":var8", 0, ":var7"),
          (player_is_active, ":var8"),
          (player_get_team_no, ":var9", ":var8"),
          (this_or_next|eq, ":var9", 0),
          (eq, ":var9", 1),
          (player_get_kill_count, ":var2", ":var8"),
          (player_get_death_count, ":var3", ":var8"),
          (store_mul, ":var10", ":var2", 1000),
          (val_sub, ":var10", ":var3"),
          (gt, ":var10", ":var4"),
          (assign, ":var5", 0),
          (assign, ":var7", 0),
        (try_end),
        (eq, ":var5", 1),
        (unlock_achievement, 68),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (store_random_in_range, ":var1", 0, ":var0"),
        (val_sub, ":var1", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var2", 0),
          (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
        (else_try),
          (assign, ":var2", 1),
          (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
        (try_end),
        (team_get_faction, ":var3", ":var2"),
        (assign, ":var4", 0),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_add, ":var4", 1),
        (try_end),
        (store_random_in_range, ":var7", 0, ":var4"),
        (assign, ":var8", "trp_swadian_crossbowman_multiplayer"),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", ":var8"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_sub, ":var7", 1),
          (lt, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", ":var5"),
        (try_end),
        (troop_get_inventory_slot, ":var10", ":var9", ek_horse),
        (try_begin),
          (ge, ":var10", 0),
          (assign, ":var11", 1),
        (else_try),
          (assign, ":var11", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var11"),
        (store_current_scene, ":var12"),
        (modify_visitors_at_site, ":var12"),
        (add_visitors_to_current_scene, reg0, ":var9", 1, ":var2", -1),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (store_mul, ":var2", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var1", ":var2"),
        (assign, ":var0", 1),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart_deathmatch"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_tdm", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 1),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_get_my_player, ":var0"),
        (is_between, ":var0", 0, 1000),
        (player_get_team_no, ":var1", ":var0"),
        (lt, ":var1", 2),
        (team_get_score, ":var2", 0),
        (team_get_score, ":var3", 1),
        (assign, ":var4", 0),
        (try_begin),
          (eq, ":var1", 0),
          (gt, ":var2", ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (eq, ":var1", 1),
          (gt, ":var3", ":var2"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (unlock_achievement, 67),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (ge, ":var1", 0),
        (agent_is_human, ":var0"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (le, ":var2", 1),
        (agent_get_team, ":var3", ":var0"),
        (neq, ":var2", ":var3"),
        (team_get_score, ":var4", ":var2"),
        (val_add, ":var4", 1),
        (team_set_score, ":var2", ":var4"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 1, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_hq", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 5),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (store_mul, ":var0", "$g_multiplayer_game_max_points", 10000),
      (assign, "$g_score_team_1", ":var0"),
      (assign, "$g_score_team_2", ":var0"),
      (try_for_range, ":var1", 146, 156),
        (troop_set_slot, "trp_multiplayer_data", ":var1", -1),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (try_for_range, ":var1", 176, 186),
          (troop_set_slot, "trp_multiplayer_data", ":var1", -1),
        (try_end),
      (try_end),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (try_begin),
        (multiplayer_is_server),
        (team_set_score, 0, "$g_multiplayer_game_max_points"),
        (team_set_score, 1, "$g_multiplayer_game_max_points"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, "$team_1_flag_scene_prop"),
      (set_spawn_effector_scene_prop_kind, 1, "$team_2_flag_scene_prop"),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (assign, "$g_number_of_flags", 0),
        (entry_point_get_position, pos1, 64),
        (entry_point_get_position, pos3, 64),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_flag_gray_code_only", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
        (val_add, "$g_number_of_flags", 1),
        (entry_point_get_position, pos2, 65),
        (entry_point_get_position, pos3, 65),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_flag_gray_code_only", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 2),
        (val_add, "$g_number_of_flags", 1),
        (scene_prop_get_num_instances, ":var1", "spr_headquarters_flag_red"),
        (scene_prop_get_num_instances, ":var2", "spr_headquarters_flag_blue"),
        (scene_prop_get_num_instances, ":var3", "spr_headquarters_flag_gray"),
        (store_add, ":var4", "spr_headquarters_flag_gray", 1),
        (try_for_range, ":var5", "spr_headquarters_flag_red", ":var4"),
          (try_begin),
            (eq, ":var5", "spr_headquarters_flag_red"),
            (assign, ":var6", ":var1"),
          (else_try),
            (eq, ":var5", "spr_headquarters_flag_blue"),
            (assign, ":var6", ":var2"),
          (else_try),
            (eq, ":var5", "spr_headquarters_flag_gray"),
            (assign, ":var6", ":var3"),
          (try_end),
          (gt, ":var6", 0),
          (try_for_range, ":var7", 0, ":var6"),
            (scene_prop_get_instance, ":var8", ":var5", ":var7"),
            (prop_instance_get_position, pos0, ":var8"),
            (set_spawn_position, pos0),
            (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
            (try_for_range, ":var9", "spr_headquarters_flag_red", ":var4"),
              (set_spawn_position, pos0),
              (try_begin),
                (eq, ":var9", "spr_headquarters_flag_red"),
                (spawn_scene_prop, "$team_1_flag_scene_prop"),
              (else_try),
                (eq, ":var9", "spr_headquarters_flag_blue"),
                (spawn_scene_prop, "$team_2_flag_scene_prop"),
              (else_try),
                (eq, ":var9", "spr_headquarters_flag_gray"),
                (spawn_scene_prop, "spr_headquarters_flag_gray_code_only"),
              (try_end),
            (try_end),
            (store_add, ":var0", 146, "$g_number_of_flags"),
            (try_begin),
              (eq, ":var5", "spr_headquarters_flag_red"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
            (else_try),
              (eq, ":var5", "spr_headquarters_flag_blue"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 2),
            (else_try),
              (eq, ":var5", "spr_headquarters_flag_gray"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 0),
            (try_end),
            (val_add, "$g_number_of_flags", 1),
          (try_end),
        (try_end),
        (assign, "$g_number_of_initial_team_1_flags", 0),
        (assign, "$g_number_of_initial_team_2_flags", 0),
        (try_for_range, ":var10", 0, "$g_number_of_flags"),
          (store_add, ":var0", 146, ":var10"),
          (troop_get_slot, ":var11", "trp_multiplayer_data", ":var0"),
          (try_begin),
            (eq, ":var10", 0),
            (entry_point_get_position, pos0, 64),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (assign, "$g_base_flag_team_1", ":var8"),
          (else_try),
            (eq, ":var10", 1),
            (entry_point_get_position, pos0, 65),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (assign, "$g_base_flag_team_2", ":var8"),
          (else_try),
            (assign, ":var12", 2),
            (scene_prop_get_num_instances, ":var13", "spr_headquarters_flag_red"),
            (store_add, ":var14", ":var12", ":var13"),
            (scene_prop_get_num_instances, ":var15", "spr_headquarters_flag_blue"),
            (store_add, ":var16", ":var14", ":var15"),
            (scene_prop_get_num_instances, ":var17", "spr_headquarters_flag_gray"),
            (try_begin),
              (ge, ":var10", ":var12"),
              (gt, ":var13", 0),
              (store_sub, ":var18", ":var10", ":var12"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_red", ":var18"),
            (else_try),
              (ge, ":var10", ":var14"),
              (gt, ":var15", 0),
              (store_sub, ":var18", ":var10", ":var14"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_blue", ":var18"),
            (else_try),
              (ge, ":var10", ":var16"),
              (gt, ":var17", 0),
              (store_sub, ":var18", ":var10", ":var16"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray", ":var18"),
            (try_end),
            (prop_instance_get_position, pos0, ":var8"),
          (try_end),
          (scene_prop_get_instance, ":var19", "spr_headquarters_pole_code_only", ":var10"),
          (prop_instance_set_position, ":var19", pos0),
          (position_move_z, pos0, 900),
          (try_begin),
            (eq, ":var11", 0),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 1),
          (else_try),
            (eq, ":var11", 1),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 1),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (val_add, "$g_number_of_initial_team_1_flags", 1),
          (else_try),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 1),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (val_add, "$g_number_of_initial_team_2_flags", 1),
          (try_end),
        (try_end),
      (else_try),
        (scene_prop_get_num_instances, ":var1", "spr_headquarters_flag_red"),
        (scene_prop_get_num_instances, ":var2", "spr_headquarters_flag_blue"),
        (scene_prop_get_num_instances, ":var3", "spr_headquarters_flag_gray"),
        (assign, "$g_number_of_flags", 2),
        (val_add, "$g_number_of_flags", ":var1"),
        (val_add, "$g_number_of_flags", ":var2"),
        (val_add, "$g_number_of_flags", ":var3"),
      (try_end),
      (try_for_range, ":var18", 0, ":var1"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_red", ":var18"),
        (scene_prop_set_visibility, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, ":var2"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_blue", ":var18"),
        (scene_prop_set_visibility, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, ":var3"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray", ":var18"),
        (scene_prop_set_visibility, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, "$g_number_of_flags"),
        (store_add, ":var20", 166, ":var18"),
        (troop_set_slot, "trp_multiplayer_data", ":var20", 0),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_get_my_player, ":var0"),
        (is_between, ":var0", 0, 1000),
        (player_get_team_no, ":var1", ":var0"),
        (lt, ":var1", 2),
        (call_script, "script_get_headquarters_scores"),
        (assign, ":var2", reg0),
        (assign, ":var3", reg1),
        (assign, ":var4", 0),
        (try_begin),
          (eq, ":var1", 0),
          (gt, ":var2", ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (eq, ":var1", 1),
          (gt, ":var3", ":var2"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (unlock_achievement, 61),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (multiplayer_is_server),
        (ge, ":var1", 0),
        (agent_is_human, ":var0"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (le, ":var2", 1),
        (agent_get_team, ":var3", ":var0"),
        (neq, ":var2", ":var3"),
        (team_get_score, ":var4", ":var3"),
        (try_begin),
          (eq, ":var2", 0),
          (val_add, "$g_score_team_2", -10000),
        (else_try),
          (val_add, "$g_score_team_1", -10000),
        (try_end),
        (val_sub, ":var4", 1),
        (get_max_players, ":var5"),
        (call_script, "script_team_set_score", ":var3", ":var4"),
        (try_for_range, ":var6", 1, ":var5"),
          (player_is_active, ":var6"),
          (multiplayer_send_2_int_to_player, ":var6", 72, ":var3", ":var4"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 166, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (val_add, ":var2", 1),
        (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
        (store_add, ":var3", 176, ":var0"),
        (troop_get_slot, ":var4", "trp_multiplayer_data", ":var3"),
        (store_mod, ":var5", ":var4", 100),
        (try_begin),
          (ge, ":var4", 100),
          (lt, ":var5", 25),
          (val_add, ":var4", 1),
          (troop_set_slot, "trp_multiplayer_data", ":var3", ":var4"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 156, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_div, ":var3", ":var2", 100),
        (store_mod, ":var4", ":var2", 100),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (get_max_players, ":var8"),
        (try_for_range, ":var9", 0, ":var8"),
          (player_is_active, ":var9"),
          (player_get_agent_id, ":var10", ":var9"),
          (ge, ":var10", 0),
          (agent_is_alive, ":var10"),
          (agent_get_team, ":var11", ":var10"),
          (agent_get_position, pos1, ":var10"),
          (get_sq_distance_between_positions, ":var12", pos0, pos1),
          (get_sq_distance_between_position_heights, ":var13", pos0, pos1),
          (val_add, ":var12", ":var13"),
          (lt, ":var12", 1600),
          (try_begin),
            (eq, ":var11", 0),
            (val_add, ":var5", 1),
          (else_try),
            (eq, ":var11", 1),
            (val_add, ":var6", 1),
          (try_end),
        (try_end),
        (try_begin),
          (this_or_next|neq, ":var3", ":var5"),
          (neq, ":var4", ":var6"),
          (store_add, ":var14", 146, ":var0"),
          (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
          (store_add, ":var16", 176, ":var0"),
          (troop_get_slot, ":var17", "trp_multiplayer_data", ":var16"),
          (store_mod, ":var18", ":var17", 100),
          (store_div, ":var19", ":var17", 100),
          (try_begin),
            (assign, ":var20", 0),
            (try_begin),
              (neq, ":var15", 1),
              (eq, ":var3", 0),
              (gt, ":var5", 0),
              (eq, ":var6", 0),
              (assign, ":var21", 1),
              (assign, ":var20", 1),
            (else_try),
              (neq, ":var15", 2),
              (eq, ":var4", 0),
              (eq, ":var5", 0),
              (gt, ":var6", 0),
              (assign, ":var21", 2),
              (assign, ":var20", 1),
            (try_end),
            (eq, ":var20", 1),
            (store_mul, ":var22", ":var21", 100),
            (troop_set_slot, "trp_multiplayer_data", ":var16", ":var22"),
            (this_or_next|neq, ":var19", ":var21"),
            (ge, ":var18", 25),
            (store_mul, ":var23", ":var21", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 10, ":var23"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 68, 10, ":var23"),
            (try_end),
          (try_end),
          (try_begin),
            (store_mul, ":var2", ":var5", 100),
            (val_add, ":var2", ":var6"),
            (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
            (call_script, "script_set_num_agents_around_flag", ":var0", ":var2"),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 73, ":var0", ":var2"),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (assign, ":var24", -1),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (store_add, ":var14", 146, ":var0"),
        (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
        (try_begin),
          (try_begin),
            (scene_prop_get_instance, ":var25", "$team_1_flag_scene_prop", ":var0"),
            (scene_prop_get_visibility, ":var26", ":var25"),
            (assign, ":var27", 1),
            (eq, ":var26", 0),
            (scene_prop_get_instance, ":var25", "$team_2_flag_scene_prop", ":var0"),
            (scene_prop_get_visibility, ":var26", ":var25"),
            (assign, ":var27", 2),
            (eq, ":var26", 0),
            (scene_prop_get_instance, ":var25", "spr_headquarters_flag_gray_code_only", ":var0"),
            (scene_prop_get_visibility, ":var26", ":var25"),
            (assign, ":var27", 0),
          (try_end),
          (prop_instance_get_position, pos1, ":var25"),
          (try_begin),
            (get_sq_distance_between_positions, ":var12", pos0, pos1),
            (lt, ":var12", 400),
            (store_add, ":var28", 156, ":var0"),
            (troop_get_slot, ":var29", "trp_multiplayer_data", ":var28"),
            (store_div, ":var5", ":var29", 100),
            (store_mod, ":var6", ":var29", 100),
            (try_begin),
              (gt, ":var5", 0),
              (eq, ":var6", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 1),
            (else_try),
              (eq, ":var5", 0),
              (gt, ":var6", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 2),
            (else_try),
              (eq, ":var5", 0),
              (eq, ":var6", 0),
              (neq, ":var27", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 0),
            (try_end),
          (else_try),
            (neq, ":var15", ":var27"),
            (get_sq_distance_between_positions, ":var12", pos0, pos1),
            (ge, ":var12", 8100),
            (store_add, ":var28", 156, ":var0"),
            (troop_get_slot, ":var29", "trp_multiplayer_data", ":var28"),
            (store_div, ":var5", ":var29", 100),
            (store_mod, ":var6", ":var29", 100),
            (try_begin),
              (eq, ":var27", 1),
              (assign, ":var24", 1),
              (assign, ":var30", 1),
            (else_try),
              (eq, ":var27", 2),
              (assign, ":var24", 2),
              (assign, ":var30", 2),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (ge, ":var24", 0),
          (this_or_next|neq, ":var24", ":var15"),
          (neq, ":var27", ":var30"),
          (try_begin),
            (neq, ":var15", 0),
            (eq, ":var24", 0),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var31", 2),
            (else_try),
              (eq, ":var15", 2),
              (assign, ":var31", 1),
            (try_end),
            (store_mul, ":var23", ":var31", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 8, ":var23"),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 68, 8, ":var23"),
            (try_end),
          (try_end),
          (try_begin),
            (neq, ":var15", ":var24"),
            (neq, ":var24", 0),
            (store_mul, ":var23", ":var24", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 9, ":var23"),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 68, 9, ":var23"),
            (try_end),
          (try_end),
          (call_script, "script_set_num_agents_around_flag", ":var0", ":var29"),
          (assign, ":var32", 0),
          (get_max_players, ":var8"),
          (try_for_range, ":var9", 1, ":var8"),
            (player_is_active, ":var9"),
            (multiplayer_send_2_int_to_player, ":var9", 73, ":var0", ":var29"),
            (val_add, ":var32", 1),
          (try_end),
          (store_mul, ":var33", ":var24", 100),
          (val_add, ":var33", ":var30"),
          (call_script, "script_change_flag_owner", ":var0", ":var33"),
          (try_for_range, ":var9", 1, ":var8"),
            (player_is_active, ":var9"),
            (multiplayer_send_2_int_to_player, ":var9", 75, ":var0", ":var33"),
          (try_end),
          (try_begin),
            (neq, ":var24", 0),
            (try_begin),
              (eq, ":var24", 1),
              (assign, ":var34", ":var5"),
            (else_try),
              (assign, ":var34", ":var6"),
            (try_end),
            (store_add, ":var35", 166, ":var0"),
            (troop_get_slot, ":var36", "trp_multiplayer_data", ":var35"),
            (troop_set_slot, "trp_multiplayer_data", ":var35", 0),
            (val_min, ":var36", 360),
            (scene_prop_get_instance, ":var37", "$team_1_flag_scene_prop", ":var0"),
            (scene_prop_get_instance, ":var38", "$team_2_flag_scene_prop", ":var0"),
            (try_begin),
              (this_or_next|eq, "$g_base_flag_team_1", ":var37"),
              (eq, "$g_base_flag_team_2", ":var38"),
              (assign, ":var39", 2),
            (else_try),
              (assign, ":var39", 1),
            (try_end),
            (try_begin),
              (le, ":var34", 1),
              (assign, ":var40", 3),
            (else_try),
              (eq, ":var34", 2),
              (assign, ":var40", 2),
            (else_try),
              (le, ":var34", 6),
              (assign, ":var40", 1),
            (else_try),
              (assign, ":var40", 0),
            (try_end),
            (store_mul, ":var41", ":var36", ":var32"),
            (val_mul, ":var41", ":var39"),
            (val_div, ":var41", 2),
            (try_begin),
              (gt, ":var34", 0),
              (store_div, ":var42", ":var41", ":var34"),
            (try_end),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 0, ":var8"),
              (player_is_active, ":var9"),
              (player_get_agent_id, ":var10", ":var9"),
              (ge, ":var10", 0),
              (agent_get_team, ":var11", ":var10"),
              (val_add, ":var11", 1),
              (eq, ":var11", ":var24"),
              (agent_get_position, pos1, ":var10"),
              (prop_instance_get_position, pos0, ":var7"),
              (get_sq_distance_between_positions, ":var12", pos0, pos1),
              (get_sq_distance_between_position_heights, ":var13", pos0, pos1),
              (val_add, ":var12", ":var13"),
              (lt, ":var12", 1600),
              (player_get_score, ":var43", ":var9"),
              (val_add, ":var43", ":var40"),
              (player_set_score, ":var9", ":var43"),
              (player_get_gold, ":var44", ":var9"),
              (val_add, ":var44", ":var42"),
              (player_set_gold, ":var9", ":var44", 15000),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (assign, ":var3", 0),
      (try_for_range, ":var4", 0, "$g_number_of_flags"),
        (store_add, ":var5", 146, ":var4"),
        (troop_get_slot, ":var6", "trp_multiplayer_data", ":var5"),
        (scene_prop_get_instance, ":var7", "$team_1_flag_scene_prop", ":var4"),
        (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var4"),
        (try_begin),
          (this_or_next|eq, "$g_base_flag_team_1", ":var7"),
          (eq, "$g_base_flag_team_2", ":var8"),
          (assign, ":var9", 2),
        (else_try),
          (assign, ":var9", 1),
        (try_end),
        (try_begin),
          (eq, ":var6", 1),
          (val_add, ":var0", ":var9"),
          (val_add, ":var2", ":var9"),
        (else_try),
          (eq, ":var6", 2),
          (val_add, ":var1", ":var9"),
          (val_add, ":var2", ":var9"),
        (else_try),
          (val_add, ":var3", ":var9"),
        (try_end),
      (try_end),
      (store_add, ":var10", ":var2", ":var3"),
      (store_sub, ":var11", ":var0", ":var1"),
      (store_mul, ":var12", ":var11", 2),
      (store_sub, ":var13", "$g_number_of_initial_team_1_flags", "$g_number_of_initial_team_2_flags"),
      (assign, ":var14", 0),
      (get_max_players, ":var15"),
      (try_for_range, ":var16", 0, ":var15"),
        (player_is_active, ":var16"),
        (val_add, ":var14", 1),
        (assign, ":var15", 0),
      (try_end),
      (try_begin),
        (ge, ":var12", ":var13"),
        (store_sub, ":var17", ":var12", ":var13"),
        (store_mul, ":var18", ":var17", 125),
        (val_add, ":var18", 500),
        (store_div, ":var19", 250000, ":var18"),
        (try_begin),
          (lt, ":var2", ":var10"),
          (val_mul, ":var19", ":var2"),
          (val_div, ":var19", ":var10"),
          (val_mul, ":var18", ":var2"),
          (val_div, ":var18", ":var10"),
        (try_end),
        (call_script, "script_find_number_of_agents_constant"),
        (val_mul, ":var18", reg0),
        (val_div, ":var18", 100),
        (val_mul, ":var19", reg0),
        (val_div, ":var19", 100),
        (val_mul, ":var18", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var18", 100),
        (val_mul, ":var19", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var19", 100),
        (try_begin),
          (ge, ":var14", 1),
          (val_sub, "$g_score_team_2", ":var18"),
          (try_begin),
            (ge, ":var1", 1),
            (val_sub, "$g_score_team_1", ":var19"),
          (else_try),
            (val_sub, "$g_score_team_2", ":var19"),
          (try_end),
        (try_end),
      (else_try),
        (store_sub, ":var17", ":var13", ":var12"),
        (store_mul, ":var18", ":var17", 125),
        (val_add, ":var18", 500),
        (store_div, ":var19", 250000, ":var18"),
        (try_begin),
          (lt, ":var2", ":var10"),
          (val_mul, ":var19", ":var2"),
          (val_div, ":var19", ":var10"),
          (val_mul, ":var18", ":var2"),
          (val_div, ":var18", ":var10"),
        (try_end),
        (call_script, "script_find_number_of_agents_constant"),
        (val_mul, ":var18", reg0),
        (val_div, ":var18", 100),
        (val_mul, ":var19", reg0),
        (val_div, ":var19", 100),
        (val_mul, ":var18", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var18", 100),
        (val_mul, ":var19", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var19", 100),
        (try_begin),
          (ge, ":var14", 1),
          (try_begin),
            (ge, ":var0", 1),
            (val_sub, "$g_score_team_2", ":var19"),
          (else_try),
            (val_sub, "$g_score_team_1", ":var19"),
          (try_end),
          (val_sub, "$g_score_team_1", ":var18"),
        (try_end),
      (try_end),
      (team_get_score, ":var20", 0),
      (try_begin),
        (store_div, ":var21", "$g_score_team_1", 10000),
        (neq, ":var21", ":var20"),
        (get_max_players, ":var22"),
        (call_script, "script_team_set_score", 0, ":var21"),
        (try_for_range, ":var16", 1, ":var22"),
          (player_is_active, ":var16"),
          (multiplayer_send_2_int_to_player, ":var16", 72, 0, ":var21"),
        (try_end),
      (try_end),
      (team_get_score, ":var23", 1),
      (try_begin),
        (store_div, ":var24", "$g_score_team_2", 10000),
        (neq, ":var24", ":var23"),
        (get_max_players, ":var22"),
        (call_script, "script_team_set_score", 1, ":var24"),
        (try_for_range, ":var16", 1, ":var22"),
          (player_is_active, ":var16"),
          (multiplayer_send_2_int_to_player, ":var16", 72, 1, ":var24"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_cf", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (64, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (65, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_is_server),
        (store_current_scene, ":var0"),
        (this_or_next|eq, ":var0", "scn_random_multi_plain_medium"),
        (this_or_next|eq, ":var0", "scn_random_multi_plain_large"),
        (this_or_next|eq, ":var0", "scn_random_multi_steppe_medium"),
        (eq, ":var0", "scn_random_multi_steppe_large"),
        (entry_point_get_position, pos0, 0),
        (entry_point_set_position, 64, pos0),
        (entry_point_get_position, pos1, 32),
        (entry_point_set_position, 65, pos1),
      (try_end),
      (assign, "$g_multiplayer_game_type", 4),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$flag_1_at_ground_timer", 0),
      (assign, "$flag_2_at_ground_timer", 0),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos0, 64),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (entry_point_get_position, pos0, 65),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (agent_is_human, ":var0"),
        (agent_get_attached_scene_prop, ":var2", ":var0"),
        (try_begin),
          (try_begin),
            (multiplayer_is_server),
            (ge, ":var2", 0),
            (multiplayer_get_my_player, ":var3"),
            (get_max_players, ":var4"),
            (call_script, "script_set_attached_scene_prop", ":var0", -1),
            (agent_set_horse_speed_factor, ":var0", 100),
            (try_for_range, ":var5", 1, ":var4"),
              (player_is_active, ":var5"),
              (neq, ":var3", ":var5"),
              (multiplayer_send_2_int_to_player, ":var5", 70, ":var0", -1),
            (try_end),
            (prop_instance_get_position, pos0, ":var2"),
            (position_set_z_to_ground_level, pos0),
            (prop_instance_set_position, ":var2", pos0),
            (agent_get_team, ":var6", ":var0"),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", 0),
            (try_end),
            (team_set_slot, ":var7", 0, 2),
            (multiplayer_get_my_player, ":var3"),
            (get_max_players, ":var4"),
            (call_script, "script_set_team_flag_situation", ":var7", 2),
            (try_for_range, ":var5", 1, ":var4"),
              (player_is_active, ":var5"),
              (neq, ":var3", ":var5"),
              (multiplayer_send_2_int_to_player, ":var5", 71, ":var7", 2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, 2),
        (try_begin),
          (team_slot_eq, ":var0", 0, 2),
          (assign, ":var1", -1),
          (try_begin),
            (eq, ":var0", 0),
            (val_add, "$flag_1_at_ground_timer", 1),
            (ge, "$flag_1_at_ground_timer", 60),
            (assign, ":var1", 0),
          (else_try),
            (val_add, "$flag_2_at_ground_timer", 1),
            (ge, "$flag_2_at_ground_timer", 60),
            (assign, ":var1", 1),
          (try_end),
          (try_begin),
            (ge, ":var1", 0),
            (try_begin),
              (eq, ":var1", 0),
              (assign, "$flag_1_at_ground_timer", 0),
            (else_try),
              (eq, ":var1", 1),
              (assign, "$flag_2_at_ground_timer", 0),
            (try_end),
            (team_set_slot, ":var1", 0, 0),
            (call_script, "script_set_team_flag_situation", ":var1", 0),
            (multiplayer_get_my_player, ":var2"),
            (get_max_players, ":var3"),
            (try_for_range, ":var4", 1, ":var3"),
              (player_is_active, ":var4"),
              (neq, ":var2", ":var4"),
              (multiplayer_send_2_int_to_player, ":var4", 71, ":var1", 0),
            (try_end),
            (scene_prop_get_instance, ":var5", "$team_1_flag_scene_prop", 0),
            (scene_prop_get_instance, ":var6", "$team_2_flag_scene_prop", 0),
            (assign, ":var7", ":var5"),
            (assign, ":var8", 64),
            (assign, ":var9", ":var6"),
            (assign, ":var10", 65),
            (try_begin),
              (eq, ":var1", 0),
              (entry_point_get_position, pos5, ":var8"),
              (prop_instance_set_position, ":var7", pos5),
            (else_try),
              (entry_point_get_position, pos5, ":var10"),
              (prop_instance_set_position, ":var9", pos5),
            (try_end),
            (store_mul, ":var11", ":var1", -1),
            (val_sub, ":var11", 1),
            (call_script, "script_show_multiplayer_message", 5, ":var11"),
            (try_for_range, ":var4", 0, ":var3"),
              (player_is_active, ":var4"),
              (neq, ":var2", ":var4"),
              (multiplayer_send_2_int_to_player, ":var4", 68, 5, ":var11"),
            (try_end),
          (try_end),
        (else_try),
          (try_begin),
            (eq, ":var0", 0),
            (assign, "$flag_1_at_ground_timer", 0),
          (else_try),
            (assign, "$flag_2_at_ground_timer", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (scene_prop_get_instance, ":var0", "$team_1_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (scene_prop_get_instance, ":var1", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos2, ":var1"),
      (multiplayer_get_my_player, ":var2"),
      (get_max_players, ":var3"),
      (try_for_agents, ":var4"),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (neg|agent_is_non_player, ":var4"),
        (agent_get_horse, ":var5", ":var4"),
        (eq, ":var5", -1),
        (agent_get_attached_scene_prop, ":var6", ":var4"),
        (agent_get_team, ":var7", ":var4"),
        (try_begin),
          (eq, ":var7", 0),
          (assign, ":var8", 1),
        (else_try),
          (assign, ":var8", 0),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
          (assign, ":var9", ":var0"),
          (assign, ":var10", 64),
        (else_try),
          (assign, ":var9", ":var1"),
          (assign, ":var10", 65),
        (try_end),
        (agent_get_position, pos3, ":var4"),
        (prop_instance_get_position, pos4, ":var9"),
        (get_distance_between_positions, ":var11", pos3, pos4),
        (team_get_slot, ":var12", ":var7", 0),
        (try_begin),
          (eq, ":var12", 2),
          (lt, ":var11", 100),
          (team_set_slot, ":var7", 0, 0),
          (call_script, "script_set_team_flag_situation", ":var7", 0),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 71, ":var7", 0),
          (try_end),
          (entry_point_get_position, pos5, ":var10"),
          (prop_instance_set_position, ":var9", pos5),
          (try_begin),
            (multiplayer_is_server),
            (neg|agent_is_non_player, ":var4"),
            (agent_get_player_id, ":var14", ":var4"),
            (player_get_score, ":var15", ":var14"),
            (val_add, ":var15", 1),
            (player_set_score, ":var14", ":var15"),
          (try_end),
          (call_script, "script_show_multiplayer_message", 5, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 68, 5, ":var4"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, ":var6", -1),
          (try_begin),
            (eq, ":var7", 0),
            (assign, ":var16", ":var1"),
            (assign, ":var17", 65),
          (else_try),
            (assign, ":var16", ":var0"),
            (assign, ":var17", 64),
          (try_end),
          (eq, ":var6", ":var16"),
          (eq, ":var12", 0),
          (lt, ":var11", 100),
          (team_get_score, ":var18", ":var7"),
          (val_add, ":var18", 1),
          (team_set_score, ":var7", ":var18"),
          (try_begin),
            (multiplayer_is_server),
            (neg|agent_is_non_player, ":var4"),
            (agent_get_player_id, ":var14", ":var4"),
            (player_get_score, ":var15", ":var14"),
            (val_add, ":var15", "$g_multiplayer_point_gained_from_capturing_flag"),
            (player_set_score, ":var14", ":var15"),
          (try_end),
          (call_script, "script_team_set_score", ":var7", ":var18"),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 72, ":var7", ":var18"),
          (try_end),
          (agent_set_attached_scene_prop, ":var4", -1),
          (team_set_slot, ":var8", 0, 0),
          (call_script, "script_set_attached_scene_prop", ":var4", -1),
          (agent_set_horse_speed_factor, ":var4", 100),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 70, ":var4", -1),
          (try_end),
          (call_script, "script_set_team_flag_situation", ":var8", 0),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 71, ":var8", 0),
          (try_end),
          (entry_point_get_position, pos5, ":var17"),
          (prop_instance_set_position, ":var16", pos5),
          (call_script, "script_show_multiplayer_message", 4, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 68, 4, ":var4"),
          (try_end),
        (try_end),
        (eq, ":var6", -1),
        (agent_get_position, pos3, ":var4"),
        (agent_get_team, ":var7", ":var4"),
        (try_begin),
          (eq, ":var7", 0),
          (get_distance_between_positions, ":var11", pos2, pos3),
          (assign, ":var16", ":var1"),
        (else_try),
          (get_distance_between_positions, ":var11", pos1, pos3),
          (assign, ":var16", ":var0"),
        (try_end),
        (try_begin),
          (le, ":var11", 100),
          (neg|team_slot_eq, ":var8", 0, 1),
          (agent_set_attached_scene_prop, ":var4", ":var16"),
          (agent_set_attached_scene_prop_x, ":var4", 20),
          (agent_set_attached_scene_prop_z, ":var4", 50),
          (try_begin),
            (eq, ":var7", 0),
            (assign, "$flag_1_at_ground_timer", 0),
          (else_try),
            (eq, ":var7", 1),
            (assign, "$flag_2_at_ground_timer", 0),
          (try_end),
          (team_set_slot, ":var8", 0, 1),
          (call_script, "script_set_attached_scene_prop", ":var4", ":var16"),
          (agent_set_horse_speed_factor, ":var4", 75),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 70, ":var4", ":var16"),
          (try_end),
          (call_script, "script_set_team_flag_situation", ":var8", 1),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 71, ":var8", 1),
          (try_end),
          (call_script, "script_show_multiplayer_message", 6, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 68, 6, ":var4"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
      (start_presentation, "prsnt_multiplayer_flag_projection_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_sg", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 2),
        (try_begin),
          (eq, ":var0", 0),
          (assign, ":var1", "spr_belfry_a"),
        (else_try),
          (assign, ":var1", "spr_belfry_b"),
        (try_end),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (prop_instance_get_position, pos1, ":var4"),
          (prop_instance_get_starting_position, pos11, ":var4"),
          (store_add, ":var5", 11, ":var3"),
          (try_begin),
            (eq, ":var0", 1),
            (scene_prop_get_num_instances, ":var6", "spr_belfry_a"),
            (val_add, ":var5", ":var6"),
          (try_end),
          (val_mul, ":var5", 10),
          (store_add, ":var7", ":var5", 10),
          (try_for_range, ":var8", ":var5", ":var7"),
            (entry_point_is_auto_generated, ":var8"),
            (assign, ":var7", ":var8"),
          (try_end),
          (assign, ":var9", ":var7"),
          (val_sub, ":var7", 1),
          (assign, reg0, ":var7"),
          (neg|entry_point_is_auto_generated, ":var7"),
          (try_begin),
            (get_sq_distance_between_positions, ":var10", pos1, pos11),
            (ge, ":var10", 4),
            (assign, ":var11", -1),
            (assign, ":var12", -1),
            (try_for_range, ":var8", ":var5", ":var9"),
              (entry_point_get_position, pos4, ":var8"),
              (get_sq_distance_between_positions, ":var13", pos11, pos4),
              (lt, ":var13", ":var10"),
              (gt, ":var13", ":var11"),
              (assign, ":var11", ":var13"),
              (assign, ":var12", ":var8"),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (entry_point_get_position, pos5, ":var12"),
            (else_try),
              (copy_position, 5, 11),
            (try_end),
            (get_distance_between_positions, ":var14", pos1, pos5),
            (try_begin),
              (eq, ":var0", 0),
              (scene_prop_get_instance, ":var15", "spr_belfry_platform_a", ":var3"),
              (scene_prop_get_instance, ":var16", "spr_belfry_platform_b", ":var3"),
            (else_try),
              (scene_prop_get_instance, ":var15", "spr_belfry_b_platform_a", ":var3"),
            (try_end),
            (store_mul, ":var17", ":var3", 3),
            (try_begin),
              (eq, ":var1", "spr_belfry_b"),
              (scene_prop_get_num_instances, ":var6", "spr_belfry_a"),
              (store_mul, ":var18", ":var6", 3),
              (val_add, ":var17", ":var18"),
            (try_end),
            (scene_prop_get_instance, ":var19", "spr_belfry_wheel", ":var17"),
            (val_add, ":var17", 1),
            (scene_prop_get_instance, ":var20", "spr_belfry_wheel", ":var17"),
            (val_add, ":var17", 1),
            (scene_prop_get_instance, ":var21", "spr_belfry_wheel", ":var17"),
            (init_position, pos17),
            (position_move_y, pos17, -225),
            (position_transform_position_to_parent, pos18, pos1, pos17),
            (position_move_y, pos17, -225),
            (position_transform_position_to_parent, pos19, pos1, pos17),
            (assign, ":var22", 0),
            (get_max_players, ":var23"),
            (try_for_range, ":var24", 0, ":var23"),
              (player_is_active, ":var24"),
              (player_get_agent_id, ":var25", ":var24"),
              (ge, ":var25", 0),
              (agent_get_team, ":var26", ":var25"),
              (eq, ":var26", 1),
              (agent_get_horse, ":var27", ":var25"),
              (eq, ":var27", -1),
              (agent_get_position, pos2, ":var25"),
              (get_sq_distance_between_positions_in_meters, ":var28", pos18, pos2),
              (lt, ":var28", 36),
              (neg|scene_prop_has_agent_on_it, ":var4", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var15", ":var25"),
              (this_or_next|eq, ":var0", 1),
              (neg|scene_prop_has_agent_on_it, ":var16", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var19", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var20", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var21", ":var25"),
              (neg|position_is_behind_position, pos2, pos19),
              (position_is_behind_position, pos2, pos1),
              (val_add, ":var22", 1),
            (try_end),
            (val_min, ":var22", 16),
            (try_begin),
              (scene_prop_get_slot, ":var29", ":var4", 3),
              (scene_prop_get_slot, ":var30", ":var4", 4),
              (this_or_next|neq, ":var29", ":var22"),
              (neq, ":var30", ":var12"),
              (try_begin),
                (eq, ":var30", ":var12"),
                (prop_instance_is_animating, ":var31", ":var4"),
                (eq, ":var31", 1),
                (store_mul, ":var32", "$g_last_number_of_agents_around_belfry", 100),
                (store_sqrt, ":var32", ":var32"),
                (val_min, ":var32", 300),
                (assign, ":var33", ":var14"),
                (val_mul, ":var33", ":var32"),
                (val_div, ":var33", 100),
                (val_mul, ":var33", 4),
              (try_end),
              (try_begin),
                (ge, ":var12", 0),
                (init_position, pos9),
                (position_set_y, pos9, -500),
                (position_set_x, pos9, -300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var34", pos10),
                (init_position, pos9),
                (position_set_y, pos9, -500),
                (position_set_x, pos9, 300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var35", pos10),
                (store_add, ":var36", ":var34", ":var35"),
                (val_mul, ":var36", 100),
                (store_div, ":var37", ":var36", 24),
                (init_position, pos20),
                (position_rotate_x_floating, pos20, ":var37"),
                (position_transform_position_to_parent, pos23, pos5, pos20),
                (init_position, pos9),
                (position_set_x, pos9, -300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var38", pos10),
                (init_position, pos9),
                (position_set_x, pos9, 300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var39", pos10),
                (store_sub, ":var34", ":var38", ":var39"),
                (init_position, pos9),
                (position_set_x, pos9, -300),
                (position_set_y, pos9, -500),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var38", pos10),
                (init_position, pos9),
                (position_set_x, pos9, 300),
                (position_set_y, pos9, -500),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var39", pos10),
                (store_sub, ":var35", ":var38", ":var39"),
                (store_add, ":var36", ":var34", ":var35"),
                (val_mul, ":var36", 100),
                (store_div, ":var37", ":var36", 24),
                (val_mul, ":var37", -1),
                (init_position, pos20),
                (position_rotate_y_floating, pos20, ":var37"),
                (position_transform_position_to_parent, pos22, pos23, pos20),
              (else_try),
                (copy_position, 22, 5),
              (try_end),
              (try_begin),
                (ge, ":var22", 1),
                (store_mul, ":var32", ":var22", 100),
                (store_sqrt, ":var32", ":var32"),
                (val_min, ":var32", 300),
                (val_mul, ":var14", 100),
                (val_mul, ":var14", 3),
                (val_div, ":var14", ":var32"),
                (prop_instance_get_position, pos6, ":var15"),
                (position_transform_position_to_local, pos7, pos1, pos6),
                (position_transform_position_to_parent, pos8, pos22, pos7),
                (prop_instance_animate_to_position, ":var15", pos8, ":var14"),
                (try_begin),
                  (eq, ":var0", 0),
                  (prop_instance_get_position, pos6, ":var16"),
                  (position_transform_position_to_local, pos7, pos1, pos6),
                  (position_transform_position_to_parent, pos8, pos22, pos7),
                  (prop_instance_animate_to_position, ":var16", pos8, ":var14"),
                (try_end),
                (store_mul, ":var40", ":var14", -25),
                (assign, "$g_last_number_of_agents_around_belfry", ":var22"),
                (prop_instance_get_position, pos13, ":var19"),
                (prop_instance_get_position, pos20, ":var4"),
                (position_transform_position_to_local, pos7, pos20, pos13),
                (position_transform_position_to_parent, pos21, pos22, pos7),
                (prop_instance_rotate_to_position, ":var19", pos21, ":var14", ":var40"),
                (prop_instance_get_position, pos13, ":var20"),
                (prop_instance_get_position, pos20, ":var4"),
                (position_transform_position_to_local, pos7, pos20, pos13),
                (position_transform_position_to_parent, pos21, pos22, pos7),
                (prop_instance_rotate_to_position, ":var20", pos21, ":var14", ":var40"),
                (prop_instance_get_position, pos13, ":var21"),
                (prop_instance_get_position, pos20, ":var4"),
                (position_transform_position_to_local, pos7, pos20, pos13),
                (position_transform_position_to_parent, pos21, pos22, pos7),
                (prop_instance_rotate_to_position, ":var21", pos21, ":var14", ":var40"),
                (prop_instance_animate_to_position, ":var4", pos22, ":var14"),
              (else_try),
                (prop_instance_is_animating, ":var31", ":var4"),
                (eq, ":var31", 1),
                (prop_instance_stop_animating, ":var15"),
                (try_begin),
                  (eq, ":var0", 0),
                  (prop_instance_stop_animating, ":var16"),
                (try_end),
                (prop_instance_stop_animating, ":var19"),
                (prop_instance_stop_animating, ":var20"),
                (prop_instance_stop_animating, ":var21"),
                (prop_instance_stop_animating, ":var4"),
              (try_end),
              (scene_prop_set_slot, ":var4", 3, ":var22"),
              (scene_prop_set_slot, ":var4", 4, ":var12"),
            (try_end),
          (else_try),
            (le, ":var10", 4),
            (scene_prop_slot_eq, ":var4", 5, 0),
            (scene_prop_set_slot, ":var4", 5, 1),
            (try_begin),
              (eq, ":var0", 0),
              (scene_prop_get_instance, ":var15", "spr_belfry_platform_a", ":var3"),
            (else_try),
              (scene_prop_get_instance, ":var15", "spr_belfry_b_platform_a", ":var3"),
            (try_end),
            (prop_instance_get_starting_position, pos0, ":var15"),
            (prop_instance_animate_to_position, ":var15", pos0, 400),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
      (try_begin),
        (multiplayer_is_server),
        (this_or_next|player_is_active, ":var0"),
        (eq, ":var0", 0),
        (store_mission_timer_a, ":var1"),
        (val_sub, ":var1", "$g_round_start_time"),
        (try_begin),
          (lt, ":var1", 25),
          (assign, ":var2", 0),
        (else_try),
          (lt, ":var1", 60),
          (assign, ":var2", 1),
        (else_try),
          (lt, ":var1", 105),
          (assign, ":var2", 2),
        (else_try),
          (lt, ":var1", 160),
          (assign, ":var2", 3),
        (else_try),
          (assign, ":var2", "$g_multiplayer_number_of_respawn_count"),
        (try_end),
        (player_set_slot, ":var0", 39, ":var2"),
        (multiplayer_send_int_to_player, ":var0", 89, ":var2"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 6),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (try_begin),
        (multiplayer_is_server),
        (try_for_range, ":var0", 176, 186),
          (troop_set_slot, "trp_multiplayer_data", ":var0", -1),
        (try_end),
        (assign, "$g_my_spawn_count", 0),
      (else_try),
        (assign, "$g_my_spawn_count", 0),
      (try_end),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (assign, "$g_flag_is_not_ready", 0),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_number_of_flags", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos1, 66),
        (set_spawn_position, pos1),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (position_move_z, pos1, 900),
        (set_spawn_position, pos1),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
      (try_end),
      (val_add, "$g_number_of_flags", 1),
      (try_begin),
        (multiplayer_is_server),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 1),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 1),
        (try_end),
        (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_a"),
        (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_b"),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (scene_prop_set_slot, ":var3", 3, 0),
          (scene_prop_set_slot, ":var3", 4, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (scene_prop_set_slot, ":var3", 3, 0),
          (scene_prop_set_slot, ":var3", 4, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 0),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (try_begin),
        (neg|multiplayer_is_server),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (assign, "$g_my_spawn_count", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
        (try_end),
      (try_end),
      (try_begin),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (val_add, "$g_my_spawn_count", 1),
        (try_begin),
          (ge, "$g_my_spawn_count", "$g_multiplayer_number_of_respawn_count"),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (multiplayer_get_my_player, ":var1"),
          (player_get_team_no, ":var3", ":var1"),
          (eq, ":var3", 0),
          (assign, "$g_my_spawn_count", 999),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var2"),
        (ge, ":var2", 0),
        (player_get_agent_id, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (agent_is_human, ":var0"),
        (neg|agent_is_non_player, ":var0"),
        (agent_get_player_id, ":var4", ":var0"),
        (player_set_slot, ":var4", 0, 0),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 156, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_div, ":var3", ":var2", 100),
        (store_mod, ":var4", ":var2", 100),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (get_max_players, ":var8"),
        (try_for_range, ":var9", 0, ":var8"),
          (player_is_active, ":var9"),
          (player_get_agent_id, ":var10", ":var9"),
          (ge, ":var10", 0),
          (agent_is_alive, ":var10"),
          (agent_get_team, ":var11", ":var10"),
          (agent_get_position, pos1, ":var10"),
          (get_sq_distance_between_positions, ":var12", pos0, pos1),
          (get_sq_distance_between_position_heights, ":var13", pos0, pos1),
          (val_add, ":var12", ":var13"),
          (lt, ":var12", 1600),
          (try_begin),
            (eq, ":var11", 0),
            (val_add, ":var5", 1),
          (else_try),
            (eq, ":var11", 1),
            (val_add, ":var6", 1),
          (try_end),
        (try_end),
        (try_begin),
          (this_or_next|neq, ":var3", ":var5"),
          (neq, ":var4", ":var6"),
          (store_add, ":var14", 176, ":var0"),
          (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
          (store_mod, ":var16", ":var15", 100),
          (store_div, ":var17", ":var15", 100),
          (try_begin),
            (eq, ":var4", 0),
            (gt, ":var6", 0),
            (eq, ":var5", 0),
            (assign, ":var18", 2),
            (store_mul, ":var19", ":var18", 100),
            (troop_set_slot, "trp_multiplayer_data", ":var14", ":var19"),
            (this_or_next|neq, ":var17", ":var18"),
            (ge, ":var16", 25),
            (store_mul, ":var20", ":var18", 100),
            (val_add, ":var20", ":var0"),
          (try_end),
          (try_begin),
            (store_mul, ":var2", ":var5", 100),
            (val_add, ":var2", ":var6"),
            (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
            (get_max_players, ":var8"),
            (call_script, "script_set_num_agents_around_flag", ":var0", ":var2"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 73, ":var0", ":var2"),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (eq, "$g_round_ended", 0),
        (eq, "$g_flag_is_not_ready", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (try_begin),
          (scene_prop_get_instance, ":var21", "$team_1_flag_scene_prop", ":var0"),
          (prop_instance_get_position, pos1, ":var21"),
          (try_begin),
            (get_sq_distance_between_positions, ":var12", pos0, pos1),
            (lt, ":var12", 400),
            (prop_instance_is_animating, ":var22", ":var21"),
            (eq, ":var22", 1),
            (assign, "$g_winner_team", 1),
            (prop_instance_stop_animating, ":var21"),
            (get_max_players, ":var8"),
            (call_script, "script_draw_this_round", "$g_winner_team"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
            (try_end),
            (assign, "$g_flag_is_not_ready", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_flag_is_not_ready", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
    ],
    [
      (assign, ":var0", 0),
      (store_add, ":var1", 156, ":var0"),
      (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
      (store_mod, ":var3", ":var2", 100),
      (try_begin),
        (eq, ":var3", 0),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
        (assign, "$g_flag_is_not_ready", 1),
        (assign, "$g_winner_team", 0),
        (get_max_players, ":var4"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var5", 1, ":var4"),
          (player_is_active, ":var5"),
          (multiplayer_send_int_to_player, ":var5", 69, "$g_winner_team"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 176, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_mod, ":var3", ":var2", 100),
        (try_begin),
          (ge, ":var2", 100),
          (lt, ":var3", 25),
          (val_add, ":var2", 1),
          (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
        (try_end),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (multiplayer_is_server),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (get_max_players, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (player_is_active, ":var8"),
            (multiplayer_send_int_to_player, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (get_max_players, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (player_is_active, ":var13"),
              (player_get_team_no, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (player_get_slot, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (player_get_agent_id, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (player_get_kill_count, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (player_set_kill_count, ":var12", ":var16"),
                (player_get_death_count, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (player_set_death_count, ":var12", ":var17"),
                (player_get_score, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (player_set_score, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (player_is_active, ":var13"),
                  (multiplayer_send_4_int_to_player, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (player_get_value_of_original_items, ":var19", ":var12"),
                (player_get_gold, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (player_set_gold, ":var12", ":var20", 15000),
              (try_end),
              (player_set_troop_id, ":var12", -1),
              (player_set_team_no, ":var12", ":var9"),
              (multiplayer_send_message_to_player, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (multiplayer_get_my_player, ":var21"),
          (get_max_players, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (player_is_active, ":var13"),
            (neq, ":var21", ":var13"),
            (multiplayer_send_int_to_player, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 0, 0),
        (player_set_slot, ":var13", 25, 0),
        (player_get_agent_id, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (player_save_picked_up_items_for_next_spawn, ":var13"),
        (player_get_value_of_original_items, ":var19", ":var13"),
        (player_set_slot, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_get_gold, ":var20", ":var13"),
        (player_get_team_no, ":var4", ":var13"),
        (try_begin),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 1),
          (val_add, ":var20", ":var23"),
        (try_end),
        (try_begin),
          (player_get_slot, ":var19", ":var13", 1),
          (store_add, ":var24", ":var20", ":var19"),
          (store_mul, ":var25", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var24", ":var25"),
          (store_sub, ":var26", ":var25", ":var24"),
          (val_add, ":var20", ":var26"),
        (try_end),
        (player_set_gold, ":var13", ":var20", 15000),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (multiplayer_clear_scene),
      (assign, "$g_my_spawn_count", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 39, 0),
      (try_end),
      (call_script, "script_initialize_objects"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_a"),
      (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_b"),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_a"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_a", ":var28"),
        (scene_prop_set_slot, ":var29", 3, 0),
        (scene_prop_set_slot, ":var29", 4, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_a"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_a", ":var28"),
        (scene_prop_set_slot, ":var29", 5, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_b"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_b", ":var28"),
        (scene_prop_set_slot, ":var29", 3, 0),
        (scene_prop_set_slot, ":var29", 4, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_b"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_b", ":var28"),
        (scene_prop_set_slot, ":var29", 5, 0),
      (try_end),
      (try_for_range, ":var30", 0, "$g_number_of_flags"),
        (scene_prop_get_instance, ":var31", "spr_headquarters_pole_code_only", ":var30"),
        (prop_instance_get_position, pos1, ":var31"),
        (position_move_z, pos1, 900),
        (scene_prop_get_instance, ":var32", "$team_1_flag_scene_prop", ":var30"),
        (prop_instance_stop_animating, ":var32"),
        (prop_instance_set_position, ":var32", pos1),
      (try_end),
      (assign, "$g_round_ended", 0),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (multiplayer_send_int_to_player, ":var13", 78, -9999),
      (try_end),
      (assign, "$g_flag_is_not_ready", 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_slot_eq, ":var1", 0, 0),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (assign, ":var7", 0),
        (try_begin),
          (assign, ":var8", 0),
          (get_max_players, ":var0"),
          (try_for_range, ":var9", 0, ":var0"),
            (player_is_active, ":var9"),
            (player_get_team_no, ":var10", ":var9"),
            (try_begin),
              (eq, ":var10", 0),
              (val_add, ":var6", 1),
            (else_try),
              (eq, ":var10", 1),
              (val_add, ":var7", 1),
            (try_end),
            (val_add, ":var8", 1),
          (try_end),
          (store_mission_timer_a, ":var11"),
          (val_sub, ":var11", "$g_round_start_time"),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (lt, ":var4", 0),
            (try_begin),
              (eq, ":var2", 0),
              (player_get_slot, ":var12", ":var1", 28),
              (store_mission_timer_a, ":var13"),
              (store_sub, ":var14", ":var13", ":var12"),
              (assign, ":var15", "$g_multiplayer_respawn_period"),
              (val_add, ":var15", 27),
              (lt, ":var14", ":var15"),
              (store_sub, ":var11", ":var13", "$g_round_start_time"),
              (ge, ":var11", 30),
              (gt, ":var8", 2),
              (store_mul, ":var16", ":var6", ":var7"),
              (neq, ":var16", 0),
              (assign, ":var5", 0),
            (else_try),
              (assign, ":var5", 1),
            (try_end),
          (else_try),
            (agent_get_time_elapsed_since_removed, ":var14", ":var4"),
            (assign, ":var15", "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var2", 0),
              (val_add, ":var15", 27),
            (try_end),
            (this_or_next|gt, ":var14", ":var15"),
            (player_slot_eq, ":var1", 25, 0),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (player_get_slot, ":var17", ":var1", 39),
        (try_begin),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (try_begin),
            (eq, ":var5", 1),
            (eq, ":var2", 0),
            (ge, ":var17", "$g_multiplayer_number_of_respawn_count"),
            (assign, ":var5", 0),
          (else_try),
            (eq, ":var5", 1),
            (eq, ":var2", 1),
            (ge, ":var17", 999),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (player_get_slot, ":var17", ":var1", 39),
        (val_add, ":var17", 1),
        (player_set_slot, ":var1", 39, ":var17"),
        (try_begin),
          (ge, ":var17", "$g_multiplayer_number_of_respawn_count"),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (eq, ":var2", 0),
          (assign, ":var17", 999),
          (player_set_slot, ":var1", 39, ":var17"),
        (try_end),
        (assign, ":var18", 0),
        (player_get_item_id, ":var19", ":var1", ek_horse),
        (try_begin),
          (this_or_next|is_between, ":var19", "itm_steppe_horse", "itm_arrows"),
          (this_or_next|eq, ":var19", "itm_warhorse_sarranid"),
          (eq, ":var19", "itm_warhorse_steppe"),
          (assign, ":var18", 1),
        (try_end),
        (try_begin),
          (lt, ":var11", 20),
          (try_begin),
            (eq, ":var2", 0),
            (call_script, "script_multiplayer_find_spawn_point", ":var2", 1, ":var18"),
            (assign, ":var20", reg0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var20", 32),
          (try_end),
        (else_try),
          (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var18"),
          (assign, ":var20", reg0),
        (try_end),
        (player_spawn_new_agent, ":var1", ":var20"),
        (player_set_slot, ":var1", 0, 1),
        (player_set_slot, ":var1", 25, 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_bt", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 2),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (assign, "$g_battle_death_mode_started", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$server_mission_timer_while_player_joined", 0),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos0, 67),
        (position_set_z_to_ground_level, pos0),
        (position_move_z, pos0, -2000),
        (position_move_x, 0, 100),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (position_move_x, 0, -200),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
        (prop_instance_get_position, pos0, ":var0"),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (position_move_z, pos0, 100),
        (prop_instance_set_position, reg0, pos0),
        (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
        (prop_instance_get_position, pos0, ":var1"),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
        (position_move_z, pos0, 100),
        (prop_instance_set_position, reg0, pos0),
        (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
        (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (call_script, "script_calculate_new_death_waiting_time_at_death_mod"),
      (try_begin),
        (neg|multiplayer_is_server),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
          (try_begin),
            (eq, "$g_team_balance_next_round", 1),
            (assign, "$g_team_balance_next_round", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var2"),
        (ge, ":var2", 0),
        (player_get_agent_id, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (agent_is_human, ":var0"),
        (assign, ":var4", 0),
        (assign, ":var5", 0),
        (try_for_agents, ":var6"),
          (agent_is_human, ":var6"),
          (try_begin),
            (agent_is_alive, ":var6"),
            (agent_get_team, ":var7", ":var6"),
            (try_begin),
              (eq, ":var7", 0),
              (val_add, ":var4", 1),
            (else_try),
              (eq, ":var7", 1),
              (val_add, ":var5", 1),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (this_or_next|eq, ":var4", 0),
            (eq, ":var5", 0),
            (assign, "$g_winner_team", -1),
            (assign, reg0, "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var4", 0),
              (try_begin),
                (neq, ":var5", 0),
                (team_get_score, ":var8", 1),
                (val_add, ":var8", 1),
                (team_set_score, 1, ":var8"),
                (assign, "$g_winner_team", 1),
              (try_end),
              (call_script, "script_show_multiplayer_message", 12, "$g_winner_team"),
              (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
            (else_try),
              (try_begin),
                (neq, ":var4", 0),
                (team_get_score, ":var9", 0),
                (val_add, ":var9", 1),
                (team_set_score, 0, ":var9"),
                (assign, "$g_winner_team", 0),
              (try_end),
              (call_script, "script_show_multiplayer_message", 12, "$g_winner_team"),
              (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
            (try_end),
            (store_mission_timer_a, "$g_round_finish_time"),
            (assign, "$g_round_ended", 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (agent_is_human, ":var0"),
        (neg|agent_is_non_player, ":var0"),
        (ge, ":var0", 0),
        (agent_get_player_id, ":var10", ":var0"),
        (ge, ":var10", 0),
        (set_fixed_point_multiplier, 100),
        (agent_get_player_id, ":var10", ":var0"),
        (agent_get_position, pos0, ":var0"),
        (position_get_x, ":var11", pos0),
        (position_get_y, ":var12", pos0),
        (position_get_z, ":var13", pos0),
        (player_set_slot, ":var10", 29, ":var11"),
        (player_set_slot, ":var10", 30, ":var12"),
        (player_set_slot, ":var10", 31, ":var13"),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
      (assign, ":var2", 0),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (scene_prop_get_instance, ":var3", "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var4", "spr_headquarters_pole_code_only", 1),
        (scene_prop_get_instance, ":var5", "$team_1_flag_scene_prop", 0),
        (scene_prop_get_instance, ":var6", "$team_2_flag_scene_prop", 0),
        (prop_instance_get_position, pos1, ":var3"),
        (prop_instance_get_position, pos2, ":var4"),
        (prop_instance_get_position, pos3, ":var5"),
        (prop_instance_get_position, pos4, ":var6"),
        (get_distance_between_positions, ":var7", pos1, pos3),
        (get_distance_between_positions, ":var8", pos2, pos4),
        (store_add, ":var9", ":var7", 50),
        (store_add, ":var10", ":var8", 50),
        (try_begin),
          (le, ":var7", ":var10"),
          (prop_instance_is_animating, ":var11", ":var5"),
          (eq, ":var11", 1),
          (prop_instance_get_animation_target_position, 5, ":var5"),
          (position_get_z, ":var12", pos5),
          (position_get_z, ":var13", pos3),
          (ge, ":var12", ":var13"),
          (assign, ":var2", 1),
        (try_end),
        (try_begin),
          (le, ":var8", ":var9"),
          (prop_instance_is_animating, ":var11", ":var6"),
          (eq, ":var11", 1),
          (prop_instance_get_animation_target_position, 5, ":var6"),
          (position_get_z, ":var12", pos5),
          (position_get_z, ":var14", pos4),
          (ge, ":var12", ":var14"),
          (assign, ":var2", 1),
        (try_end),
      (try_end),
      (eq, ":var2", 0),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (assign, "$g_winner_team", -1),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
        (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
        (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
        (prop_instance_get_position, pos1, ":var0"),
        (prop_instance_get_position, pos2, ":var1"),
        (prop_instance_get_position, pos3, ":var2"),
        (prop_instance_get_position, pos4, ":var3"),
        (get_distance_between_positions, ":var4", pos1, pos3),
        (get_distance_between_positions, ":var5", pos2, pos4),
        (try_begin),
          (ge, ":var4", ":var5"),
          (store_sub, ":var6", ":var4", ":var5"),
          (ge, ":var6", 50),
          (assign, "$g_winner_team", 0),
        (else_try),
          (store_sub, ":var6", ":var5", ":var4"),
          (ge, ":var6", 50),
          (assign, "$g_winner_team", 1),
        (try_end),
      (try_end),
      (multiplayer_get_my_player, ":var7"),
      (call_script, "script_draw_this_round", "$g_winner_team"),
      (get_max_players, ":var8"),
      (try_for_range, ":var9", 1, ":var8"),
        (player_is_active, ":var9"),
        (neq, ":var9", ":var7"),
        (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (multiplayer_is_server),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (get_max_players, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (player_is_active, ":var8"),
            (multiplayer_send_int_to_player, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 0),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_start_time"),
      (store_div, "$g_multiplayer_round_max_seconds_div_2", "$g_multiplayer_round_max_seconds", 2),
      (ge, ":var0", "$g_multiplayer_round_max_seconds_div_2"),
    ],
    [
      (call_script, "script_calculate_new_death_waiting_time_at_death_mod"),
      (assign, "$g_battle_death_mode_started", 1),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_death_mode_part_1_start_time"),
      (store_add, ":var1", "$g_battle_waiting_seconds", "$g_reduced_waiting_seconds"),
      (ge, ":var0", ":var1"),
      (store_mission_timer_a, ":var2"),
      (store_sub, ":var3", ":var2", "$g_round_start_time"),
      (store_sub, ":var4", "$g_multiplayer_round_max_seconds", 15),
      (lt, ":var3", ":var4"),
    ],
    [
      (assign, "$g_battle_death_mode_started", 2),
      (call_script, "script_start_death_mode"),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 1, ":var0"),
        (player_is_active, ":var1"),
        (multiplayer_send_int_to_player, ":var1", 80),
      (try_end),
      (scene_prop_get_instance, ":var2", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var3", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var4", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var5", "$team_2_flag_scene_prop", 0),
      (store_random_in_range, "$g_random_entry_point", 0, 3),
      (val_add, "$g_random_entry_point", 67),
      (entry_point_get_position, pos0, "$g_random_entry_point"),
      (position_set_z_to_ground_level, pos0),
      (position_move_x, 0, 100),
      (prop_instance_set_position, ":var2", pos0),
      (position_move_x, 0, -200),
      (prop_instance_set_position, ":var3", pos0),
      (prop_instance_get_position, pos0, ":var2"),
      (position_move_z, pos0, 100),
      (prop_instance_set_position, ":var4", pos0),
      (prop_instance_get_position, pos0, ":var3"),
      (position_move_z, pos0, 100),
      (prop_instance_set_position, ":var5", pos0),
      (start_presentation, "prsnt_multiplayer_flag_projection_display_bt"),
    ]),

    (3, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_death_mode_part_1_start_time"),
      (store_add, ":var1", "$g_battle_waiting_seconds", "$g_reduced_waiting_seconds"),
      (val_sub, ":var1", 20),
      (ge, ":var0", ":var1"),
    ],
    [
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (eq, ":var0", 0),
        (agent_is_human, ":var1"),
        (try_for_agents, ":var2"),
          (agent_is_human, ":var2"),
          (neq, ":var1", ":var2"),
          (agent_get_team, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var2"),
          (neq, ":var3", ":var4"),
          (agent_get_position, pos1, ":var1"),
          (agent_get_position, pos2, ":var2"),
          (get_sq_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 49),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (val_add, "$g_reduced_waiting_seconds", 3),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (store_sub, ":var2", "$g_multiplayer_round_max_seconds", 66),
      (ge, ":var1", ":var2"),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (store_sub, ":var3", "$g_multiplayer_round_max_seconds", 24),
      (le, ":var1", ":var3"),
    ],
    [
      (val_add, "$g_reduced_waiting_seconds", 1),
    ]),

    (0, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (prop_instance_get_position, pos2, ":var1"),
      (prop_instance_get_position, pos3, ":var2"),
      (prop_instance_get_position, pos4, ":var3"),
      (copy_position, 7, 1),
      (position_move_z, pos7, 100),
      (copy_position, 8, 2),
      (position_move_z, pos8, 100),
      (get_distance_between_positions, ":var4", pos1, pos3),
      (get_distance_between_positions, ":var5", pos2, pos4),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (get_max_players, ":var8"),
      (try_for_range, ":var9", 0, ":var8"),
        (player_is_active, ":var9"),
        (player_get_agent_id, ":var10", ":var9"),
        (ge, ":var10", 0),
        (agent_is_human, ":var10"),
        (agent_is_alive, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos0, ":var10"),
        (agent_get_horse, ":var12", ":var10"),
        (eq, ":var12", -1),
        (try_begin),
          (eq, ":var11", 0),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (this_or_next|eq, ":var6", 0),
              (eq, ":var6", 1),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", -1),
            (else_try),
              (eq, ":var7", 1),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var11", 1),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (this_or_next|eq, ":var7", 0),
              (eq, ":var7", 1),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", -1),
            (else_try),
              (eq, ":var6", 1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var4", 800),
        (assign, "$g_winner_team", 0),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var14", 0),
        (call_script, "script_team_set_score", 0, ":var14"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 0, ":var14"),
        (try_end),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (else_try),
        (ge, ":var5", 800),
        (assign, "$g_winner_team", 1),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var15", 1),
        (call_script, "script_team_set_score", 1, ":var15"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 1, ":var15"),
        (try_end),
        (call_script, "script_show_multiplayer_message", 12, 0),
        (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (try_end),
      (try_begin),
        (eq, "$g_round_ended", 0),
        (position_get_z, ":var16", pos3),
        (prop_instance_is_animating, ":var17", ":var2"),
        (try_begin),
          (eq, ":var6", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var2"),
        (else_try),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", -1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var18", ":var16"),
          (get_distance_between_positions, ":var19", pos3, pos7),
          (gt, ":var19", 0),
          (val_mul, ":var19", 16),
          (prop_instance_animate_to_position, ":var2", pos7, ":var19"),
        (else_try),
          (eq, ":var6", 1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var18", ":var16"),
          (copy_position, 5, 1),
          (position_move_z, pos5, 800),
          (get_distance_between_positions, ":var19", pos3, pos5),
          (gt, ":var19", 0),
          (val_mul, ":var19", 8),
          (prop_instance_animate_to_position, ":var2", pos5, ":var19"),
        (try_end),
        (position_get_z, ":var20", pos4),
        (prop_instance_is_animating, ":var17", ":var3"),
        (try_begin),
          (eq, ":var7", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var3"),
        (else_try),
          (this_or_next|eq, ":var7", 0),
          (eq, ":var7", -1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var21", ":var20"),
          (get_distance_between_positions, ":var22", pos4, pos8),
          (gt, ":var22", 0),
          (val_mul, ":var22", 16),
          (prop_instance_animate_to_position, ":var3", pos8, ":var22"),
        (else_try),
          (eq, ":var7", 1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var21", ":var20"),
          (copy_position, 6, 2),
          (position_move_z, pos6, 800),
          (get_distance_between_positions, ":var22", pos4, pos6),
          (gt, ":var22", 0),
          (val_mul, ":var22", 8),
          (prop_instance_animate_to_position, ":var3", pos6, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (get_max_players, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (player_is_active, ":var13"),
              (player_get_team_no, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (player_get_slot, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (player_get_agent_id, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (player_get_kill_count, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (player_set_kill_count, ":var12", ":var16"),
                (player_get_death_count, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (player_set_death_count, ":var12", ":var17"),
                (player_get_score, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (player_set_score, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (player_is_active, ":var13"),
                  (multiplayer_send_4_int_to_player, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (player_get_value_of_original_items, ":var19", ":var12"),
                (player_get_gold, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (player_set_gold, ":var12", ":var20", 15000),
              (try_end),
              (player_set_troop_id, ":var12", -1),
              (player_set_team_no, ":var12", ":var9"),
              (multiplayer_send_message_to_player, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (multiplayer_get_my_player, ":var21"),
          (get_max_players, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (player_is_active, ":var13"),
            (neq, ":var21", ":var13"),
            (multiplayer_send_int_to_player, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_get_agent_id, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (player_save_picked_up_items_for_next_spawn, ":var13"),
        (player_get_value_of_original_items, ":var19", ":var13"),
        (player_set_slot, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_slot_eq, ":var13", 0, 1),
        (player_get_gold, ":var20", ":var13"),
        (player_get_team_no, ":var4", ":var13"),
        (try_begin),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 1),
          (val_add, ":var20", ":var23"),
        (try_end),
        (try_begin),
          (player_get_slot, ":var19", ":var13", 1),
          (store_add, ":var24", ":var20", ":var19"),
          (store_mul, ":var25", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var24", ":var25"),
          (store_sub, ":var26", ":var25", ":var24"),
          (val_add, ":var20", ":var26"),
        (try_end),
        (player_set_gold, ":var13", ":var20", 15000),
      (try_end),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 0, 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (multiplayer_clear_scene),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (call_script, "script_move_death_mode_flags_down"),
      (try_end),
      (assign, "$g_battle_death_mode_started", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_round_ended", 0),
      (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
      (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (multiplayer_send_int_to_player, ":var13", 78, -9999),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (try_begin),
          (player_slot_eq, ":var1", 0, 0),
          (player_get_team_no, ":var2", ":var1"),
          (lt, ":var2", 2),
          (player_get_troop_id, ":var3", ":var1"),
          (ge, ":var3", 0),
          (assign, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (try_begin),
            (assign, ":var7", 0),
            (get_max_players, ":var0"),
            (try_for_range, ":var8", 0, ":var0"),
              (player_is_active, ":var8"),
              (val_add, ":var7", 1),
              (player_get_team_no, ":var9", ":var8"),
              (try_begin),
                (eq, ":var9", 0),
                (val_add, ":var5", 1),
              (else_try),
                (eq, ":var9", 1),
                (val_add, ":var6", 1),
              (try_end),
            (try_end),
            (store_mul, ":var10", ":var5", ":var6"),
            (store_mission_timer_a, ":var11"),
            (val_sub, ":var11", "$g_round_start_time"),
            (this_or_next|lt, ":var11", 30),
            (this_or_next|le, ":var7", 2),
            (eq, ":var10", 0),
            (eq, "$g_round_ended", 0),
            (assign, ":var4", 1),
          (try_end),
          (eq, ":var4", 1),
          (try_begin),
            (eq, ":var2", 0),
            (assign, ":var12", 0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var12", 32),
          (try_end),
          (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
          (player_spawn_new_agent, ":var1", ":var12"),
          (player_set_slot, ":var1", 0, 1),
        (else_try),
          (eq, "$g_multiplayer_player_respawn_as_bot", 1),
          (player_get_agent_id, ":var13", ":var1"),
          (ge, ":var13", 0),
          (neg|agent_is_alive, ":var13"),
          (agent_get_time_elapsed_since_removed, ":var14", ":var13"),
          (gt, ":var14", "$g_multiplayer_respawn_period"),
          (player_get_team_no, ":var2", ":var1"),
          (assign, ":var15", 0),
          (try_for_agents, ":var16"),
            (eq, ":var15", 0),
            (agent_is_alive, ":var16"),
            (agent_is_human, ":var16"),
            (agent_is_non_player, ":var16"),
            (agent_get_team, ":var17", ":var16"),
            (eq, ":var17", ":var2"),
            (assign, ":var15", 1),
          (try_end),
          (try_begin),
            (eq, ":var15", 1),
            (call_script, "script_find_most_suitable_bot_to_control", ":var1"),
            (player_control_agent, ":var1", reg0),
            (player_get_slot, ":var18", ":var1", 0),
            (val_add, ":var18", 1),
            (player_set_slot, ":var1", 0, ":var18"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (start_presentation, "prsnt_multiplayer_flag_projection_display_bt"),
      (try_end),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_fd", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 3),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_destructible_target_1", "spr_catapult_destructible"),
      (assign, "$g_destructible_target_2", "spr_trebuchet_destructible"),
      (scene_prop_get_num_instances, ":var0", "$g_destructible_target_1"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "$g_destructible_target_1", ":var1"),
        (ge, ":var2", 0),
        (scene_prop_set_team, ":var2", 0),
      (try_end),
      (scene_prop_get_num_instances, ":var3", "$g_destructible_target_2"),
      (try_for_range, ":var4", 0, ":var3"),
        (scene_prop_get_instance, ":var5", "$g_destructible_target_2", ":var4"),
        (ge, ":var5", 0),
        (scene_prop_set_team, ":var5", 0),
      (try_end),
      (try_begin),
        (scene_prop_get_num_instances, ":var6", "spr_catapult_destructible"),
        (ge, ":var6", 1),
        (scene_prop_get_instance, ":var7", "spr_catapult_destructible", 0),
        (scene_prop_get_team, "$g_defender_team", ":var7"),
      (else_try),
        (scene_prop_get_num_instances, ":var8", "spr_trebuchet_destructible"),
        (ge, ":var8", 1),
        (scene_prop_get_instance, ":var9", "spr_trebuchet_destructible", 0),
        (scene_prop_get_team, "$g_defender_team", ":var9"),
      (try_end),
      (assign, "$g_number_of_targets_destroyed", 0),
      (try_begin),
        (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
        (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (try_end),
      (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (try_begin),
        (neg|multiplayer_is_server),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
          (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
          (try_begin),
            (eq, "$g_team_balance_next_round", 1),
            (assign, "$g_team_balance_next_round", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var2"),
        (ge, ":var2", 0),
        (player_get_agent_id, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (agent_is_human, ":var0"),
        (assign, ":var4", 0),
        (assign, ":var5", 0),
        (try_for_agents, ":var6"),
          (agent_is_human, ":var6"),
          (try_begin),
            (agent_is_alive, ":var6"),
            (agent_get_team, ":var7", ":var6"),
            (try_begin),
              (eq, ":var7", 0),
              (val_add, ":var4", 1),
            (else_try),
              (eq, ":var7", 1),
              (val_add, ":var5", 1),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (this_or_next|eq, ":var4", 0),
            (eq, ":var5", 0),
            (assign, "$g_winner_team", -1),
            (assign, reg0, "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var4", 0),
              (try_begin),
                (neq, ":var5", 0),
                (assign, "$g_winner_team", 1),
              (try_end),
              (try_begin),
                (eq, "$g_winner_team", -1),
              (else_try),
                (eq, "$g_defender_team", 1),
                (try_begin),
                  (neg|multiplayer_is_server),
                  (call_script, "script_calculate_number_of_targets_destroyed"),
                (try_end),
                (store_sub, ":var8", 2, "$g_number_of_targets_destroyed"),
                (call_script, "script_show_multiplayer_message", 16, ":var8"),
              (else_try),
                (call_script, "script_show_multiplayer_message", 17, 0),
              (try_end),
            (else_try),
              (try_begin),
                (neq, ":var4", 0),
                (assign, "$g_winner_team", 0),
              (try_end),
              (try_begin),
                (eq, "$g_winner_team", -1),
              (else_try),
                (eq, "$g_defender_team", 0),
                (try_begin),
                  (neg|multiplayer_is_server),
                  (call_script, "script_calculate_number_of_targets_destroyed"),
                (try_end),
                (store_sub, ":var8", 2, "$g_number_of_targets_destroyed"),
                (call_script, "script_show_multiplayer_message", 16, ":var8"),
              (else_try),
                (call_script, "script_show_multiplayer_message", 17, 0),
              (try_end),
            (try_end),
            (store_mission_timer_a, "$g_round_finish_time"),
            (assign, "$g_round_ended", 1),
            (try_begin),
              (multiplayer_is_server),
              (ge, "$g_winner_team", 0),
              (lt, "$g_winner_team", 2),
              (neq, "$g_winner_team", -1),
              (team_get_score, ":var9", "$g_winner_team"),
              (store_sub, ":var10", 2, "$g_number_of_targets_destroyed"),
              (val_add, ":var9", ":var10"),
              (call_script, "script_team_set_score", "$g_winner_team", ":var9"),
              (get_max_players, ":var11"),
              (try_for_range, ":var12", 1, ":var11"),
                (player_is_active, ":var12"),
                (multiplayer_send_2_int_to_player, ":var12", 72, "$g_winner_team", ":var9"),
              (try_end),
            (try_end),
            (try_begin),
              (neq, "$g_defender_team", "$g_winner_team"),
              (neq, "$g_winner_team", -1),
              (assign, "$g_number_of_targets_destroyed", 2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (agent_is_human, ":var0"),
        (neg|agent_is_non_player, ":var0"),
        (ge, ":var0", 0),
        (agent_get_player_id, ":var13", ":var0"),
        (ge, ":var13", 0),
        (set_fixed_point_multiplier, 100),
        (agent_get_player_id, ":var13", ":var0"),
        (agent_get_position, pos0, ":var0"),
        (position_get_x, ":var14", pos0),
        (position_get_y, ":var15", pos0),
        (position_get_z, ":var16", pos0),
        (player_set_slot, ":var13", 29, ":var14"),
        (player_set_slot, ":var13", 30, ":var15"),
        (player_set_slot, ":var13", 31, ":var16"),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_number_of_targets_destroyed", 2),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (multiplayer_get_my_player, ":var0"),
      (call_script, "script_draw_this_round", -9),
      (get_max_players, ":var1"),
      (try_for_range, ":var2", 1, ":var1"),
        (player_is_active, ":var2"),
        (neq, ":var2", ":var0"),
        (multiplayer_send_int_to_player, ":var2", 69, -9),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (assign, "$g_winner_team", -9),
      (multiplayer_get_my_player, ":var0"),
      (store_sub, ":var1", 2, "$g_number_of_targets_destroyed"),
      (call_script, "script_show_multiplayer_message", 16, ":var1"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 1, ":var2"),
        (player_is_active, ":var3"),
        (multiplayer_send_2_int_to_player, ":var3", 68, 16, ":var1"),
      (try_end),
      (call_script, "script_draw_this_round", "$g_winner_team"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 1, ":var2"),
        (player_is_active, ":var3"),
        (neq, ":var3", ":var0"),
        (multiplayer_send_int_to_player, ":var3", 69, "$g_winner_team"),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_winner_team", "$g_defender_team"),
        (team_get_score, ":var4", "$g_winner_team"),
        (store_sub, ":var5", 2, "$g_number_of_targets_destroyed"),
        (val_add, ":var4", ":var5"),
        (call_script, "script_team_set_score", "$g_winner_team", ":var4"),
        (try_for_range, ":var3", 1, ":var2"),
          (player_is_active, ":var3"),
          (multiplayer_send_2_int_to_player, ":var3", 72, "$g_winner_team", ":var4"),
        (try_end),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (multiplayer_is_server),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (get_max_players, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (player_is_active, ":var8"),
            (multiplayer_send_int_to_player, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (prop_instance_get_position, pos2, ":var1"),
      (prop_instance_get_position, pos3, ":var2"),
      (prop_instance_get_position, pos4, ":var3"),
      (copy_position, 7, 1),
      (position_move_z, pos7, 100),
      (copy_position, 8, 2),
      (position_move_z, pos8, 100),
      (get_distance_between_positions, ":var4", pos1, pos3),
      (get_distance_between_positions, ":var5", pos2, pos4),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (get_max_players, ":var8"),
      (try_for_range, ":var9", 0, ":var8"),
        (player_is_active, ":var9"),
        (player_get_agent_id, ":var10", ":var9"),
        (ge, ":var10", 0),
        (agent_is_human, ":var10"),
        (agent_is_alive, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos0, ":var10"),
        (agent_get_horse, ":var12", ":var10"),
        (eq, ":var12", -1),
        (try_begin),
          (eq, ":var11", 0),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", 1),
            (else_try),
              (eq, ":var6", -1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", -1),
            (else_try),
              (eq, ":var7", 1),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var11", 1),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", -1),
            (else_try),
              (eq, ":var6", 1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var4", 800),
        (assign, "$g_winner_team", 0),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var14", 0),
        (call_script, "script_team_set_score", 0, ":var14"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 0, ":var14"),
        (try_end),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (else_try),
        (ge, ":var5", 800),
        (assign, "$g_winner_team", 1),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var15", 1),
        (call_script, "script_team_set_score", 1, ":var15"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 1, ":var15"),
        (try_end),
        (call_script, "script_show_multiplayer_message", 12, 0),
        (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (try_end),
      (try_begin),
        (eq, "$g_round_ended", 0),
        (position_get_z, ":var16", pos3),
        (prop_instance_is_animating, ":var17", ":var2"),
        (try_begin),
          (eq, ":var6", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var2"),
        (else_try),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", -1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var18", ":var16"),
          (get_distance_between_positions, ":var19", pos3, pos7),
          (gt, ":var19", 0),
          (val_mul, ":var19", 16),
          (prop_instance_animate_to_position, ":var2", pos7, ":var19"),
        (else_try),
          (eq, ":var6", 1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var18", ":var16"),
          (copy_position, 5, 1),
          (position_move_z, pos5, 800),
          (get_distance_between_positions, ":var19", pos3, pos5),
          (gt, ":var19", 0),
          (val_mul, ":var19", 8),
          (prop_instance_animate_to_position, ":var2", pos5, ":var19"),
        (try_end),
        (position_get_z, ":var20", pos4),
        (prop_instance_is_animating, ":var17", ":var3"),
        (try_begin),
          (eq, ":var7", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var3"),
        (else_try),
          (this_or_next|eq, ":var7", 0),
          (eq, ":var7", -1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var21", ":var20"),
          (get_distance_between_positions, ":var22", pos4, pos8),
          (gt, ":var22", 0),
          (val_mul, ":var22", 16),
          (prop_instance_animate_to_position, ":var3", pos8, ":var22"),
        (else_try),
          (eq, ":var7", 1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var21", ":var20"),
          (copy_position, 6, 2),
          (position_move_z, pos6, 800),
          (get_distance_between_positions, ":var22", pos4, pos6),
          (gt, ":var22", 0),
          (val_mul, ":var22", 8),
          (prop_instance_animate_to_position, ":var3", pos6, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (get_max_players, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (player_is_active, ":var13"),
              (player_get_team_no, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (player_get_slot, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (player_get_agent_id, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (player_get_kill_count, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (player_set_kill_count, ":var12", ":var16"),
                (player_get_death_count, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (player_set_death_count, ":var12", ":var17"),
                (player_get_score, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (player_set_score, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (player_is_active, ":var13"),
                  (multiplayer_send_4_int_to_player, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (player_get_value_of_original_items, ":var19", ":var12"),
                (player_get_gold, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (player_set_gold, ":var12", ":var20", 15000),
              (try_end),
              (player_set_troop_id, ":var12", -1),
              (player_set_team_no, ":var12", ":var9"),
              (multiplayer_send_message_to_player, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (multiplayer_get_my_player, ":var21"),
          (get_max_players, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (player_is_active, ":var13"),
            (neq, ":var21", ":var13"),
            (multiplayer_send_int_to_player, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_get_agent_id, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (player_save_picked_up_items_for_next_spawn, ":var13"),
        (player_get_value_of_original_items, ":var19", ":var13"),
        (player_set_slot, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (store_sub, ":var24", 2, "$g_number_of_targets_destroyed"),
      (store_mul, ":var25", ":var24", 100),
      (store_mul, ":var26", "$g_number_of_targets_destroyed", 100),
      (val_add, ":var25", 100),
      (val_sub, ":var26", 100),
      (get_max_players, ":var2"),
      (val_mul, ":var25", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var25", 100),
      (val_mul, ":var26", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var26", 100),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_slot_eq, ":var13", 0, 1),
        (player_get_gold, ":var20", ":var13"),
        (player_get_team_no, ":var4", ":var13"),
        (val_add, ":var20", ":var23"),
        (try_begin),
          (eq, ":var4", "$g_defender_team"),
          (val_add, ":var20", ":var25"),
        (else_try),
          (val_add, ":var20", ":var26"),
        (try_end),
        (try_begin),
          (player_get_slot, ":var19", ":var13", 1),
          (store_add, ":var27", ":var20", ":var19"),
          (store_mul, ":var28", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var27", ":var28"),
          (store_sub, ":var29", ":var28", ":var27"),
          (val_add, ":var20", ":var29"),
        (try_end),
        (player_set_gold, ":var13", ":var20", 15000),
      (try_end),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 0, 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (multiplayer_clear_scene),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 1, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 32, 0),
        (player_set_slot, ":var13", 33, 0),
      (try_end),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_round_ended", 0),
      (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
      (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
      (call_script, "script_initialize_objects"),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (multiplayer_send_int_to_player, ":var13", 78, -9999),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (try_begin),
          (player_slot_eq, ":var1", 0, 0),
          (player_get_team_no, ":var2", ":var1"),
          (lt, ":var2", 2),
          (player_get_troop_id, ":var3", ":var1"),
          (ge, ":var3", 0),
          (assign, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (try_begin),
            (assign, ":var7", 0),
            (get_max_players, ":var0"),
            (try_for_range, ":var8", 0, ":var0"),
              (player_is_active, ":var8"),
              (val_add, ":var7", 1),
              (player_get_team_no, ":var9", ":var8"),
              (try_begin),
                (eq, ":var9", 0),
                (val_add, ":var5", 1),
              (else_try),
                (eq, ":var9", 1),
                (val_add, ":var6", 1),
              (try_end),
            (try_end),
            (store_mul, ":var10", ":var5", ":var6"),
            (store_mission_timer_a, ":var11"),
            (val_sub, ":var11", "$g_round_start_time"),
            (this_or_next|lt, ":var11", 30),
            (this_or_next|le, ":var7", 2),
            (eq, ":var10", 0),
            (eq, "$g_round_ended", 0),
            (assign, ":var4", 1),
          (try_end),
          (eq, ":var4", 1),
          (try_begin),
            (eq, ":var2", 0),
            (assign, ":var12", 0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var12", 32),
          (try_end),
          (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
          (player_spawn_new_agent, ":var1", ":var12"),
          (player_set_slot, ":var1", 0, 1),
        (else_try),
          (eq, "$g_multiplayer_player_respawn_as_bot", 1),
          (player_get_agent_id, ":var13", ":var1"),
          (ge, ":var13", 0),
          (neg|agent_is_alive, ":var13"),
          (agent_get_time_elapsed_since_removed, ":var14", ":var13"),
          (gt, ":var14", "$g_multiplayer_respawn_period"),
          (player_get_team_no, ":var2", ":var1"),
          (assign, ":var15", 0),
          (try_for_agents, ":var16"),
            (eq, ":var15", 0),
            (agent_is_alive, ":var16"),
            (agent_is_human, ":var16"),
            (agent_is_non_player, ":var16"),
            (agent_get_team, ":var17", ":var16"),
            (eq, ":var17", ":var2"),
            (assign, ":var15", 1),
          (try_end),
          (try_begin),
            (eq, ":var15", 1),
            (call_script, "script_find_most_suitable_bot_to_control", ":var1"),
            (player_control_agent, ":var1", reg0),
            (player_get_slot, ":var18", ":var1", 0),
            (val_add, ":var18", 1),
            (player_set_slot, ":var1", 0, ":var18"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("bandit_lair", mtf_battle_mode|mtf_synch_inventory, charge,
  "Ambushing a bandit lair",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 7, []),
    (1, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (7, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    magic_trigger,

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 3, 
    [
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (item_slot_eq, "$currentbanner", 132, 1),
      (try_begin),
        (eq, "$spell_cast", 1),
        (store_random_in_range, ":var0", 1, 6),
        (try_begin),
          (eq, ":var0", 5),
          (call_script, "script_cf_cancel_magic_effect"),
          (display_message, "@The rune of spellbreaking cancels all magical effects.", 0xFFCC00),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_slot_eq, "trp_player", 225, 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_player_missile_light", "itm_phas_protection_ammo"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (item_get_type, ":var7", ":var3"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (item_get_type, ":var8", ":var4"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (item_get_type, ":var9", ":var5"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (item_get_type, ":var10", ":var6"),
        (try_end),
        (try_begin),
          (ge, ":var3", 1),
          (this_or_next|eq, ":var7", 17),
          (this_or_next|eq, ":var7", 16),
          (eq, ":var7", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var3", 0),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (this_or_next|eq, ":var8", 17),
          (this_or_next|eq, ":var8", 16),
          (eq, ":var8", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var4", 1),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (this_or_next|eq, ":var9", 17),
          (this_or_next|eq, ":var9", 16),
          (eq, ":var9", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var5", 2),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (this_or_next|eq, ":var10", 17),
          (this_or_next|eq, ":var10", 16),
          (eq, ":var10", 18),
          (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
          (agent_unequip_item, ":var0", ":var6", 3),
        (try_end),
      (else_try),
        (item_get_type, ":var11", ":var1"),
        (this_or_next|eq, ":var11", 17),
        (this_or_next|eq, ":var11", 16),
        (eq, ":var11", 18),
        (neg|is_between, ":var1", "itm_player_missile_light", "itm_items_end"),
        (troop_get_inventory_slot, ":var3", "trp_player", ek_item_0),
        (troop_get_inventory_slot, ":var4", "trp_player", ek_item_1),
        (troop_get_inventory_slot, ":var5", "trp_player", ek_item_2),
        (troop_get_inventory_slot, ":var6", "trp_player", ek_item_3),
        (try_begin),
          (ge, ":var3", 1),
          (is_between, ":var3", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var4", 1),
          (is_between, ":var4", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var5", 1),
          (is_between, ":var5", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
        (try_begin),
          (ge, ":var6", 1),
          (is_between, ":var6", "itm_player_missile_light", "itm_phas_protection_ammo"),
          (agent_unequip_item, ":var0", ":var1"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (assign, "$relative_of_merchant_is_found", 0),
      (try_begin),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (eq, ":var1", 1),
        (agent_get_position, pos4, ":var0"),
        (agent_set_scripted_destination, ":var0", pos4, 1),
      (try_end),
      (try_begin),
        (agent_get_troop_id, ":var2", ":var0"),
        (is_between, ":var2", "trp_relative_of_merchant", "trp_relative_of_merchants_end"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (party_get_template_id, ":var0", "$g_encountered_party"),
      (eq, ":var0", "pt_looter_lair"),
      (check_quest_active, "qst_save_relative_of_merchant"),
      (eq, "$relative_of_merchant_is_found", 0),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (is_between, ":var2", "trp_relative_of_merchant", "trp_relative_of_merchants_end"),
        (agent_set_scripted_destination, ":var1", pos0),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (le, ":var3", 200),
        (start_mission_conversation, "trp_relative_of_merchant"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (1, 0, ti_once, 
    [],
    [
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$bandits_spawned_extra", 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (eq, ":var1", 1),
        (agent_is_in_special_mode, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_position, pos0, ":var0"),
        (try_for_agents, ":var2"),
          (agent_is_alive, ":var2"),
          (agent_get_team, ":var3", ":var2"),
          (eq, ":var3", 0),
          (agent_is_human, ":var2"),
          (store_agent_hit_points, ":var4", ":var0"),
          (assign, ":var5", 0),
          (try_begin),
            (lt, ":var4", 100),
            (try_for_agents, ":var6"),
              (agent_is_alive, ":var6"),
              (agent_get_team, ":var7", ":var6"),
              (eq, ":var7", 1),
              (neq, ":var0", ":var6"),
              (agent_is_in_special_mode, ":var6"),
              (agent_is_human, ":var6"),
              (agent_get_position, pos1, ":var0"),
              (agent_get_position, pos2, ":var6"),
              (get_distance_between_positions, ":var8", pos1, pos2),
              (le, ":var8", 1000),
              (agent_clear_scripted_mode, ":var6"),
            (try_end),
            (assign, ":var5", 1),
          (else_try),
            (agent_get_position, pos1, ":var0"),
            (agent_get_position, pos2, ":var2"),
            (get_distance_between_positions, ":var8", pos1, pos2),
            (le, ":var8", 4000),
            (try_for_agents, ":var6"),
              (agent_is_alive, ":var6"),
              (agent_get_team, ":var7", ":var6"),
              (eq, ":var7", 1),
              (neq, ":var0", ":var6"),
              (agent_is_in_special_mode, ":var6"),
              (agent_is_human, ":var6"),
              (agent_get_position, pos1, ":var0"),
              (agent_get_position, pos2, ":var6"),
              (get_distance_between_positions, ":var8", pos1, pos2),
              (le, ":var8", 1000),
              (agent_clear_scripted_mode, ":var6"),
            (try_end),
            (assign, ":var5", 1),
          (try_end),
          (eq, ":var5", 1),
          (agent_clear_scripted_mode, ":var0"),
        (try_end),
      (try_end),
    ]),

    (15, 0, 0, 
    [
      (le, "$defender_reinforcement_stage", 1),
    ],
    [
      (store_character_level, ":var0", "trp_player"),
      (store_add, ":var1", 5, ":var0"),
      (val_div, ":var1", 3),
      (val_max, ":var1", 1),
      (lt, "$bandits_spawned_extra", ":var1"),
      (val_add, "$bandits_spawned_extra", 1),
      (party_get_template_id, ":var2", "$g_encountered_party"),
      (store_random_in_range, ":var3", 0, 2),
      (assign, ":var4", "trp_goblin_bandit"),
      (try_begin),
        (eq, ":var2", "pt_steppe_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_skeleton_warrior"),
      (else_try),
        (eq, ":var2", "pt_goblin_bandit4_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_goblin_bandit"),
      (else_try),
        (eq, ":var2", "pt_goblin_bandit3_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_nord_trained_footman"),
      (else_try),
        (eq, ":var2", "pt_goblin_bandit6_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_nord_trained_footman"),
      (else_try),
        (eq, ":var2", "pt_sea_raider_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_skeleton_warrior"),
      (else_try),
        (eq, ":var2", "pt_desert_bandits2_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_hunter_bandit"),
      (else_try),
        (eq, ":var2", "pt_amazon_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_amazon_bandit"),
      (else_try),
        (eq, ":var2", "pt_hunter_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_bandit"),
      (else_try),
        (eq, ":var2", "pt_desert_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_hunter_bandit"),
      (else_try),
        (eq, ":var2", "pt_goblin_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_goblin_bandit"),
      (else_try),
        (eq, ":var2", "pt_taiga_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_skaven_corsair"),
      (else_try),
        (eq, ":var2", "pt_sea_raider2_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_skaven_corsair"),
      (else_try),
        (eq, ":var2", "pt_goblin_bandit5_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_goblin_bandit"),
      (else_try),
        (eq, ":var2", "pt_mountain_bandits_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_looter_goblin"),
      (else_try),
        (eq, ":var2", "pt_beastmen_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_nord_trained_footman"),
      (else_try),
        (eq, ":var2", "pt_nippon_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_nippon_ninja"),
      (else_try),
        (eq, ":var2", "pt_goblin_bandit2_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_goblin_bandit"),
      (else_try),
        (eq, ":var2", "pt_amazon_hunters_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_goblin_bandit"),
      (else_try),
        (this_or_next|eq, ":var2", "pt_looter_lair"),
        (neq, ":var3", 0),
      (try_end),
      (try_begin),
        (eq, ":var3", 0),
        (store_random_in_range, ":var5", 2, 5),
        (add_visitors_to_current_scene, ":var5", ":var4", 1),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_3, ":var1"),
      (try_begin),
        (ge, ":var0", 0),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var2", ":var0"),
        (str_store_troop_name, s6, ":var2"),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (party_add_members, "p_total_enemy_casualties", ":var2", 1),
          (try_begin),
            (eq, ":var1", 1),
            (party_wound_members, "p_total_enemy_casualties", ":var2", 1),
          (try_end),
        (try_end),
        (party_add_members, "p_temp_casualties", ":var2", 1),
        (eq, ":var1", 1),
        (party_wound_members, "p_temp_casualties", ":var2", 1),
      (try_end),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (agent_is_non_player, ":var4"),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (neg|agent_is_ally, ":var4"),
        (val_add, ":var3", 1),
      (try_end),
      (try_begin),
        (le, ":var3", 2),
        (le, "$defender_reinforcement_stage", 1),
        (val_add, "$defender_reinforcement_stage", 1),
        (store_character_level, ":var5", "trp_player"),
        (store_add, ":var6", 5, ":var5"),
        (val_div, ":var6", 3),
        (try_begin),
          (ge, "$defender_reinforcement_stage", 2),
          (val_sub, ":var6", "$bandits_spawned_extra"),
        (try_end),
        (party_get_template_id, ":var7", "$g_encountered_party"),
        (store_random_in_range, ":var8", 0, 2),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", "pt_steppe_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_skeleton_warrior"),
        (else_try),
          (eq, ":var7", "pt_goblin_bandit4_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_goblin_bandit"),
        (else_try),
          (eq, ":var7", "pt_goblin_bandit3_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_goblin_bandit"),
        (else_try),
          (eq, ":var7", "pt_goblin_bandit6_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_goblin_bandit"),
        (else_try),
          (eq, ":var7", "pt_sea_raider_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_chaos_dwarf_warrior"),
        (else_try),
          (eq, ":var7", "pt_desert_bandits2_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_hunter_bandit"),
        (else_try),
          (eq, ":var7", "pt_amazon_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_amazon_bandit"),
        (else_try),
          (eq, ":var7", "pt_hunter_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_hunter_bandit"),
        (else_try),
          (eq, ":var7", "pt_desert_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_hunter_bandit"),
        (else_try),
          (eq, ":var7", "pt_goblin_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_goblin_bandit"),
        (else_try),
          (eq, ":var7", "pt_taiga_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_taiga_bandit"),
        (else_try),
          (eq, ":var7", "pt_sea_raider2_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_chaos_dwarf_warrior"),
        (else_try),
          (eq, ":var7", "pt_goblin_bandit5_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_goblin_bandit"),
        (else_try),
          (eq, ":var7", "pt_mountain_bandits_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_skeleton_warrior"),
        (else_try),
          (eq, ":var7", "pt_beastmen_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_chaos_dwarf_warrior"),
        (else_try),
          (eq, ":var7", "pt_nippon_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_nippon_ninja"),
        (else_try),
          (eq, ":var7", "pt_goblin_bandit2_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_skeleton_warrior"),
        (else_try),
          (eq, ":var7", "pt_amazon_hunters_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_amazon_bandit"),
        (else_try),
          (this_or_next|eq, ":var7", "pt_looter_lair"),
          (neq, ":var8", 0),
        (try_end),
        (try_begin),
          (eq, ":var8", 0),
          (store_random_in_range, ":var10", 2, 5),
          (add_visitors_to_current_scene, ":var10", ":var9", ":var6"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
    ]),

    (2, 0, ti_once, 
    [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (party_get_template_id, ":var0", "$g_encountered_party"),
      (try_begin),
        (eq, ":var0", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (store_faction_of_party, ":var1", "$g_starting_town"),
        (try_begin),
          (assign, ":var2", "trp_relative_of_merchant"),
        (try_end),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos0, ":var3"),
        (assign, ":var4", 100000),
        (try_for_range, ":var5", 1, 10),
          (entry_point_get_position, pos1, ":var5"),
          (get_distance_between_positions, ":var6", pos0, pos1),
          (le, ":var6", ":var4"),
          (ge, ":var6", 1000),
          (assign, ":var7", ":var5"),
          (assign, ":var4", ":var6"),
        (try_end),
        (add_visitors_to_current_scene, ":var7", ":var2", 1, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (assign, ":var0", 0),
      (party_get_template_id, ":var1", "$g_encountered_party"),
      (try_begin),
        (eq, ":var1", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (this_or_next|main_hero_fallen),
        (eq, "$relative_of_merchant_is_found", 1),
        (assign, ":var0", 1),
      (else_try),
        (this_or_next|neq, ":var1", "pt_looter_lair"),
        (neg|check_quest_active, "qst_save_relative_of_merchant"),
        (store_mission_timer_a, ":var2"),
        (ge, ":var2", 5),
        (this_or_next|main_hero_fallen),
        (num_active_teams_le, 1),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
      (else_try),
        (party_set_slot, "$g_encountered_party", 8, 2),
      (try_end),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("alley_fight", mtf_battle_mode, charge,
  "Alley fight",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 7, []),
    (1, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (assign, "$g_main_attacker_agent", ":var0"),
      (agent_ai_set_aggressiveness, ":var0", 199),
      (try_begin),
        (agent_get_troop_id, ":var2", ":var0"),
        (is_between, ":var2", "trp_swadian_merchant", "trp_startup_merchants_end"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$talked_with_merchant", 0),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (is_between, ":var2", "trp_swadian_merchant", "trp_startup_merchants_end"),
        (agent_set_scripted_destination, ":var1", pos0),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (le, ":var3", 200),
        (assign, "$talk_context", 11),
        (start_mission_conversation, ":var2"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (ge, "$g_main_attacker_agent", 0),
      (ge, ":var0", 0),
      (agent_is_active, "$g_main_attacker_agent"),
      (agent_is_active, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (agent_get_position, pos1, "$g_main_attacker_agent"),
      (get_distance_between_positions, ":var1", pos0, pos1),
      (ge, ":var1", 5),
      (agent_set_scripted_destination, "$g_main_attacker_agent", pos0),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (display_message, "str_cannot_leave_now"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
    ]),

    (0, 0, ti_once, 
    [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (store_faction_of_party, ":var0", "$g_starting_town"),
      (try_begin),
        (eq, ":var0", "fac_kingdom_1"),
        (assign, ":var1", "trp_swadian_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_2"),
        (assign, ":var1", "trp_vaegir_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_3"),
        (assign, ":var1", "trp_khergit_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_4"),
        (assign, ":var1", "trp_nord_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_5"),
        (assign, ":var1", "trp_rhodok_merchant"),
      (else_try),
        (eq, ":var0", "fac_kingdom_6"),
        (assign, ":var1", "trp_sarranid_merchant"),
      (try_end),
      (add_visitors_to_current_scene, 3, ":var1", 1, 0),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talked_with_merchant", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),
      (assign, "$current_startup_quest_phase", 1),
      (change_screen_return),
      (set_trigger_result, 1),
      (get_player_agent_no, ":var0"),
      (store_agent_hit_points, ":var1", ":var0"),
      (try_begin),
        (lt, ":var1", 90),
        (agent_set_hit_points, ":var0", 90),
      (try_end),
    ]),

    (1, 3, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),
      (assign, "$current_startup_quest_phase", 1),
      (change_screen_return),
      (set_trigger_result, 1),
      (get_player_agent_no, ":var0"),
      (store_agent_hit_points, ":var1", ":var0"),
      (try_begin),
        (lt, ":var1", 90),
        (agent_set_hit_points, ":var0", 90),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("meeting_merchant", 0, -1,
  "Meeting with the merchant",
  [
    (0, mtef_team_0, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (agent_get_troop_id, ":var1", ":var0"),
        (is_between, ":var1", "trp_swadian_merchant", "trp_startup_merchants_end"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (assign, "$dialog_with_merchant_ended", 0),
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (eq, "$talk_context", 14),
        (call_script, "script_music_set_situation_with_culture", 512),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (ge, "$dialog_with_merchant_ended", 6),
        (assign, ":var0", 1),
      (else_try),
        (ge, "$dialog_with_merchant_ended", 1),
        (neg|conversation_screen_is_active),
        (try_begin),
          (eq, "$dialog_with_merchant_ended", 1),
          (check_quest_active, "qst_collect_men"),
          (dialog_box, "str_start_up_first_quest", "@Tutorial"),
        (try_end),
        (val_add, "$dialog_with_merchant_ended", 1),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (conversation_screen_is_active),
        (tutorial_message, -1),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
    ],
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, 500, 650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "str_press_tab_to_exit_from_town"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (gt, "$dialog_with_merchant_ended", 0),
        (assign, ":var0", 0),
        (party_get_position, pos1, "$current_town"),
        (try_for_range, ":var1", 0, 10),
          (map_get_random_position_around_position, pos0, pos1, 2),
          (get_distance_between_positions, ":var2", pos0, pos1),
          (ge, ":var2", ":var0"),
          (assign, ":var0", ":var2"),
          (copy_position, 2, 0),
        (try_end),
        (party_set_position, "p_main_party", pos2),
        (finish_mission),
        (assign, "$current_startup_quest_phase", 2),
        (tutorial_message, -1),
        (tutorial_message_set_background, 0),
        (change_screen_map),
        (try_begin),
          (check_quest_finished, "qst_save_town_from_bandits"),
          (assign, "$g_do_one_more_meeting_with_merchant", 1),
        (else_try),
          (set_spawn_radius, 50),
          (try_for_range, ":var1", 0, 20),
            (spawn_around_party, "p_main_party", "pt_looters"),
          (try_end),
        (try_end),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("town_fight", 0, -1,
  "Town Fight",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_team, ":var0", 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (mission_disable_talk),
      (assign, "$g_main_attacker_agent", 0),
      (set_party_battle_mode),
      (assign, "$number_of_bandits_killed_by_player", 0),
      (assign, "$number_of_civilian_loses", 0),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (1, 0, ti_once, 
    [
      (call_script, "script_init_town_walker_agents"),
    ],
    []),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (try_begin),
        (agent_get_team, ":var2", ":var0"),
        (eq, ":var2", 1),
        (get_player_agent_no, ":var3"),
        (eq, ":var3", ":var1"),
        (val_add, "$number_of_bandits_killed_by_player", 1),
      (else_try),
        (eq, ":var2", 0),
        (val_add, "$number_of_civilian_loses", 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (lt, "$merchant_sign_count", 8),
      (val_add, "$merchant_sign_count", 1),
      (try_begin),
        (eq, "$merchant_sign_count", 2),
        (get_player_agent_no, ":var0"),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (ge, ":var2", "trp_swadian_merchant"),
          (lt, ":var2", "trp_startup_merchants_end"),
          (assign, "$g_city_merchant_troop_id", ":var2"),
          (assign, "$g_city_merchant_agent_id", ":var1"),
          (agent_get_position, pos0, ":var0"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var3", -1000),
          (try_for_range, ":var4", 0, 64),
            (entry_point_get_position, pos6, ":var4"),
            (get_distance_between_positions, ":var5", pos0, pos6),
            (get_distance_between_positions, ":var6", pos1, pos6),
            (store_sub, ":var7", ":var6", ":var5"),
            (ge, ":var6", 15),
            (ge, ":var7", ":var3"),
            (copy_position, 2, 6),
            (assign, ":var3", ":var7"),
          (try_end),
          (agent_set_scripted_destination, ":var1", pos2, 0),
          (agent_set_speed_limit, ":var1", 10),
        (try_end),
      (else_try),
        (eq, "$merchant_sign_count", 5),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos0, ":var0"),
        (agent_set_scripted_destination, "$g_city_merchant_agent_id", pos0, 0),
        (agent_set_speed_limit, "$g_city_merchant_agent_id", 10),
      (else_try),
        (eq, "$merchant_sign_count", 7),
        (agent_clear_scripted_mode, "$g_city_merchant_agent_id"),
        (assign, "$talk_context", 0),
        (start_mission_conversation, "$g_city_merchant_troop_id"),
      (try_end),
    ],
    []),

    (1, 0, 0, 
    [],
    [
      (ge, "$merchant_sign_count", 8),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (eq, ":var2", 0),
        (agent_get_position, pos0, ":var1"),
        (assign, ":var3", 10000),
        (try_for_agents, ":var4"),
          (agent_is_alive, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 1),
          (agent_get_position, pos1, ":var4"),
          (get_distance_between_positions, ":var6", pos0, pos1),
          (le, ":var6", ":var3"),
          (assign, ":var3", ":var6"),
          (copy_position, 2, 1),
        (try_end),
        (assign, reg1, ":var6"),
        (try_begin),
          (le, ":var3", 500),
          (agent_clear_scripted_mode, ":var1"),
        (else_try),
          (lt, ":var3", 10000),
          (agent_set_scripted_destination, ":var1", pos2, 0),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (lt, "$merchant_sign_count", 8),
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
      (ge, "$merchant_sign_count", 8),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (assign, "$current_startup_quest_phase", 4),
      (mission_enable_talk),
      (finish_mission),
      (unlock_achievement, 6),
      (change_screen_return),
      (set_trigger_result, 1),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("multiplayer_duel", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 7),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (team_set_relation, 0, 0, 1),
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 1, 1, 1),
      (mission_set_duel_mode, 1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (get_player_agent_no, ":var2"),
        (agent_is_active, ":var2"),
        (agent_slot_ge, ":var2", 21, 0),
        (try_begin),
          (eq, ":var0", ":var2"),
          (display_message, "str_you_have_lost_a_duel"),
        (else_try),
          (agent_slot_eq, ":var2", 21, ":var0"),
          (display_message, "str_you_have_won_a_duel"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_ge, ":var0", 21, 0),
        (agent_get_slot, ":var3", ":var0", 21),
        (agent_set_slot, ":var0", 21, -1),
        (try_begin),
          (agent_is_active, ":var3"),
          (agent_set_slot, ":var3", 21, -1),
          (agent_clear_relations_with_agents, ":var3"),
          (try_begin),
            (agent_get_player_id, ":var4", ":var3"),
            (neg|player_is_active, ":var4"),
            (agent_force_rethink, ":var3"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (store_random_in_range, ":var1", 0, ":var0"),
        (val_sub, ":var1", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var2", 0),
          (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
        (else_try),
          (assign, ":var2", 1),
          (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
        (try_end),
        (team_get_faction, ":var3", ":var2"),
        (assign, ":var4", 0),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_add, ":var4", 1),
        (try_end),
        (store_random_in_range, ":var7", 0, ":var4"),
        (assign, ":var8", "trp_swadian_crossbowman_multiplayer"),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", ":var8"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_sub, ":var7", 1),
          (lt, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", ":var5"),
        (try_end),
        (troop_get_inventory_slot, ":var10", ":var9", ek_horse),
        (try_begin),
          (ge, ":var10", 0),
          (assign, ":var11", 1),
        (else_try),
          (assign, ":var11", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var11"),
        (store_current_scene, ":var12"),
        (modify_visitors_at_site, ":var12"),
        (add_visitors_to_current_scene, reg0, ":var9", 1, ":var2", -1),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (store_mul, ":var2", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var1", ":var2"),
        (assign, ":var0", 1),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart_deathmatch"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

    (1, 0, 0, 
    [],
    [
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", 3),
      (try_for_agents, ":var2"),
        (agent_slot_ge, ":var2", 21, 0),
        (agent_get_slot, ":var3", ":var2", 22),
        (ge, ":var3", 0),
        (le, ":var3", ":var1"),
        (agent_set_slot, ":var2", 22, -1),
        (agent_get_slot, ":var4", ":var2", 21),
        (agent_is_active, ":var4"),
        (agent_add_relation_with_agent, ":var2", ":var4", -1),
        (agent_force_rethink, ":var2"),
      (try_end),
    ]),

  ]),

  ("lead_charge_water_battle", mtf_battle_mode, -1,
  "You enter battle on your ships.",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (1, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (2, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (12, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$coastal_assault", 0),
      (call_script, "script_list_clear", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_force_weapon", ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|main_hero_fallen),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.3, 0, 0, 
    [],
    [
      (try_begin),
        (is_presentation_active, "prsnt_battle"),
        (call_script, "script_update_order_panel_statistics_and_map"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (store_random_in_range, "$weather", 1, 5),
      (try_begin),
        (eq, "$weather", 1),
        (store_random_in_range, ":var0", 80, 101),
        (set_global_haze_amount, ":var0"),
        (set_global_cloud_amount, ":var0"),
        (set_rain, 1, ":var0"),
        (store_random_in_range, ":var0", 100, 200),
        (set_fog_distance, ":var0", 4287269468),
        (store_random_in_range, "$wind_strange", 0, 2),
      (else_try),
        (eq, "$weather", 2),
        (store_random_in_range, ":var0", 50, 81),
        (set_global_haze_amount, ":var0"),
        (set_global_cloud_amount, ":var0"),
        (set_rain, 1, ":var0"),
        (store_random_in_range, ":var0", 200, 500),
        (set_fog_distance, ":var0", 4293717190),
        (store_random_in_range, "$wind_strange", 0, 2),
      (else_try),
        (eq, "$weather", 3),
        (store_random_in_range, ":var0", 10, 51),
        (set_global_haze_amount, ":var0"),
        (set_global_cloud_amount, ":var0"),
        (set_rain, 1, 0),
        (store_random_in_range, ":var0", 500, 1000),
        (set_fog_distance, ":var0", 4294958008),
        (store_random_in_range, "$wind_strange", 0, 3),
      (else_try),
        (store_random_in_range, ":var0", 0, 10),
        (set_global_haze_amount, ":var0"),
        (set_global_cloud_amount, ":var0"),
        (set_rain, 1, 0),
        (store_random_in_range, ":var0", 1000, 2000),
        (set_fog_distance, ":var0", 4292603391),
        (store_random_in_range, "$wind_strange", 0, 3),
      (try_end),
      (store_random_in_range, "$wind_angle", 0, 360),
      (display_message, "str_klabautermann_info", 0xFF3D9EFF),
    ]),

    (0.1, 0, ti_once, 
    [],
    [
      (call_script, "script_set_ships_and_crew"),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
    ]),

    (1.2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_position, pos6, ":var0"),
        (try_begin),
          (position_get_z, ":var1", pos6),
          (lt, ":var1", -2),
          (assign, ":var2", ":var1"),
          (val_abs, ":var2"),
          (position_move_z, pos6, ":var2"),
          (agent_set_position, ":var0", pos6),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (key_clicked, key_back_space),
        (try_begin),
          (eq, "$cam_mode", 0),
          (assign, "$cam_mode", 1),
          (mission_cam_set_mode, 1, 100, 0),
        (else_try),
          (eq, "$cam_mode", 1),
          (assign, "$cam_mode", 0),
          (mission_cam_set_mode, 0, 2000, 0),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (gt, "$player_ship_number", -1),
        (get_player_agent_no, ":var0"),
        (agent_is_alive, ":var0"),
        (scene_prop_get_instance, ":var1", "spr_klabautermann_ship1", "$player_ship_number"),
        (scene_prop_get_slot, ":var2", ":var1", 6),
        (scene_prop_get_slot, ":var3", ":var1", 7),
        (scene_prop_get_slot, ":var4", ":var1", 8),
        (scene_prop_get_slot, ":var5", ":var1", 12),
        (scene_prop_get_slot, ":var6", ":var1", 13),
        (try_begin),
          (key_clicked, key_enter),
          (try_begin),
            (eq, ":var2", 0),
            (assign, ":var2", 1),
            (display_message, "str_set_sail", 0xFFADD6FF),
          (else_try),
            (assign, ":var2", 0),
            (display_message, "str_get_sail", 0xFFADD6FF),
          (try_end),
        (try_end),
        (try_begin),
          (key_clicked, key_down),
          (gt, ":var3", 0),
          (val_add, ":var3", -1),
          (display_message, "str_less_rowing", 0xFFADD6FF),
        (else_try),
          (key_clicked, key_up),
          (lt, ":var3", 5),
          (val_add, ":var3", 1),
          (display_message, "str_more_rowing", 0xFFADD6FF),
        (try_end),
        (try_begin),
          (key_clicked, key_right),
          (gt, ":var4", -3),
          (val_add, ":var4", -1),
          (display_message, "str_starbord", 0xFFADD6FF),
        (else_try),
          (key_clicked, key_left),
          (lt, ":var4", 3),
          (val_add, ":var4", 1),
          (display_message, "str_port", 0xFFADD6FF),
        (try_end),
        (try_begin),
          (key_clicked, key_k),
          (try_begin),
            (eq, ":var5", -1),
            (assign, ":var5", 0),
            (display_message, "str_try_to_bord", 0xFFADD6FF),
          (else_try),
            (eq, ":var5", 0),
            (assign, ":var5", 1),
            (display_message, "str_bord_even_friendly_ships", 0xFFADD6FF),
          (else_try),
            (eq, ":var5", 1),
            (assign, ":var5", -1),
            (display_message, "str_avoid_boarding", 0xFFADD6FF),
          (try_end),
        (try_end),
        (try_begin),
          (key_clicked, key_j),
          (try_begin),
            (eq, ":var6", 0),
            (assign, ":var6", 1),
            (display_message, "str_try_to_land", 0xFFADD6FF),
          (else_try),
            (eq, ":var6", 1),
            (assign, ":var6", 0),
            (display_message, "str_avoid_landing", 0xFFADD6FF),
          (try_end),
        (try_end),
        (try_begin),
          (key_clicked, key_right_shift),
          (display_message, "str_situation_report", 0xFF7ABDFF),
          (try_begin),
            (gt, "$wind_strange", 0),
            (try_begin),
              (eq, "$wind_strange", 1),
              (str_store_string, s1, "str_light"),
            (else_try),
              (eq, "$wind_strange", 2),
              (str_store_string, s1, "@str strong"),
            (try_end),
            (try_begin),
              (this_or_next|is_between, "$wind_angle", 0, 20),
              (is_between, "$wind_angle", 340, 360),
              (str_store_string, s2, "str_north"),
            (else_try),
              (is_between, "$wind_angle", 20, 70),
              (str_store_string, s2, "str_north_east"),
            (else_try),
              (is_between, "$wind_angle", 70, 110),
              (str_store_string, s2, "str_east"),
            (else_try),
              (is_between, "$wind_angle", 110, 160),
              (str_store_string, s2, "str_south_east"),
            (else_try),
              (is_between, "$wind_angle", 160, 200),
              (str_store_string, s2, "str_south"),
            (else_try),
              (is_between, "$wind_angle", 200, 250),
              (str_store_string, s2, "str_south_west"),
            (else_try),
              (is_between, "$wind_angle", 250, 290),
              (str_store_string, s2, "str_west"),
            (else_try),
              (is_between, "$wind_angle", 290, 340),
              (str_store_string, s2, "str_north_west"),
            (try_end),
            (display_message, "str_wind_comes_from", 0xFF7ABDFF),
          (else_try),
            (display_message, "str_doldrums", 0xFF7ABDFF),
          (try_end),
          (try_begin),
            (scene_prop_get_instance, ":var1", "spr_klabautermann_ship1", "$player_ship_number"),
            (scene_prop_get_slot, reg1, ":var1", 9),
            (val_mul, reg1, 2),
            (display_message, "str_speed_report", 0xFF7ABDFF),
          (try_end),
          (try_begin),
            (eq, "$weather", 1),
            (str_store_string, s1, "str_very_bad"),
          (else_try),
            (eq, "$weather", 2),
            (str_store_string, s1, "str_bad"),
          (else_try),
            (eq, "$weather", 3),
            (str_store_string, s1, "str_normal"),
          (else_try),
            (str_store_string, s1, "str_good"),
          (try_end),
          (display_message, "str_weather_report", 0xFF7ABDFF),
        (try_end),
        (scene_prop_set_slot, ":var1", 6, ":var2"),
        (scene_prop_set_slot, ":var1", 7, ":var3"),
        (scene_prop_set_slot, ":var1", 8, ":var4"),
        (scene_prop_set_slot, ":var1", 12, ":var5"),
        (scene_prop_set_slot, ":var1", 13, ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$cam_mode", 1),
        (neq, "$player_ship_number", -1),
        (scene_prop_get_instance, ":var0", "spr_klabautermann_ship1", "$player_ship_number"),
        (prop_instance_get_position, pos8, ":var0"),
        (position_move_z, pos8, 500),
        (get_player_agent_no, ":var1"),
        (agent_get_look_position, pos9, ":var1"),
        (position_copy_rotation, pos8, pos9),
        (position_move_y, pos8, -1500),
        (try_begin),
          (position_get_z, ":var2", pos8),
          (lt, ":var2", 0),
          (position_set_z, pos8, 0),
        (try_end),
        (mission_cam_set_position, pos8),
      (try_end),
    ]),

    (180, 0, 0, 
    [],
    [
      (try_begin),
        (store_random_in_range, ":var0", 1, 4),
        (try_begin),
          (eq, ":var0", 1),
          (store_random_in_range, "$wind_angle", 0, 360),
        (try_end),
      (try_end),
    ]),

    (1, 0.2, 0, 
    [],
    [
      (call_script, "script_put_the_klabautermann_into_the_ships"),
    ]),

    (1, 0, 5, 
    [],
    [
      (try_begin),
        (lt, "$attacker_reinforcement_stage", 2),
        (store_mission_timer_a, ":var0"),
        (ge, ":var0", 10),
        (store_normalized_team_count, ":var1", 1),
        (lt, ":var1", 6),
        (entry_point_get_position, pos5, 0),
        (set_spawn_position, pos5),
        (assign, "$last_reinforcement_ship", 0),
        (add_reinforcements_to_entry, 0, 7),
        (val_add, "$attacker_reinforcement_stage", 1),
      (try_end),
      (try_begin),
        (lt, "$defender_reinforcement_stage", 2),
        (store_mission_timer_a, ":var0"),
        (ge, ":var0", 10),
        (store_normalized_team_count, ":var1", 0),
        (lt, ":var1", 6),
        (entry_point_get_position, pos5, 10),
        (set_spawn_position, pos5),
        (assign, "$last_reinforcement_ship", 0),
        (add_reinforcements_to_entry, 3, 7),
        (val_add, "$defender_reinforcement_stage", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (try_begin),
        (eq, "$last_reinforcement_ship", 0),
        (spawn_scene_prop, "spr_klabautermann_ship1"),
        (assign, "$last_reinforcement_ship", reg0),
        (scene_prop_set_visibility, "$last_reinforcement_ship", 0),
        (spawn_scene_prop, "spr_Klabautermann_ship1_sail_off"),
        (scene_prop_set_slot, "$last_reinforcement_ship", 17, reg0),
        (spawn_scene_prop, "spr_Klabautermann_ship1_planks_a"),
        (scene_prop_set_slot, "$last_reinforcement_ship", 18, reg0),
        (scene_prop_set_visibility, reg0, 0),
        (spawn_scene_prop, "spr_Klabautermann_ship1_planks_b"),
        (scene_prop_set_slot, "$last_reinforcement_ship", 19, reg0),
        (scene_prop_set_visibility, reg0, 0),
      (try_end),
      (store_trigger_param_1, ":var1"),
      (prop_instance_get_position, pos7, "$last_reinforcement_ship"),
      (position_move_z, pos7, 200),
      (agent_set_position, ":var1", pos7),
      (agent_set_slot, ":var1", 23, "$last_reinforcement_ship"),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$player_ship_number", -1),
        (try_begin),
          (eq, "$move_sound", 0),
          (stop_all_sounds),
          (assign, "$move_sound", -1),
        (try_end),
      (else_try),
        (scene_prop_get_instance, ":var0", "spr_klabautermann_ship1", "$player_ship_number"),
        (scene_prop_get_slot, ":var1", ":var0", 9),
        (try_begin),
          (gt, ":var1", 0),
          (le, "$move_sound", 0),
          (stop_all_sounds),
          (play_sound, "snd_ship_drive", 1),
          (assign, "$move_sound", 1),
        (else_try),
          (le, ":var1", 0),
          (eq, "$move_sound", 1),
          (stop_all_sounds),
          (play_sound, "snd_ship_stay", 1),
          (assign, "$move_sound", 0),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
        (call_script, "script_change_player_party_morale", -25),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@Press TAB to end the battle."),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("ship_battle", mtf_battle_mode, -1,
  "You close in and board the enemy ships",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (1, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (2, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (3, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (4, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (5, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (6, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (7, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (8, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (9, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (12, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (13, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (14, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_list_clear_deep", "trp_list_08"),
      (assign, "$regenerate_in_battle", 0),
      (assign, "$poison_in_battle", 0),
      (assign, "$mummy_in_battle", 0),
      (assign, "$magic_in_battle", 0),
      (call_script, "script_reset_spell_class_cooldown"),
      (assign, "$orcshaman_in_battle", 0),
      (assign, "$savagedominioncast", 0),
      (assign, "$shieldofthornscast", 0),
      (assign, "$harmonicconvergencecast", 0),
      (assign, "$soulblightcast", 0),
      (assign, "$flamingswordcast", 0),
      (assign, "$sneakycast", 0),
      (assign, "$withercast", 0),
      (assign, "$stench_nurgle", 0),
      (assign, "$thewitheringcast", 0),
      (assign, "$usekhpcast", 0),
      (assign, "$tempest", 0),
      (assign, "$boon", 0),
      (assign, "$drain_magic", 0),
      (assign, "$mork_save_uz", 0),
      (assign, "$mork_save_uz_2", 0),
      (assign, "$okkamsmindrazorcast", 0),
      (assign, "$geniecast", 0),
      (assign, "$runebanner_in_battle", 0),
      (assign, "$emitters", 0),
      (assign, "$spells_in_play", 0),
      (assign, "$kill_counter", 0),
      (try_for_range, ":var0", "itm_phas_protection", "itm_runic_banner"),
        (item_set_slot, ":var0", 160, 0),
        (item_set_slot, ":var0", 161, 0),
      (try_end),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_prop_instances, ":var1"),
        (prop_instance_get_scene_prop_kind, ":var2", ":var1"),
        (try_begin),
          (is_between, ":var2", "spr_candle_forcefield1", "spr_beam_emitter_pain_full"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 5),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_candle_netofamyntok", "spr_candle_forcefield1"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 10),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (is_between, ":var2", "spr_beam_emitter_pain_full", "spr_amyntok_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 30),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (else_try),
          (eq, ":var2", "spr_doom_blast"),
          (scene_prop_get_slot, ":var3", ":var1", 53),
          (store_mission_timer_a, ":var4"),
          (store_sub, ":var5", ":var4", ":var3"),
          (ge, ":var5", 2),
          (prop_instance_receive_damage, ":var1", ":var0", 100),
        (try_end),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (ge, ":var0", 1),
    ],
    [
      (troop_slot_eq, "trp_player", 257, 1),
      (troop_slot_eq, "trp_player", 225, 1),
      (start_presentation, "prsnt_magic_overlay"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_b),
      (call_script, "script_list_count", "trp_list_36"),
      (assign, ":var0", reg1),
      (troop_get_slot, ":var1", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var1"),
      (assign, ":var2", reg1),
      (neq, ":var2", ":var0"),
    ],
    [
      (call_script, "script_scroll_up_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_v),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
      (troop_get_slot, ":var0", "trp_player", 231),
      (call_script, "script_list_index_of", "trp_list_36", ":var0"),
      (assign, ":var1", reg1),
      (neq, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_spells"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_n),
    ],
    [
      (call_script, "script_spell_affect_info"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_m),
      (troop_slot_eq, "trp_player", 225, 1),
      (troop_slot_ge, "trp_player", 255, 1),
      (eq, "$willpower_focus", 0),
    ],
    [
      (call_script, "script_cf_willpower_casting"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_k),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_up_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_j),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_scroll_down_potions"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_h),
      (get_player_agent_no, ":var0"),
      (agent_get_slot, ":var1", ":var0", 157),
      (ge, ":var1", 1),
    ],
    [
      (call_script, "script_drink_battle_potion"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (get_player_agent_no, ":var0"),
      (eq, "$mana_boost_activated", 0),
      (store_skill_level, ":var1", 20, "trp_player"),
      (ge, ":var1", 4),
    ],
    [
      (assign, "$mana_boost_activated", 1),
      (display_message, "@Mana boost activated for next casting attempt"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (call_script, "script_list_clear", "trp_list_37"),
      (troop_get_inventory_capacity, ":var0", "trp_player"),
      (try_for_range, ":var1", 0, ":var0"),
        (troop_get_inventory_slot, ":var2", "trp_player", ":var1"),
        (ge, ":var2", 0),
        (is_between, ":var2", "itm_potion_healing", "itm_potion_strength"),
        (call_script, "script_list_add", "trp_list_37", ":var2"),
      (try_end),
      (call_script, "script_list_count", "trp_list_37"),
      (assign, ":var3", reg1),
      (val_add, ":var3", 1),
      (gt, ":var3", 1),
      (start_presentation, "prsnt_potion_overlay"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$hasnotcastthisturn", 1),
    ],
    [
      (call_script, "script_list_clear", "trp_list_13"),
      (call_script, "script_cf_magic_phase_casting"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$magic_in_battle", 1),
      (ge, "$spells_in_play", 1),
    ],
    [
      (store_mission_timer_a, ":var0"),
      (try_for_prop_instances, ":var1"),
        (scene_prop_get_slot, ":var2", ":var1", 55),
        (ge, ":var2", 1),
        (scene_prop_get_slot, ":var3", ":var1", 54),
        (store_sub, ":var4", ":var0", ":var3"),
        (eq, ":var4", 30),
        (call_script, "script_cf_cancel_magic_effect", ":var1", ":var2"),
      (try_end),
    ]),

    (ti_on_item_wielded, 0, 0, 
    [
      (troop_get_type, ":var0", "trp_player"),
      (eq, ":var0", 4),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 137),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 136),
        (try_begin),
          (eq, ":var3", 1),
          (eq, ":var4", 0),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 130),
        (else_try),
          (eq, ":var3", 1),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 140),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 1),
          (agent_set_accuracy_modifier, ":var0", 110),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 2),
          (agent_set_accuracy_modifier, ":var0", 120),
        (else_try),
          (eq, ":var3", 0),
          (eq, ":var4", 3),
          (agent_set_accuracy_modifier, ":var0", 130),
        (try_end),
        (try_begin),
          (eq, ":var5", 1),
          (agent_set_reload_speed_modifier, ":var0", 175),
        (else_try),
          (eq, ":var5", 2),
          (agent_set_reload_speed_modifier, ":var0", 250),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (try_begin),
            (eq, ":var7", 0),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 120),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 128),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 1),
            (agent_set_damage_modifier, ":var0", 136),
          (else_try),
            (eq, ":var7", 1),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 108),
          (else_try),
            (eq, ":var7", 2),
            (eq, ":var6", 0),
            (agent_set_damage_modifier, ":var0", 116),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (eq, ":var9", 1),
          (agent_set_slot, ":var0", 148, 4),
        (else_try),
          (eq, ":var8", 1),
          (agent_set_slot, ":var0", 148, 6),
        (else_try),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 5),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 1),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 1),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (eq, ":var2", "trp_player"),
      (try_begin),
        (is_between, ":var1", "itm_rifle_rune", "itm_ferlangen_musket"),
        (item_get_slot, ":var3", ":var1", 136),
        (item_get_slot, ":var4", ":var1", 128),
        (item_get_slot, ":var5", ":var1", 137),
        (try_begin),
          (this_or_next|eq, ":var4", 1),
          (eq, ":var5", 1),
          (agent_set_accuracy_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (item_get_slot, ":var6", ":var1", 142),
        (item_get_slot, ":var7", ":var1", 124),
        (try_begin),
          (this_or_next|ge, ":var7", 1),
          (eq, ":var6", 1),
          (agent_set_damage_modifier, ":var0", 100),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (agent_set_reload_speed_modifier, 100),
        (else_try),
          (eq, ":var3", 2),
          (agent_set_reload_speed_modifier, 100),
        (try_end),
      (try_end),
      (try_begin),
        (is_between, ":var1", "itm_runearmour", "itm_dwarf_gold_armour"),
        (item_get_slot, ":var8", ":var1", 156),
        (item_get_slot, ":var9", ":var1", 150),
        (item_get_slot, ":var10", ":var1", 148),
        (item_get_slot, ":var11", ":var1", 139),
        (item_get_slot, ":var12", ":var1", 140),
        (try_begin),
          (this_or_next|eq, ":var9", 1),
          (this_or_next|eq, ":var8", 1),
          (eq, ":var8", 2),
          (agent_set_slot, ":var0", 148, 0),
        (try_end),
        (try_begin),
          (eq, ":var10", 1),
          (agent_set_slot, ":var0", 149, 0),
        (try_end),
        (try_begin),
          (eq, ":var11", 1),
          (agent_set_slot, ":var0", 150, 0),
        (try_end),
        (try_begin),
          (eq, ":var12", 1),
          (agent_set_slot, ":var0", 151, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "itm_hellfire_sword"),
        (this_or_next|is_between, ":var1", "itm_dwarf_rune_warhammer", "itm_gotrek_runic_axe"),
        (this_or_next|eq, ":var1", "itm_tzeentch_chosen_sword"),
        (eq, ":var1", "itm_hellblade"),
        (try_begin),
          (this_or_next|eq, ":var1", "itm_hellfire_sword"),
          (eq, ":var1", "itm_hellblade"),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (eq, ":var1", "itm_tzeentch_chosen_sword"),
          (particle_system_remove, "psys_blue_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (else_try),
          (item_get_slot, ":var13", ":var1", 126),
          (eq, ":var13", 1),
          (particle_system_remove, "psys_weapon_fire"),
          (particle_system_remove, "psys_torch_smoke"),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$defender_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 0, 7),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 3, 7),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (180, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (1, 4, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (try_begin),
        (party_slot_eq, "p_main_party", 85, 1),
        (assign, ":var0", 0),
        (try_for_agents, ":var1"),
          (agent_is_ally, ":var1"),
          (agent_is_alive, ":var1"),
          (val_add, ":var0", 1),
        (try_end),
        (gt, ":var0", 0),
        (try_begin),
          (neq, "$cam_free", 1),
          (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
          (call_script, "script_cust_cam_init_death_cam", 2),
          (party_slot_eq, "p_main_party", 86, 1),
          (set_show_messages, 0),
          (team_give_order, "$fplayer_team_no", 9, 2),
          (team_set_order_listener, "$fplayer_team_no", 9),
          (call_script, "script_player_order_formations", 2),
          (set_show_messages, 1),
        (try_end),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0.6, ti_once, 
    [
      (party_slot_ge, "p_main_party", 232, 1),
    ],
    [
      (party_get_slot, ":var0", "p_main_party", 232),
      (party_set_slot, "p_main_party", 232, 0),
      (set_show_messages, 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_range, ":var3", 0, ":var0"),
        (store_add, ":var4", ":var3", 250),
        (party_get_slot, ":var5", "p_main_party", ":var4"),
        (ge, ":var5", 10),
        (store_div, ":var6", ":var5", 100),
        (store_mul, ":var7", ":var6", 100),
        (val_sub, ":var5", ":var7"),
        (store_div, ":var7", ":var5", 10),
        (store_mul, ":var8", ":var7", 10),
        (store_sub, ":var8", ":var5", ":var8"),
        (assign, ":var9", 0),
        (try_begin),
          (eq, ":var7", 1),
          (eq, ":var8", 3),
          (assign, ":var8", 11),
        (else_try),
          (eq, ":var7", 2),
          (is_between, ":var8", 5, 9),
          (assign, ":var9", 1),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 3),
          (try_begin),
            (eq, ":var8", 0),
            (assign, ":var8", 10),
          (else_try),
            (eq, ":var8", 2),
            (assign, ":var8", 12),
          (else_try),
            (eq, ":var8", 3),
            (assign, ":var8", 13),
          (try_end),
        (else_try),
          (eq, ":var7", 4),
          (set_show_messages, 0),
          (assign, "$battle_phase", 0),
          (call_script, "script_player_attempt_formation", ":var6", ":var8", 0),
          (assign, ":var2", 1),
        (else_try),
          (is_between, ":var7", 5, 7),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var7", 7),
          (eq, ":var8", 1),
          (team_set_order_listener, "$fplayer_team_no", ":var6"),
          (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
        (try_begin),
          (is_between, ":var7", 1, 4),
          (neq, ":var9", 1),
          (team_give_order, "$fplayer_team_no", ":var6", ":var8"),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_show_messages, 1),
      (display_message, "@Everyone, you know what to do. To your positions!", 0xFFDDDD66),
      (try_begin),
        (eq, ":var0", 1),
        (party_get_slot, ":var10", "p_main_party_backup", 250),
        (party_set_slot, "p_main_party", 250, ":var10"),
        (party_set_slot, "p_main_party_backup", 250, 0),
      (try_end),
      (try_begin),
        (eq, ":var1", 0),
        (eq, ":var2", 1),
        (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (try_end),
      (assign, "$battle_phase", 1),
    ]),

    (0, 1, ti_once, 
    [
      (party_slot_ge, "p_main_party_backup", 232, 1),
    ],
    [
      (set_show_messages, 0),
      (party_get_slot, ":var0", "p_main_party_backup", 232),
      (party_set_slot, "p_main_party_backup", 232, 0),
      (try_for_range, ":var1", 0, ":var0"),
        (store_add, ":var2", ":var1", 250),
        (party_get_slot, ":var3", "p_main_party", ":var2"),
        (ge, ":var3", 10),
        (store_div, ":var4", ":var3", 100),
        (store_mul, ":var5", ":var4", 100),
        (val_sub, ":var3", ":var5"),
        (store_div, ":var5", ":var3", 10),
        (this_or_next|is_between, ":var5", 5, 7),
        (eq, ":var5", 2),
        (store_mul, ":var6", ":var5", 10),
        (store_sub, ":var6", ":var3", ":var6"),
        (try_begin),
          (eq, ":var5", 2),
          (is_between, ":var6", 5, 9),
          (store_add, ":var7", ":var2", 70),
          (party_get_slot, ":var8", "p_main_party", ":var7"),
          (val_max, ":var8", 1),
          (try_begin),
            (is_between, ":var6", 5, 7),
            (call_script, "script_formation_current_position", 63, "$fplayer_team_no", ":var4"),
            (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var4", 63),
            (try_begin),
              (eq, ":var6", 5),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -1),
            (try_end),
            (val_mul, ":var6", ":var8"),
            (call_script, "script_formation_move_position", "$fplayer_team_no", ":var4", 63, ":var6"),
          (else_try),
            (store_add, ":var9", 194, ":var4"),
            (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
            (try_begin),
              (eq, ":var6", 7),
              (val_mul, ":var8", -1),
            (try_end),
            (val_add, ":var10", ":var8"),
            (val_clamp, ":var10", -3, 2),
            (team_set_slot, "$fplayer_team_no", ":var9", ":var10"),
          (try_end),
        (else_try),
          (is_between, ":var5", 5, 7),
          (team_set_order_listener, "$fplayer_team_no", ":var4"),
          (call_script, "script_order_weapon_type_switch", ":var6", "$fplayer_team_no"),
          (team_set_order_listener, "$fplayer_team_no", -1),
        (try_end),
      (try_end),
      (team_set_order_listener, "$fplayer_team_no", 9),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_team_get_position_of_enemies", 24, "$fplayer_team_no", 9),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var9", 14, ":var11"),
        (team_get_slot, ":var12", "$fplayer_team_no", ":var9"),
        (gt, ":var12", 0),
        (team_get_order_position, pos16, "$fplayer_team_no", ":var11"),
        (position_get_x, reg0, pos16),
        (convert_from_fixed_point, reg0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (this_or_next|neq, reg0, 20),
        (neq, ":var10", 0),
        (store_add, ":var9", 185, ":var11"),
        (team_get_slot, ":var13", "$fplayer_team_no", ":var9"),
        (try_begin),
          (eq, ":var13", 0),
          (eq, reg0, 20),
          (call_script, "script_formation_current_position", 16, "$fplayer_team_no", ":var11"),
        (try_end),
        (store_add, ":var9", 176, ":var11"),
        (team_get_slot, ":var14", "$fplayer_team_no", ":var9"),
        (call_script, "script_point_y_toward_position", 16, 24),
        (call_script, "script_set_formation_destination", "$fplayer_team_no", ":var11", 16),
        (try_begin),
          (eq, ":var13", 0),
          (val_add, ":var10", 2),
          (lt, ":var10", 0),
          (assign, ":var13", 2),
          (assign, ":var14", 1),
        (try_end),
        (call_script, "script_get_centering_amount", ":var13", ":var12", ":var10"),
        (try_begin),
          (this_or_next|eq, ":var13", 0),
          (eq, ":var14", 1),
          (val_mul, reg0, -1),
          (assign, ":var15", "script_form_archers"),
        (else_try),
          (eq, ":var13", 4),
          (assign, ":var15", "script_form_cavalry"),
        (else_try),
          (assign, ":var15", "script_form_infantry"),
        (try_end),
        (position_move_x, 16, reg0),
        (copy_position, 1, 16),
        (assign, "$battle_phase", 0),
        (call_script, ":var15", "$fplayer_team_no", ":var11", "$fplayer_agent_no", ":var10", ":var13"),
        (store_add, ":var9", 185, ":var11"),
        (team_slot_eq, "$fplayer_team_no", ":var9", 0),
        (store_add, ":var9", 194, ":var11"),
        (team_get_slot, ":var10", "$fplayer_team_no", ":var9"),
        (neq, ":var10", 0),
        (assign, ":var16", 0),
        (assign, ":var17", 0),
        (try_begin),
          (lt, ":var10", 0),
          (assign, ":var16", ":var10"),
        (else_try),
          (assign, ":var17", ":var10"),
        (try_end),
        (try_for_range, ":var18", ":var16", ":var17"),
          (lt, ":var10", 0),
          (team_give_order, "$fplayer_team_no", ":var11", 7),
        (else_try),
          (team_give_order, "$fplayer_team_no", ":var11", 8),
        (try_end),
      (try_end),
      (call_script, "script_prebattle_agents_set_start_positions", "$fplayer_team_no"),
      (assign, "$battle_phase", 1),
      (set_show_messages, 1),
    ]),

    (0, 0.8, ti_once, 
    [
      (mission_cam_set_screen_color, 4278190080),
    ],
    [
      (mission_cam_animate_to_screen_color, 0, 1000),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (call_script, "script_party_copy", "p_temp_party", "p_main_party"),
      (party_upgrade_with_xp, "p_main_party", 1, 1),
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_set_slot, ":var2", 39, 0),
        (troop_set_slot, ":var2", 52, 0),
      (try_end),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neg|troop_is_hero, ":var2"),
        (troop_slot_eq, ":var2", 39, 0),
        (try_for_range, ":var3", 47, 54),
          (party_set_slot, "p_main_party_backup", ":var3", 0),
        (try_end),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (assign, ":var7", ":var0"),
          (try_for_range, ":var8", 0, ":var7"),
            (party_stack_get_troop_id, ":var9", "p_temp_party", ":var8"),
            (neg|troop_is_hero, ":var9"),
            (neq, ":var9", ":var4"),
            (troop_get_upgrade_troop, ":var10", ":var9", 0),
            (eq, ":var10", ":var4"),
            (assign, ":var7", 0),
          (try_end),
          (try_begin),
            (neq, ":var10", ":var4"),
            (assign, ":var5", 0),
            (troop_slot_eq, ":var4", 39, 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var4"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var4"),
            (store_sub, ":var13", ":var11", ":var12"),
            (val_max, ":var13", 0),
            (troop_set_slot, ":var4", 52, ":var13"),
            (troop_set_slot, ":var4", 39, 1),
          (else_try),
            (assign, ":var14", 47),
            (try_for_range_backwards, ":var15", ":var14", 54),
              (party_slot_eq, "p_main_party_backup", ":var15", 0),
              (party_set_slot, "p_main_party_backup", ":var15", ":var9"),
              (assign, ":var14", 54),
            (try_end),
            (assign, ":var4", ":var9"),
          (try_end),
        (try_end),
        (troop_slot_eq, ":var2", 39, 0),
        (assign, ":var4", ":var2"),
        (assign, ":var5", 7),
        (try_for_range, ":var6", 0, ":var5"),
          (troop_get_upgrade_troop, ":var10", ":var4", 0),
          (party_count_members_of_type, ":var16", "p_main_party", ":var10"),
          (try_begin),
            (gt, ":var16", 0),
            (assign, ":var17", 54),
            (try_for_range, ":var18", 47, ":var17"),
              (party_slot_eq, "p_main_party_backup", ":var18", 0),
              (party_set_slot, "p_main_party_backup", ":var18", ":var10"),
              (assign, ":var17", 47),
            (try_end),
            (assign, ":var4", ":var10"),
          (else_try),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (assign, ":var5", 54),
        (try_for_range, ":var3", 47, ":var5"),
          (party_get_slot, ":var4", "p_main_party_backup", ":var3"),
          (gt, ":var4", 0),
          (troop_slot_eq, ":var4", 39, 1),
          (assign, ":var19", ":var3"),
          (assign, ":var20", 0),
          (try_for_range_backwards, ":var18", 47, ":var19"),
            (party_get_slot, ":var21", "p_main_party_backup", ":var18"),
            (gt, ":var21", 0),
            (party_count_members_of_type, ":var11", "p_temp_party", ":var21"),
            (party_count_members_of_type, ":var12", "p_main_party", ":var21"),
            (store_sub, ":var13", ":var12", ":var11"),
            (val_add, ":var13", ":var20"),
            (val_max, ":var13", 0),
            (assign, ":var20", ":var13"),
            (store_sub, ":var22", ":var18", 1),
            (try_begin),
              (ge, ":var22", 47),
              (party_get_slot, ":var23", "p_main_party_backup", ":var22"),
            (else_try),
              (eq, ":var22", 46),
              (assign, ":var23", ":var2"),
            (try_end),
            (gt, ":var23", 0),
            (troop_slot_eq, ":var23", 39, 0),
            (troop_set_slot, ":var23", 52, ":var13"),
            (troop_set_slot, ":var21", 39, 1),
          (try_end),
          (troop_set_slot, ":var2", 39, 1),
          (assign, ":var20", 0),
          (try_for_range, ":var15", ":var19", ":var5"),
            (party_get_slot, ":var24", "p_main_party_backup", ":var15"),
            (gt, ":var24", 0),
            (try_begin),
              (troop_slot_eq, ":var24", 39, 1),
              (troop_get_slot, ":var20", ":var24", 52),
            (else_try),
              (troop_slot_eq, ":var24", 39, 0),
              (party_count_members_of_type, ":var11", "p_temp_party", ":var24"),
              (party_count_members_of_type, ":var12", "p_main_party", ":var24"),
              (store_sub, ":var13", ":var12", ":var11"),
              (val_add, ":var13", ":var20"),
              (val_max, ":var13", 0),
              (assign, ":var20", ":var13"),
              (troop_set_slot, ":var24", 52, ":var13"),
              (troop_set_slot, ":var24", 39, 1),
            (try_end),
          (try_end),
          (assign, ":var5", 47),
        (try_end),
      (try_end),
      (call_script, "script_party_copy", "p_main_party", "p_temp_party"),
      (troop_set_slot, "trp_player", 37, 1),
      (party_get_num_companion_stacks, ":var25", "p_main_party"),
      (val_add, ":var25", 1),
      (try_for_range_backwards, ":var1", 0, ":var25"),
        (party_stack_get_troop_id, ":var2", "p_main_party", ":var1"),
        (troop_get_slot, ":var26", ":var2", 37),
        (party_stack_get_size, ":var27", "p_main_party", ":var1"),
        (store_sub, ":var13", ":var27", ":var26"),
        (gt, ":var13", 0),
        (party_remove_members_wounded_first, "p_main_party", ":var2", ":var13"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 47, 1),
    ],
    [
      (party_get_num_companion_stacks, ":var0", "p_temp_party"),
      (try_for_range, ":var1", 0, ":var0"),
        (party_stack_get_troop_id, ":var2", "p_temp_party", ":var1"),
        (neq, ":var2", "trp_player"),
        (party_stack_get_size, ":var3", "p_temp_party", ":var1"),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_stack_get_size, ":var5", "p_main_party", ":var7"),
          (party_stack_get_num_wounded, ":var6", "p_main_party", ":var7"),
          (assign, ":var4", 0),
        (try_end),
        (store_sub, ":var9", ":var3", ":var5"),
        (try_begin),
          (gt, ":var9", 0),
          (party_add_members, "p_main_party", ":var2", ":var9"),
          (party_stack_get_num_wounded, ":var10", "p_temp_party", ":var1"),
          (val_sub, ":var10", ":var6"),
          (gt, ":var10", 0),
          (party_wound_members, "p_main_party", ":var8", ":var10"),
        (try_end),
        (neg|troop_is_hero, ":var2"),
        (troop_get_slot, ":var11", ":var2", 52),
        (gt, ":var11", 0),
        (call_script, "script_game_get_upgrade_xp", ":var2"),
        (store_mul, ":var12", ":var11", reg0),
        (party_get_num_companion_stacks, ":var4", "p_main_party"),
        (try_for_range, ":var7", 0, ":var4"),
          (party_stack_get_troop_id, ":var8", "p_main_party", ":var7"),
          (eq, ":var8", ":var2"),
          (party_add_xp_to_stack, "p_main_party", ":var7", ":var12"),
          (assign, ":var4", 0),
        (try_end),
      (try_end),
      (party_set_slot, "p_main_party", 47, 0),
    ]),

    (0, 0.5, ti_once, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, 0),
    ]),

    (1, 0, 0, 
    [
      (party_slot_eq, "p_main_party", 51, 1),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$fplayer_team_no", 0),
        (eq, "$fplayer_team_no", 2),
        (assign, ":var0", "$defender_reinforcement_stage"),
      (else_try),
        (assign, ":var0", "$attacker_reinforcement_stage"),
      (try_end),
      (neg|party_slot_eq, "p_main_party_backup", 107, ":var0"),
      (call_script, "script_prebattle_split_troop_divisions"),
      (party_set_slot, "p_main_party_backup", 107, ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (party_set_slot, "p_main_party_backup", 108, 0),
      (party_set_slot, p_camp_bandits, 108, 0),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 300, 318),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_everyone_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (game_key_clicked, gk_everyone_around_hear),
      (neg|main_hero_fallen),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (start_presentation, "prsnt_caba_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|key_clicked, "$key_order_9"),
      (key_clicked, key_escape),
    ],
    [
      (party_set_slot, "p_main_party", 108, 0),
      (is_presentation_active, "prsnt_caba_order_display"),
      (presentation_set_duration, 0),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
      (neg|main_hero_fallen),
    ],
    [
      (store_mission_timer_c_msec, "$when_f1_first_detected"),
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (party_set_slot, p_camp_bandits, 108, 1),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 5),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 24),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 1),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 6),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_volley_begin_end", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (neg|party_slot_eq, "p_main_party", 108, 23),
        (neg|party_slot_eq, "p_main_party", 108, 24),
        (neg|party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 25),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 8),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (this_or_next|eq, "$g_next_menu", "mnu_simple_encounter"),
        (eq, "$g_next_menu", "mnu_join_battle"),
        (party_set_slot, "p_main_party", 108, 26),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 11),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 7),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 25),
        (call_script, "script_order_set_display_text", -1),
        (call_script, "script_order_set_team_slot", -1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 2, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_end_active_order", "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 27),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 23),
        (call_script, "script_player_order_formations", 14),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 3, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 1),
        (call_script, "script_order_weapon_type_switch", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 4),
        (call_script, "script_order_weapon_type_switch", 4, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 9),
        (call_script, "script_order_skirmish_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, 28),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 24),
        (call_script, "script_player_order_formations", 4),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 4, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 2),
        (call_script, "script_order_weapon_type_switch", 2, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 5),
        (call_script, "script_order_weapon_type_switch", 5, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 11),
        (call_script, "script_order_volley_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_7"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 0),
        (party_set_slot, "p_main_party", 108, "$key_order_7"),
        (start_presentation, "prsnt_caba_order_display"),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_division_reset_places"),
        (agent_get_position, pos49, "$fplayer_agent_no"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 284, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", -1),
          (store_add, ":var1", 14, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (store_add, ":var1", 212, ":var0"),
          (team_set_slot, "$fplayer_team_no", ":var1", 1),
          (call_script, "script_battlegroup_get_position", 28, "$fplayer_team_no", ":var0"),
          (agent_set_position, "$fplayer_agent_no", pos28),
          (call_script, "script_player_attempt_formation", ":var0", 5, 1),
        (try_end),
        (agent_set_position, "$fplayer_agent_no", pos49),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 3),
        (call_script, "script_order_weapon_type_switch", 3, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 28),
        (call_script, "script_order_set_display_text", 6),
        (call_script, "script_order_set_team_slot", 6, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, "$key_order_7"),
        (call_script, "script_order_set_display_text", 13),
        (call_script, "script_order_sp_brace_begin_end", 1, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_order_8"),
      (neg|main_hero_fallen),
    ],
    [
      (try_begin),
        (party_slot_eq, "p_main_party", 108, 26),
        (call_script, "script_player_order_formations", 2),
        (party_set_slot, "p_main_party", 108, 0),
      (else_try),
        (party_slot_eq, "p_main_party", 108, 27),
        (call_script, "script_order_set_display_text", 0),
        (call_script, "script_order_weapon_type_switch", 0, "$fplayer_team_no"),
        (party_set_slot, "p_main_party", 108, 0),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

  ("lead_charge_water_battle3", mtf_battle_mode, -1,
  "You close in and board the enemy ships",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (1, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (2, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (3, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (4, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (5, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (6, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (7, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 4, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (8, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (9, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (12, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (13, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (14, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_party_calculate_strength", "p_main_party", 1),
      (assign, ":var0", reg0),
      (val_max, ":var0", 1),
      (troop_get_slot, ":var1", "trp_player", 7),
      (assign, "$temp3", ":var1"),
      (call_script, "script_party_calculate_strength", "p_collective_enemy", 0),
      (assign, ":var2", reg0),
      (val_max, ":var2", 1),
      (assign, ":var3", 150),
      (store_mul, "$temp_2", ":var2", ":var3"),
      (call_script, "script_party_calculate_strength", "p_collective_ally", 1),
      (assign, ":var4", reg0),
      (val_max, ":var4", 1),
      (store_mul, ":var5", ":var0", 100),
      (val_div, ":var5", ":var4"),
      (store_mul, "$temp2", ":var5", ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$defender_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 0, 7),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 3, 7),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 16, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (set_show_messages, 1),
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (store_skill_level, ":var0", "skl_willpower", "trp_player"),
        (try_begin),
          (ge, ":var0", 1),
          (call_script, "script_cf_willpower_chance"),
        (try_end),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (party_slot_eq, "p_main_party", 85, 1),
        (this_or_next|main_hero_fallen),
        (eq, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 1, ti_once, 
    [
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
      (try_begin),
        (store_current_scene, ":var1"),
        (is_between, ":var1", "scn_random_scene_steppe", "scn_camp_scene"),
        (team_give_order, "$deathcam_player_team", 9, 2),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (47, 0, 0, 
    [],
    [
      (call_script, "script_ce_get_troop_encumbrance", "trp_player"),
      (call_script, "script_ce_put_troop_encumbrance", "trp_player", 0),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$combat_damage", 1),
    ],
    [
      (store_trigger_param, ":var0", 1),
      (store_trigger_param, ":var1", 2),
      (store_trigger_param, ":var2", 3),
      (store_trigger_param, ":var3", 5),
      (store_trigger_param, ":var4", 9),
      (agent_is_human, ":var0"),
      (agent_get_troop_id, ":var5", ":var0"),
      (agent_get_troop_id, ":var6", ":var1"),
      (assign, ":var7", 1),
      (assign, ":var8", 0),
      (agent_get_wielded_item, ":var9", ":var1", 0),
      (troop_get_type, ":var10", ":var5"),
      (try_begin),
        (eq, ":var9", "itm_mace_of_years"),
        (this_or_next|eq, ":var10", 2),
        (eq, ":var10", 9),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (ge, ":var3", 1),
        (item_get_slot, ":var10", ":var3", 113),
        (try_begin),
          (eq, ":var10", 3),
          (assign, ":var7", 0),
        (else_try),
          (ge, "$spells_in_play", 1),
          (this_or_next|neq, ":var10", 1),
          (neq, ":var10", 2),
          (agent_get_slot, ":var11", ":var0", 161),
          (agent_get_slot, ":var12", ":var0", 164),
          (this_or_next|eq, ":var11", 1),
          (eq, ":var12", 1),
          (try_begin),
            (eq, ":var11", 1),
            (store_random_in_range, ":var13", 1, 101),
            (try_begin),
              (le, ":var13", 83),
              (assign, ":var7", 0),
              (try_begin),
                (this_or_next|eq, ":var5", "trp_player"),
                (eq, ":var6", "trp_player"),
                (display_message, "@Shimmering Cloak absorbed the damage.", 0xFFFFFFAA),
              (try_end),
            (try_end),
          (else_try),
            (assign, ":var7", 0),
            (try_begin),
              (this_or_next|eq, ":var5", "trp_player"),
              (eq, ":var6", "trp_player"),
              (display_message, "@Radiance of Potolos absorbed the damage.", 0xFFFFFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, "$spells_in_play", 1),
        (agent_get_slot, ":var14", ":var0", 162),
        (ge, ":var14", 1),
        (assign, ":var7", 0),
        (val_sub, ":var14", 1),
        (agent_set_slot, ":var0", 162, ":var14"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@The cloak of Dain absorbed the attack.", 0xFFFFFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, "$spells_in_play", 1),
        (agent_slot_eq, ":var0", 165, 1),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_wooden_shield"),
        (this_or_next|is_between, ":var9", "itm_house_axe", "itm_gekokujo_tekko_1"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (store_random_in_range, ":var13", 1, 101),
        (try_begin),
          (le, ":var13", 83),
          (assign, ":var7", 0),
          (try_begin),
            (this_or_next|eq, ":var5", "trp_player"),
            (eq, ":var6", "trp_player"),
            (display_message, "@Shield of Fire absorbed the damage.", 0xFFFFFFAA),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (agent_is_human, ":var0"),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 2),
          (try_begin),
            (eq, "$missile_cast", 1),
            (assign, ":var15", 0),
            (assign, ":var16", ":var0"),
            (call_script, "script_get_magic_resistance_roll", ":var16", ":var5"),
            (assign, ":var15", reg1),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var7", 0),
            (else_try),
              (call_script, "script_cf_cast_magic_missile", ":var3", ":var6", ":var0"),
              (assign, ":var2", reg3),
            (try_end),
            (assign, "$missile_cast", 0),
          (else_try),
            (assign, ":var7", 0),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 1),
        (ge, ":var3", 1),
        (try_begin),
          (item_slot_eq, ":var3", 113, 1),
          (troop_get_slot, ":var17", ":var5", 228),
          (assign, ":var18", 0),
          (try_begin),
            (ge, ":var17", 1),
            (str_store_troop_name, s2, ":var5"),
            (try_begin),
              (eq, ":var17", 6),
              (store_random_in_range, ":var19", 1, 7),
              (eq, ":var19", 6),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 5),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 5),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 4),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 4),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 3),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 3),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var17", 2),
              (store_random_in_range, ":var19", 1, 7),
              (ge, ":var19", 2),
              (assign, ":var18", 1),
              (display_message, "@{s2} has resisted your magic", 0xFFFFAAAA),
            (else_try),
            (try_end),
          (try_end),
          (try_begin),
            (this_or_next|eq, "$missile_cast", 0),
            (eq, ":var18", 1),
            (assign, ":var7", 0),
          (else_try),
            (assign, "$missile_cast", 0),
            (assign, ":var20", 0),
            (try_begin),
              (eq, ":var3", "itm_stream_of_corruption_ammo"),
              (store_skill_level, ":var21", "skl_constitution", ":var5"),
              (store_random_in_range, ":var22", 1, 7),
              (store_random_in_range, ":var19", 1, 7),
              (store_add, ":var23", ":var22", ":var19"),
              (store_sub, ":var24", ":var23", ":var21"),
              (try_begin),
                (ge, ":var24", 1),
                (store_random_in_range, ":var25", 1, 9),
                (val_add, ":var2", ":var25"),
                (assign, reg2, ":var25"),
                (display_message, "@{reg2} bonus damage", 0x4C9900),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_lash_of_slaanesh_ammo"),
              (assign, "$bliss", 1),
              (agent_set_slot, ":var0", 115, 1),
              (agent_set_slot, ":var1", 116, 1),
            (else_try),
              (eq, ":var9", "itm_shems_burning_gaze_ammo"),
              (troop_get_type, ":var10", ":var5"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (this_or_next|eq, ":var10", 2),
              (this_or_next|eq, ":var10", 9),
              (eq, ":var26", 1),
              (val_mul, ":var2", 2),
            (else_try),
              (eq, ":var3", "itm_searing_doom_ammo"),
              (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
              (troop_get_type, ":var10", ":var5"),
              (this_or_next|neq, ":var26", 1),
              (neq, ":var10", 7),
              (troop_get_inventory_slot, ":var27", ":var5", ek_body),
              (ge, ":var27", 1),
              (item_get_body_armor, ":var28", ":var27"),
              (try_begin),
                (ge, ":var28", 55),
                (assign, ":var20", 5),
              (else_try),
                (ge, ":var28", 50),
                (assign, ":var20", 4),
              (else_try),
                (ge, ":var28", 45),
                (assign, ":var20", 3),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_doom_bolt_ammo"),
              (agent_set_slot, ":var0", 142, 1),
              (agent_set_slot, ":var1", 143, 1),
              (assign, "$lifeleech", 1),
              (store_random_in_range, ":var29", 1, 7),
              (store_random_in_range, ":var30", 1, 7),
              (try_begin),
                (eq, ":var29", ":var30"),
                (assign, ":var20", 10),
                (display_message, "@Dhar magic damage boosted.", 0x000000),
              (try_end),
            (else_try),
              (eq, ":var3", "itm_gaze_of_mork_ammo"),
              (agent_get_slot, ":var31", ":var1", 146),
              (assign, ":var24", ":var31"),
              (try_begin),
                (ge, ":var24", 1),
                (try_begin),
                  (ge, ":var24", 24),
                  (assign, ":var20", 10),
                  (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 16),
                  (assign, ":var20", 8),
                  (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 8),
                  (assign, ":var20", 5),
                  (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
                (else_try),
                  (ge, ":var24", 1),
                  (assign, ":var20", 2),
                  (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
                (try_end),
              (else_try),
                (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
              (try_end),
            (else_try),
            (try_end),
            (val_add, ":var2", ":var20"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (is_between, ":var9", "itm_light_missile_4", "itm_player_missile_light"),
        (assign, ":var15", 0),
        (str_store_troop_name, s3, ":var6"),
        (try_begin),
          (troop_get_slot, ":var17", ":var5", 228),
          (ge, ":var17", 1),
          (try_begin),
            (eq, ":var17", 6),
            (store_random_in_range, ":var19", 1, 7),
            (eq, ":var19", 6),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 5),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 5),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 4),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 4),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 3),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 3),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
            (eq, ":var17", 2),
            (store_random_in_range, ":var19", 1, 7),
            (ge, ":var19", 2),
            (assign, ":var15", 1),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@{s3} has resisted your magic", 0xFFFFAAAA),
            (else_try),
              (eq, ":var5", "trp_player"),
              (display_message, "@You have resisted {s3}s magic", 0xFFFFAAAA),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var20", 0),
          (try_begin),
            (this_or_next|eq, ":var9", "itm_light_missile_4"),
            (this_or_next|eq, ":var9", "itm_light_missile_6"),
            (eq, ":var9", "itm_light_missile_8"),
            (troop_get_type, ":var10", ":var5"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (this_or_next|eq, ":var10", 2),
            (this_or_next|eq, ":var10", 9),
            (eq, ":var26", 1),
            (val_mul, ":var2", 2),
          (else_try),
            (this_or_next|eq, ":var9", "itm_gold_missile_4"),
            (this_or_next|eq, ":var9", "itm_gold_missile_6"),
            (this_or_next|eq, ":var9", "itm_gold_missile_8"),
            (eq, ":var9", "itm_gold_missile_9"),
            (troop_get_slot, ":var26", trp_wolf_brother, ":var5"),
            (troop_get_type, ":var10", ":var5"),
            (this_or_next|neq, ":var26", 1),
            (neq, ":var10", 7),
            (troop_get_inventory_slot, ":var27", ":var5", ek_body),
            (ge, ":var27", 1),
            (item_get_body_armor, ":var28", ":var27"),
            (try_begin),
              (ge, ":var28", 55),
              (assign, ":var20", 5),
            (else_try),
              (ge, ":var28", 50),
              (assign, ":var20", 4),
            (else_try),
              (ge, ":var28", 45),
              (assign, ":var20", 3),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_dhar_missile_4"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_6"),
            (this_or_next|eq, ":var9", "itm_dhar_missile_8"),
            (eq, ":var9", "itm_dhar_missile_9"),
            (agent_set_slot, ":var0", 142, 1),
            (agent_set_slot, ":var1", 143, 1),
            (assign, "$lifeleech", 1),
            (store_random_in_range, ":var29", 1, 7),
            (store_random_in_range, ":var30", 1, 7),
            (try_begin),
              (eq, ":var29", ":var30"),
              (assign, ":var20", 10),
              (display_message, "@Dhar magic damage boosted.", 0x000000),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_4"),
            (this_or_next|eq, ":var9", "itm_slaanesh_missile_6"),
            (eq, ":var9", "itm_slaanesh_missile_8"),
            (agent_set_slot, ":var0", 115, 1),
            (agent_set_slot, ":var1", 116, 1),
            (assign, "$bliss", 1),
          (else_try),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_4"),
            (this_or_next|eq, ":var9", "itm_nurgle_missile_6"),
            (eq, ":var9", "itm_nurgle_missile_8"),
            (store_skill_level, ":var32", "skl_constitution", ":var5"),
            (store_random_in_range, ":var33", 1, 7),
            (store_random_in_range, ":var34", 1, 7),
            (val_add, ":var33", ":var34"),
            (store_sub, ":var23", ":var33", ":var32"),
            (try_begin),
              (ge, ":var23", 1),
              (assign, ":var20", 10),
            (else_try),
              (assign, ":var7", 0),
              (try_begin),
                (eq, ":var6", "trp_player"),
                (display_message, "@{s3} has passed the constitution test.", 0x4C9900),
              (try_end),
            (try_end),
          (else_try),
            (this_or_next|eq, ":var9", "itm_orc_missile_4"),
            (this_or_next|eq, ":var9", "itm_orc_missile_6"),
            (eq, ":var9", "itm_orc_missile_8"),
            (agent_get_slot, ":var31", ":var1", 146),
            (assign, ":var24", ":var31"),
            (try_begin),
              (ge, ":var24", 1),
              (try_begin),
                (ge, ":var24", 24),
                (assign, ":var20", 10),
                (display_message, "@Power of da Waaagh bonus: Dead Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 16),
                (assign, ":var20", 8),
                (display_message, "@Power of da Waaagh bonus: Killy Hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 8),
                (assign, ":var20", 5),
                (display_message, "@Power of da Waaagh bonus: Big hurt.", 0x009900),
              (else_try),
                (ge, ":var24", 1),
                (assign, ":var20", 2),
                (display_message, "@Power of da Waaagh bonus: Lil hurt.", 0x009900),
              (try_end),
            (else_try),
              (display_message, "@Power of da Waaagh bonus: No hurt.", 0x009900),
            (try_end),
          (else_try),
          (try_end),
          (val_add, ":var2", ":var20"),
        (try_end),
      (try_end),
      (troop_get_slot, ":var35", ":var5", 158),
      (val_clamp, ":var35", 0, 11),
      (troop_get_slot, ":var36", ":var5", 156),
      (val_clamp, ":var36", -4, 7),
      (agent_get_slot, ":var37", ":var0", 102),
      (try_begin),
        (gt, ":var7", 0),
        (try_begin),
          (eq, ":var37", 1),
          (assign, ":var35", 10),
          (try_begin),
            (lt, ":var36", "$casterdodge"),
            (assign, ":var36", "$casterdodge"),
          (try_end),
        (try_end),
        (try_begin),
          (agent_slot_eq, ":var0", 83, 0),
          (gt, ":var35", 0),
          (troop_get_slot, ":var38", ":var5", 58),
          (this_or_next|eq, ":var38", 2),
          (eq, ":var37", 1),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (try_begin),
            (this_or_next|is_between, ":var9", "itm_darts", "itm_torch"),
            (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
            (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
            (this_or_next|eq, ":var9", "itm_dragon_bow"),
            (this_or_next|is_between, ":var9", "itm_mortis_light_crossbow", "itm_vampire_sabre"),
            (this_or_next|is_between, ":var9", "itm_light_missile_4", "itm_items_end"),
            (this_or_next|is_between, ":var9", "itm_cannon_canister_dummy", "itm_nath_bomb"),
            (is_between, ":var9", "itm_dwarfpistol", "itm_tournament_small_bolts"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 30),
          (else_try),
            (is_between, ":var9", "itm_nath_bomb", "itm_items_end"),
            (item_get_missile_speed, ":var39", ":var9"),
            (assign, ":var8", 1),
            (val_add, ":var39", 200),
          (try_end),
          (try_begin),
            (ge, ":var36", 0),
            (val_mul, ":var35", ":var36"),
            (store_random_in_range, ":var40", 1, 100),
            (try_begin),
              (eq, ":var8", 1),
              (store_attribute_level, ":var41", ":var5", ca_agility),
              (store_mul, ":var42", ":var41", 3),
              (val_sub, ":var39", ":var42"),
              (ge, ":var39", 0),
              (val_add, ":var40", ":var39"),
            (try_end),
            (try_begin),
              (le, ":var40", ":var35"),
              (assign, ":var2", 0),
              (try_begin),
                (eq, ":var5", "trp_player"),
                (display_message, "@You dodge the attack!", 0x339900),
              (else_try),
                (eq, ":var6", "trp_player"),
                (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
                (display_message, "@{reg4?She:He} dodges the attack!"),
              (try_end),
              (assign, ":var7", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (troop_get_slot, ":var44", ":var5", 170),
        (troop_get_slot, ":var45", ":var5", 171),
        (troop_get_slot, ":var46", ":var5", 172),
        (agent_get_slot, ":var47", ":var0", 98),
        (agent_get_slot, ":var48", ":var0", 148),
        (agent_get_slot, ":var49", ":var0", 150),
        (agent_get_slot, ":var50", ":var0", 103),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var49", 1),
          (try_begin),
            (ge, ":var3", 1),
            (item_get_slot, ":var51", ":var3", 113),
            (ge, ":var51", 1),
            (assign, ":var52", 1),
          (try_end),
          (agent_get_wielded_item, ":var9", ":var1", 0),
          (this_or_next|is_between, ":var9", "itm_musket", "itm_pilgrim_disguise"),
          (this_or_next|eq, ":var9", "itm_runic_blunderbus"),
          (this_or_next|eq, ":var9", "itm_dragon_bow"),
          (eq, ":var52", 1),
          (assign, ":var53", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, ":var44", 2),
          (this_or_next|eq, ":var50", 3),
          (this_or_next|eq, ":var48", 4),
          (this_or_next|eq, ":var53", 1),
          (eq, ":var47", 4),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 3),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var45", 2),
          (this_or_next|eq, ":var50", 2),
          (this_or_next|eq, ":var48", 5),
          (eq, ":var47", 5),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 4),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var46", 2),
          (this_or_next|eq, ":var50", 1),
          (this_or_next|eq, ":var48", 6),
          (eq, ":var47", 6),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (gt, ":var13", 5),
            (assign, ":var2", 0),
            (try_begin),
              (eq, ":var5", "trp_player"),
              (display_message, "@A magical shield protects you from damage", 0x339900),
            (else_try),
              (eq, ":var6", "trp_player"),
              (call_script, "script_dplmc_store_troop_is_female_reg", ":var5", 4),
              (display_message, "@A magical shield protects {reg4?her:Him} from damage"),
            (try_end),
            (assign, ":var7", 0),
            (agent_set_slot, ":var0", 103, 0),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
        (try_end),
      (try_end),
      (assign, ":var54", 0),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 123, 1),
        (assign, ":var54", 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (val_mul, ":var2", 2),
          (try_begin),
            (eq, ":var6", "trp_player"),
            (display_message, "@Rune of smiting caused double damage", 0xFFCC00),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, ":var54", 0),
        (troop_get_type, ":var10", ":var6"),
        (troop_get_type, ":var55", ":var5"),
        (eq, ":var55", 7),
        (eq, ":var10", 4),
        (item_get_slot, ":var56", ":var9", 122),
        (ge, ":var56", 1),
        (try_begin),
          (eq, ":var56", 1),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 4),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var56", 2),
          (store_random_in_range, ":var13", 1, 7),
          (try_begin),
            (ge, ":var13", 5),
            (val_mul, ":var2", 3),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused triple damage", 0xFFCC00),
            (try_end),
          (else_try),
            (ge, ":var13", 3),
            (val_mul, ":var2", 2),
            (try_begin),
              (eq, ":var6", "trp_player"),
              (display_message, "@Rune of dragon slaying caused double damage", 0xFFCC00),
            (try_end),
          (else_try),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var57", ":var6", 176),
      (agent_get_slot, ":var58", ":var1", 129),
      (store_skill_level, ":var59", "skl_power_strike", ":var6"),
      (val_clamp, ":var59", 0, 11),
      (store_random_in_range, ":var13", 1, 13),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (this_or_next|gt, ":var57", 0),
        (gt, ":var58", 0),
        (gt, ":var59", 0),
        (agent_is_human, ":var0"),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (try_begin),
          (gt, ":var13", 11),
          (val_mul, ":var59", 6),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 30),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (else_try),
          (gt, ":var13", 8),
          (val_mul, ":var59", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", ":var59"),
          (val_div, ":var60", 100),
          (val_min, ":var60", 15),
          (val_add, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (assign, ":var7", 2),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Mighty blow increased damage by {reg1}."),
          (try_end),
        (try_end),
      (try_end),
      (troop_get_slot, ":var61", ":var5", 173),
      (agent_get_slot, ":var62", ":var0", 118),
      (agent_get_slot, ":var63", ":var0", 141),
      (agent_get_slot, ":var64", ":var0", 149),
      (store_skill_level, ":var32", "skl_ironflesh", ":var5"),
      (val_clamp, ":var32", 0, 11),
      (assign, ":var43", 0),
      (try_begin),
        (ge, ":var9", 1),
        (item_slot_eq, ":var9", 143, 1),
        (assign, ":var43", 1),
      (try_end),
      (assign, ":var60", 0),
      (try_begin),
        (agent_slot_eq, ":var0", 83, 0),
        (neq, ":var43", 1),
        (gt, ":var7", 0),
        (gt, ":var61", 0),
        (gt, ":var32", 0),
        (agent_is_human, ":var0"),
        (try_begin),
          (this_or_next|eq, ":var62", 4),
          (this_or_next|eq, ":var63", 4),
          (this_or_next|eq, ":var64", 1),
          (eq, ":var61", 4),
          (val_mul, ":var32", 6),
        (else_try),
          (this_or_next|eq, ":var62", 2),
          (this_or_next|eq, ":var63", 2),
          (eq, ":var61", 2),
          (val_mul, ":var32", 4),
        (try_end),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", ":var32"),
        (val_div, ":var60", 100),
        (val_sub, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (else_try),
          (eq, ":var6", "trp_player"),
          (display_message, "@Ignore Pain soaked {reg1} damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_is_human, ":var0"),
        (agent_get_slot, ":var65", ":var0", 73),
        (ge, ":var65", 1),
        (try_begin),
          (eq, ":var65", 5),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 50),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 4),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 40),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 3),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 30),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 2),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 20),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (else_try),
          (eq, ":var65", 1),
          (assign, ":var60", ":var2"),
          (val_mul, ":var60", 10),
          (val_div, ":var60", 100),
          (val_sub, ":var2", ":var60"),
          (assign, reg1, ":var60"),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (else_try),
            (eq, ":var6", "trp_player"),
            (display_message, "@Magical protection soaked {reg1} damage."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var1", 83, 0),
        (gt, ":var7", 0),
        (eq, "$poison_in_battle", 1),
        (assign, ":var66", 0),
        (troop_get_type, ":var10", ":var5"),
        (this_or_next|neq, ":var10", 2),
        (this_or_next|neq, ":var10", 9),
        (neq, ":var10", 10),
        (troop_slot_eq, ":var5", 222, 0),
        (troop_get_slot, ":var67", ":var6", 223),
        (agent_get_slot, ":var68", ":var1", 117),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (eq, ":var10", 4),
          (agent_slot_eq, ":var0", 151, 1),
          (assign, ":var66", 1),
        (try_end),
        (eq, ":var66", 0),
        (this_or_next|eq, ":var67", 1),
        (eq, ":var68", 1),
        (ge, ":var2", 1),
        (agent_set_slot, ":var0", 63, 1),
        (try_begin),
          (troop_is_hero, ":var5"),
          (main_party_has_troop, ":var5"),
          (troop_set_slot, ":var5", 222, 1),
        (try_end),
        (try_begin),
          (eq, ":var5", "trp_player"),
          (display_message, "@You have been poisoned", 0xFFAAFFAA),
        (else_try),
          (is_between, ":var5", "trp_npc1", "trp_kingdom_1_lord"),
          (str_store_troop_name, s1, ":var5"),
          (display_message, "@{s1} has been poisoned", 0xFFAAFFAA),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$shieldthornscast", 1),
        (agent_slot_eq, ":var1", 79, 0),
        (agent_slot_ge, ":var0", 79, 1),
        (agent_get_slot, ":var69", ":var0", 79),
        (try_begin),
          (eq, ":var69", 3),
          (assign, ":var70", 60),
        (else_try),
          (eq, ":var69", 2),
          (assign, ":var70", 50),
        (else_try),
          (assign, ":var70", 40),
        (try_end),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var70"),
        (try_begin),
          (this_or_next|eq, ":var5", "trp_player"),
          (eq, ":var6", "trp_player"),
          (display_message, "@Shield of thorns returns auto hit attack", 0x0FF5B7),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$harmonicconvergencecast", 1),
        (agent_slot_eq, ":var1", 82, 1),
        (store_skill_level, ":var71", 19, ":var6"),
        (try_begin),
          (ge, ":var71", 7),
          (lt, ":var2", 10),
          (assign, ":var2", 10),
        (else_try),
          (ge, ":var71", 4),
          (lt, ":var2", 7),
          (assign, ":var2", 7),
        (else_try),
          (lt, ":var2", 5),
          (assign, ":var2", 5),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$soulblightcast", 1),
        (agent_slot_eq, ":var0", 92, 1),
        (val_add, ":var2", 10),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Soulblight caused 10 extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$flamingswordcast", 1),
        (agent_slot_eq, ":var1", 94, 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming sword of Rhuin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var3", 1),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (this_or_next|eq, ":var3", "itm_light_ammo"),
        (this_or_next|eq, ":var3", "itm_gold_ammo"),
        (this_or_next|eq, ":var3", "itm_bright_ammo"),
        (this_or_next|eq, ":var3", "itm_shems_burning_gaze_ammo"),
        (this_or_next|eq, ":var3", "itm_searing_doom_ammo"),
        (this_or_next|eq, ":var3", "itm_fireball_ammo"),
        (this_or_next|eq, ":var3", "itm_fire_arrow"),
        (eq, ":var3", "itm_fire_bolt"),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming attacks caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (ge, ":var9", 1),
        (item_get_slot, ":var73", ":var9", 111),
        (eq, ":var73", 1),
        (troop_get_slot, ":var72", trp_mercenary_amethyst_sorceress_initiate, ":var5"),
        (this_or_next|ge, ":var72", 1),
        (eq, ":var5", "trp_treekin"),
        (assign, ":var60", ":var2"),
        (val_mul, ":var60", 8),
        (val_div, ":var60", 100),
        (val_add, ":var2", ":var60"),
        (assign, reg1, ":var60"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Flaming weapons caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (eq, "$orcshaman_in_battle", 1),
        (troop_get_type, ":var74", ":var5"),
        (troop_get_type, ":var75", ":var6"),
        (agent_get_team, ":var76", ":var0"),
        (try_begin),
          (eq, ":var74", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_sub, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
        (try_begin),
          (eq, ":var75", 12),
          (try_for_agents, ":var77"),
            (agent_is_alive, ":var77"),
            (agent_is_human, ":var77"),
            (agent_is_active, ":var77"),
            (agent_get_troop_id, ":var78", ":var77"),
            (troop_get_type, ":var10", ":var78"),
            (eq, ":var10", 12),
            (troop_slot_eq, ":var78", 225, 1),
            (agent_get_team, ":var79", ":var77"),
            (neg|teams_are_enemies, ":var79", ":var76"),
            (agent_get_slot, ":var80", ":var77", 145),
            (val_add, ":var80", 1),
            (agent_set_slot, ":var77", 145, ":var80"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$sneakycast", 1),
        (agent_get_slot, ":var81", ":var1", 123),
        (ge, ":var81", 2),
        (agent_get_wielded_item, ":var9", ":var1", 0),
        (this_or_next|is_between, ":var9", "itm_empireone", "itm_rubberbullet"),
        (this_or_next|is_between, ":var9", "itm_falchion", "itm_jousting_lance"),
        (is_between, ":var9", "itm_gor_rok_axe", "itm_dragon_bow"),
        (eq, ":var4", 1),
        (val_add, ":var2", ":var81"),
        (assign, reg1, ":var81"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Sneaky stabbin caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (this_or_next|ge, "$withercast", 1),
        (this_or_next|ge, "$usekhpcast", 1),
        (ge, "$thewitheringcast", 1),
        (agent_get_slot, ":var82", ":var0", 88),
        (ge, ":var82", 1),
        (store_random_in_range, ":var33", 1, 9),
        (val_mul, ":var33", ":var82"),
        (assign, reg1, ":var33"),
        (val_add, ":var2", ":var33"),
        (try_begin),
          (ge, "$thewitheringcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@The withering caused {reg1} extra damage."),
        (else_try),
          (ge, "$withercast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Wither caused {reg1} extra damage."),
        (else_try),
          (ge, "$usekhpcast", 1),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Usekhps Incantation of Dessication caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$okkamsmindrazorcast", 1),
        (agent_slot_eq, ":var1", 89, 1),
        (val_add, ":var2", "$okkamsboost"),
        (assign, reg1, "$okkamsboost"),
        (try_begin),
          (this_or_next|eq, ":var6", "trp_player"),
          (eq, ":var5", "trp_player"),
          (display_message, "@Okkams mindrazor caused {reg1} extra damage."),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, "$geniecast", 1),
        (agent_get_slot, ":var83", ":var0", 135),
        (ge, ":var83", 1),
        (store_random_in_range, ":var33", 1, 7),
        (lt, ":var33", 4),
        (try_begin),
          (eq, ":var83", 3),
          (val_add, ":var2", 12),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 12 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 2),
          (val_add, ":var2", 8),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 8 extra damage", 0xF1F507),
          (try_end),
        (else_try),
          (eq, ":var83", 1),
          (val_add, ":var2", 4),
          (try_begin),
            (this_or_next|eq, ":var6", "trp_player"),
            (eq, ":var5", "trp_player"),
            (display_message, "@Curse of the genie caused 4 extra damage", 0xF1F507),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (troop_get_type, ":var10", ":var6"),
        (eq, ":var10", 4),
        (item_slot_eq, ":var9", 144, 1),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (ge, ":var13", 4),
          (call_script, "script_rune_of_breaking", ":var0", ":var5"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var7", 0),
        (ge, ":var9", 1),
        (this_or_next|eq, ":var9", "itm_single_wight_blade"),
        (eq, ":var9", "itm_wightblade"),
        (store_random_in_range, ":var13", 1, 7),
        (try_begin),
          (eq, ":var13", 6),
          (assign, ":var2", 500),
          (try_begin),
            (eq, ":var5", "trp_player"),
            (display_message, "@You succumb to the power of the wight blade."),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var7", 0),
        (set_trigger_result, 0),
      (else_try),
        (set_trigger_result, ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (store_agent_hit_points, ":var3", ":var0", 1),
      (store_agent_hit_points, ":var4", ":var0", 0),
      (try_begin),
        (lt, ":var4", 100),
        (assign, reg0, 100),
        (store_div, ":var5", reg0, ":var4"),
        (val_mul, ":var3", ":var5"),
      (try_end),
      (agent_set_slot, ":var0", 58, ":var3"),
      (agent_set_slot, ":var0", 129, 0),
      (agent_set_slot, ":var0", 118, 0),
      (agent_set_slot, ":var0", 127, 0),
      (agent_set_slot, ":var0", 98, 0),
      (agent_set_slot, ":var0", 102, 0),
      (agent_set_slot, ":var0", 73, 0),
      (agent_set_slot, ":var0", 162, 0),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_inventory_slot, ":var6", ":var1", ek_gloves),
        (store_item_kind_count, ":var7", "itm_ep_ring1", ":var1"),
        (try_begin),
          (this_or_next|eq, ":var6", "itm_ep_ring1"),
          (ge, ":var7", 1),
          (troop_set_slot, ":var1", 174, 16),
        (try_end),
      (try_end),
      (try_begin),
        (troop_slot_ge, ":var1", 256, 1),
        (call_script, "script_set_battle_wounds", ":var0", ":var1"),
      (try_end),
      (agent_set_slot, ":var0", 63, 0),
      (try_begin),
        (troop_get_slot, ":var8", ":var1", 223),
        (eq, ":var8", 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var1", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var1", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_set_slot, ":var1", 247, 0),
        (assign, "$kill_counter", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_mummy"),
        (this_or_next|eq, ":var1", "trp_mummy_king"),
        (eq, ":var1", "trp_knight_6_1"),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (assign, "$mummy_in_battle", 1),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var1", "trp_player"),
        (is_between, ":var1", "trp_npc1", "trp_knight_1_1_wife"),
        (troop_get_slot, ":var9", ":var1", 222),
        (eq, ":var9", 1),
        (agent_set_slot, ":var0", 63, 1),
        (assign, "$poison_in_battle", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var10", ":var1", 225),
        (eq, ":var10", 1),
        (call_script, "script_list_add", "trp_list_08", ":var0"),
        (agent_set_slot, ":var0", 147, 0),
        (assign, "$magic_in_battle", 1),
        (try_begin),
          (neq, ":var1", "trp_player"),
          (call_script, "script_set_starting_ammo", ":var0", ":var1"),
          (agent_set_accuracy_modifier, ":var0", 175),
        (else_try),
          (eq, ":var1", "trp_player"),
          (troop_slot_eq, ":var1", 257, 1),
          (assign, "$spell_cast", 0),
          (assign, "$missile_cast", 0),
          (assign, "$willpower_focus", 0),
          (assign, "$willpower_boost", 0),
          (troop_set_slot, "trp_player", 255, 0),
          (call_script, "script_set_willpower_focus"),
          (call_script, "script_list_clear", "trp_list_36"),
          (call_script, "script_cf_set_starting_spell"),
        (try_end),
        (troop_get_slot, ":var11", ":var1", 226),
        (try_begin),
          (eq, ":var11", 15),
          (assign, "$orcshaman_in_battle", 1),
          (agent_set_slot, ":var0", 145, 0),
          (agent_set_slot, ":var0", 146, 0),
        (else_try),
          (eq, ":var11", 16),
          (assign, "$goblinshaman_in_battle", 1),
        (else_try),
          (eq, ":var11", 7),
          (assign, "$brightattribute", 0),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (try_begin),
          (troop_get_inventory_slot, ":var12", "trp_player", 10),
          (this_or_next|eq, ":var12", "itm_runic_banner"),
          (this_or_next|eq, ":var12", "itm_runic_banner2"),
          (eq, ":var12", "itm_runic_banner3"),
          (item_get_slot, ":var13", ":var12", 129),
          (item_get_slot, ":var14", ":var12", 131),
          (item_get_slot, ":var15", ":var12", 132),
          (assign, "$currentbanner", ":var12"),
          (try_begin),
            (this_or_next|eq, ":var14", 1),
            (this_or_next|eq, ":var15", 1),
            (eq, ":var13", 1),
            (assign, "$runebanner_in_battle", 1),
          (try_end),
        (try_end),
        (try_begin),
          (troop_get_inventory_slot, ":var16", "trp_player", ek_body),
          (is_between, ":var16", "itm_runearmour", "itm_dwarf_gold_armour"),
          (item_get_slot, ":var17", ":var16", 156),
          (item_get_slot, ":var18", ":var16", 150),
          (item_get_slot, ":var19", ":var16", 148),
          (item_get_slot, ":var20", ":var16", 138),
          (item_get_slot, ":var21", ":var16", 139),
          (item_get_slot, ":var22", ":var16", 140),
          (try_begin),
            (eq, ":var18", 1),
            (agent_set_slot, ":var0", 148, 4),
          (else_try),
            (eq, ":var17", 1),
            (agent_set_slot, ":var0", 148, 6),
          (else_try),
            (eq, ":var17", 2),
            (agent_set_slot, ":var0", 148, 5),
          (try_end),
          (try_begin),
            (eq, ":var19", 1),
            (agent_set_slot, ":var0", 149, 1),
          (try_end),
          (try_begin),
            (eq, ":var20", 1),
            (store_agent_hit_points, ":var23", ":var0"),
            (lt, ":var23", 100),
            (val_add, ":var23", 30),
            (val_clamp, ":var23", 1, 101),
            (agent_set_hit_points, ":var0", ":var23"),
          (try_end),
          (try_begin),
            (eq, ":var21", 1),
            (agent_set_slot, ":var0", 150, 1),
          (try_end),
          (try_begin),
            (eq, ":var22", 1),
            (agent_set_slot, ":var0", 151, 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var1", "trp_player"),
        (eq, ":var2", 4),
        (assign, ":var24", 0),
        (try_for_range, ":var25", "itm_rifle_rune", "itm_ferlangen_musket"),
          (agent_has_item_equipped, ":var0", ":var25"),
          (item_slot_eq, ":var25", 155, 1),
          (val_add, ":var24", 1),
        (try_end),
        (try_begin),
          (ge, ":var24", 1),
          (try_for_range, ":var25", 1, 3),
            (agent_has_item_equipped, ":var0", "itm_cartridges"),
            (agent_unequip_item, ":var0", "itm_cartridges"),
            (agent_equip_item, ":var0", "itm_rune_cartridges"),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (assign, "$drunkenmaster", 0),
        (eq, ":var1", "trp_player"),
        (agent_set_reload_speed_modifier, ":var0", 90),
        (agent_set_accuracy_modifier, ":var0", 80),
      (try_end),
      (troop_get_slot, ":var26", ":var1", 174),
      (gt, ":var26", 0),
      (call_script, "script_list_add", "trp_list_08", ":var0"),
      (assign, "$regenerate_in_battle", 1),
      (eq, ":var1", "trp_cattle"),
      (agent_set_hit_points, ":var0", 1, 1),
      (agent_deliver_damage_to_agent, ":var0", ":var0", 20),
    ]),

    (5, 0, 0, 
    [
      (eq, "$regenerate_in_battle", 1),
    ],
    [
      (call_script, "script_list_count", "trp_list_08"),
      (assign, ":var0", reg1),
      (val_add, ":var0", 1),
      (gt, ":var0", 1),
      (try_for_range, ":var1", 1, ":var0"),
        (call_script, "script_list_at_nc", "trp_list_08", ":var1"),
        (assign, ":var2", reg1),
        (try_begin),
          (neg|agent_is_alive, ":var2"),
          (call_script, "script_list_remove_at", "trp_list_08", ":var1"),
          (val_sub, ":var2", 1),
          (val_sub, ":var0"),
        (else_try),
          (agent_is_alive, ":var2"),
          (agent_is_human, ":var2"),
          (agent_get_troop_id, reg0, ":var2"),
          (troop_get_slot, ":var3", reg0, 174),
          (agent_slot_eq, ":var2", 83, 0),
          (try_begin),
            (lt, ":var3", 5),
            (this_or_next|eq, reg0, "trp_orc_troll"),
            (this_or_next|eq, reg0, "trp_goblin_troll"),
            (this_or_next|eq, reg0, "trp_knight_3_1"),
            (this_or_next|eq, reg0, "trp_merc_minotaur"),
            (eq, reg0, "trp_mountain_bandit"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 145),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_3_1"),
                (display_message, "@The heart of Averlorn regenerates Prince Tyrion"),
              (else_try),
                (display_message, "@The Troll regenerates his wounds"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 8),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_paladin"),
            (this_or_next|eq, reg0, "trp_warrior_priest"),
            (eq, reg0, "trp_mummy_king"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 111),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_paladin"),
                (display_message, "@The blessing of the lady heals the Paladin"),
              (else_try),
                (eq, reg0, "trp_warrior_priest"),
                (display_message, "@The blessing of Sigmar heals the Warrior Priest"),
              (else_try),
                (display_message, "@The Mummy King regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 10),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_mummy"),
            (eq, reg0, "trp_bretonnian_grail"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 63),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_bretonnian_grail"),
                (display_message, "@The blessing of the lady heals the Grail Knight"),
              (else_try),
                (display_message, "@The Mummy regenerates"),
              (try_end),
            (try_end),
          (else_try),
            (lt, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (this_or_next|eq, reg0, "trp_knight_2_13"),
            (this_or_next|eq, reg0, "trp_knight_17_8"),
            (eq, reg0, "trp_knight_17_9"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 129),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (try_begin),
                (eq, reg0, "trp_knight_2_13"),
                (display_message, "@The talisman of stone regenerates Lord Brokk"),
              (else_try),
                (eq, reg0, "trp_knight_17_8"),
                (display_message, "@The chalice of blood regenerates Walach Harkon"),
              (else_try),
                (display_message, "@The blood armour regenerates the Red Duke"),
              (try_end),
            (try_end),
          (else_try),
            (eq, ":var3", 13),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_6_1"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 161),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Goddess of the Asp regenerates High Queen Khalida"),
            (try_end),
          (else_try),
            (eq, ":var3", 14),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_12_4"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 80),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The power of the Kraken regenerates Lord Fellheart"),
            (try_end),
          (else_try),
            (eq, ":var3", 15),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_kingdom_11_lord"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 177),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The golden light regenerates King Leoncour"),
            (try_end),
          (else_try),
            (eq, ":var3", 16),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_15_6"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The festering blight regenerates Beastlord Slugtongue"),
            (try_end),
          (else_try),
            (eq, ":var3", 18),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_7"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@Papa Nurgle regenerates Valnir the Reaper"),
            (try_end),
          (else_try),
            (eq, ":var3", 19),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_5"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Auric armour regenerates Sigvald the Magnificent"),
            (try_end),
          (else_try),
            (eq, ":var3", 20),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_5_15"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Breath of Life regenerates Aekold Helbrass"),
            (try_end),
          (else_try),
            (eq, ":var3", 21),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (eq, reg0, "trp_knight_1_17"),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (lt, ":var4", 100),
            (store_random_in_range, ":var5", 1, 101),
            (try_begin),
              (ge, ":var5", 85),
              (val_add, ":var4", 25),
              (agent_set_hit_points, ":var2", ":var4", 1),
              (display_message, "@The Jade griffon regenerates Luther Huss"),
            (try_end),
          (else_try),
            (eq, ":var3", 17),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, reg0, ":var2"),
            (agent_get_slot, ":var6", ":var2", 58),
            (store_mul, ":var7", ":var6", 7),
            (val_div, ":var7", 8),
            (store_agent_hit_points, ":var4", ":var2", 1),
            (le, ":var4", ":var7"),
            (store_div, ":var8", ":var6", 8),
            (val_add, ":var4", ":var8"),
            (agent_set_hit_points, ":var2", ":var4", 1),
            (agent_get_troop_id, ":var9", ":var2"),
            (str_clear, s1),
            (str_store_troop_name, s1, ":var9"),
            (display_message, "@A golden light regenerates {s1}"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (this_or_next|eq, "$poison_in_battle", 1),
      (eq, "$is_drunk", 1),
    ],
    [
      (try_begin),
        (eq, "$poison_in_battle", 1),
        (try_for_agents, ":var0"),
          (agent_is_alive, ":var0"),
          (agent_is_human, ":var0"),
          (agent_slot_eq, ":var0", 63, 1),
          (store_random_in_range, ":var1", 1, 3),
          (assign, reg1, ":var1"),
          (store_agent_hit_points, ":var2", ":var0", 1),
          (try_begin),
            (gt, ":var2", 3),
            (val_sub, ":var2", ":var1"),
            (val_clamp, ":var2", 0, 300),
            (agent_set_hit_points, ":var0", ":var2", 1),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take {reg1} damage.", 0xFFAAFFAA),
            (try_end),
          (else_try),
            (agent_set_hit_points, ":var0", 1, 1),
            (agent_deliver_damage_to_agent, ":var0", ":var0", 65, "itm_sword_empire_a"),
            (try_begin),
              (agent_get_troop_id, ":var3", ":var0"),
              (eq, ":var3", "trp_player"),
              (display_message, "@The poison inflicts more pain on your body. You take fatal damage.", 0xFFAAFFAA),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$is_drunk", 1),
        (get_player_agent_no, ":var0"),
        (call_script, "script_cf_get_drunk_battle_changes", ":var0"),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$stench_nurgle", 1),
      (eq, "$runebanner_in_battle", 1),
    ],
    [
      (try_begin),
        (eq, "$mummy_in_battle", 1),
        (call_script, "script_list_count", "trp_list_08"),
        (assign, ":var0", reg1),
        (val_add, ":var0", 1),
        (gt, ":var0", 1),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (agent_get_position, pos1, ":var1"),
          (try_for_agents, ":var5"),
            (agent_is_alive, ":var5"),
            (agent_is_human, ":var5"),
            (neq, ":var1", ":var5"),
            (agent_get_position, pos2, ":var5"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 200),
            (agent_get_troop_id, ":var7", ":var5"),
            (this_or_next|eq, ":var7", "trp_mummy"),
            (this_or_next|eq, ":var7", "trp_mummy_king"),
            (eq, ":var7", "trp_knight_6_1"),
            (store_random_in_range, ":var8", 1, 4),
            (assign, reg2, ":var8"),
            (store_agent_hit_points, ":var9", ":var1", 1),
            (try_begin),
              (gt, ":var9", ":var8"),
              (val_sub, ":var9", ":var8"),
              (val_clamp, ":var9", 0, 300),
              (agent_set_hit_points, ":var1", ":var9", 1),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take {reg2} damage.", 0xFFAAFFAA),
              (try_end),
            (else_try),
              (agent_set_hit_points, ":var1", 1, 1),
              (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
              (try_begin),
                (eq, ":var2", "trp_player"),
                (display_message, "@Tomb rot emanates from the mummy and you feel a pain behind your eyes. You take fatal damage.", 0xFFAAFFAA),
              (try_end),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$stench_nurgle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos2, ":var10"),
        (position_set_z_to_ground_level, pos2),
        (try_begin),
          (agent_is_alive, ":var10"),
          (particle_system_burst, "psys_game_hoof_dust_plague", pos2, 30),
        (try_end),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var12", ":var1"),
          (teams_are_enemies, ":var12", ":var11"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_slot, ":var3", ":var2", 227),
          (troop_get_type, ":var4", ":var2"),
          (neq, ":var4", 2),
          (neq, ":var4", 9),
          (neq, ":var4", 10),
          (neq, ":var2", "trp_bloodletter"),
          (neq, ":var2", "trp_daemonette"),
          (neq, ":var2", "trp_nurgling"),
          (neq, ":var2", "trp_plaguebearer"),
          (neq, ":var2", "trp_herald"),
          (neq, ":var2", "trp_skryre_globadier"),
          (neq, ":var2", "trp_warlock_engineer"),
          (neq, ":var2", "trp_plague_priest"),
          (neq, ":var2", "trp_plague_monk"),
          (neq, ":var2", "trp_ushabti"),
          (neq, ":var3", 1),
          (str_store_troop_name, s3, ":var2"),
          (agent_get_position, pos1, ":var1"),
          (agent_is_alive, ":var10"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 200),
          (store_skill_level, ":var13", 19, ":var2"),
          (try_begin),
            (ge, ":var13", 7),
            (store_random_in_range, ":var8", 3, 6),
          (else_try),
            (ge, ":var13", 4),
            (store_random_in_range, ":var8", 2, 5),
          (else_try),
            (store_random_in_range, ":var8", 1, 4),
          (try_end),
          (assign, reg2, ":var8"),
          (store_agent_hit_points, ":var9", ":var1", 1),
          (try_begin),
            (gt, ":var9", ":var8"),
            (val_sub, ":var9", ":var8"),
            (val_clamp, ":var9", 0, 300),
            (agent_set_hit_points, ":var1", ":var9", 1),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (else_try),
            (agent_set_hit_points, ":var1", 1, 1),
            (agent_deliver_damage_to_agent, ":var5", ":var1", 65, "itm_tomb_axe"),
            (display_message, "@The stench of Nurgle deals {reg2} damage to the {s3}.", 0x003300),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$runebanner_in_battle", 1),
        (get_player_agent_no, ":var10"),
        (agent_get_position, pos1, ":var10"),
        (try_begin),
          (item_slot_eq, "$currentbanner", 129, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 91, 1),
          (try_end),
        (try_end),
        (try_begin),
          (item_slot_eq, "$currentbanner", 131, 1),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 0),
          (try_end),
          (try_for_agents, ":var1"),
            (agent_is_alive, ":var1"),
            (agent_is_human, ":var1"),
            (neq, ":var1", ":var10"),
            (agent_get_position, pos2, ":var1"),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 3000),
            (agent_get_troop_id, ":var2", ":var1"),
            (troop_get_type, ":var4", ":var2"),
            (eq, ":var4", 4),
            (agent_set_slot, ":var1", 90, 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [
      (this_or_next|eq, "$mummy_in_battle", 1),
      (this_or_next|eq, "$regenerate_in_battle", 1),
      (this_or_next|eq, "$kill_counter", 1),
      (this_or_next|eq, "$bliss", 1),
      (this_or_next|eq, "$magic_in_battle", 1),
      (eq, "$savagedominioncast", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (assign, ":var4", 0),
      (agent_get_wielded_item, ":var5", ":var1", 0),
      (try_begin),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_4"),
        (this_or_next|eq, ":var5", "itm_slaanesh_missile_6"),
        (this_or_next|eq, ":var5", "itm_lash_of_slaanesh_ammo"),
        (this_or_next|eq, ":var5", "itm_pavane_of_slaanesh_ammo"),
        (eq, ":var5", "itm_slaanesh_missile_8"),
        (assign, ":var4", 1),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var6", ":var2", 225),
        (eq, ":var6", 1),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (troop_get_slot, ":var7", ":var2", 174),
        (gt, ":var7", 0),
        (call_script, "script_list_remove", "trp_list_08", ":var0"),
      (try_end),
      (try_begin),
        (eq, "$soulstealercast", 1),
        (agent_slot_eq, ":var0", 107, 1),
        (agent_slot_eq, ":var1", 108, 1),
        (store_skill_level, ":var8", 19, ":var3"),
        (try_begin),
          (store_agent_hit_points, ":var9", ":var1"),
          (lt, ":var9", 100),
          (try_begin),
            (ge, ":var8", 9),
            (val_add, ":var9", 10),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 5),
            (val_add, ":var9", 7),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (else_try),
            (ge, ":var8", 1),
            (val_add, ":var9", 5),
            (val_clamp, ":var9", 1, 101),
            (agent_set_hit_points, ":var1", ":var9"),
          (try_end),
          (agent_set_slot, ":var1", 108, 0),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|is_between, ":var3", "trp_knight_1_1", "trp_kingdom_1_pretender"),
        (is_between, ":var3", "trp_npc1", "trp_kingdom_1_lord"),
        (troop_get_slot, ":var10", ":var3", 247),
        (val_add, ":var10", 1),
        (troop_set_slot, ":var3", 247, ":var10"),
        (str_store_troop_name, s1, ":var3"),
        (try_begin),
          (eq, ":var10", 10),
          (display_message, "@{s1} has reached 10 kills in the current battle."),
        (else_try),
          (eq, ":var10", 20),
          (display_message, "@{s1} has reached 20 kills in the current battle."),
        (else_try),
          (eq, ":var10", 30),
          (display_message, "@{s1} has reached 30 kills in the current battle."),
        (else_try),
          (eq, ":var10", 40),
          (display_message, "@{s1} has reached 40 kills in the current battle."),
        (else_try),
          (eq, ":var10", 50),
          (display_message, "@{s1} has reached 50 kills in the current battle."),
        (else_try),
          (eq, ":var10", 60),
          (display_message, "@{s1} has reached 60 kills in the current battle."),
        (else_try),
          (eq, ":var10", 70),
          (display_message, "@{s1} has reached 70 kills in the current battle."),
        (else_try),
          (eq, ":var10", 80),
          (display_message, "@{s1} has reached 80 kills in the current battle."),
        (else_try),
          (eq, ":var10", 90),
          (display_message, "@{s1} has reached 90 kills in the current battle."),
        (else_try),
          (eq, ":var10", 100),
          (display_message, "@{s1} has reached 100 kills in the current battle."),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$slaaneshbliss", 1),
        (eq, ":var4", 1),
        (agent_slot_eq, ":var0", 115, 1),
        (agent_slot_eq, ":var1", 116, 1),
        (store_random_in_range, ":var11", 1, 7),
        (agent_set_slot, ":var1", 116, 0),
        (try_begin),
          (eq, ":var11", 6),
          (agent_get_team, ":var12", ":var1"),
          (agent_get_position, pos3, ":var1"),
          (assign, "$resurrect_in_play", 1),
          (set_show_messages, 0),
          (store_random_in_range, ":var13", 1, 361),
          (position_rotate_z, pos3, ":var13"),
          (position_move_y, pos3, 300),
          (position_set_z_to_ground_level, pos3),
          (set_spawn_position, pos3),
          (spawn_agent, "trp_daemonette"),
          (assign, ":var14", reg0),
          (agent_set_team, ":var14", ":var12"),
          (assign, "$resurrect_in_play", 0),
          (set_show_messages, 1),
          (str_store_troop_name, s4, ":var3"),
          (display_message, "@A daemonette has been summoned by {s4}.", 0xFF0074),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$lifeleech", 1),
        (agent_slot_eq, ":var0", 142, 1),
        (agent_slot_eq, ":var1", 143, 1),
        (store_random_in_range, ":var15", 1, 101),
        (try_begin),
          (le, ":var15", 33),
          (agent_get_slot, ":var16", ":var1", 144),
          (val_add, ":var16", 1),
          (agent_set_slot, ":var1", 144, ":var16"),
          (assign, "$leechbonus", 1),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_eq, ":var0", 127, 1),
        (store_random_in_range, ":var17", 1, 7),
        (try_begin),
          (ge, ":var17", 5),
          (assign, ":var18", 40),
          (assign, ":var19", 100),
          (assign, ":var20", 500),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var21", ":var0"),
          (call_script, "script_create_plague_explosion", ":var21", ":var18", ":var19", ":var20"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$savagedominioncast", 1),
        (agent_slot_eq, ":var0", 139, 1),
        (try_for_agents, ":var22"),
          (agent_slot_eq, ":var22", 140, ":var0"),
          (agent_fade_out, ":var22"),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_prebattle_agent_fix_division", ":var0"),
    ]),

    (0.5, 0, 0, 
    [
      (neq, "$g_next_menu", "mnu_simple_encounter"),
      (neq, "$g_next_menu", "mnu_join_battle"),
      (store_mission_timer_a, reg0),
      (gt, reg0, 4),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_slot_ge, ":var0", 29, 0),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 29, ":var1"),
        (agent_get_slot, ":var1", ":var0", 29),
        (agent_set_division, ":var0", ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 36, ":var0"),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$cam_current_agent"),
      (gt, "$cam_current_agent", -1),
    ],
    [
      (assign, "$cam_mode", 0),
      (assign, "$cam_free", -1),
      (assign, "$pin_player_fallen", 0),
      (assign, "$camera_mouse_center_x", 500),
      (assign, "$camera_mouse_center_y", 375),
      (assign, "$camera_mouse_x", "$camera_mouse_center_x"),
      (assign, "$camera_mouse_y", "$camera_mouse_center_y"),
      (assign, "$camera_mouse_counter", 0),
      (neg|is_between, "$camera_mouse_deadzone", 1, 11),
      (assign, "$camera_mouse_deadzone", 3),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (this_or_next|key_clicked, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_clicked, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_clicked, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_clicked, "$key_camera_right"),
      (key_is_down, "$key_camera_right"),
    ],
    [
      (mission_cam_get_position, pos47),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_forward"),
        (key_is_down, "$key_camera_forward"),
        (assign, ":var1", 10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_backward"),
        (key_is_down, "$key_camera_backward"),
        (assign, ":var1", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_left"),
        (key_is_down, "$key_camera_left"),
        (assign, ":var0", -10),
      (try_end),
      (try_begin),
        (this_or_next|key_clicked, "$key_camera_right"),
        (key_is_down, "$key_camera_right"),
        (assign, ":var0", 10),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var2", pos47),
        (lt, ":var2", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 2),
      (neg|is_presentation_active, "prsnt_battle"),
      (mouse_get_position, pos1),
      (set_fixed_point_multiplier, 1000),
      (position_get_x, reg1, pos1),
      (position_get_y, reg2, pos1),
      (this_or_next|neq, reg1, "$camera_mouse_center_x"),
      (neq, reg2, "$camera_mouse_center_y"),
    ],
    [
      (assign, ":var0", 1),
      (try_begin),
        (eq, reg1, "$camera_mouse_x"),
        (eq, reg2, "$camera_mouse_y"),
        (val_add, "$camera_mouse_counter", 1),
        (try_begin),
          (gt, "$camera_mouse_counter", 50),
          (assign, "$camera_mouse_center_x", reg1),
          (assign, "$camera_mouse_center_y", reg2),
          (assign, "$camera_mouse_counter", 0),
        (try_end),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (assign, "$camera_mouse_counter", 0),
      (assign, "$camera_mouse_x", reg1),
      (assign, "$camera_mouse_y", reg2),
      (mission_cam_get_position, pos47),
      (store_sub, ":var1", "$camera_mouse_center_x", reg1),
      (store_sub, ":var2", reg2, "$camera_mouse_center_y"),
      (try_for_range, ":var3", 0, 2),
        (try_begin),
          (eq, ":var3", 1),
          (assign, ":var1", ":var2"),
        (try_end),
        (store_mul, ":var4", "$camera_mouse_deadzone", -1),
        (this_or_next|lt, ":var1", ":var4"),
        (gt, ":var1", "$camera_mouse_deadzone"),
        (assign, ":var5", 1),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var5", -1),
        (try_end),
        (val_abs, ":var1"),
        (val_sub, ":var1", "$camera_mouse_deadzone"),
        (convert_to_fixed_point, ":var1"),
        (store_sqrt, ":var1", ":var1"),
        (convert_from_fixed_point, ":var1"),
        (val_clamp, ":var1", 1, 6),
        (val_mul, ":var1", ":var5"),
        (try_begin),
          (eq, ":var3", 0),
          (store_mul, ":var6", "$g_camera_rotx", -1),
          (position_rotate_x, pos47, ":var6"),
          (position_rotate_z, pos47, ":var1"),
          (position_rotate_x, pos47, "$g_camera_rotx"),
        (try_end),
        (try_begin),
          (eq, ":var3", 1),
          (position_rotate_x, pos47, ":var1"),
          (val_add, "$g_camera_rotx", ":var1"),
        (try_end),
      (try_end),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (agent_get_look_position, pos47, "$cam_current_agent"),
      (position_get_rotation_around_x, ":var0", pos47),
      (store_sub, ":var1", 0, ":var0"),
      (position_rotate_x, pos47, ":var1"),
      (try_begin),
        (eq, "$cam_free", -1),
        (val_clamp, "$g_camera_x", -1000, 1000),
        (val_clamp, "$g_camera_y", -1000, 1000),
        (val_min, "$g_camera_z", 1000),
      (try_end),
      (position_move_y, pos47, "$g_camera_y"),
      (position_move_z, pos47, "$g_camera_z"),
      (position_move_x, 47, "$g_camera_x"),
      (agent_get_horse, ":var2", "$cam_current_agent"),
      (try_begin),
        (ge, ":var2", 0),
        (position_move_z, pos47, 80),
      (try_end),
      (store_mul, ":var1", -1, "$g_camera_y"),
      (store_atan2, ":var3", "$g_camera_z", ":var1"),
      (convert_from_fixed_point, ":var3"),
      (val_sub, ":var0", ":var3"),
      (position_rotate_x, pos47, ":var0"),
      (try_begin),
        (position_get_distance_to_ground_level, ":var4", pos47),
        (lt, ":var4", 0),
        (position_set_z_to_ground_level, pos47),
        (position_move_z, pos47, 50),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 0),
        (mission_cam_set_position, pos47),
      (else_try),
        (mission_cam_animate_to_position, pos47, 100, 0),
      (try_end),
      (try_begin),
        (neg|main_hero_fallen),
        (this_or_next|game_key_clicked, gk_view_char),
        (game_key_clicked, gk_cam_toggle),
        (mission_cam_set_mode, 0),
        (assign, "$cam_mode", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, "$key_camera_toggle"),
      (lt, "$cam_mode", 3),
    ],
    [
      (try_begin),
        (eq, "$cam_mode", 0),
        (assign, "$g_camera_z", 300),
        (assign, "$g_camera_y", -1000),
        (assign, "$g_camera_x", 0),
        (assign, "$cam_mode", 1),
      (else_try),
        (eq, "$cam_mode", 1),
        (try_begin),
          (eq, "$cam_free", -1),
          (try_begin),
            (neg|main_hero_fallen),
            (get_player_agent_no, "$cam_current_agent"),
          (try_end),
          (assign, "$cam_mode", 0),
        (else_try),
          (try_begin),
            (main_hero_fallen),
            (mission_cam_get_position, pos47),
            (position_get_rotation_around_x, "$g_camera_rotx", pos47),
          (else_try),
            (assign, "$g_camera_rotx", 0),
          (try_end),
          (assign, "$cam_mode", 2),
        (try_end),
      (else_try),
        (eq, "$cam_mode", 2),
        (try_begin),
          (ge, "$cam_free", 0),
          (assign, "$g_camera_z", 300),
          (assign, "$g_camera_y", -1000),
          (assign, "$g_camera_x", 0),
          (assign, "$cam_mode", 1),
        (else_try),
          (assign, "$cam_mode", 0),
        (try_end),
      (try_end),
      (start_presentation, "prsnt_caba_camera_mode_display"),
      (try_begin),
        (eq, "$cam_mode", 0),
        (mission_cam_set_mode, 0),
      (else_try),
        (mission_cam_set_mode, 1),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 1),
      (this_or_next|key_is_down, "$key_camera_forward"),
      (this_or_next|key_is_down, "$key_camera_backward"),
      (this_or_next|key_is_down, "$key_camera_left"),
      (this_or_next|key_is_down, "$key_camera_right"),
      (this_or_next|key_is_down, "$key_camera_zoom_plus"),
      (this_or_next|key_is_down, "$key_camera_zoom_min"),
      (this_or_next|key_clicked, "$key_camera_next"),
      (this_or_next|key_clicked, "$key_camera_prev"),
      (game_key_is_down, gk_attack),
    ],
    [
      (try_begin),
        (game_key_is_down, gk_attack),
        (neg|main_hero_fallen),
        (eq, "$fplayer_agent_no", "$cam_current_agent"),
        (agent_is_alive, "$fplayer_agent_no"),
        (agent_get_wielded_item, ":var0", "$cam_current_agent", 0),
        (ge, ":var0", 0),
        (item_get_type, ":var1", ":var0"),
        (this_or_next|eq, ":var1", 8),
        (this_or_next|eq, ":var1", 9),
        (eq, ":var1", 10),
        (assign, "$cam_mode", 3),
        (mission_cam_set_mode, 0),
      (try_end),
      (try_begin),
        (ge, "$cam_free", 1),
        (try_begin),
          (key_clicked, "$key_camera_next"),
          (call_script, "script_cust_cam_cycle_forwards"),
        (else_try),
          (key_clicked, "$key_camera_prev"),
          (call_script, "script_cust_cam_cycle_backwards"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_forward"),
        (val_add, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_backward"),
        (val_sub, "$g_camera_y", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_y", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_left"),
        (val_sub, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_right"),
        (val_add, "$g_camera_x", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_x", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_plus"),
        (val_add, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_add, "$g_camera_z", 9),
      (try_end),
      (try_begin),
        (key_is_down, "$key_camera_zoom_min"),
        (val_sub, "$g_camera_z", 1),
        (neg|game_key_is_down, gk_zoom),
        (val_sub, "$g_camera_z", 9),
        (val_max, "$g_camera_z", 50),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$cam_mode", 3),
      (neg|game_key_is_down, gk_attack),
    ],
    [
      (assign, "$cam_mode", 1),
      (mission_cam_set_mode, 1),
    ]),

  ]),

]